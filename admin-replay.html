<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Replay Checkout ‚Üí Inserisci eventi</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/style.css">
  <style>
    body{padding:16px}
    .card{max-width:720px;margin:0 auto}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input{flex:1}
    pre{white-space:pre-wrap;background:#0f1c2d;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px}
    .ok{color:#7CFC7C;font-weight:700}
    .err{color:#ff9a9a;font-weight:700}
  </style>
  <script src="assets/app-config.js?v=3"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <header class="header">
    <a href="index.html" class="logo">
      <svg class="pin" viewBox="0 0 64 72" aria-hidden="true">
        <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/>
        <circle cx="32" cy="24" r="9" fill="#ffffff"/>
      </svg>
      <span class="wordmark">stasera qui</span>
    </a>
  </header>

  <main class="container">
    <div class="card">
      <h1 style="margin-top:0">Replay pagamento ‚Üí inserisci eventi in DB</h1>
      <p class="small">Incolla un ID di <b>Checkout Session</b> (es. <code>cs_live_‚Ä¶</code>) e premi ‚ÄúInserisci in DB‚Äù.</p>

      <div class="row">
        <input id="cs" placeholder="cs_live_‚Ä¶" autocomplete="off">
        <button class="btn primary" id="go" type="button">Inserisci in DB</button>
      </div>

      <div id="out" style="margin-top:12px"></div>
      <div style="margin-top:16px">
        <a class="btn" href="admin.html">‚Üê Torna a Admin</a>
        <a class="btn" href="index.html">Torna alla mappa</a>
      </div>
    </div>
  </main>

  <script>
  (function(){
    const CFG = window.SQ_CONFIG || window.SQ || {};
    const SUPABASE_URL = CFG.SUPABASE_URL;
    const SUPABASE_ANON = CFG.SUPABASE_ANON || CFG.SUPABASE_ANON_KEY;

    if(!SUPABASE_URL || !SUPABASE_ANON){
      document.getElementById('out').innerHTML = '<div class="err">Config mancante: controlla assets/app-config.js</div>';
      return;
    }

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
    const $ = s=>document.querySelector(s);
    const out = (html)=> $('#out').innerHTML = html;

    $('#go').addEventListener('click', async ()=>{
      const id = ($('#cs').value||'').trim();
      if(!id || !/^cs_/.test(id)){ out('<div class="err">ID non valido. Incolla un ID che inizia con <code>cs_</code>.</div>'); return; }

      out('Invio‚Ä¶');

      // üëâ usa l‚ÄôSDK: niente CORS/preflight rognosi
      const { data, error } = await sb.functions.invoke('admin-insert-events', {
        body: { session_id: id }
      });

      if(error){
        out('<div class="err">Errore: '+(error.message||JSON.stringify(error))+'</div><pre>'+JSON.stringify(error, null, 2)+'</pre>');
        return;
      }
      out('<div class="ok">Fatto! Inseriti '+(data?.inserted_events||0)+' eventi e '+(data?.inserted_occurrences||0)+' occorrenze.</div>'
          + (data?.message? '<div class="small">'+data.message+'</div>':'')
      );
    });
  })();
  </script>
</body>
</html>
