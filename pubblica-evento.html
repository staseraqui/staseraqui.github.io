<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pubblica evento — Stasera Qui</title>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="assets/style.css">
<style>
  .modal{z-index:999999!important}
  .err{color:#ffb4b4;margin-top:8px}
  .badge{display:inline-block;background:#17304d;border:1px solid #2e6e8f;color:#d7f2ff;border-radius:16px;padding:4px 10px;margin:6px 8px 0 0;font-size:13px}
  .card{background:#0f1c2d;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:16px;margin:14px 0}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid > div > label{display:block;margin:6px 0 6px;font-weight:700}
  input,textarea,select{width:100%;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#ffffff;color:#081421}
  textarea{min-height:240px}
  .block-title{margin:22px 0 10px}
  .btn{background:#111f31;border:1px solid rgba(255,255,255,.2);padding:10px 14px;border-radius:10px;color:#fff;display:inline-block;cursor:pointer}
  .btn.primary{background:#22b3f0;color:#081421;border-color:#22b3f0;font-weight:700}
  .btn.secondary{background:#1a2a44}
  .footer-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
  .divider{border:none;border-top:1px solid rgba(255,255,255,.12);margin:18px 0}
  .page-footer{padding:20px 16px}
  @media (max-width:720px){ .grid{grid-template-columns:1fr} }
</style>
<!-- Supabase JS per upload su Storage -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>
<body>
<header class="header" style="padding:0 16px">
  <a href="index.html" class="logo">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true">
      <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/>
      <circle cx="32" cy="24" r="9" fill="#ffffff"/>
    </svg>
    <span class="wordmark">stasera qui</span>
  </a>
</header>

<main class="container">
  <h1>Pubblica il tuo evento</h1>

  <div class="card">
    <h2 style="margin-top:0">Perché pubblicare su Stasera Qui?</h2>
    <ul style="margin-top:6px">
      <li><b>Visibilità immediata</b> sulla mappa dove le persone cercano cosa fare <i>oggi</i>.</li>
      <li><b>Semplice e veloce</b>: 2 minuti per inserire titolo, foto e date.</li>
      <li><b>Pubblico locale</b>: ideale per Pro Loco, circoli, locali, associazioni.</li>
      <li><b>Costi chiari</b> e pagamento online sicuro.</li>
    </ul>
    <div style="margin-top:10px">
      <a class="btn primary" href="prezzi-condizioni.html">Vedi prezzi e condizioni</a>
    </div>
  </div>

  <form id="eventForm" class="card" onsubmit="return false">
    <div class="grid">
      <div>
        <label for="titolo">Titolo evento*</label>
        <input id="titolo" required maxlength="80" placeholder="Es. Aperitivo jazz in piazza">
      </div>
      <div>
        <label for="categorieBtn">Categorie*</label><br>
        <button class="btn secondary" id="categorieBtn" type="button">Scegli categorie</button>
        <div id="catBadges"></div>
      </div>
    </div>

    <div class="grid">
      <div>
        <label for="prezzo">Prezzo/Ingresso</label>
        <input id="prezzo" placeholder="Es. Gratis / 10€ con drink">
      </div>
      <div>
        <label>Locandina/Foto*</label>
        <div class="grid">
          <div><input id="locandinaFile" type="file" accept="image/png,image/jpeg"></div>
          <div><input id="locandinaUrl" placeholder="oppure incolla un URL (https://…)" ></div>
        </div>
        <p class="small">Carica un JPG/PNG <b>oppure</b> incolla un URL. Se scegli il file, lo carichiamo noi in modo sicuro.</p>
      </div>
    </div>

    <h3 class="block-title">Prenotazione / Contatto</h3>
    <div id="contattiWrap">
      <div class="grid contact">
        <div><label>Nome referente</label><input class="ref_name" placeholder="Es. Laura Bianchi"></div>
        <div><label>Numero referente</label><input class="ref_phone" type="tel" placeholder="+39 333 1234567"></div>
      </div>
    </div>
    <div style="margin-top:6px">
      <button class="btn secondary" id="addContact" type="button">Aggiungi contatto</button>
    </div>

    <div style="margin-top:10px">
      <label for="descrizione">Descrizione breve (max 400)*</label>
      <textarea id="descrizione" name="descrizione" maxlength="400" required placeholder="Due righe chiare: cosa succede, per chi è, dettagli utili."></textarea>
    </div>

    <h3 class="block-title">Occorrenze</h3>
    <div id="occWrap">
      <!-- Prima occorrenza (obbligatoria) -->
      <div class="occ card">
        <div class="grid">
          <div><label>Luogo/Nome locale*</label><input class="luogo" placeholder="Es. Bar Centrale"></div>
          <div><label>Indirizzo*</label><input class="indirizzo" placeholder="Via Roma 1"></div>
        </div>
        <div class="grid">
          <div><label>Città*</label><input class="citta" placeholder="Es. Torino"></div>
          <div><label>Data*</label><input class="data" type="date"></div>
        </div>
        <div class="grid">
          <div><label>Orario*</label><input class="ora" type="time"></div>
          <div></div>
        </div>
      </div>
    </div>
    <div style="margin-top:8px">
      <button class="btn primary" id="addOcc" type="button">Aggiungi altra occorrenza</button>
    </div>

    <hr class="divider">

    <h3 class="block-title">Chi inserisce l’annuncio</h3>
    <div class="grid">
      <div><label for="sub_nome">Nome*</label><input id="sub_nome" required></div>
      <div><label for="sub_cognome">Cognome*</label><input id="sub_cognome" required></div>
    </div>
    <div class="grid">
      <div><label for="sub_tel">Telefono*</label><input id="sub_tel" type="tel" required></div>
      <div><label for="sub_email">Email*</label><input id="sub_email" type="email" required></div>
    </div>
    <p class="note">Questi dati rimarranno riservati e non verranno resi pubblici. Li useremo solo per contattarti in caso di chiarimenti sull’annuncio.</p>

    <div style="margin-top:8px">
      <label for="partner_code">Codice partner</label>
      <input id="partner_code" placeholder="Se hai un codice partner, inseriscilo qui">
      <p class="small">Se sei stato contattato da un partner “Stasera Qui”, inserisci nella casella di testo qui sopra il suo codice identificativo a 6 cifre.</p>
    </div>

    <div class="footer-actions">
      <button class="btn primary" id="anteprimaBtn" type="button">Rivedi anteprima</button>
      <button class="btn primary" id="confermaFooterBtn" type="button">Conferma pubblicazione evento</button>
      <button class="btn secondary" id="azzeraBtn" type="button">Azzera tutto</button>
    </div>
    <div id="err" class="err"></div>
  </form>

  <div id="preview" class="card" style="display:none">
    <h3>Anteprima</h3>
    <div class="small">
      <div><b>Titolo:</b> <span id="pv_titolo"></span></div>
      <div><b>Categorie:</b> <span id="pv_cats"></span></div>
    </div>
    <p id="pv_descr" style="margin-top:8px"></p>
    <div><b class="small">Occorrenze:</b> <span id="pv_occ"></span></div>
    <div id="pv_list" style="margin-top:6px"></div>
  </div>

  <p class="small" style="margin-top:16px">In caso di dubbi o problemi durante la pubblicazione di un evento, scrivi a: <a href="mailto:eventi@staseraqui.it">eventi@staseraqui.it</a></p>
</main>

<footer class="page-footer"><a href="index.html" class="btn">← Torna alla mappa</a></footer>

<script>
// ====== CONFIG (SOSTITUISCI QUESTE QUATTRO COSTANTI) ======
const SUPABASE_URL = 'https://rubdzlnolxcgpjklfggk.supabase.co';            // es. https://rubdzlnolxcgpjklfggk.supabase.co
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1YmR6bG5vbHhjZ3Bqa2xmZ2drIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4OTI3NjQsImV4cCI6MjA3MjQ2ODc2NH0.Fhq7lKdx1OcyuCWOnHqNH7Omsg7qjdQVzxvNqZyeQQ8';  // anon public key (ey…)
const FN_URL = 'https://rubdzlnolxcgpjklfggk.supabase.co/functions/v1/create-checkout-session';   // invoke URL della funzione di checkout
const GEOCODE_FN = 'https://rubdzlnolxcgpjklfggk.supabase.co/functions/v1/geocode';      // invoke URL della funzione geocode (Google)

// Inizializza Supabase (per upload della locandina)
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Tutto dentro IIFE per avere il DOM pronto
(function(){

  // ====== MODALE CATEGORIE ======
  var btn = document.getElementById('categorieBtn');
  var wrap = document.getElementById('catBadges');
  var modal = document.createElement('div');
  modal.className='modal'; modal.style.display='none'; modal.style.alignItems='center'; modal.style.justifyContent='center';
  modal.innerHTML = '<div style="background:#0f1c2d;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:16px;min-width:280px;max-width:900px">'
    + '<h3 style="margin:0 0 6px">Scegli categorie (multi)</h3>'
    + '<div id="chipsModal" style="display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 12px">'
    + ['Musica','Food & Drink','Nightlife','Cultura/Spettacolo','Famiglie & Bambini','Sport','Sagre & Fiere','Mercatini'].map(function(c){
        return '<div class="chip" data-cat="'+c+'" style="background:#17304d;border:1px solid #2e6e8f;color:#d7f2ff;border-radius:28px;padding:10px 18px;font-weight:700;cursor:pointer;user-select:none">'+c+'</div>';
      }).join('')
    + '</div>'
    + '<div class="actions" style="display:flex;gap:8px;justify-content:flex-end">'
      + '<button class="btn primary" id="catOk" type="button">Conferma</button>'
      + '<button class="btn secondary" id="catClear" type="button">Azzera</button>'
    + '</div></div>';
  document.body.appendChild(modal);
  function renderCats(cats){ wrap.innerHTML=''; for(var i=0;i<cats.length;i++){var b=document.createElement('span'); b.className='badge'; b.textContent=cats[i]; wrap.appendChild(b);} }
  var cats = [];
  btn.addEventListener('click', function(){ modal.style.display='flex'; document.body.style.overflow='hidden'; });
  modal.addEventListener('click', function(e){ if(e.target===modal){ modal.style.display='none'; document.body.style.overflow='auto'; } });
  modal.addEventListener('click', function(e){
    if(e.target.classList.contains('chip')){
      e.target.classList.toggle('active');
      if(e.target.classList.contains('active')){ e.target.style.background='#22b3f0'; e.target.style.color='#081421'; e.target.style.borderColor='#22b3f0'; }
      else { e.target.style.background='#17304d'; e.target.style.color='#d7f2ff'; e.target.style.borderColor='#2e6e8f'; }
    }
  });
  modal.querySelector('#catOk').addEventListener('click', function(){
    cats = Array.prototype.slice.call(modal.querySelectorAll('.chip.active')).map(function(ch){return ch.getAttribute('data-cat');});
    renderCats(cats); modal.style.display='none'; document.body.style.overflow='auto';
  });
  modal.querySelector('#catClear').addEventListener('click', function(){
    cats = []; renderCats(cats);
    Array.prototype.forEach.call(modal.querySelectorAll('.chip'), function(ch){ ch.classList.remove('active'); ch.style.background='#17304d'; ch.style.color='#d7f2ff'; ch.style.borderColor='#2e6e8f'; });
  });

  // ====== AGGIUNGI CONTATTO ======
  var wrapC = document.getElementById('contattiWrap');
  document.getElementById('addContact').addEventListener('click', function(){
    var d=document.createElement('div'); d.className='grid contact';
    d.innerHTML = '<div><label>Nome referente</label><input class="ref_name" placeholder="Es. Laura Bianchi"></div>'
                + '<div><label>Numero referente</label><input class="ref_phone" type="tel" placeholder="+39 333 1234567"></div>';
    wrapC.appendChild(d);
  });

  // ====== OCCORRENZE ADD/REMOVE ======
  var wrapO = document.getElementById('occWrap');
  document.getElementById('addOcc').addEventListener('click', function(){
    var d=document.createElement('div'); d.className='occ card';
    d.innerHTML =
      '<div class="grid">'
        + '<div><label>Luogo/Nome locale*</label><input class="luogo" placeholder="Es. Bar Centrale"></div>'
        + '<div><label>Indirizzo*</label><input class="indirizzo" placeholder="Via Roma 1"></div>'
      + '</div>'
      + '<div class="grid">'
        + '<div><label>Città*</label><input class="citta" placeholder="Es. Torino"></div>'
        + '<div><label>Data*</label><input class="data" type="date"></div>'
      + '</div>'
      + '<div class="grid">'
        + '<div><label>Orario*</label><input class="ora" type="time"></div>'
        + '<div style="display:flex;align-items:flex-end;justify-content:flex-end"><button type="button" class="btn secondary del-btn">Elimina occorrenza</button></div>'
      + '</div>';
    wrapO.appendChild(d);
  });
  wrapO.addEventListener('click', function(e){
    if(e.target.classList.contains('del-btn')){
      var box=e.target.closest('.occ'); if(box) box.remove();
    }
  });

  // ====== UTILS ======
  var err = document.getElementById('err');
  function clean(t){ t=(t||'').trim().replace(/\s+/g,' '); return t? t.charAt(0).toUpperCase()+t.slice(1):''; }

  // Geocoding via Edge Function (Google Geocoding lato server)
  async function geocode(indirizzo, citta){
    try{
      const res = await fetch(GEOCODE_FN, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ indirizzo, citta })
      });
      if (!res.ok) return null;
      const js = await res.json();
      if (js && typeof js.lat === 'number' && typeof js.lng === 'number') {
        return { lat: js.lat, lng: js.lng };
      }
      return null;
    }catch(_){ return null; }
  }

  // Upload locandina su Supabase Storage (se file) oppure usa URL
  async function getImageUrl(){
    var f = document.getElementById('locandinaFile').files[0];
    var urlInput = (document.getElementById('locandinaUrl').value||'').trim();
    if (f){
      if(!(f.type==='image/jpeg' || f.type==='image/png')) throw new Error('La locandina deve essere JPG o PNG');
      if(f.size > 6*1024*1024) throw new Error('La locandina supera 6MB');
      var ext = f.type==='image/png' ? 'png' : 'jpg';
      var path = 'events/'+(new Date().toISOString().replace(/[:.]/g,'-'))+'_'+Math.random().toString(36).slice(2)+'.'+ext;
      var up = await sb.storage.from('event-images').upload(path, f, { contentType: f.type, cacheControl: '3600', upsert:false });
      if(up.error) throw new Error('Upload immagine: '+up.error.message);
      var pub = sb.storage.from('event-images').getPublicUrl(path);
      return pub.data.publicUrl;
    }
    if(!urlInput) throw new Error('Carica un file oppure incolla un URL immagine');
    if(!/^https?:\/\//.test(urlInput)) throw new Error('URL immagine non valido');
    return urlInput;
  }

  // Anteprima (senza geocoding)
  function collectOccForPreview(){
    var occ=[];
    Array.prototype.forEach.call(document.querySelectorAll('#occWrap .occ'), function(b){
      var luogo=clean((b.querySelector('.luogo')||{}).value||'');
      var indirizzo=clean((b.querySelector('.indirizzo')||{}).value||'');
      var citta=clean((b.querySelector('.citta')||{}).value||'');
      var data=(b.querySelector('.data')||{}).value||'';
      var ora=(b.querySelector('.ora')||{}).value||'';
      if(!luogo||!indirizzo||!citta||!data||!ora){ occ.push(null); } else { occ.push({luogo,indirizzo,citta,data,ora}); }
    });
    if(occ.length===0 || occ.indexOf(null)>-1) return null;
    return occ;
  }
  document.getElementById('anteprimaBtn').addEventListener('click', function(){
    err.textContent='';
    var titolo=clean(document.getElementById('titolo').value);
    var descr =clean(document.getElementById('descrizione').value);
    var anyCat=(document.getElementById('catBadges').children.length>0);
    var occ=collectOccForPreview();
    if(!titolo||!descr||!anyCat||!occ){ err.textContent='Controlla: Titolo*, Descrizione*, almeno 1 Categoria* e completa tutte le occorrenze.'; return; }
    document.getElementById('pv_titolo').textContent=titolo;
    document.getElementById('pv_cats').textContent=Array.prototype.map.call(document.getElementById('catBadges').children,function(b){return b.textContent;}).join(', ');
    document.getElementById('pv_descr').textContent=descr;
    document.getElementById('pv_occ').textContent=occ.length+' occorrenza/e';
    var ul=document.createElement('ul'); occ.forEach(function(o){ var li=document.createElement('li'); li.textContent=o.data+' ore '+o.ora+' — '+o.luogo+', '+o.indirizzo+', '+o.citta; ul.appendChild(li); }); var list=document.getElementById('pv_list'); list.innerHTML=''; list.appendChild(ul);
    document.getElementById('preview').style.display='block';
    window.scrollTo({ top: document.getElementById('preview').offsetTop-10, behavior:'smooth'});
  });

  // Costruisci payload finale con geocoding
  async function buildPayload(){
    var occBlocks = Array.prototype.slice.call(document.querySelectorAll('#occWrap .occ'));
    var occFinal = [];
    for (var i=0;i<occBlocks.length;i++){
      var b = occBlocks[i];
      var luogo = (b.querySelector('.luogo')||{}).value||'';
      var indirizzo = (b.querySelector('.indirizzo')||{}).value||'';
      var citta = (b.querySelector('.citta')||{}).value||'';
      var data = (b.querySelector('.data')||{}).value||'';
      var ora  = (b.querySelector('.ora')||{}).value||'';
      if(!(luogo && indirizzo && citta && data && ora)) throw new Error('Completa tutti i campi dell\'occorrenza '+(i+1));
      var pos = await geocode(indirizzo, citta);
      if(!pos) throw new Error('Indirizzo non trovato per l\'occorrenza '+(i+1)+'. Verifica Indirizzo/Città.');
      occFinal.push({ luogo, indirizzo, citta, data, ora, lat: pos.lat, lng: pos.lng });
    }
    var imageURL = await getImageUrl();
    return {
      titolo: clean(document.getElementById('titolo').value),
      prezzo: (document.getElementById('prezzo').value||'').trim(),
      descrizione: clean(document.getElementById('descrizione').value),
      locandina_url: imageURL,
      categorie: Array.prototype.map.call(document.getElementById('catBadges').children, function(b){return b.textContent;}),
      occorrenze: occFinal,
      submitter: {
        nome: (document.getElementById('sub_nome').value||''),
        cognome: (document.getElementById('sub_cognome').value||''),
        tel: (document.getElementById('sub_tel').value||''),
        email: (document.getElementById('sub_email').value||'')
      },
      partner_code: (document.getElementById('partner_code').value||'')
    };
  }

  function validatePayload(p){
    var e=[];
    if(!p.titolo) e.push('Titolo obbligatorio');
    if(!p.descrizione) e.push('Descrizione obbligatoria');
    if(!p.locandina_url || !/^https?:\/\//.test(p.locandina_url)) e.push('Immagine non valida');
    if(!p.categorie || p.categorie.length===0) e.push('Seleziona almeno una categoria');
    if(!p.occorrenze || p.occorrenze.length===0) e.push('Aggiungi almeno una occorrenza');
    if(!(p.submitter && p.submitter.nome && p.submitter.cognome && p.submitter.email && p.submitter.tel)) e.push('Completa i dati del referente');
    if((p.descrizione||'').length>400) e.push('Descrizione oltre 400 caratteri');
    if(p.occorrenze.length>4) e.push('Massimo 4 occorrenze per evento multiplo');
    return e;
  }

  // ====== CONFERMA → Stripe Checkout ======
  document.getElementById('confermaFooterBtn').addEventListener('click', async function(){
    var errBox = document.getElementById('err');
    errBox.textContent='';
    try{
      var payload = await buildPayload();
      var errs = validatePayload(payload);
      if(errs.length){ errBox.textContent = errs.join(' — '); return; }
      var res = await fetch(FN_URL, {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'Authorization':'Bearer ' + SUPABASE_ANON_KEY
        },
        body: JSON.stringify(payload)
      });
      if(!res.ok){
        var t=await res.text();
        throw new Error(t || ('HTTP '+res.status));
      }
      var data = await res.json();
      if(!data.url) throw new Error('URL checkout non ricevuto');
      window.location.href = data.url; // Stripe Checkout
    }catch(ex){
      errBox.textContent = 'Errore: ' + (ex && ex.message ? ex.message : String(ex));
    }
  });

  document.getElementById('azzeraBtn').addEventListener('click', function(){ location.reload(); });
})();
</script>
</body>
</html>
