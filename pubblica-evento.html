<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Pubblica evento — Stasera Qui</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/style.css?v=18">
  <style>.modal{z-index:999999!important}</style>
  <!-- Config chiavi -->
  <script src="assets/app-config.js?v=1"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>

<header class="header">
  <div class="logo">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true">
      <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/>
      <circle cx="32" cy="24" r="9" fill="#ffffff"/>
    </svg>
    <span class="wordmark">stasera qui</span>
  </div>
</header>

<main class="container">
  <h1>Pubblica il tuo evento</h1>

  <div class="card">
    <h2 style="margin-top:0">Perché pubblicare su Stasera Qui?</h2>
    <ul style="margin-top:6px">
      <li><b>Visibilità immediata</b> sulla mappa dove le persone cercano cosa fare <i>oggi</i>.</li>
      <li><b>Semplice e veloce</b>: 2 minuti per inserire titolo, foto e date.</li>
      <li><b>Pubblico locale</b>: ideale per Pro Loco, circoli, locali, associazioni.</li>
      <li><b>Pagamento online sicuro</b> con Stripe.</li>
    </ul>
    <div style="margin-top:10px">
      <a class="btn primary" href="prezzi-condizioni.html">Vedi prezzi e condizioni</a>
    </div>
  </div>

  <form id="eventForm" class="card" onsubmit="return false">
    <div class="grid">
      <div>
        <label for="titolo">Titolo evento*</label>
        <input id="titolo" required maxlength="80" placeholder="Es. Aperitivo jazz in piazza">
      </div>
      <div>
        <label for="categorieBtn">Categorie*</label><br>
        <button class="btn secondary" id="categorieBtn" type="button">Scegli categorie</button>
        <div id="catBadges"></div>
      </div>
    </div>

    <div class="grid">
      <div>
        <label for="prezzo">Prezzo/Ingresso</label>
        <input id="prezzo" placeholder="Es. Gratis / 10€ con drink">
      </div>
      <div>
        <label for="locandina">Locandina/Foto (JPG/PNG)*</label>
        <input id="locandina" type="file" accept="image/png,image/jpeg" required>
      </div>
    </div>

    <h3 class="block-title">Prenotazione / Contatto</h3>
    <div id="contattiWrap">
      <div class="grid contact">
        <div><label>Nome referente</label><input class="ref_name" placeholder="Es. Laura Bianchi"></div>
        <div><label>Numero referente</label><input class="ref_phone" type="tel" placeholder="+39 333 1234567"></div>
      </div>
    </div>
    <div style="margin-top:6px">
      <button class="btn secondary" id="addContact" type="button">Aggiungi contatto</button>
    </div>

    <div style="margin-top:10px">
      <label for="descrizione">Descrizione breve (max 400)*</label>
      <textarea id="descrizione" maxlength="400" required placeholder="Due righe chiare: cosa succede, per chi è, dettagli utili." style="min-height:240px"></textarea>
    </div>

    <h3 class="block-title">Occorrenze</h3>
    <div id="occWrap">
      <div class="occ card">
        <div class="grid">
          <div><label>Luogo/Nome locale*</label><input class="luogo" placeholder="Es. Bar Centrale"></div>
          <div><label>Indirizzo*</label><input class="indirizzo" placeholder="Via Roma 1"></div>
        </div>
        <div class="grid">
          <div><label>Città*</label><input class="citta" placeholder="Es. Torino"></div>
          <div><label>Data*</label><input class="data" type="date"></div>
        </div>
        <div class="grid">
          <div><label>Orario*</label><input class="ora" type="time"></div>
          <div></div>
        </div>
      </div>
    </div>
    <div style="margin-top:8px">
      <button class="btn primary" id="addOcc" type="button">Aggiungi altra occorrenza</button>
    </div>

    <hr class="divider">

    <h3 class="block-title">Chi inserisce l’annuncio</h3>
    <div class="grid">
      <div><label for="sub_nome">Nome*</label><input id="sub_nome" required></div>
      <div><label for="sub_cognome">Cognome*</label><input id="sub_cognome" required></div>
    </div>
    <div class="grid">
      <div><label for="sub_tel">Telefono*</label><input id="sub_tel" type="tel" required></div>
      <div><label for="sub_email">Email*</label><input id="sub_email" type="email" required></div>
    </div>
    <p class="note">Questi dati rimarranno riservati e non verranno resi pubblici. Li useremo solo per contattarti in caso di chiarimenti sull’annuncio.</p>

    <div style="margin-top:8px">
      <label for="partner_code">Codice partner</label>
      <input id="partner_code" placeholder="Se hai un codice partner, inseriscilo qui">
      <p class="small">Se sei stato contattato da un partner “Stasera Qui”, inserisci nella casella di testo qui sopra il suo codice identificativo a 6 cifre.</p>
    </div>

    <div class="footer-actions">
      <button class="btn primary" id="anteprimaBtn" type="button">Rivedi anteprima</button>
      <button class="btn primary" id="confermaFooterBtn" type="button">Conferma pubblicazione evento</button>
      <button class="btn secondary" id="azzeraBtn" type="button">Azzera tutto</button>
    </div>
    <div id="err" class="err"></div>
  </form>

  <div id="preview" class="card" style="display:none">
    <h3>Anteprima</h3>
    <div class="small">
      <div><b>Titolo:</b> <span id="pv_titolo"></span></div>
      <div><b>Categorie:</b> <span id="pv_cats"></span></div>
    </div>
    <p id="pv_descr" style="margin-top:8px"></p>
    <div><b class="small">Occorrenze:</b> <span id="pv_occ"></span></div>
    <div id="pv_list" style="margin-top:6px"></div>
  </div>

  <p class="small" style="margin-top:16px">In caso di dubbi o problemi durante la pubblicazione di un evento, scrivi a: <a href="mailto:eventi@staseraqui.it">eventi@staseraqui.it</a></p>
</main>

<footer class="page-footer"><a href="index.html" class="btn">← Torna alla mappa</a></footer>

<script>
(function(){
  // ====== CONFIG ======
  const CFG = window.SQ_CONFIG || {};
  const SUPABASE_URL = CFG.SUPABASE_URL;
  const SUPABASE_ANON = CFG.SUPABASE_ANON;
  const GOOGLE_KEY   = CFG.GOOGLE_MAPS_API_KEY;
  const sb = (SUPABASE_URL && SUPABASE_ANON) ? supabase.createClient(SUPABASE_URL, SUPABASE_ANON) : null;
  const EDGE_URL = (SUPABASE_URL || '') + '/functions/v1/create-checkout-session';

  // ====== CATEGORIE: MODALE ======
  const btn = document.getElementById('categorieBtn');
  const wrap = document.getElementById('catBadges');
  const modal = document.createElement('div');
  modal.className='modal';
  Object.assign(modal.style,{display:'none',position:'fixed',inset:'0',background:'rgba(0,0,0,.45)',alignItems:'center',justifyContent:'center',padding:'16px'});
  modal.innerHTML = '<div style="background:#0f1c2d;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:16px;min-width:280px;max-width:900px">\
    <h3 style="margin:0 0 6px">Scegli categorie (multi)</h3>\
    <div id="chipsModal" style="display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 12px">\
      '+['Musica','Food & Drink','Nightlife','Cultura/Spettacolo','Famiglie & Bambini','Sport','Sagre & Fiere','Mercatini']
        .map(c=>'<div class="chip" data-cat="'+c+'" style="background:#17304d;border:1px solid #2e6e8f;color:#d7f2ff;border-radius:28px;padding:10px 18px;font-weight:700;cursor:pointer;user-select:none">'+c+'</div>').join('')+'\
    </div>\
    <div class="actions" style="display:flex;gap:8px;justify-content:flex-end">\
      <button class="btn primary" id="catOk" type="button">Conferma</button>\
      <button class="btn secondary" id="catClear" type="button">Azzera</button>\
    </div>\
  </div>';
  document.body.appendChild(modal);

  function renderCats(cats){ wrap.innerHTML=''; cats.forEach(c=>{ const b=document.createElement('span'); b.className='badge'; b.textContent=c; wrap.appendChild(b); }); }
  let cats=[];
  btn.addEventListener('click', ()=>{ modal.style.display='flex'; document.body.style.overflow='hidden'; });
  modal.addEventListener('click', e=>{ if(e.target===modal){ modal.style.display='none'; document.body.style.overflow='auto'; }});
  modal.addEventListener('click', e=>{
    if(e.target.classList.contains('chip')){
      e.target.classList.toggle('active');
      if(e.target.classList.contains('active')){ e.target.style.background='#22b3f0'; e.target.style.color='#081421'; e.target.style.borderColor='#22b3f0'; }
      else { e.target.style.background='#17304d'; e.target.style.color='#d7f2ff'; e.target.style.borderColor='#2e6e8f'; }
    }
  });
  modal.querySelector('#catOk').addEventListener('click', ()=>{
    cats = Array.prototype.slice.call(modal.querySelectorAll('.chip.active')).map(ch=>ch.getAttribute('data-cat'));
    renderCats(cats); modal.style.display='none'; document.body.style.overflow='auto';
  });
  modal.querySelector('#catClear').addEventListener('click', ()=>{
    cats=[]; renderCats(cats);
    Array.prototype.forEach.call(modal.querySelectorAll('.chip'), ch=>{ ch.classList.remove('active'); ch.style.background='#17304d'; ch.style.color='#d7f2ff'; ch.style.borderColor='#2e6e8f'; });
  });

  // ====== CONTATTI ======
  const wrapC = document.getElementById('contattiWrap');
  document.getElementById('addContact').addEventListener('click', ()=>{
    const d=document.createElement('div'); d.className='grid contact';
    d.innerHTML = '<div><label>Nome referente</label><input class="ref_name" placeholder="Es. Laura Bianchi"></div>\
                   <div><label>Numero referente</label><input class="ref_phone" type="tel" placeholder="+39 333 1234567"></div>';
    wrapC.appendChild(d);
  });

  // ====== OCCORRENZE ======
  const wrapO = document.getElementById('occWrap');
  document.getElementById('addOcc').addEventListener('click', ()=>{
    const d=document.createElement('div'); d.className='occ card';
    d.innerHTML = '<div class="grid">\
      <div><label>Luogo/Nome locale*</label><input class="luogo" placeholder="Es. Bar Centrale"></div>\
      <div><label>Indirizzo*</label><input class="indirizzo" placeholder="Via Roma 1"></div>\
    </div><div class="grid">\
      <div><label>Città*</label><input class="citta" placeholder="Es. Torino"></div>\
      <div><label>Data*</label><input class="data" type="date"></div>\
    </div><div class="grid">\
      <div><label>Orario*</label><input class="ora" type="time"></div>\
      <div style="display:flex;align-items:flex-end;justify-content:flex-end"><button type="button" class="btn secondary del-btn">Elimina occorrenza</button></div>\
    </div>';
    wrapO.appendChild(d);
  });
  wrapO.addEventListener('click', e=>{
    if(e.target.classList.contains('del-btn')){
      const box=e.target.closest('.occ'); if(box) box.remove();
    }
  });

  // ====== UTILITY ======
  const err = document.getElementById('err');
  function clean(t){ t=(t||'').trim().replace(/\s+/g,' '); return t? t.charAt(0).toUpperCase()+t.slice(1):''; }

  <script>
/* ... il resto del file ... */

// --- SOSTITUISCI QUESTA FUNZIONE ---
async function geocode(indirizzo, citta){
  const base = 'https://maps.googleapis.com/maps/api/geocode/json';
  const makeUrl = (q, comp) =>
    `${base}?address=${encodeURIComponent(q)}&components=${encodeURIComponent(comp)}&region=it&language=it&key=${GOOGLE_KEY}`;

  // Costruiamo vari tentativi “guidando” Google verso l’Italia e il comune.
  const tentativi = [
    { q: `${indirizzo}, ${citta}`, comp: `locality:${citta}|country:IT` },
    // Per Torino (e altri casi), proviamo anche l’alias inglese
    { q: `${indirizzo}, ${citta}`, comp: `locality:${citta.toLowerCase()==='torino'?'Turin':citta}|country:IT` },
    // Aggiungiamo "Italia" esplicito
    { q: `${indirizzo}, ${citta}, Italia`, comp: `locality:${citta}|country:IT` },
  ];

  let lastStatus = null, lastErr = null;

  for(const t of tentativi){
    try{
      const res = await fetch(makeUrl(t.q, t.comp));
      const j = await res.json();
      if (j.status === 'OK' && j.results?.[0]?.geometry?.location) {
        const g = j.results[0].geometry.location;
        return { lat: g.lat, lng: g.lng };
      } else {
        lastStatus = j.status || 'UNKNOWN';
        lastErr = j.error_message || null;
      }
    }catch(e){
      lastStatus = 'FETCH_ERROR';
      lastErr = e?.message || String(e);
    }
  }

  // Se arriviamo qui, tutti i tentativi sono falliti: alziamo un errore descrittivo.
  const msg = `Geocoding fallito (${lastStatus}${lastErr? ` — ${lastErr}`:''})`;
  throw new Error(msg);
}
// --- FINE FUNZIONE SOSTITUITA ---

/* ... il resto del file ... */
</script>
  // 2° tentativo: aggiunge "Italia"
  res = await fetch(makeUrl(`${indirizzo}, ${citta}, Italia`));
  j = await res.json();
  if (j.status === 'OK' && j.results?.[0]?.geometry?.location) {
    const g = j.results[0].geometry.location;
    return { lat: g.lat, lng: g.lng };
  }

  return null;
}

  function collectOcc(){
    const occ=[];
    Array.prototype.forEach.call(document.querySelectorAll('#occWrap .occ'), function(b){
      const luogo=clean((b.querySelector('.luogo')||{}).value||'');
      const indirizzo=clean((b.querySelector('.indirizzo')||{}).value||'');
      const citta=clean((b.querySelector('.citta')||{}).value||'');
      const data=(b.querySelector('.data')||{}).value||'';
      const ora=(b.querySelector('.ora')||{}).value||'';
      if(!luogo||!indirizzo||!citta||!data||!ora){ occ.push(null); }
      else { occ.push({luogo,indirizzo,citta,data,ora}); }
    });
    if(occ.length===0 || occ.indexOf(null)>-1) return null;
    return occ;
  }

  // ====== ANTEPRIMA ======
  document.getElementById('anteprimaBtn').addEventListener('click', ()=>{
    err.textContent='';
    const titolo=clean(document.getElementById('titolo').value);
    const descr =clean(document.getElementById('descrizione').value);
    const file  =(document.getElementById('locandina').files||[])[0];
    const anyCat=(document.getElementById('catBadges').children.length>0);
    const occ=collectOcc();
    if(!titolo||!descr||!file||!anyCat||!occ){
      err.textContent='Controlla: Titolo*, Descrizione*, Locandina*, almeno 1 Categoria* e completa tutte le occorrenze.'; return;
    }
    document.getElementById('pv_titolo').textContent=titolo;
    document.getElementById('pv_cats').textContent=Array.prototype.map.call(document.getElementById('catBadges').children,b=>b.textContent).join(', ');
    document.getElementById('pv_descr').textContent=descr;
    document.getElementById('pv_occ').textContent=occ.length+' occorrenza/e';
    const ul=document.createElement('ul'); occ.forEach(o=>{ const li=document.createElement('li'); li.textContent=o.data+' ore '+o.ora+' — '+o.luogo+', '+o.indirizzo+', '+o.citta; ul.appendChild(li); });
    const list=document.getElementById('pv_list'); list.innerHTML=''; list.appendChild(ul);
    document.getElementById('preview').style.display='block';
    window.scrollTo({ top: document.getElementById('preview').offsetTop-10, behavior:'smooth'});
  });

  // ====== CONFERMA → STRIPE ======
  document.getElementById('confermaFooterBtn').addEventListener('click', async ()=>{
    try{
      err.textContent='';
      if(!sb){ err.textContent='Configurazione mancante: contatta il supporto.'; return; }

      const titolo=clean(document.getElementById('titolo').value);
      const descr =clean(document.getElementById('descrizione').value);
      const prezzo=(document.getElementById('prezzo').value||'').trim();
      const file  =(document.getElementById('locandina').files||[])[0];
      const occ   =collectOcc();
      const submitter={
        nome:(document.getElementById('sub_nome').value||''),
        cognome:(document.getElementById('sub_cognome').value||''),
        tel:(document.getElementById('sub_tel').value||''),
        email:(document.getElementById('sub_email').value||'')
      };
      if(!titolo||!descr||!file||!occ){ err.textContent='Compila i dati obbligatori e almeno una occorrenza completa.'; return; }

      // 1) Upload locandina su Storage
      const stamp = new Date().toISOString().replace(/[:.]/g,'-');
      const rand = Math.random().toString(36).slice(2,10);
      const fname = `events/${stamp}_${rand}.${file.type==='image/png'?'png':'jpg'}`;
      const up = await sb.storage.from('event-images').upload(fname, file, { upsert:false, contentType:file.type });
      if(up.error){ err.textContent='Upload immagine fallito: '+up.error.message; return; }
      const pub = sb.storage.from('event-images').getPublicUrl(fname);
      const locandina_url = pub?.data?.publicUrl || '';

      // 2) Geocoding per ogni occorrenza
      const occFull=[];
      for(const o of occ){
try{
  const g = await geocode(o.indirizzo, o.citta);
  if(!g){ err.textContent = `Indirizzo non trovato per: ${o.indirizzo}, ${o.citta}`; return; }
  occFull.push({ ...o, lat: g.lat, lng: g.lng });
}catch(geoErr){
  err.textContent = `Errore geocoding per: ${o.indirizzo}, ${o.citta} — ${geoErr.message}`;
  return;
}        occFull.push({ ...o, lat: g.lat, lng: g.lng });
      }

      // 3) Metadati per Stripe
      const metadata = {
        titolo, prezzo, descrizione: descr, locandina_url,
        categorie: JSON.stringify(cats),
        occorrenze: JSON.stringify(occFull),
        submitter: JSON.stringify(submitter),
        partner_code: (document.getElementById('partner_code').value||'')
      };

      const tipo = (occFull.length>1) ? 'multi' : 'single';

      // 4) Crea la sessione Checkout su Supabase Edge
      const resp = await fetch( (SUPABASE_URL + '/functions/v1/create-checkout-session'), {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify({ tipo, metadata })
      });
      const j = await resp.json();
      if(!resp.ok){ throw new Error(j.error || 'Errore creazione checkout'); }

      // 5) Vai al pagamento
      window.location.href = j.url;

    }catch(e){
      err.textContent = 'Errore: '+ (e&&e.message? e.message: String(e));
    }
  });

  document.getElementById('azzeraBtn').addEventListener('click', ()=> location.reload());
})();
</script>
</body>
</html>
