<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pubblica evento — Stasera Qui</title>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/assets/style.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header class="header">
  <div class="logo">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true"><path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/><circle cx="32" cy="24" r="9" fill="#ffffff"/></svg>
    <span class="wordmark">stasera qui</span>
  </div>
</header>

<main class="container">
  <h1>Pubblica il tuo evento</h1>

  <div class="card">
    <h2 style="margin-top:0">Perché pubblicare su Stasera Qui?</h2>
    <ul style="margin-top:6px">
      <li><b>Visibilità immediata</b> sulla mappa dove le persone cercano cosa fare <i>oggi</i>.</li>
      <li><b>Semplice e veloce</b>: 2 minuti per inserire titolo, foto e date.</li>
      <li><b>Pubblico locale</b>: ideale per Pro Loco, circoli, locali, associazioni.</li>
      <li><b>Costi chiari</b> e pagamento online sicuro (quando sarà attivo il gateway).</li>
    </ul>
    <div style="margin-top:10px">
      <a class="btn primary" href="/prezzi-condizioni.html">Vedi prezzi e condizioni</a>
    </div>
  </div>

  <p class="small" style="margin-top:8px">Compila i dati, aggiungi <b>una o più occorrenze</b> (date/luoghi), rivedi l’anteprima e conferma.</p>

  <form id="eventForm" class="card" onsubmit="return false">
    <div class="grid">
      <div>
        <label for="titolo">Titolo evento*</label>
        <input id="titolo" required maxlength="80" placeholder="Es. Aperitivo jazz in piazza">
      </div>
      <div>
        <label for="categorieBtn">Categorie*</label>
        <div class="actions">
          <a class="btn secondary" id="categorieBtn">Scegli categorie</a>
          <div id="catBadges"></div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div>
        <label for="prezzo">Prezzo/Ingresso</label>
        <input id="prezzo" placeholder="Es. Gratis / 10€ con drink">
      </div>
      <div>
        <label for="locandina">Locandina/Foto (JPG/PNG)*</label>
        <input id="locandina" type="file" accept="image/png,image/jpeg" required>
      </div>
    </div>

    <h3 class="block-title">Prenotazione / Contatto</h3>
    <div id="contattiWrap">
      <div class="grid contact">
        <div><label>Nome referente</label><input class="ref_name" placeholder="Es. Laura Bianchi"></div>
        <div><label>Numero referente</label><input class="ref_phone" type="tel" placeholder="+39 333 1234567"></div>
      </div>
    </div>
    <div class="actions" style="margin-top:6px">
      <a class="btn secondary" id="addContact">Aggiungi contatto</a>
    </div>

    <div style="margin-top:10px">
      <label for="descrizione">Descrizione breve (max 400)*</label>
      <textarea id="descrizione" name="descrizione" maxlength="400" required placeholder="Due righe chiare: cosa succede, per chi è, dettagli utili."></textarea>
    </div>

    <h3 class="block-title">Occorrenze</h3>
    <div id="occWrap">
      <div class="occ card">
        <div class="grid">
          <div><label>Luogo/Nome locale*</label><input class="luogo" placeholder="Es. Bar Centrale"></div>
          <div><label>Indirizzo*</label><input class="indirizzo" placeholder="Via Roma 1"></div>
        </div>
        <div class="grid">
          <div><label>Città*</label><input class="citta" placeholder="Es. Torino"></div>
          <div><label>Data*</label><input class="data" type="date"></div>
        </div>
        <div class="grid">
          <div><label>Orario*</label><input class="ora" type="time"></div>
          <div></div>
        </div>
      </div>
    </div>
    <div class="actions" style="margin-top:8px">
      <a class="btn primary" id="addOcc">Aggiungi altra occorrenza</a>
    </div>

    <hr class="divider">

    <h3 class="block-title">Chi inserisce l’annuncio</h3>
    <div class="grid">
      <div><label for="sub_nome">Nome*</label><input id="sub_nome" required></div>
      <div><label for="sub_cognome">Cognome*</label><input id="sub_cognome" required></div>
    </div>
    <div class="grid">
      <div><label for="sub_tel">Telefono*</label><input id="sub_tel" type="tel" required></div>
      <div><label for="sub_email">Email*</label><input id="sub_email" type="email" required></div>
    </div>
    <p class="note">Questi dati rimarranno riservati e non verranno resi pubblici. Li useremo solo per contattarti in caso di chiarimenti sull’annuncio.</p>

    <div style="margin-top:8px">
      <label for="partner_code">Codice partner</label>
      <input id="partner_code" placeholder="Se hai un codice partner, inseriscilo qui">
      <p class="small">Se sei stato contattato da un partner “Stasera Qui”, inserisci nella casella di testo qui sopra il suo codice identificativo a 6 cifre.</p>
    </div>

    <div class="footer-actions">
      <a class="btn primary" id="anteprimaBtn">Rivedi anteprima</a>
      <a class="btn primary" id="confermaFooterBtn">Conferma pubblicazione evento</a>
      <a class="btn secondary" id="azzeraBtn" onclick="location.reload()">Azzera tutto</a>
    </div>
    <div id="err" class="err"></div>
  </form>

  <div id="preview" class="card" style="display:none">
    <h3>Anteprima</h3>
    <div class="small">
      <div><b>Titolo:</b> <span id="pv_titolo"></span></div>
      <div><b>Categorie:</b> <span id="pv_cats"></span></div>
    </div>
    <p id="pv_descr" style="margin-top:8px"></p>
    <div><b class="small">Occorrenze:</b> <span id="pv_occ"></span></div>
    <div id="pv_list" style="margin-top:6px"></div>
  </div>

  <p class="small" style="margin-top:16px">In caso di dubbi o problemi durante la pubblicazione di un evento, scrivi a: <a href="mailto:eventi@staseraqui.it">eventi@staseraqui.it</a></p>
</main>

<footer class="page-footer"><a href="/index.html" class="btn">← Torna alla mappa</a></footer>

<script src="/assets/config.js"></script>
<script>
const $ = s => document.querySelector(s);

// categorie popup
(function initCategorie(){
  const btn = document.getElementById('categorieBtn'); if(!btn) return;
  const wrap = document.getElementById('catBadges');
  const modal = document.createElement('div');
  modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:flex-end;justify-content:center;z-index:50';
  modal.innerHTML = `
    <div style="background:#0f1c2d;border:1px solid rgba(255,255,255,.12);border-top-left-radius:16px;border-top-right-radius:16px;padding:16px;width:100%;max-width:1000px">
      <h3 style="margin:0 0 6px">Scegli categorie (multi)</h3>
      <div id="chipsModal" style="display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 12px">
        ${['Musica','Food & Drink','Nightlife','Cultura/Spettacolo','Famiglie & Bambini','Sport','Sagre & Fiere','Mercatini'].map(c => `<div class="chip" data-cat="${c}" style="background:#17304d;border:1px solid #2e6e8f;color:#d7f2ff;border-radius:28px;padding:10px 18px;font-weight:700;cursor:pointer;user-select:none">${c}</div>`).join('')}
      </div>
      <div class="actions">
        <a class="btn primary" id="catOk">Conferma</a>
        <a class="btn secondary" id="catClear">Azzera</a>
      </div>
    </div>`;
  document.body.appendChild(modal);
  function renderCats(cats){ wrap.innerHTML=''; cats.forEach(c => { const b=document.createElement('span'); b.className='badge'; b.textContent=c; wrap.appendChild(b); }); }
  let cats = [];
  btn.addEventListener('click', ()=>{ modal.style.display='flex'; });
  modal.addEventListener('click', e=>{ if(e.target===modal) modal.style.display='none'; });
  modal.addEventListener('click', e=>{
    if(e.target.classList.contains('chip')){
      e.target.classList.toggle('active');
      if(e.target.classList.contains('active')){ e.target.style.background='#22b3f0'; e.target.style.color='#081421'; e.target.style.borderColor='#22b3f0'; }
      else { e.target.style.background='#17304d'; e.target.style.color='#d7f2ff'; e.target.style.borderColor='#2e6e8f'; }
    }
  });
  modal.querySelector('#catOk').addEventListener('click', ()=>{
    cats = [...modal.querySelectorAll('.chip.active')].map(ch=>ch.dataset.cat);
    renderCats(cats); modal.style.display='none';
  });
  modal.querySelector('#catClear').addEventListener('click', ()=>{
    cats = []; renderCats(cats); modal.querySelectorAll('.chip').forEach(ch => ch.classList.remove('active'));
  });
})();

// contatti
(function initContatti(){
  const wrap = document.getElementById('contattiWrap');
  const addBtn = document.getElementById('addContact');
  function addContactRow(){
    const d=document.createElement('div');
    d.className='grid contact';
    d.innerHTML = `<div><label>Nome referente</label><input class="ref_name" placeholder="Es. Laura Bianchi"></div>
                   <div><label>Numero referente</label><input class="ref_phone" type="tel" placeholder="+39 333 1234567"></div>`;
    wrap.appendChild(d);
  }
  addBtn.addEventListener('click', addContactRow);
})();

// occorrenze
(function initOccorrenze(){
  const wrap = document.getElementById('occWrap');
  function occTpl(){
    return `<div class="occ card">
      <div class="grid">
        <div><label>Luogo/Nome locale*</label><input class="luogo" placeholder="Es. Bar Centrale"></div>
        <div><label>Indirizzo*</label><input class="indirizzo" placeholder="Via Roma 1"></div>
      </div>
      <div class="grid">
        <div><label>Città*</label><input class="citta" placeholder="Es. Torino"></div>
        <div><label>Data*</label><input class="data" type="date"></div>
      </div>
      <div class="grid">
        <div><label>Orario*</label><input class="ora" type="time"></div>
        <div style="display:flex;align-items:flex-end;justify-content:flex-end">
          <button type="button" class="del-btn">Elimina occorrenza</button>
        </div>
      </div>
    </div>`;
  }
  document.getElementById('addOcc').addEventListener('click', ()=>{
    const d=document.createElement('div'); d.innerHTML=occTpl(); wrap.appendChild(d.firstElementChild);
  });
  wrap.addEventListener('click', e=>{
    if(e.target.classList.contains('del-btn')){
      const box = e.target.closest('.occ'); if(box) box.remove();
    }
  });
})();

// anteprima
(function initPreview(){
  const err = document.getElementById('err');
  function clean(t){ t=(t||'').trim().replace(/\s+/g,' '); return t? t.charAt(0).toUpperCase()+t.slice(1):''; }
  function collectOcc(){
    const occ = [];
    document.querySelectorAll('#occWrap .occ').forEach(b=>{
      const luogo=clean(b.querySelector('.luogo').value);
      const indirizzo=clean(b.querySelector('.indirizzo').value);
      const citta=clean(b.querySelector('.citta').value);
      const data=b.querySelector('.data').value;
      const ora=b.querySelector('.ora').value;
      if(!luogo||!indirizzo||!citta||!data||!ora){ occ.push(null); }
      else { occ.push({luogo,indirizzo,citta,data,ora}); }
    });
    if(occ.length===0 || occ.includes(null)) return null;
    return occ;
  }
  function validate(){
    err.textContent='';
    const titolo = clean(document.getElementById('titolo').value);
    const descr  = clean(document.getElementById('descrizione').value);
    const file   = document.getElementById('locandina').files[0];
    const anyCat = (document.getElementById('catBadges').children.length>0);
    if(!titolo || !descr || !file || !anyCat){ err.textContent='Controlla: Titolo*, Descrizione*, Locandina*, almeno 1 Categoria*.'; return null; }
    if(file && file.size>5*1024*1024){ err.textContent='Immagine troppo pesante (>5MB).'; return null; }
    const occ = collectOcc(); if(!occ){ err.textContent='Completa tutti i campi delle occorrenze. Usa “Elimina occorrenza” per quelle superflue.'; return null; }
    return { titolo, descr, occ };
  }
  document.getElementById('anteprimaBtn').addEventListener('click', ()=>{
    const data = validate(); if(!data) return;
    document.getElementById('pv_titolo').textContent = data.titolo;
    document.getElementById('pv_cats').textContent   = [...document.getElementById('catBadges').children].map(b=>b.textContent).join(', ');
    document.getElementById('pv_descr').textContent  = data.descr;
    document.getElementById('pv_occ').textContent    = `${data.occ.length} occorrenza/e`;
    const ul = document.createElement('ul'); ul.style.marginTop='6px';
    data.occ.forEach(o=>{ const li=document.createElement('li'); li.textContent=`${o.data} ore ${o.ora} — ${o.luogo}, ${o.indirizzo}, ${o.citta}`; ul.appendChild(li); });
    const list = document.getElementById('pv_list'); list.innerHTML=''; list.appendChild(ul);
    document.getElementById('preview').style.display='block';
    window.scrollTo({ top: document.getElementById('preview').offsetTop-10, behavior:'smooth'});
  });
})();

// invio via email (testo professionale, niente JSON)
(function initSubmit(){
  function clean(t){ return (t||'').trim(); }
  function collect(){
    const payload = {
      titolo: clean(document.getElementById('titolo').value),
      prezzo: clean(document.getElementById('prezzo').value),
      descr : clean(document.getElementById('descrizione').value),
      cats  : [...document.getElementById('catBadges').children].map(b=>b.textContent),
      contatti: [...document.querySelectorAll('#contattiWrap .contact')].map(row=>({
        name: clean(row.querySelector('.ref_name')?.value||''),
        phone: clean(row.querySelector('.ref_phone')?.value||'')
      })).filter(x=>x.name||x.phone),
      occ: [...document.querySelectorAll('#occWrap .occ')].map(b=>({
        luogo: clean(b.querySelector('.luogo')?.value||''),
        indirizzo: clean(b.querySelector('.indirizzo')?.value||''),
        citta: clean(b.querySelector('.citta')?.value||''),
        data: b.querySelector('.data')?.value||'',
        ora: b.querySelector('.ora')?.value||''
      })),
      submitter: {
        nome: clean(document.getElementById('sub_nome').value),
        cognome: clean(document.getElementById('sub_cognome').value),
        tel: clean(document.getElementById('sub_tel').value),
        email: clean(document.getElementById('sub_email').value)
      },
      partner: clean(document.getElementById('partner_code').value),
      created_at: new Date()
    };
    return payload;
  }
  function formatEmail(payload){
    const dt = payload.created_at;
    const pad = n=>String(n).padStart(2,'0');
    const when = `${pad(dt.getDate())}/${pad(dt.getMonth()+1)}/${dt.getFullYear()} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
    const occLines = payload.occ.map(o=>`- ${o.data} ore ${o.ora} — ${o.luogo}, ${o.indirizzo}, ${o.citta}`).join('\n') || '—';
    const contLines = (payload.contatti.length? payload.contatti.map(c=>`- ${c.name} — ${c.phone}`).join('\n') : '—');
    const cats = payload.cats.join(', ');
    const lines = [
      'Stasera Qui — Nuovo evento',
      '',
      '[DATI EVENTO]',
      `Titolo: ${payload.titolo}`,
      `Categorie: ${cats}`,
      `Prezzo/Ingresso: ${payload.prezzo ? payload.prezzo : ""}`,
      '',
      'Descrizione:',
      payload.descr,
      '',
      '[OCCORRENZE]',
      occLines,
      '',
      '[CONTATTI REFERENTI]',
      contLines,
      '',
      '[DATI DI CHI COMPILA]',
      `Nome: ${payload.submitter.nome} ${payload.submitter.cognome}`,
      `Telefono: ${payload.submitter.tel}`,
      `Email: ${payload.submitter.email}`,
      `Codice partner: ${payload.partner ? payload.partner : ""}`,
      `Data invio: ${when}`
    ];
    const body = encodeURIComponent(lines.join('\n'));
    const subj = encodeURIComponent(`Nuovo evento — ${payload.titolo}`);
    const to = 'eventi@staseraqui.it';
    const cc = payload.submitter.email ? `&cc=${encodeURIComponent(payload.submitter.email)}` : '';
    return `mailto:${to}?subject=${subj}${cc}&body=${body}`;
  }
  document.getElementById('confermaFooterBtn').addEventListener('click', ()=>{
    const p = collect();
    if(!p.titolo || !p.descr || !p.cats.length || !p.occ.length){
      document.getElementById('err').textContent = "Compila tutti i campi obbligatori e almeno una occorrenza."; return;
    }
    window.location.href = formatEmail(p);
  });
})();
</script>
</body>
</html>
