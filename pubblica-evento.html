<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pubblica evento — Stasera Qui</title>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="assets/style.css">
<style>.modal{z-index:999999!important}</style>
</head>
<body>
<header class="header">
  <div class="logo">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true"><path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/><circle cx="32" cy="24" r="9" fill="#ffffff"/></svg>
    <span class="wordmark">stasera qui</span>
  </div>
</header>

<main class="container">
  <h1>Pubblica il tuo evento</h1>

  <div class="card">
    <h2 style="margin-top:0">Perché pubblicare su Stasera Qui?</h2>
    <ul style="margin-top:6px">
      <li><b>Visibilità immediata</b> sulla mappa dove le persone cercano cosa fare <i>oggi</i>.</li>
      <li><b>Semplice e veloce</b>: 2 minuti per inserire titolo, foto e date.</li>
      <li><b>Pubblico locale</b>: ideale per Pro Loco, circoli, locali, associazioni.</li>
      <li><b>Costi chiari</b> e pagamento online sicuro (in arrivo).</li>
    </ul>
    <div style="margin-top:10px">
      <a class="btn primary" href="prezzi-condizioni.html">Vedi prezzi e condizioni</a>
    </div>
  </div>

  <form id="eventForm" class="card" onsubmit="return false">
    <div class="grid">
      <div>
        <label for="titolo">Titolo evento*</label>
        <input id="titolo" required maxlength="80" placeholder="Es. Aperitivo jazz in piazza">
      </div>
      <div>
        <label for="categorieBtn">Categorie*</label><br>
        <button class="btn secondary" id="categorieBtn" type="button">Scegli categorie</button>
        <div id="catBadges"></div>
      </div>
    </div>

    <div class="grid">
      <div>
        <label for="prezzo">Prezzo/Ingresso</label>
        <input id="prezzo" placeholder="Es. Gratis / 10€ con drink">
      </div>
      <div>
        <label for="locandina">Locandina/Foto (JPG/PNG)*</label>
        <input id="locandina" type="file" accept="image/png,image/jpeg" required>
      </div>
    </div>

    <h3 class="block-title">Prenotazione / Contatto</h3>
    <div id="contattiWrap">
      <div class="grid contact">
        <div><label>Nome referente</label><input class="ref_name" placeholder="Es. Laura Bianchi"></div>
        <div><label>Numero referente</label><input class="ref_phone" type="tel" placeholder="+39 333 1234567"></div>
      </div>
    </div>
    <div style="margin-top:6px">
      <button class="btn secondary" id="addContact" type="button">Aggiungi contatto</button>
    </div>

    <div style="margin-top:10px">
      <label for="descrizione">Descrizione breve (max 400)*</label>
      <textarea id="descrizione" name="descrizione" maxlength="400" required placeholder="Due righe chiare: cosa succede, per chi è, dettagli utili." style="min-height:240px"></textarea>
    </div>

    <h3 class="block-title">Occorrenze</h3>
    <div id="occWrap">
      <div class="occ card">
        <div class="grid">
          <div><label>Luogo/Nome locale*</label><input class="luogo" placeholder="Es. Bar Centrale"></div>
          <div><label>Indirizzo*</label><input class="indirizzo" placeholder="Via Roma 1"></div>
        </div>
        <div class="grid">
          <div><label>Città*</label><input class="citta" placeholder="Es. Torino"></div>
          <div><label>Data*</label><input class="data" type="date"></div>
        </div>
        <div class="grid">
          <div><label>Orario*</label><input class="ora" type="time"></div>
          <div></div>
        </div>
      </div>
    </div>
    <div style="margin-top:8px">
      <button class="btn primary" id="addOcc" type="button">Aggiungi altra occorrenza</button>
    </div>

    <hr class="divider">

    <h3 class="block-title">Chi inserisce l’annuncio</h3>
    <div class="grid">
      <div><label for="sub_nome">Nome*</label><input id="sub_nome" required></div>
      <div><label for="sub_cognome">Cognome*</label><input id="sub_cognome" required></div>
    </div>
    <div class="grid">
      <div><label for="sub_tel">Telefono*</label><input id="sub_tel" type="tel" required></div>
      <div><label for="sub_email">Email*</label><input id="sub_email" type="email" required></div>
    </div>
    <p class="note">Questi dati rimarranno riservati e non verranno resi pubblici. Li useremo solo per contattarti in caso di chiarimenti sull’annuncio.</p>

    <div style="margin-top:8px">
      <label for="partner_code">Codice partner</label>
      <input id="partner_code" placeholder="Se hai un codice partner, inseriscilo qui">
      <p class="small">Se sei stato contattato da un partner “Stasera Qui”, inserisci nella casella di testo qui sopra il suo codice identificativo a 6 cifre.</p>
    </div>

    <div class="footer-actions">
      <button class="btn primary" id="anteprimaBtn" type="button">Rivedi anteprima</button>
      <button class="btn primary" id="confermaFooterBtn" type="button">Conferma pubblicazione evento</button>
      <button class="btn secondary" id="azzeraBtn" type="button">Azzera tutto</button>
    </div>
    <div id="err" class="err"></div>
  </form>

  <div id="preview" class="card" style="display:none">
    <h3>Anteprima</h3>
    <div class="small">
      <div><b>Titolo:</b> <span id="pv_titolo"></span></div>
      <div><b>Categorie:</b> <span id="pv_cats"></span></div>
    </div>
    <p id="pv_descr" style="margin-top:8px"></p>
    <div><b class="small">Occorrenze:</b> <span id="pv_occ"></span></div>
    <div id="pv_list" style="margin-top:6px"></div>
  </div>

  <p class="small" style="margin-top:16px">In caso di dubbi o problemi durante la pubblicazione di un evento, scrivi a: <a href="mailto:eventi@staseraqui.it">eventi@staseraqui.it</a></p>
</main>

<footer class="page-footer"><a href="index.html" class="btn">← Torna alla mappa</a></footer>

<script>
(function(){
  // URL della funzione Supabase (già personalizzato per te)
  const fnURL = 'https://rubdzlnolxcgpjklfggk.supabase.co/functions/v1/create-checkout-session';

  const occWrap = document.getElementById('occWrap');
  const addOccBtn = document.getElementById('addOcc');
  const anteprimaBtn = document.getElementById('anteprima');
  const pagaBtn = document.getElementById('pagaPubblica');
  const azzeraBtn = document.getElementById('azzera');
  const errBox = document.getElementById('err');
  const previewBox = document.getElementById('preview');

  if (addOccBtn) addOccBtn.addEventListener('click', function(e){
    e.preventDefault();
    const base = document.querySelector('.occ');
    const d = document.createElement('div');
    d.className = 'grid occ';
    d.innerHTML = base.innerHTML;
    // pulisci i valori della nuova occorrenza
    d.querySelectorAll('input').forEach(i => i.value = '');
    occWrap.appendChild(d);
  });

  function clean(s){ return (s||'').trim().replace(/\s+/g,' '); }

  function gather(){
    const cats = Array.from(document.getElementById('categorie').selectedOptions).map(o=>o.value);
    const occ = Array.from(document.querySelectorAll('.occ')).map(b=>({
      luogo: clean(b.querySelector('.luogo').value),
      indirizzo: clean(b.querySelector('.indirizzo').value),
      citta: clean(b.querySelector('.citta').value),
      data: b.querySelector('.data').value,
      ora: b.querySelector('.ora').value,
      lat: parseFloat(b.querySelector('.lat').value),
      lng: parseFloat(b.querySelector('.lng').value)
    }));
    return {
      titolo: clean(document.getElementById('titolo').value),
      categorie: cats,
      prezzo: clean(document.getElementById('prezzo').value),
      descrizione: clean(document.getElementById('descrizione').value),
      locandina_url: clean(document.getElementById('locandinaUrl').value),
      occorrenze: occ,
      submitter: {
        nome: clean(document.getElementById('nome').value),
        cognome: clean(document.getElementById('cognome').value),
        email: clean(document.getElementById('email').value),
        tel: clean(document.getElementById('tel').value)
      },
      partner_code: clean(document.getElementById('codicePartner').value)
    };
  }

  function validate(p){
    const e = [];
    if(!p.titolo) e.push('Titolo obbligatorio');
    if(!p.descrizione) e.push('Descrizione obbligatoria');
    if(!p.locandina_url || !/^https?:\/\//.test(p.locandina_url)) e.push('URL immagine non valido');
    if(!p.categorie || p.categorie.length===0) e.push('Seleziona almeno una categoria');
    if(!p.occorrenze || p.occorrenze.length===0) e.push('Aggiungi almeno una occorrenza');
    p.occorrenze.forEach((o,i)=>{
      if(!(o.luogo && o.indirizzo && o.citta && o.data && o.ora)) e.push('Occorrenza '+(i+1)+': completa tutti i campi');
      if(isNaN(o.lat) || isNaN(o.lng)) e.push('Occorrenza '+(i+1)+': inserisci latitudine/longitudine');
    });
    if(!p.submitter.nome || !p.submitter.cognome || !p.submitter.email || !p.submitter.tel) e.push('Completa i dati del referente');
    if(p.descrizione.length>400) e.push('Descrizione oltre 400 caratteri');
    if(p.occorrenze.length>4) e.push('Massimo 4 occorrenze per evento multiplo');
    return e;
  }

  if (anteprimaBtn) anteprimaBtn.addEventListener('click', function(){
    const p = gather(); const errs = validate(p);
    if(errs.length){ errBox.textContent = errs.join(' — '); return; }
    previewBox.style.display='block';
    previewBox.innerHTML = '<h3>Anteprima</h3>'
      + '<p><b>'+p.titolo+'</b></p>'
      + '<p>'+p.descrizione+'</p>'
      + '<p class="small">Categorie: '+p.categorie.join(', ')+'</p>'
      + '<ul>'+p.occorrenze.map(o=>'<li>'+o.data+' '+o.ora+' — '+o.luogo+', '+o.indirizzo+', '+o.citta+' ('+o.lat+', '+o.lng+')</li>').join('')+'</ul>';
  });

  if (pagaBtn) pagaBtn.addEventListener('click', async function(){
    const p = gather(); const errs = validate(p);
    if(errs.length){ errBox.textContent = errs.join(' — '); return; }
    try{
      const res = await fetch(fnURL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(p)
      });
      if(!res.ok){ const t=await res.text(); throw new Error(t||('HTTP '+res.status)); }
      const data = await res.json();
      if(!data.url) throw new Error('URL checkout non ricevuto');
      window.location.href = data.url;
    }catch(err){ errBox.textContent = 'Errore: '+err.message; }
  });

  if (azzeraBtn) azzeraBtn.addEventListener('click', ()=> location.reload());
})();
</script>
</body>
</html>
