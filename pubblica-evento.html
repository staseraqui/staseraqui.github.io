<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Pubblica evento ‚Äî Stasera Qui</title>
  <link rel="canonical" href="https://www.staseraqui.it/pubblica-evento.html">
  <meta name="description" content="Inserisci titolo, foto o sito e date: geolocalizziamo il tuo evento sulla mappa. Pagamento sicuro con Stripe e pubblicazione immediata.">
  <meta name="robots" content="index,follow">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Pubblica evento ‚Äî Stasera Qui">
  <meta property="og:description" content="Pubblica in 2 minuti. Pagamento con Stripe e visibilit√† immediata sulla mappa.">
  <meta property="og:url" content="https://www.staseraqui.it/pubblica-evento.html">
  <meta property="og:site_name" content="Stasera Qui">
  <meta property="og:image" content="https://www.staseraqui.it/assets/social/share-default.jpg">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Pubblica evento ‚Äî Stasera Qui">
  <meta name="twitter:description" content="Pubblica in 2 minuti. Pagamento con Stripe e visibilit√† immediata sulla mappa.">
  <meta name="twitter:image" content="https://www.staseraqui.it/assets/social/share-default.jpg">

  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/style.css?v=24">
  <style>
    .modal{z-index:999999!important}
    /* Barra carrello */
    #cartBar{position:sticky;top:0;z-index:30;background:#0f1c2d;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px;margin-bottom:12px;display:none}
    #cartList{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 0}
    .cartItem{background:#17304d;color:#d7f2ff;border:1px solid #2e6e8f;border-radius:10px;padding:6px 10px;display:flex;gap:8px;align-items:center}
    .cartItem b{white-space:nowrap;max-width:280px;overflow:hidden;text-overflow:ellipsis}
    .cartItem button{padding:6px 8px}
    .help-inline{font-size:12px;color:#b8c2ce;margin-top:4px}
    .smallmuted{font-size:12px;color:#9fb0c4}
    /* badge sotto-categorie leggermente ‚Äúlight‚Äù */
    .badge.sub{background:#12263a;border-color:#3b7aa3;opacity:.95}
    /* modale categorie */
    .cat-grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:720px){ .cat-grid{grid-template-columns:1fr 2fr} }
    .cat-box, .subcat-box{background:#0b1726;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:10px;min-height:120px}
    .chip{background:#17304d;border:1px solid #2e6e8f;color:#d7f2ff;border-radius:28px;padding:8px 14px;font-weight:700;cursor:pointer;user-select:none}
    .chip.active{background:#22b3f0;color:#081421;border-color:#22b3f0}
    .chip.group{cursor:default;border-style:dashed;opacity:.8;font-weight:700}
  </style>

  <!-- Config chiavi + tassonomia -->
  <script src="assets/app-config.js?v=3"></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- Dati strutturati -->
  <script type="application/ld+json">
  {"@context":"https://schema.org","@type":"Organization","name":"Stasera Qui","url":"https://www.staseraqui.it/","logo":"https://www.staseraqui.it/favicon.ico","sameAs":[]}
  </script>
  <script type="application/ld+json">
  {"@context":"https://schema.org","@type":"WebSite","name":"Stasera Qui","url":"https://www.staseraqui.it/","potentialAction":{"@type":"SearchAction","target":"https://www.staseraqui.it/?q={search_term_string}","query-input":"required name=search_term_string"}}
  </script>

  <!-- ‚úÖ Cookie banner / GA dopo consenso -->
  <script src="assets/cookie-consent.js" defer></script>
</head>
<body>

<header class="header">
  <a href="index.html" class="logo" aria-label="Stasera Qui - home">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true">
      <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/>
      <circle cx="32" cy="24" r="9" fill="#ffffff"/>
    </svg>
    <span class="wordmark">stasera qui</span>
  </a>
</header>

<main class="container">
  <h1>Pubblica il tuo evento</h1>

  <!-- BARRA CARRELLO -->
  <div id="cartBar">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
      <div><b>Carrello eventi:</b> <span id="cartCount">0</span></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn secondary" id="cartClear" type="button">Svuota carrello</button>
        <button class="btn primary" id="goCheckout" type="button">Vai al pagamento</button>
      </div>
    </div>
    <div id="cartList"></div>
  </div>

  <div class="card">
    <h2 style="margin-top:0">Perch√© pubblicare su Stasera Qui?</h2>
    <ul style="margin-top:6px">
      <li><b>Visibilit√† immediata</b> sulla mappa dove le persone cercano cosa fare <i>oggi</i>.</li>
      <li><b>Semplice e veloce</b>: 2 minuti per inserire titolo, foto o sito e date.</li>
      <li><b>Pubblico locale</b>: ideale per Pro Loco, circoli, locali, associazioni.</li>
      <li><b>Pagamento online sicuro</b> con Stripe.</li>
    </ul>
    <div style="margin-top:10px">
      <a class="btn primary" href="prezzi-condizioni.html">Vedi prezzi e condizioni</a>
    </div>
  </div>

  <form id="eventForm" class="card" onsubmit="return false">
    <div class="grid">
      <div>
        <label for="titolo">Titolo evento*</label>
        <input id="titolo" required maxlength="80" placeholder="Es. Aperitivo jazz in piazza">
      </div>
      <div>
        <label for="categorieBtn">Categorie*</label><br>
        <button class="btn secondary" id="categorieBtn" type="button">Scegli categorie</button>
        <div id="catBadges"></div>
      </div>
    </div>

    <div class="grid">
      <div>
        <label for="prezzo">Prezzo/Ingresso</label>
        <input id="prezzo" placeholder="Es. Gratis / 10‚Ç¨ con drink">
      </div>
      <div>
        <label for="locandina">Locandina/Foto (JPG/PNG/WebP)</label>
        <input id="locandina" type="file" accept="image/png,image/jpeg,image/webp">
        <div class="help-inline">Carica un‚Äôimmagine (JPG/PNG/WebP) <b>oppure</b> inserisci il <b>sito ufficiale</b> qui sotto.</div>
      </div>
    </div>

    <!-- üîó SITO WEB (opzionale, alternativo alla locandina) -->
    <div class="grid">
      <div>
        <label for="sito_web">Sito ufficiale dell‚Äôevento (opzionale)</label>
        <input id="sito_web" type="url" placeholder="Es. https://www.miosito.it/evento">
        <div class="help-inline">Se non carichi la locandina, inserisci qui il link: sar√† visibile nel popup dell‚Äôevento.</div>
      </div>
      <div></div>
    </div>

    <!-- CONTATTI -->
    <h3 class="block-title">Prenotazione / Contatto</h3>
    <div id="contattiWrap">
      <div class="grid contact">
        <div><label>Nome referente</label><input class="ref_name" placeholder="Es. Laura Bianchi"></div>
        <div><label>Numero referente</label><input class="ref_phone" type="tel" placeholder="+39 333 1234567"></div>
      </div>
    </div>
    <div style="margin-top:6px">
      <button class="btn secondary" id="addContact" type="button">Aggiungi contatto</button>
    </div>

    <!-- DESCRIZIONE -->
    <div style="margin-top:10px">
      <label for="descrizione">Descrizione breve (max 400)*</label>
      <textarea id="descrizione" maxlength="400" required placeholder="Due righe chiare: cosa succede, per chi √®, dettagli utili." style="min-height:240px"></textarea>
    </div>

    <h3 class="block-title" style="display:flex;justify-content:space-between;align-items:center">
      <span>Occorrenze</span>
      <a class="btn secondary" id="howBtn" href="prezzi-condizioni.html#istruzioni" target="_blank" rel="noopener">Cos‚Äô√® evento singolo/multiplo?</a>
    </h3>

    <!-- Occorrenza #1 -->
    <div id="occWrap">
      <div class="occ card">
        <div class="grid">
          <div><label>Luogo/Nome locale*</label><input class="luogo" placeholder="Es. Bar Centrale / Centro storico"></div>
          <div>
            <label>Indirizzo <span class="smallmuted">(opzionale se evento diffuso)</span></label>
            <input class="indirizzo" placeholder="Via Roma 1">
          </div>
        </div>
        <div class="grid">
          <div>
            <label>Citt√†*</label>
            <input class="citta" placeholder="Es. Alba">
            <label class="smallmuted" style="display:block;margin-top:6px">
              <input type="checkbox" class="diffuso"> Evento diffuso in citt√† (senza indirizzo preciso)
            </label>
          </div>
          <div>
            <label>Dal*</label>
            <input class="dal" type="date">
            <div class="help-inline">Se l‚Äôevento dura pi√π giorni, compila anche ‚ÄúAl‚Äù.</div>
          </div>
        </div>
        <div class="grid">
          <div>
            <label>Al (facoltativo)</label>
            <input class="al" type="date">
          </div>
          <div>
            <label>Orario</label>
            <select class="sched_mode">
              <option value="none" selected>Nessun orario (tutto il giorno)</option>
              <option value="single">Stessa fascia per tutte le date</option>
              <option value="split">Feriali vs weekend</option>
            </select>

            <div class="sched_single" style="display:none;margin-top:6px">
              <div class="grid">
                <div><label>Dalle</label><input type="time" class="time_from"></div>
                <div><label>Alle</label><input type="time" class="time_to"></div>
              </div>
            </div>

            <div class="sched_split" style="display:none;margin-top:6px">
              <div class="smallmuted" style="margin-bottom:4px">Default: lun‚Äìven 15:00‚Äì21:00; sab‚Äìdom 10:00‚Äì21:00</div>
              <div class="grid">
                <div><label>Lun‚ÄìVen dalle</label><input type="time" class="wd_from" value="15:00"></div>
                <div><label>Lun‚ÄìVen alle</label><input type="time" class="wd_to" value="21:00"></div>
              </div>
              <div class="grid">
                <div><label>Sab‚ÄìDom dalle</label><input type="time" class="we_from" value="10:00"></div>
                <div><label>Sab‚ÄìDom alle</label><input type="time" class="we_to" value="21:00"></div>
              </div>
            </div>
          </div>
        </div>
      </div> <!-- /.occ -->
    </div>

    <div style="margin-top:8px">
      <button class="btn primary" id="addOcc" type="button">Aggiungi altra occorrenza</button>
    </div>

    <hr class="divider">

    <h3 class="block-title">Chi inserisce l‚Äôannuncio</h3>
    <div class="grid">
      <div><label for="sub_nome">Nome*</label><input id="sub_nome" required></div>
      <div><label for="sub_cognome">Cognome*</label><input id="sub_cognome" required></div>
    </div>
    <div class="grid">
      <div><label for="sub_tel">Telefono*</label><input id="sub_tel" type="tel" required></div>
      <div><label for="sub_email">Email*</label><input id="sub_email" type="email" required></div>
    </div>
    <p class="note">Questi dati rimarranno riservati e non verranno resi pubblici. Li useremo solo per contattarti in caso di chiarimenti sull‚Äôannuncio.</p>

    <div style="margin-top:8px">
      <label for="partner_code">Codice Ambassador</label>
      <input id="partner_code" placeholder="Se hai un codice Ambassador, inseriscilo qui">
      <p class="small">Se sei stato contattato da un Ambassador ‚ÄúStasera Qui‚Äù, inserisci nella casella di testo qui sopra il suo codice identificativo a 6 cifre.</p>
    </div>

    <div class="footer-actions">
      <button class="btn primary"   id="addToCartBtn"     type="button">‚ûï Aggiungi al carrello</button>
      <button class="btn"           id="anteprimaBtn"     type="button">Rivedi anteprima</button>
      <button class="btn secondary" id="azzeraBtn"        type="button">Azzera tutto</button>
    </div>
    <div id="err" class="err"></div>
  </form>

  <div id="preview" class="card" style="display:none">
    <h3>Anteprima</h3>
    <div class="small">
      <div><b>Titolo:</b> <span id="pv_titolo"></span></div>
      <div><b>Categorie:</b> <span id="pv_cats"></span></div>
      <div id="pv_subcats_wrap" style="display:none"><b>Sotto-categorie:</b> <span id="pv_subcats"></span></div>
      <div id="pv_site_wrap" style="display:none"><b>Sito web:</b> <a id="pv_site" href="#" target="_blank" rel="noopener"></a></div>
    </div>
    <p id="pv_descr" style="margin-top:8px"></p>
    <div><b class="small">Occorrenze:</b> <span id="pv_occ"></span></div>
    <div id="pv_list" style="margin-top:6px"></div>
  </div>

  <p class="small" style="margin-top:16px">In caso di dubbi o problemi durante la pubblicazione di un evento, scrivi a: <a href="mailto:eventi@staseraqui.it">eventi@staseraqui.it</a></p>
</main>

<script>
(function(){
  // ====== CONFIG ROBUSTA ======
  const CFG = (typeof window!=='undefined' && window.SQ_CONFIG) ? window.SQ_CONFIG : {};
  const SUPABASE_URL = CFG.SUPABASE_URL || 'https://rubdzlnolxcgpjklfggk.supabase.co';
  const SUPABASE_ANON = CFG.SUPABASE_ANON || '';
  const GOOGLE_KEY   = CFG.GOOGLE_MAPS_API_KEY || '';
  const EDGE_URL = 'https://rubdzlnolxcgpjklfggk.functions.supabase.co/create-checkout-session';

  const sb = (SUPABASE_URL && SUPABASE_ANON && window.supabase)
    ? supabase.createClient(SUPABASE_URL, SUPABASE_ANON)
    : null;

  // ====== TASSONOMIA (da config, con fallback) ======
  const EB_TAXONOMY = (CFG && CFG.EB_TAXONOMY) ? CFG.EB_TAXONOMY : {
    "Musica": ["Rock","Jazz & Blues","Classica","Elettronica","Hip-Hop / Rap","Indie / Alternative","Pop","Metal","Folk / Acustico","Country","Latina","R&B / Soul","DJ / Dance","Cantautori"],
    "Food & Drink": ["Degustazioni","Birra","Vino","Distillati","Street Food","Festival enogastronomici","Corsi di cucina","Cene sociali / Supper club","Caff√® / Tea","Mixology / Cocktail"],
    "Nightlife": ["Discoteca / Club","DJ set","Karaoke","Latin Night","Bar Crawl","Aperitivo","Serata a tema"],
    "Cultura/Spettacolo": ["Teatro","Arti visive / Mostre","Cinema / Proiezioni","Stand-up / Commedia","Danza","Letture / Presentazioni","Opera / Operetta"],
    "Famiglie & Bambini": ["Laboratori","Spettacolo bambini","Letture animate","Giochi / Animazione","Feste di paese","Parchi / Outdoor"],
    "Sport": ["Calcio","Running / Corsa","Ciclismo","Trekking / Escursioni","Fitness / Wellness","Tornei","Arti marziali"],
    "Sagre & Fiere": ["Sagra","Fiera / Festival","Enogastronomia","Festa patronale","Festa della birra","Festa del vino"],
    "Mercatini": ["Antiquariato","Hobbisti / Handmade","Usato / Vintage","Km0 / Prodotti locali","Mercatino di Natale"]
  };
  const EB_ORDER = (CFG && Array.isArray(CFG.EB_CATEGORIES_ORDER) && CFG.EB_CATEGORIES_ORDER.length)
    ? CFG.EB_CATEGORIES_ORDER
    : Object.keys(EB_TAXONOMY);

  // ====== Carica Google Maps JS (Geocoder) ======
  let mapsLoadedPromise = null;
  function loadGoogleMaps(){
    if (window.google && window.google.maps) return Promise.resolve();
    if (mapsLoadedPromise) return mapsLoadedPromise;
    mapsLoadedPromise = new Promise((resolve, reject)=>{
      if(!GOOGLE_KEY){ resolve(); return; } // se manca la key, saltiamo il geocode ma non blocchiamo tutto
      const s = document.createElement('script');
      s.src = 'https://maps.googleapis.com/maps/api/js?key='+encodeURIComponent(GOOGLE_KEY)+'&libraries=places&v=quarterly';
      s.async = true; s.defer = true;
      s.onload = ()=> resolve();
      s.onerror = ()=> resolve(); // NON bloccare il resto della pagina
      document.head.appendChild(s);
    });
    return mapsLoadedPromise;
  }

  // ====== CATEGORIE: MODALE (con sotto-categorie) ======
  const catBtn = document.getElementById('categorieBtn');
  const wrapBadges = document.getElementById('catBadges');

  // stato selezione
  let selCats = [];
  let selSubcats = [];

  function renderBadges(){
    wrapBadges.innerHTML = '';
    selCats.forEach(c=>{
      const b = document.createElement('span');
      b.className = 'badge';
      b.dataset.type = 'cat';
      b.textContent = c;
      wrapBadges.appendChild(b);
    });
    selSubcats.forEach(s=>{
      const b = document.createElement('span');
      b.className = 'badge sub';
      b.dataset.type = 'sub';
      b.textContent = s;
      wrapBadges.appendChild(b);
    });
  }
  function getSelected(type){ // 'cat' | 'sub'
    return Array.prototype.map.call(wrapBadges.querySelectorAll('.badge'+(type==='cat'?':not(.sub)':'.sub')), b=>b.textContent);
  }

  // modal element
  const modal = document.createElement('div');
  modal.className='modal';
  Object.assign(modal.style,{
    display:'none',position:'fixed',inset:'0',background:'rgba(0,0,0,.45)',
    alignItems:'center',justifyContent:'center',padding:'16px'
  });

  const allCatsOrdered = EB_ORDER.slice();
  const allSubByCat = EB_TAXONOMY;

  modal.innerHTML = `
  <div style="background:#0f1c2d;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:16px;min-width:320px;max-width:980px;width:100%">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <h3 style="margin:0">Categorie & sotto-categorie</h3>
      <button class="btn" id="catClose" type="button">Chiudi</button>
    </div>
    <div class="help-inline" style="margin-top:4px">Selezione multipla. Le sotto-categorie sono facoltative.</div>
    <div class="cat-grid" style="margin-top:10px">
      <div class="cat-box">
        <div class="small" style="opacity:.85;margin-bottom:6px"><b>Categorie</b></div>
        <div id="chipsCats" style="display:flex;gap:8px;flex-wrap:wrap"></div>
      </div>
      <div class="subcat-box">
        <div class="small" style="opacity:.85;margin-bottom:6px"><b>Sotto-categorie</b> <span class="smallmuted">(in base alle categorie scelte)</span></div>
        <div id="chipsSubcats" style="display:flex;gap:8px;flex-wrap:wrap;min-height:40px"></div>
      </div>
    </div>
    <div class="actions" style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn secondary" id="catClear" type="button">Azzera</button>
      <button class="btn primary"   id="catOk"    type="button">Conferma</button>
    </div>
  </div>`;

  document.body.appendChild(modal);

  function rebuildCatChips(){
    const box = modal.querySelector('#chipsCats');
    box.innerHTML = allCatsOrdered.map(c=>{
      const active = selCats.includes(c) ? ' active':'';
      return `<div class="chip${active}" data-cat="${c}">${c}</div>`;
    }).join('');
  }
  function rebuildSubcatChips(){
    const box = modal.querySelector('#chipsSubcats');
    // tutte le sub delle categorie selezionate (se nessuna, mostra tutte)
    const set = new Set();
    const srcCats = selCats.length ? selCats : allCatsOrdered;
    srcCats.forEach(c => (allSubByCat[c]||[]).forEach(s=> set.add(s)));
    const subs = Array.from(set).sort((a,b)=>a.localeCompare(b,'it'));
    const html = subs.map(s=>{
      const active = selSubcats.includes(s) ? ' active':'';
      return `<div class="chip${active}" data-sub="${s}">${s}</div>`;
    }).join('');
    box.innerHTML = html || `<div class="chip group">‚Äî nessuna sotto-categoria ‚Äî</div>`;
  }

  function openCatsModal(){
    rebuildCatChips();
    rebuildSubcatChips();
    modal.style.display='flex';
    document.body.style.overflow='hidden';
  }
  function closeCatsModal(){
    modal.style.display='none';
    document.body.style.overflow='auto';
  }

  if (catBtn) catBtn.addEventListener('click', openCatsModal);
  modal.addEventListener('click', e=>{ if(e.target===modal) closeCatsModal(); });
  modal.querySelector('#catClose').addEventListener('click', closeCatsModal);

  // Deleghe click chips
  modal.addEventListener('click', (e)=>{
    const catChip = e.target.closest('.chip[data-cat]');
    const subChip = e.target.closest('.chip[data-sub]');
    if (catChip){
      const c = catChip.getAttribute('data-cat');
      const idx = selCats.indexOf(c);
      if (idx>-1){ selCats.splice(idx,1); catChip.classList.remove('active'); }
      else { selCats.push(c); catChip.classList.add('active'); }
      // appena cambiano le categorie, limiamo le sub non pi√π appartenenti
      selSubcats = selSubcats.filter(s=>{
        // rimane se √® in almeno una delle sub delle cat selezionate
        return selCats.length
          ? selCats.some(cat => (EB_TAXONOMY[cat]||[]).includes(s))
          : true; // se nessuna cat selezionata, lasciamo tutto
      });
      rebuildSubcatChips();
      return;
    }
    if (subChip){
      const s = subChip.getAttribute('data-sub');
      const idx = selSubcats.indexOf(s);
      if (idx>-1){ selSubcats.splice(idx,1); subChip.classList.remove('active'); }
      else { selSubcats.push(s); subChip.classList.add('active'); }
      return;
    }
  });

  modal.querySelector('#catClear').addEventListener('click', ()=>{
    selCats = [];
    selSubcats = [];
    rebuildCatChips();
    rebuildSubcatChips();
  });

  modal.querySelector('#catOk').addEventListener('click', ()=>{
    renderBadges();
    closeCatsModal();
  });

  // ====== CONTATTI ======
  const wrapC = document.getElementById('contattiWrap');
  const addC  = document.getElementById('addContact');
  if (addC) addC.addEventListener('click', ()=>{
    const d=document.createElement('div'); d.className='grid contact';
    d.innerHTML = '<div><label>Nome referente</label><input class="ref_name" placeholder="Es. Laura Bianchi"></div>\
                   <div><label>Numero referente</label><input class="ref_phone" type="tel" placeholder="+39 333 1234567"></div>';
    wrapC.appendChild(d);
  });

  // ====== OCCORRENZE ======
  const wrapO = document.getElementById('occWrap');
  const addO  = document.getElementById('addOcc');
  if (addO) addO.addEventListener('click', ()=>{
    const d=document.createElement('div'); d.className='occ card';
    d.innerHTML = '<div class="grid">\
      <div><label>Luogo/Nome locale*</label><input class="luogo" placeholder="Es. Bar Centrale / Centro storico"></div>\
      <div><label>Indirizzo <span class="smallmuted">(opzionale se evento diffuso)</span></label><input class="indirizzo" placeholder="Via Roma 1"></div>\
    </div><div class="grid">\
      <div>\
        <label>Citt√†*</label><input class="citta" placeholder="Es. Alba">\
        <label class="smallmuted" style="display:block;margin-top:6px"><input type="checkbox" class="diffuso"> Evento diffuso in citt√† (senza indirizzo preciso)</label>\
      </div>\
      <div><label>Dal*</label><input class="dal" type="date"><div class="help-inline">Compila anche ‚ÄúAl‚Äù se dura pi√π giorni</div></div>\
    </div><div class="grid">\
      <div><label>Al (facoltativo)</label><input class="al" type="date"></div>\
      <div>\
        <label>Orario</label>\
        <select class="sched_mode">\
          <option value="none" selected>Nessun orario (tutto il giorno)</option>\
          <option value="single">Stessa fascia per tutte le date</option>\
          <option value="split">Feriali vs weekend</option>\
        </select>\
        <div class="sched_single" style="display:none;margin-top:6px">\
          <div class="grid">\
            <div><label>Dalle</label><input type="time" class="time_from"></div>\
            <div><label>Alle</label><input type="time" class="time_to"></div>\
          </div>\
        </div>\
        <div class="sched_split" style="display:none;margin-top:6px">\
          <div class="smallmuted" style="margin-bottom:4px">Default: lun‚Äìven 15:00‚Äì21:00; sab‚Äìdom 10:00‚Äì21:00</div>\
          <div class="grid">\
            <div><label>Lun‚ÄìVen dalle</label><input type="time" class="wd_from" value="15:00"></div>\
            <div><label>Lun‚ÄìVen alle</label><input type="time" class="wd_to" value="21:00"></div>\
          </div>\
          <div class="grid">\
            <div><label>Sab‚ÄìDom dalle</label><input type="time" class="we_from" value="10:00"></div>\
            <div><label>Sab‚ÄìDom alle</label><input type="time" class="we_to" value="21:00"></div>\
          </div>\
        </div>\
      </div>\
    </div>';
    wrapO.appendChild(d);
  });

  // Delegati: toggle indirizzo vs diffuso + pannelli orari
  wrapO.addEventListener('change', (e)=>{
    const box = e.target.closest('.occ');
    if (!box) return;

    if (e.target.classList.contains('sched_mode')){
      const m = e.target.value;
      const s1 = box.querySelector('.sched_single');
      const s2 = box.querySelector('.sched_split');
      if (s1) s1.style.display = (m==='single') ? 'block' : 'none';
      if (s2) s2.style.display = (m==='split')  ? 'block' : 'none';
      return;
    }

    if (e.target.classList.contains('diffuso')){
      const indirizzo = box.querySelector('.indirizzo');
      if (e.target.checked){
        if (indirizzo){ indirizzo.value=''; indirizzo.disabled=true; indirizzo.placeholder='Evento diffuso ‚Äî nessun indirizzo'; }
      } else {
        if (indirizzo){ indirizzo.disabled=false; indirizzo.placeholder='Via Roma 1'; }
      }
    }
  });

  // ====== UTILITY ======
  const err = document.getElementById('err');
  function clean(t){ t=(t||'').trim().replace(/\s+/g,' '); return t? t.charAt(0).toUpperCase()+t.slice(1):''; }
  function selectedCats(){ return getSelected('cat'); }
  function selectedSubcats(){ return getSelected('sub'); }

  // Raccoglie i referenti (nome/telefono) dal form
  function collectContactsFromForm(){
    const out = [];
    document.querySelectorAll('#contattiWrap .contact').forEach(row=>{
      const name  = (row.querySelector('.ref_name')  ?.value || '').trim();
      const phone = (row.querySelector('.ref_phone') ?.value || '').trim();
      if (name || phone) out.push({ nome: name, tel: phone });
    });
    return out;
  }

  // Normalizza URL "sito web"
  function normalizeUrl(u){
    u = (u||'').trim();
    if (!u) return '';
    if (!/^https?:\/\//i.test(u)) u = 'https://' + u;
    try { const _ = new URL(u); return u; } catch(_){ return ''; }
  }

  // Date utils (UTC-safe per yyyy-mm-dd)
  function toISO(d){ return (typeof d==='string' && /^\d{4}-\d{2}-\d{2}$/.test(d)) ? d : d; }
  function datesBetweenInclusive(from, to){
    const res=[]; if(!from) return res;
    const m1=String(from).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    const m2=String(to || from).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m1 || !m2) return res;
    let d=new Date(Date.UTC(+m1[1], +m1[2]-1, +m1[3]));
    const e=new Date(Date.UTC(+m2[1], +m2[2]-1, +m2[3]));
    while (d.getTime() <= e.getTime()){
      const y=d.getUTCFullYear(), m=String(d.getUTCMonth()+1).padStart(2,'0'), day=String(d.getUTCDate()).padStart(2,'0');
      res.push(`${y}-${m}-${day}`); d.setUTCDate(d.getUTCDate()+1);
    }
    return res;
  }
  function formatRange(a,b){ if(a&&b) return `${a}-${b}`; if(a) return a; if(b) return b; return ''; }
  function weekdayOfISO(d){ try{ return new Date(d+'T00:00:00').getDay(); }catch(_){ return null; } } // 0=dom ... 6=sab
  function oraForDate(o, d){
    const mode = o.mode || 'none';
    if (mode==='none') return '';
    if (mode==='single') return formatRange(o.t_from||'', o.t_to||'');
    if (mode==='split'){
      const wd = weekdayOfISO(d);
      const weekend = (wd===0 || wd===6);
      const from = weekend ? (o.we_from||'') : (o.wd_from||'');
      const to   = weekend ? (o.we_to||'')   : (o.wd_to||'');
      return formatRange(from,to);
    }
    return '';
  }

  // Geocoding helpers
  async function geocode(indirizzo, citta){
    try{ await loadGoogleMaps(); }catch(_){}
    if (!(window.google && google.maps && google.maps.Geocoder)){ throw new Error('Geocoding non disponibile'); }
    const geocoder = new google.maps.Geocoder();
    const tentativi = [
      { address: `${indirizzo}, ${citta}`, componentRestrictions: { country: 'IT', locality: citta } },
      { address: `${indirizzo}, ${citta}`, componentRestrictions: { country: 'IT' } },
      { address: `${indirizzo}, ${citta}, Italia`, componentRestrictions: { country: 'IT' } },
    ];
    for (const t of tentativi){
      const res = await new Promise((resolve)=>{
        geocoder.geocode(t, (results, status)=>{
          if(status==='OK' && results && results[0] && results[0] .geometry){
            const loc = results[0].geometry.location;
            resolve({ok:true, lat:loc.lat(), lng:loc.lng()});
          } else resolve({ok:false});
        });
      });
      if(res.ok) return { lat:+res.lat.toFixed(6), lng:+res.lng.toFixed(6) };
    }
    throw new Error('Geocoding fallito (indirizzo)');
  }
  async function geocodeCity(citta){
    try{ await loadGoogleMaps(); }catch(_){}
    if (!(window.google && google.maps && google.maps.Geocoder)){ throw new Error('Geocoding non disponibile'); }
    const geocoder = new google.maps.Geocoder();
    const res = await new Promise((resolve)=>{
      geocoder.geocode({ address: `${citta}, Italia`, componentRestrictions:{ country:'IT' }}, (results,status)=>{
        if(status==='OK' && results && results[0] && results[0].geometry){
          const loc = results[0].geometry.location;
          resolve({ok:true, lat:loc.lat(), lng:loc.lng()});
        } else resolve({ok:false});
      });
    });
    if (res.ok) return { lat:+res.lat.toFixed(6), lng:+res.lng.toFixed(6) };
    throw new Error('Geocoding citt√† fallito');
  }

  function collectOcc(){
    const occ=[];
    Array.prototype.forEach.call(document.querySelectorAll('#occWrap .occ'), (b)=>{
      const luogo=clean((b.querySelector('.luogo')||{}).value||'');
      const indirizzo=clean((b.querySelector('.indirizzo')||{}).value||'');
      const citta=clean((b.querySelector('.citta')||{}).value||'');
      const diffuso=(b.querySelector('.diffuso')||{}).checked||false;
      const dal=(b.querySelector('.dal')||{}).value||'';
      const al =(b.querySelector('.al')||{}).value||'';
      const mode=(b.querySelector('.sched_mode')||{}).value||'none';
      const t_from=(b.querySelector('.time_from')||{}).value||'';
      const t_to=(b.querySelector('.time_to')||{}).value||'';
      const wd_from=(b.querySelector('.wd_from')||{}).value||'';
      const wd_to=(b.querySelector('.wd_to')||{}).value||'';
      const we_from=(b.querySelector('.we_from')||{}).value||'';
      const we_to=(b.querySelector('.we_to')||{}).value||'';

      const from = dal, to = al || dal;
      if(!luogo||!citta||!from||(!diffuso && !indirizzo)){ occ.push(null); }
      else if (to && to < from){ occ.push(null); }
      else {
        occ.push({luogo,indirizzo,citta,diffuso,dal:from,al:to,mode,t_from,t_to,wd_from,wd_to,we_from,we_to});
      }
    });
    if(occ.length===0 || occ.indexOf(null)>-1) return null;
    return occ;
  }

  // ====== ANTEPRIMA ======
  document.getElementById('anteprimaBtn').addEventListener('click', ()=>{
    err.textContent='';
    const titolo=clean(document.getElementById('titolo').value);
    const descr =clean(document.getElementById('descrizione').value);
    const rawSite=document.getElementById('sito_web').value||'';
    const site = normalizeUrl(rawSite);
    const file  =(document.getElementById('locandina').files||[])[0];
    const catsArr = selectedCats();
    const subArr  = selectedSubcats();
    const anyCat = catsArr.length>0;
    const occ=collectOcc();
    if(!titolo||!descr||(!file && !site)||!anyCat||!occ){
      err.textContent='Controlla: Titolo*, Descrizione*, almeno 1 Categoria*, (Locandina OPPURE Sito ufficiale), e completa tutte le occorrenze (luogo/citt√† e date).'; return;
    }
    if (rawSite && !site){ err.textContent='URL del sito non valido. Correggilo o lascia vuoto.'; return; }

    // espandi le date dei periodi
    const expanded=[];
    occ.forEach(o=>{
      datesBetweenInclusive(o.dal, o.al).forEach(d=>{
        expanded.push({ ...o, data:d, ora: oraForDate(o, d) });
      });
    });

    document.getElementById('pv_titolo').textContent=titolo;
    document.getElementById('pv_cats').textContent=catsArr.join(', ');
    document.getElementById('pv_descr').textContent=descr;
    document.getElementById('pv_occ').textContent=expanded.length+' occorrenza/e';
    const subWrap = document.getElementById('pv_subcats_wrap');
    const subEl   = document.getElementById('pv_subcats');
    if (subArr.length){ subEl.textContent = subArr.join(', '); subWrap.style.display='block'; }
    else { subWrap.style.display='none'; }

    const ul=document.createElement('ul');
    occ.forEach(o=>{
      const r = (o.al && o.al!==o.dal) ? (`dal ${toISO(o.dal)} al ${toISO(o.al)}`) : (`${toISO(o.dal)}`);
      let sched='';
      if (o.mode==='single'){
        const s = formatRange(o.t_from||'', o.t_to||'');
        if (s) sched = ` ‚Äî ore ${s}`;
      } else if (o.mode==='split'){
        const fer = formatRange(o.wd_from||'', o.wd_to||'') || '‚Äî';
        const we  = formatRange(o.we_from||'', o.we_to||'') || '‚Äî';
        sched = ` ‚Äî feriali ${fer}; weekend ${we}`;
      }
      const luogoLine = o.diffuso ? `${o.luogo}, ${o.citta} (evento diffuso)` : `${o.luogo}, ${o.indirizzo}, ${o.citta}`;
      const li=document.createElement('li');
      li.textContent = `${r}${sched} ‚Äî ${luogoLine}`;
      ul.appendChild(li);
    });
    const list=document.getElementById('pv_list'); list.innerHTML=''; list.appendChild(ul);

    // sito nell‚Äôanteprima
    const wrap = document.getElementById('pv_site_wrap');
    const a = document.getElementById('pv_site');
    if (site){ a.href = site; a.textContent = site.replace(/^https?:\/\//i,''); wrap.style.display='block'; }
    else { wrap.style.display='none'; }

    document.getElementById('preview').style.display='block';
    window.scrollTo({ top: document.getElementById('preview').offsetTop-10, behavior:'smooth'});
  });

  // ====== CARRELLO ======
  const cartBar   = document.getElementById('cartBar');
  const cartList  = document.getElementById('cartList');
  const cartCount = document.getElementById('cartCount');
  const CART = []; // [{titolo, descr, prezzo, sito, cats[], subcats[], locandina_url, occ:[...], contacts:[] }]

  function refreshCartUI(){
    cartCount.textContent = CART.length;
    cartList.innerHTML = CART.map((ev,idx)=>(
      `<div class="cartItem"><b>${ev.titolo||'(senza titolo)'}</b>
         <span class="small">${ev.occ?.length>1?'evento multiplo':'evento singolo'}</span>
         <button class="btn" data-del="${idx}" type="button">Rimuovi</button>
       </div>`
    )).join('');
    cartBar.style.display = CART.length ? 'block' : 'none';
  }
  cartList.addEventListener('click', (e)=>{
    const i = e.target?.getAttribute('data-del');
    if(i!=null){ CART.splice(+i,1); refreshCartUI(); }
  });
  document.getElementById('cartClear').onclick = ()=>{ CART.length=0; refreshCartUI(); };

  // ====== Aggiungi al carrello ======
  document.getElementById('addToCartBtn').addEventListener('click', addToCart);
  async function addToCart(){
    try{
      err.textContent='';
      if(!sb){ err.textContent='Configurazione mancante: contatta il supporto.'; return; }

      const titolo=clean(document.getElementById('titolo').value);
      const descr =clean(document.getElementById('descrizione').value);
      const prezzo=(document.getElementById('prezzo').value||'').trim();
      const sito_raw=(document.getElementById('sito_web').value||'').trim();
      const sito = normalizeUrl(sito_raw);
      const catsArr = selectedCats();
      const subArr  = selectedSubcats();
      const file  =(document.getElementById('locandina').files||[])[0];
      const occ   =collectOcc();
      const contacts = collectContactsFromForm();
      if(!titolo||!descr||(!file && !sito)||!occ||!catsArr.length){
        err.textContent='Compila Titolo, Descrizione, almeno 1 Categoria e (Locandina OPPURE Sito ufficiale). Completa tutte le occorrenze (luogo/citt√† e date).'; return;
      }
      if (sito_raw && !sito){ err.textContent='URL del sito non valido. Correggilo o lascia vuoto.'; return; }

      // Upload locandina (se presente)
      let locandina_url = '';
      if (file){
        const stamp = new Date().toISOString().replace(/[:.]/g,'-');
        const rand = Math.random().toString(36).slice(2,10);
        const ext  = (file.type==='image/png'?'png':(file.type==='image/webp'?'webp':'jpg'));
        const fname = `events/${stamp}_${rand}.${ext}`;
        const up = await sb.storage.from('event-images').upload(fname, file, { upsert:false, contentType:file.type });
        if(up.error){ err.textContent='Upload immagine fallito: '+up.error.message; return; }
        const pub = sb.storage.from('event-images').getPublicUrl(fname);
        locandina_url = pub?.data?.publicUrl || '';
      }

      // Geocoding per ogni occorrenza + espansione periodi a giorni
      const occExpanded=[];
      for(const o of occ){
        let g;
        if (o.diffuso){
          g = await geocodeCity(o.citta);
        } else {
          g = await geocode(o.indirizzo, o.citta);
        }
        const days = datesBetweenInclusive(o.dal, o.al);
        if(!days.length){ err.textContent = `Intervallo date non valido per: ${o.luogo}, ${o.citta}`; return; }
        for(const d of days){
          occExpanded.push({
            luogo:o.luogo, indirizzo:o.indirizzo, citta:o.citta,
            data:d, ora: oraForDate(o, d),
            lat:+(+g.lat).toFixed(6), lng:+(+g.lng).toFixed(6),
            diffuso: !!o.diffuso
          });
        }
      }

      const eventObj = { titolo, descr, prezzo, sito, cats: catsArr, subcats: subArr, locandina_url, occ: occExpanded, contacts };
      CART.push(eventObj);
      refreshCartUI();

      // Reset campi evento
      document.getElementById('titolo').value='';
      document.getElementById('prezzo').value='';
      document.getElementById('sito_web').value='';
      document.getElementById('descrizione').value='';
      document.getElementById('locandina').value='';
      selCats=[]; selSubcats=[]; renderBadges();
      document.getElementById('occWrap').innerHTML = `
        <div class="occ card">
          <div class="grid">
            <div><label>Luogo/Nome locale*</label><input class="luogo" placeholder="Es. Bar Centrale / Centro storico"></div>
            <div><label>Indirizzo <span class="smallmuted">(opzionale se evento diffuso)</span></label><input class="indirizzo" placeholder="Via Roma 1"></div>
          </div>
          <div class="grid">
            <div>
              <label>Citt√†*</label><input class="citta" placeholder="Es. Alba">
              <label class="smallmuted" style="display:block;margin-top:6px"><input type="checkbox" class="diffuso"> Evento diffuso in citt√† (senza indirizzo preciso)</label>
            </div>
            <div>
              <label>Dal*</label><input class="dal" type="date">
              <div class="help-inline">Compila anche ‚ÄúAl‚Äù se dura pi√π giorni</div>
            </div>
          </div>
          <div class="grid">
            <div><label>Al (facoltativo)</label><input class="al" type="date"></div>
            <div>
              <label>Orario</label>
              <select class="sched_mode">
                <option value="none" selected>Nessun orario (tutto il giorno)</option>
                <option value="single">Stessa fascia per tutte le date</option>
                <option value="split">Feriali vs weekend</option>
              </select>
              <div class="sched_single" style="display:none;margin-top:6px">
                <div class="grid">
                  <div><label>Dalle</label><input type="time" class="time_from"></div>
                  <div><label>Alle</label><input type="time" class="time_to"></div>
                </div>
              </div>
              <div class="sched_split" style="display:none;margin-top:6px">
                <div class="smallmuted" style="margin-bottom:4px">Default: lun‚Äìven 15:00‚Äì21:00; sab‚Äìdom 10:00‚Äì21:00</div>
                <div class="grid">
                  <div><label>Lun‚ÄìVen dalle</label><input type="time" class="wd_from" value="15:00"></div>
                  <div><label>Lun‚ÄìVen alle</label><input type="time" class="wd_to" value="21:00"></div>
                </div>
                <div class="grid">
                  <div><label>Sab‚ÄìDom dalle</label><input type="time" class="we_from" value="10:00"></div>
                  <div><label>Sab‚ÄìDom alle</label><input type="time" class="we_to" value="21:00"></div>
                </div>
              </div>
            </div>
          </div>
        </div>`;
      document.getElementById('preview').style.display='none';
      window.scrollTo({top:0, behavior:'smooth'});
    }catch(e){
      err.textContent = 'Errore: '+( e?.message || String(e) );
    }
  }

  // ====== Vai al pagamento (bundle nel formato ATTESO) ======
  document.getElementById('goCheckout').addEventListener('click', async ()=>{
    try{
      if(CART.length===0){ alert('Il carrello √® vuoto. Aggiungi almeno un evento.'); return; }

      const nome = (document.getElementById('sub_nome').value||'').trim();
      const cognome = (document.getElementById('sub_cognome').value||'').trim();
      const tel = (document.getElementById('sub_tel').value||'').trim();
      const email = (document.getElementById('sub_email').value||'').trim();
      const partner = (document.getElementById('partner_code').value||'').trim();
      if(!nome || !cognome || !tel || !email){
        alert('Compila Nome, Cognome, Telefono ed Email di chi inserisce l‚Äôannuncio.');
        return;
      }

      // Trasforma gli eventi del carrello nel formato { tipo, metadata }
      const bundleItems = CART.map(ev=>{
        const catsStr = (ev.cats||[]).join('|').slice(0,120);
        const subStr  = (ev.subcats||[]).join('|').slice(0,180);
        const occMin  = (ev.occ||[]).map(o=>({
          l:o.luogo, i:o.indirizzo, c:o.citta, d:o.data, o:o.ora,
          la:+(+o.lat).toFixed(6), ln:+(+o.lng).toFixed(6),
          df: o.diffuso ? 1 : 0
        }));
        const occStr = JSON.stringify(occMin);

        const MAX_DAYS = 60; // deve corrispondere a MAX_DAYS_PER_EVENT su create-checkout-session
        const actualDays = new Set(occMin.map(o => o.d)).size;
        if (actualDays > MAX_DAYS) {
          throw new Error(`Periodo troppo lungo: ${actualDays} giorni (limite ${MAX_DAYS}). Dividi il periodo in pi√π annunci o contattaci: eventi@staseraqui.it`);
        }
        const contactsStr = JSON.stringify(ev.contacts || []).slice(0, 4000);
        const metadata = {
          titolo: (ev.titolo||'').slice(0,80),
          descr:  (ev.descr||'').slice(0,180),
          prezzo: (ev.prezzo||'').slice(0,120),
          locandina_url: ev.locandina_url,
          website: (ev.sito||'').slice(0,200),
          cats: catsStr,
          subcats: subStr,                 // ‚Üê NOVIT√Ä
          occ:  occStr,
          contacts: contactsStr,           // ‚Üê referenti
          submitter_email: email.slice(0,120),
          submitter_name: (`${nome} ${cognome}`).slice(0,80),
          submitter_tel: (tel||'').slice(0,32),
          partner: (partner||'').slice(0,12)
        };
        const tipo = (ev.occ && ev.occ.length>1) ? 'multi' : 'single';
        return { tipo, metadata };
      });

      const resp = await fetch(EDGE_URL, {
        method:'POST',
        headers:{
          'content-type':'application/json',
          'apikey': SUPABASE_ANON,
          'Authorization': 'Bearer ' + SUPABASE_ANON
        },
        body: JSON.stringify({ bundle: bundleItems })
      });

      if(!resp.ok){
        const txt = await resp.text().catch(()=>'(no body)');
        throw new Error('create-checkout-session FAILED: ' + txt);
      }
      const j = await resp.json();
      if(!j?.url) throw new Error('Risposta senza URL da Supabase. Dettagli: '+JSON.stringify(j));
      window.location.href = j.url;
    }catch(e){
      alert(e?.message||String(e));
    }
  });

  // ====== RESET ======
  document.getElementById('azzeraBtn').addEventListener('click', ()=> location.reload());

})();
</script>

<footer class="page-footer">
  <a href="index.html" class="btn">‚Üê Torna alla mappa</a>
  <a href="termini-privacy.html" class="btn">Termini & Privacy</a>
  <a href="#" class="btn" id="cookieSettingsLink">Preferenze cookie</a>
</footer>
</body>
</html>
