<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Replay pagamento → inserisci eventi in DB</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/style.css?v=100">
  <script src="assets/app-config.js?v=3"></script>
  <style>
    body{background:#0b1828;color:#fff;font-family:Rubik,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}
    .card{background:#0f1c2d;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:18px}
    h1{margin:0 0 10px}
    input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,.2)}
    .row{display:flex;gap:10px;align-items:center;margin-top:10px}
    .btn{display:inline-block;padding:10px 14px;border-radius:10px;border:2px solid rgba(255,255,255,.15);background:#111f31;color:#fff;font-weight:800;cursor:pointer}
    .btn.primary{background:#ffd54f;border-color:#f0c43c;color:#081421}
    pre{background:#081421;border:1px solid rgba(255,255,255,.12);padding:10px;border-radius:10px;overflow:auto}
    .ok{color:#78ffa7} .err{color:#ff9a9a} .muted{color:#b8c2ce}
    .pill{display:inline-block;margin-right:8px;padding:4px 8px;border-radius:8px;background:#132338;border:1px solid rgba(255,255,255,.12)}
    .links{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Replay pagamento → inserisci eventi in DB</h1>
    <div class="muted" id="fnStatus">Ricerca dell’endpoint disponibile…</div>
    <div style="margin-top:8px">
      <span class="pill">Provo: <code>admin-replay-insert</code></span>
      <span class="pill">fallback: <code>admin-insert-events</code></span>
    </div>

    <p style="margin-top:12px">Incolla un ID <b>Checkout Session</b> (<code>cs_…</code>) <i>oppure</i> un ID <b>Payment Intent</b> (<code>pi_…</code>) e premi <b>“Inserisci in DB”</b>.</p>
    <div class="row">
      <input id="idInput" placeholder="es. cs_live_… oppure pi_…">
      <button class="btn primary" id="goBtn" type="button">Inserisci in DB</button>
    </div>

    <div id="status" style="margin-top:12px"></div>
    <pre id="out" style="margin-top:8px"></pre>

    <div class="links">
      <a class="btn" href="admin.html">← Torna a Admin</a>
      <a class="btn" href="index.html">Torna alla mappa</a>
    </div>
  </div>
</div>

<script>
(function(){
  const CFG = window.SQ_CONFIG || {};
  const BASE = (CFG.SUPABASE_URL||'') + '/functions/v1/';
  const ANON = CFG.SUPABASE_ANON;

  const $ = s => document.querySelector(s);
  const idInput = $('#idInput');
  const status  = $('#status');
  const out     = $('#out');
  const fnStatus= $('#fnStatus');

  // quale funzione useremo
  let chosen = null;   // 'admin-replay-insert' (POST JSON) oppure 'admin-insert-events' (GET ?id=)

  // Probing: prima replay-insert (POST JSON), poi insert-events (GET ?id=)
  (async function probe(){
    // 1) prova admin-replay-insert (POST ping)
    try{
      const r = await fetch(BASE+'admin-replay-insert', {
        method:'POST',
        headers:{'content-type':'application/json','Authorization':'Bearer '+ANON,'apikey':ANON},
        body: JSON.stringify({ ping: true })
      });
      if(r.ok){ chosen='admin-replay-insert'; fnStatus.innerHTML='Endpoint selezionato: <b>admin-replay-insert</b>'; fnStatus.className='ok'; return; }
    }catch(_){}
    // 2) prova admin-insert-events (GET ?id=)
    try{
      const r2 = await fetch(BASE+'admin-insert-events?id=', {
        method:'GET',
        headers:{'Authorization':'Bearer '+ANON,'apikey':ANON}
      });
      if(r2.ok){ chosen='admin-insert-events'; fnStatus.innerHTML='Endpoint selezionato: <b>admin-insert-events</b>'; fnStatus.className='ok'; return; }
    }catch(_){}
    fnStatus.textContent='Nessun endpoint disponibile (verifica che almeno uno sia deployato con Verify JWT = NO).';
    fnStatus.className='err';
  })();

  $('#goBtn').addEventListener('click', async ()=>{
    const val = (idInput.value||'').trim();
    status.textContent=''; status.className=''; out.textContent='';

    if(!chosen){
      status.className='err'; status.textContent='Nessuna funzione raggiungibile.'; return;
    }
    if(!/^cs_|^pi_/.test(val)){
      status.className='err'; status.textContent='ID non valido (deve iniziare con cs_ o pi_)'; return;
    }

    try{
      let r, txt, j;
      if (chosen==='admin-replay-insert'){
        // questa vuole POST JSON { cs_id } oppure { pi_id }
        const payload = /^cs_/.test(val) ? { cs_id: val } : { pi_id: val };
        r = await fetch(BASE+chosen, {
          method:'POST',
          headers:{'content-type':'application/json','Authorization':'Bearer '+ANON,'apikey':ANON},
          body: JSON.stringify(payload)
        });
      } else {
        // admin-insert-events: chiamata via GET con ?id=
        const url = BASE+chosen+'?id='+encodeURIComponent(val);
        r = await fetch(url, { method:'GET', headers:{'Authorization':'Bearer '+ANON,'apikey':ANON} });
      }
      txt = await r.text().catch(()=>'(no body)'); try{ j=JSON.parse(txt); }catch{}
      if(!r.ok){
        status.className='err'; status.textContent='HTTP '+r.status;
        out.textContent = j? JSON.stringify(j,null,2) : txt;
        return;
      }
      status.className='ok'; status.textContent='Inserimento completato';
      out.textContent = j? JSON.stringify(j,null,2) : txt;
    }catch(e){
      status.className='err';
      status.textContent='Errore di rete';
      out.textContent=String(e);
    }
  });
})();
</script>
</body>
</html>
