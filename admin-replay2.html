<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Replay Checkout → DB</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/style.css">
  <style>
    body{padding:16px}
    .card{max-width:820px;margin:0 auto}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input{flex:1}
    pre{white-space:pre-wrap;background:#0f1c2d;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px}
    .ok{color:#7CFC7C;font-weight:700}
    .err{color:#ff9a9a;font-weight:700}
    .muted{color:#b8c2ce}
  </style>
  <script src="assets/app-config.js?v=3"></script>
</head>
<body>
<header class="header">
  <a href="index.html" class="logo">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true"><path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/><circle cx="32" cy="24" r="9" fill="#ffffff"/></svg>
    <span class="wordmark">stasera qui</span>
  </a>
</header>

<main class="container">
  <div class="card">
    <h1 style="margin-top:0">Replay pagamento → inserisci eventi in DB</h1>
    <p class="small">Incolla l’ID di <b>Checkout Session</b> (es. <code>cs_live_…</code>) e premi “Inserisci in DB”.</p>

    <div class="row">
      <input id="cs" placeholder="cs_live_…" autocomplete="off">
      <button class="btn primary" id="go" type="button">Inserisci in DB</button>
    </div>

    <div id="out" style="margin-top:12px"></div>

    <div style="margin-top:16px">
      <a class="btn" href="admin.html">← Torna a Admin</a>
      <a class="btn" href="index.html">Torna alla mappa</a>
    </div>
  </div>
</main>

<script>
(function(){
  const CFG = window.SQ_CONFIG || window.SQ || {};
  const SUPABASE_URL  = CFG.SUPABASE_URL;
  const SUPABASE_ANON = CFG.SUPABASE_ANON || CFG.SUPABASE_ANON_KEY;
  const FN = (SUPABASE_URL||'').replace(/\/+$/,'') + '/functions/v1/admin-insert-events';
  const $ = s=>document.querySelector(s);
  const out = (html)=> $('#out').innerHTML = html;

  if(!SUPABASE_URL || !SUPABASE_ANON){
    out('<div class="err">Chiavi mancanti in <code>assets/app-config.js</code> (SUPABASE_URL / SUPABASE_ANON).</div>');
    return;
  }

  async function tryFetch(desc, req){
    const r = await fetch(req);
    const raw = await r.text();
    let json=null; try{ json = JSON.parse(raw) }catch(_){}
    return { ok:r.ok, status:r.status, statusText:r.statusText, body: json? JSON.stringify(json,null,2): raw, label:desc };
  }

  $('#go').addEventListener('click', async ()=>{
    const id = ($('#cs').value||'').trim();
    if(!id || !/^cs_/.test(id)){
      out('<div class="err">ID non valido (deve iniziare con <code>cs_</code>).</div>');
      return;
    }
    out('<span class="muted">Invio…</span>');

    const headers = {
      'apikey': SUPABASE_ANON,
      'Authorization': 'Bearer ' + SUPABASE_ANON
    };

    const attempts = [];

    // 1) POST JSON (alcune versioni la vogliono così)
    attempts.push(await tryFetch('POST JSON', new Request(FN, {
      method:'POST',
      headers: { ...headers, 'content-type':'application/json' },
      body: JSON.stringify({ id, session_id:id })
    })));

    // 2) GET ?id=…
    if(!attempts[0].ok){
      attempts.push(await tryFetch('GET ?id=', new Request(FN + '?id=' + encodeURIComponent(id), { method:'GET', headers })));
    }

    // 3) GET ?session_id=…
    if(attempts.every(a=>!a.ok)){
      attempts.push(await tryFetch('GET ?session_id=', new Request(FN + '?session_id=' + encodeURIComponent(id), { method:'GET', headers })));
    }

    // 4) POST form-urlencoded id=…
    if(attempts.every(a=>!a.ok)){
      attempts.push(await tryFetch('POST form-urlencoded', new Request(FN, {
        method:'POST',
        headers: { ...headers, 'content-type':'application/x-www-form-urlencoded' },
        body: 'id=' + encodeURIComponent(id)
      })));
    }

    // Mostra il primo OK, altrimenti l’ultimo errore con log di tutti i tentativi
    const success = attempts.find(a=>a.ok);
    if(success){
      out('<div class="ok">OK ('+success.label+') — HTTP '+success.status+'</div><pre>'+success.body+'</pre>');
    } else {
      const last = attempts[attempts.length-1];
      const log = attempts.map(a=>'['+a.label+'] HTTP '+a.status+' '+a.statusText+'\n'+a.body).join('\n\n----\n\n');
      out('<div class="err">HTTP '+last.status+' '+last.statusText+'</div><pre>'+log+'</pre>');
    }
  });
})();
</script>
</body>
</html>
