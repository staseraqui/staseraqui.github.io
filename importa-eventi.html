<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Importa eventi — Stasera Qui</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/style.css?v=24">
  <script src="assets/app-config.js?v=3"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .uploader{border:2px dashed rgba(255,255,255,.25);padding:14px;border-radius:12px;text-align:center}
    .small{color:#b8c2ce}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:top}
    th{text-align:left;color:#b8c2ce;white-space:nowrap}
    tbody tr:hover{background:rgba(255,255,255,.03)}
    input[type="file"]{background:#fff;color:#1c2a3a;border:1px solid rgba(0,0,0,.18);border-radius:10px;padding:8px}
    input[type="text"], input[type="date"], input[type="time"], input[type="url"]{background:#fff;color:#1c2a3a;border:1px solid rgba(0,0,0,.18);border-radius:10px;padding:8px}
    select{background:#fff;color:#1c2a3a;border:1px solid rgba(0,0,0,.18);border-radius:10px;padding:8px}
    #err{color:#ffb4b4;font-weight:700;margin:10px 0}
    .ok{color:#7be28c}
    code{white-space:pre-wrap}
  </style>
</head>
<body>
<header class="header">
  <a href="admin.html" class="logo" aria-label="Stasera Qui - admin">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true"><path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/><circle cx="32" cy="24" r="9" fill="#ffffff"/></svg>
    <span class="wordmark">stasera qui</span>
  </a>
</header>

<main class="wrap">
  <h1 style="margin:8px 0 12px">Importa eventi</h1>
  <div id="err"></div>

  <div class="card">
    <div class="grid">
      <div>
        <h3 style="margin:0 0 8px">1) Carica CSV</h3>
        <div class="uploader">
          <input id="csvFile" type="file" accept=".csv">
          <div class="small" style="margin-top:6px">
            Template colonne supportate (quelle in <b>grassetto</b> sono consigliate/chiave):<br>
            <code><b>titolo</b>, <b>descrizione</b>, <b>categorie</b>, locandina_url(opz), website(opz),
<b>luogo</b>, <b>indirizzo</b>, <b>citta</b>,
data(YYYY-MM-DD) <i>oppure</i> dal(YYYY-MM-DD), al(YYYY-MM-DD),
ora(HH:MM) <i>oppure</i> sched_mode(none|single|split),
time_from,time_to,wd_from,wd_to,we_from,we_to,
lat(opz), lng(opz)</code>
          </div>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="dlTemplate" type="button">Scarica template CSV</button>
          <a class="btn" href="#help">Guida rapida formati</a>
        </div>
      </div>
      <div>
        <h3 style="margin:0 0 8px">2) Opzioni</h3>
        <div class="grid">
          <div>
            <label>PIN admin</label>
            <input id="pin" type="text" placeholder="Il PIN che hai messo nei Secrets">
          </div>
          <div>
            <label>Funzione (URL)</label>
            <input id="fnUrl" type="text" placeholder="Edge Function URL (…/admin-insert-events)" />
          </div>
        </div>
        <p class="small" style="margin-top:6px">
          Usa <b>assets/app-config.js</b> per Supabase (URL/ANON) e Google.  
          Per la URL funzione: in Supabase apri <i>admin-insert-events</i> e copia la <b>Function URL</b>.
        </p>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">3) Geocoding & locandine</h3>
    <div class="small" style="margin-bottom:6px">
      Almeno uno tra <b>locandina_url</b> e <b>website</b> deve essere presente (come da pubblicazione singola).  
      Per upload immagine singola riga supportiamo <b>JPG/PNG/WebP</b>.
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="geoAll" type="button">Geocodifica tutte le righe senza lat/lng</button>
      <span class="small">Oppure geocodifica singolarmente modificando le celle Lat/Lng.</span>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">Anteprima CSV</h3>
    <div style="overflow:auto">
      <table id="tbl">
        <thead>
          <tr>
            <th>#</th>
            <th>Titolo</th><th>Descrizione</th><th>Categorie</th>
            <th>Locandina URL</th><th>Website</th>
            <th>Luogo</th><th>Indirizzo</th><th>Città</th>
            <th>Data</th><th>Dal</th><th>Al</th>
            <th>Ora</th><th>Sched&nbsp;mode</th><th>time_from</th><th>time_to</th><th>wd_from</th><th>wd_to</th><th>we_from</th><th>we_to</th>
            <th>Lat</th><th>Lng</th><th>Upload img</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">4) Invia</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn primary" id="sendBtn" type="button">Invia a Supabase (PIN richiesto)</button>
      <a class="btn" href="index.html">← Torna alla mappa</a>
    </div>
    <div id="out" class="small" style="margin-top:8px"></div>
  </div>

  <div id="help" class="card">
    <h3 style="margin:0 0 8px">Guida rapida</h3>
    <ul class="small" style="margin-top:0">
      <li><b>categorie</b>: separa con <code>|</code> (pipe) o virgole. Es: <code>Musica|Food &amp; Drink</code>.</li>
      <li><b>data</b> singola oppure <b>dal/al</b> per un periodo (esteso in giorni). Se compili <code>dal</code>/<code>al</code>, puoi lasciare vuoto <code>data</code>.</li>
      <li><b>ora</b>: opzionale. Alternativa: usa <b>sched_mode</b>:
        <ul>
          <li><code>none</code>: nessun orario (tutto il giorno)</li>
          <li><code>single</code>: usa <code>time_from</code>/<code>time_to</code> → “HH:MM–HH:MM”</li>
          <li><code>split</code>: feriali vs weekend con <code>wd_from/wd_to</code> e <code>we_from/we_to</code> (l’ora viene calcolata in base al giorno).</li>
        </ul>
      </li>
      <li><b>locandina_url</b> o <b>website</b>: almeno uno. Website può essere anche una pagina Facebook/Eventbrite/Comune.</li>
      <li><b>lat/lng</b>: opzionali; se mancano, usa “Geocodifica” (Italia).</li>
    </ul>
  </div>
</main>

<script>
(function(){
  // === CONFIG ===
  const CFG = window.SQ_CONFIG || {};
  const SB_URL  = CFG.SUPABASE_URL;
  const SB_ANON = CFG.SUPABASE_ANON;
  const GOOGLE  = CFG.GOOGLE_MAPS_API_KEY;
  const sb = (SB_URL && SB_ANON) ? supabase.createClient(SB_URL, SB_ANON) : null;

  if (!sb) {
    document.getElementById('err').textContent = 'Chiavi Supabase mancanti in assets/app-config.js';
  }

  // carico Google Maps Geocoder
  let mapsLoaded = null;
  function loadGoogle(){
    if (window.google && window.google.maps) return Promise.resolve();
    if (mapsLoaded) return mapsLoaded;
    mapsLoaded = new Promise((resolve, reject)=>{
      if (!GOOGLE) { reject(new Error('GOOGLE_MAPS_API_KEY mancante in app-config.js')); return; }
      const s = document.createElement('script');
      s.src = 'https://maps.googleapis.com/maps/api/js?key='+encodeURIComponent(GOOGLE)+'&libraries=places&v=quarterly';
      s.async = true; s.defer = true;
      s.onload = resolve; s.onerror = ()=>reject(new Error('Google Maps JS load failed'));
      document.head.appendChild(s);
    });
    return mapsLoaded;
  }

  // === CSV PARSE SEMPLICE ===
  function parseCSV(text){
    const rows = [];
    let i=0, cur=[], cell='', inQ=false;
    while (i < text.length){
      const ch = text[i++];
      if (inQ){
        if (ch === '"'){
          if (text[i] === '"'){ cell+='"'; i++; }
          else inQ=false;
        } else cell += ch;
      } else {
        if (ch === '"'){ inQ=true; }
        else if (ch === ','){ cur.push(cell); cell=''; }
        else if (ch === '\n'){ cur.push(cell); rows.push(cur); cur=[]; cell=''; }
        else if (ch === '\r'){ /* skip */ }
        else cell += ch;
      }
    }
    if (cell.length || cur.length) { cur.push(cell); rows.push(cur); }
    return rows;
  }

  // === HELPERS ===
  const $ = s => document.querySelector(s);
  const tbody = $('#tbl tbody');
  const out = $('#out');
  const err = $('#err');

  function esc(s){ return String(s||'').replace(/"/g,'&quot;'); }
  function isISO(d){ return /^\d{4}-\d{2}-\d{2}$/.test(d||''); }
  function isTime(t){ return /^\d{2}:\d{2}$/.test(t||''); }
  function fmtRange(a,b){ return (a&&b)? `${a}-${b}` : (a||b||''); }
  function weekdayOfISO(iso){ try { return new Date(iso+'T00:00:00').getDay(); } catch(_){ return null; } } // 0=dom…6=sab
  function normalizeUrl(u){
    u = (u||'').trim(); if(!u) return '';
    if (!/^https?:\/\//i.test(u)) u = 'https://' + u;
    try { new URL(u); return u; } catch(_){ return ''; }
  }

  // === STATE ===
  let rows = []; // oggetti normalizzati
  let geocoder = null;

  // Template CSV
  $('#dlTemplate').addEventListener('click', ()=>{
    const csv = [
      'titolo,descrizione,categorie,locandina_url,website,luogo,indirizzo,citta,data,dal,al,ora,sched_mode,time_from,time_to,wd_from,wd_to,we_from,we_to,lat,lng',
      'Festa in piazza,Musica dal vivo e street food,Musica|Food & Drink,,https://facebook.com/event/123,Piazza Castello,Via Roma 1,Torino,2025-12-24,,21:00,none,,,,,,,' ,
      'Mercatino di Natale,Bancarelle e vin brulé,Shopping|Mercatini,,,Piazza Duomo,Piazza Duomo,Milano,,2025-12-08,2025-12-23,,split,,,15:00,21:00,10:00,21:00,,' ,
      'Mostra permanente,Ingresso gratuito,Cultura/Spettacolo,https://cdn.site/img.jpg,,Museo Civico,Via Verdi 5,Bologna,2025-11-10,,,single,10:00,18:00,,,,,,'
    ].join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='template_import.csv';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  // Carica CSV
  $('#csvFile').addEventListener('change', async (e)=>{
    const f = e.target.files?.[0]; if (!f) return;
    const text = await f.text();
    const raw = parseCSV(text);
    if (!raw.length) { err.textContent='CSV vuoto'; return; }
    const header = raw[0].map(h => (h||'').trim().toLowerCase());
    const idx = (name)=> header.indexOf(name);

    const must = ['titolo','descrizione','categorie','luogo','indirizzo','citta'];
    for (const m of must){ if (idx(m)===-1){ err.textContent='Colonna mancante: '+m; return; } }

    err.textContent='';

    rows = raw.slice(1)
      .filter(r=>r.some(x=>String(x).trim().length))
      .map((r, i)=>({
        i: i+1,
        titolo: (r[idx('titolo')]||'').trim(),
        descrizione: (r[idx('descrizione')]||'').trim(),
        categorie: (r[idx('categorie')]||'').trim(),
        locandina_url: (r[idx('locandina_url')]||'').trim(),
        website: (idx('website')>-1 ? (r[idx('website')]||'').trim() : ''),
        luogo: (r[idx('luogo')]||'').trim(),
        indirizzo: (r[idx('indirizzo')]||'').trim(),
        citta: (r[idx('citta')]||'').trim(),
        data: (idx('data')>-1 ? (r[idx('data')]||'').trim().slice(0,10) : ''),
        dal:  (idx('dal')>-1 ? (r[idx('dal')]||'').trim().slice(0,10) : ''),
        al:   (idx('al')>-1 ? (r[idx('al')]||'').trim().slice(0,10) : ''),
        ora:  (idx('ora')>-1 ? (r[idx('ora')]||'').trim().slice(0,5) : ''),
        sched_mode: (idx('sched_mode')>-1 ? (r[idx('sched_mode')]||'none').trim() : 'none'),
        time_from: (idx('time_from')>-1 ? (r[idx('time_from')]||'').trim().slice(0,5) : ''),
        time_to:   (idx('time_to')>-1   ? (r[idx('time_to')]||'').trim().slice(0,5)   : ''),
        wd_from:   (idx('wd_from')>-1   ? (r[idx('wd_from')]||'').trim().slice(0,5)   : ''),
        wd_to:     (idx('wd_to')>-1     ? (r[idx('wd_to')]||'').trim().slice(0,5)     : ''),
        we_from:   (idx('we_from')>-1   ? (r[idx('we_from')]||'').trim().slice(0,5)   : ''),
        we_to:     (idx('we_to')>-1     ? (r[idx('we_to')]||'').trim().slice(0,5)     : ''),
        lat: (idx('lat')>-1 ? (r[idx('lat')]||'').trim() : ''),
        lng: (idx('lng')>-1 ? (r[idx('lng')]||'').trim() : '')
      }));

    renderTable();
  });

  function renderTable(){
    tbody.innerHTML = rows.map((r, n)=>`
      <tr>
        <td>${n+1}</td>
        <td><input value="${esc(r.titolo)}" onchange="upd(${n},'titolo',this.value)"></td>
        <td><input value="${esc(r.descrizione)}" onchange="upd(${n},'descrizione',this.value)"></td>
        <td><input value="${esc(r.categorie)}" onchange="upd(${n},'categorie',this.value)"></td>
        <td><input value="${esc(r.locandina_url)}" onchange="upd(${n},'locandina_url',this.value)"></td>
        <td><input value="${esc(r.website)}" onchange="upd(${n},'website',this.value)"></td>
        <td><input value="${esc(r.luogo)}" onchange="upd(${n},'luogo',this.value)"></td>
        <td><input value="${esc(r.indirizzo)}" onchange="upd(${n},'indirizzo',this.value)"></td>
        <td><input value="${esc(r.citta)}" onchange="upd(${n},'citta',this.value)"></td>
        <td><input type="date" value="${esc(r.data)}" onchange="upd(${n},'data',this.value)"></td>
        <td><input type="date" value="${esc(r.dal)}" onchange="upd(${n},'dal',this.value)"></td>
        <td><input type="date" value="${esc(r.al)}" onchange="upd(${n},'al',this.value)"></td>
        <td><input type="time" value="${esc(r.ora)}" onchange="upd(${n},'ora',this.value)"></td>
        <td>
          <select onchange="upd(${n},'sched_mode',this.value)">
            <option value="none"  ${r.sched_mode==='none'?'selected':''}>none</option>
            <option value="single"${r.sched_mode==='single'?'selected':''}>single</option>
            <option value="split" ${r.sched_mode==='split'?'selected':''}>split</option>
          </select>
        </td>
        <td><input type="time" value="${esc(r.time_from)}" onchange="upd(${n},'time_from',this.value)"></td>
        <td><input type="time" value="${esc(r.time_to)}"   onchange="upd(${n},'time_to',this.value)"></td>
        <td><input type="time" value="${esc(r.wd_from)}"   onchange="upd(${n},'wd_from',this.value)"></td>
        <td><input type="time" value="${esc(r.wd_to)}"     onchange="upd(${n},'wd_to',this.value)"></td>
        <td><input type="time" value="${esc(r.we_from)}"   onchange="upd(${n},'we_from',this.value)"></td>
        <td><input type="time" value="${esc(r.we_to)}"     onchange="upd(${n},'we_to',this.value)"></td>
        <td><input value="${esc(r.lat)}" onchange="upd(${n},'lat',this.value)"></td>
        <td><input value="${esc(r.lng)}" onchange="upd(${n},'lng',this.value)"></td>
        <td><input type="file" accept="image/png,image/jpeg,image/webp" onchange="uploadImg(${n}, this.files[0])"></td>
      </tr>
    `).join('');
    // esponi funzioni globali per gli onchange
    window.upd = (i,k,v)=>{ rows[i][k]=v; };
    window.uploadImg = uploadImg;
  }

  // Upload immagine → Storage (event-images) → set locandina_url
  async function uploadImg(i, file){
    try{
      if (!file || !sb){ alert('File mancante o Supabase non configurato'); return; }
      const ext = file.type==='image/png' ? 'png' : (file.type==='image/webp' ? 'webp' : 'jpg');
      const stamp = new Date().toISOString().replace(/[:.]/g,'-');
      const rand = Math.random().toString(36).slice(2,10);
      const path = `events/${stamp}_${rand}.${ext}`;
      const up = await sb.storage.from('event-images').upload(path, file, { upsert:false, contentType:file.type });
      if (up.error){ alert('Upload fallito: '+up.error.message); return; }
      const pub = sb.storage.from('event-images').getPublicUrl(path);
      const url = pub?.data?.publicUrl || '';
      rows[i].locandina_url = url;
      renderTable();
    }catch(e){ alert('Errore upload: '+String(e.message||e)); }
  }

  // Geocoding tutte le righe senza lat/lng
  $('#geoAll').addEventListener('click', async ()=>{
    try{
      await loadGoogle(); geocoder = geocoder || new google.maps.Geocoder();
      const toDo = rows.map((r,idx)=>({idx,r})).filter(x=>!(Number(x.r.lat)&&Number(x.r.lng)));
      if (!toDo.length){ alert('Tutte le righe hanno già lat/lng.'); return; }
      for (const item of toDo){
        const q = `${item.r.indirizzo}, ${item.r.citta}, Italia`;
        const res = await new Promise((res)=> geocoder.geocode({ address:q, componentRestrictions:{country:'IT'}}, (results, status)=>{
          if(status==='OK' && results && results[0]){
            const loc = results[0].geometry.location;
            res({lat:loc.lat(), lng:loc.lng()});
          } else res(null);
        }));
        if (res){ rows[item.idx].lat = (+res.lat).toFixed(6); rows[item.idx].lng = (+res.lng).toFixed(6); }
        await new Promise(r=>setTimeout(r, 150)); // piccola pausa anti-rate
      }
      renderTable();
      alert('Geocoding completato.');
    }catch(e){
      alert('Geocoding fallito: '+String(e.message||e));
    }
  });

  // Espansione date inclusive
  function datesBetweenInclusive(from, to){
    const out=[]; if(!from && !to) return out;
    const a = from || to, b = to || from;
    if (!isISO(a) || !isISO(b)) return out;
    let d = new Date(a+'T00:00:00'); const end = new Date(b+'T00:00:00');
    while (d.getTime() <= end.getTime()){
      out.push(d.toISOString().slice(0,10));
      d.setDate(d.getDate()+1);
    }
    return out;
  }

  function timeFromSchedule(row, isoDate){
    if (row.ora && isTime(row.ora)) return row.ora; // override diretto
    const mode = (row.sched_mode||'none').toLowerCase();
    if (mode==='single'){
      if (isTime(row.time_from) || isTime(row.time_to)) return fmtRange(row.time_from,row.time_to);
      return '';
    }
    if (mode==='split'){
      const wd = weekdayOfISO(isoDate);
      const weekend = (wd===0 || wd===6);
      const f = weekend ? row.we_from : row.wd_from;
      const t = weekend ? row.we_to   : row.wd_to;
      if (isTime(f) || isTime(t)) return fmtRange(f,t);
      return '';
    }
    return ''; // none
  }

  // Invio a funzione
  $('#sendBtn').addEventListener('click', async ()=>{
    try{
      err.textContent=''; out.textContent='';
      const pin = ($('#pin').value||'').trim();
      const url = ($('#fnUrl').value||'').trim();
      if (!pin){ err.textContent='Inserisci il PIN admin.'; return; }
      if (!url){ err.textContent='Inserisci la Function URL (admin-insert-events).'; return; }
      if (!rows.length){ err.textContent='Nessuna riga importata.'; return; }

      // Raggruppa per titolo → 1 evento con più occorrenze
      const byTitle = new Map();
      for (const r of rows){
        const key = (r.titolo||'').trim();
        if (!key) continue;

        // normalizza website
        const website = normalizeUrl(r.website);

        if (!byTitle.has(key)){
          byTitle.set(key, {
            title: r.titolo,
            description: r.descrizione,
            categories: (r.categorie||'')
              .split(/[|,]+/).map(s=>s.trim()).filter(Boolean),
            locandina_url: (r.locandina_url||'').trim(),
            website: website || '',
            occurrences: []
          });
        } else {
          // se non impostati a livello evento, ereditali dalla prima riga utile
          const ev0 = byTitle.get(key);
          if (!ev0.locandina_url && r.locandina_url) ev0.locandina_url = r.locandina_url.trim();
          if (!ev0.website && website) ev0.website = website;
        }

        // genera le date della riga
        let dates = [];
        if (isISO(r.data)) dates = [r.data];
        else if (isISO(r.dal) || isISO(r.al)) dates = datesBetweenInclusive(r.dal, r.al);
        else { /* nessuna data valida -> salta occorrenza */ }

        for (const d of dates){
          const ora = timeFromSchedule(r, d);
          byTitle.get(key).occurrences.push({
            luogo: r.luogo, indirizzo: r.indirizzo, citta: r.citta,
            data: d, ora,
            lat: r.lat ? Number(r.lat) : null,
            lng: r.lng ? Number(r.lng) : null
          });
        }
      }

      const events = Array.from(byTitle.values());

      // Validazione minima: ogni evento deve avere almeno 1 occorrenza e (locandina o website)
      for (const ev of events){
        if (!ev.occurrences.length){ throw new Error(`Evento "${ev.title}": nessuna occorrenza valida (manca data/dal/al).`); }
        if (!ev.locandina_url && !ev.website){
          throw new Error(`Evento "${ev.title}": serve almeno una locandina_url o un website.`);
        }
      }

      const payload = { pin, events };

      const resp = await fetch(url, {
        method:'POST',
        headers:{ 'content-type':'application/json' },
        body: JSON.stringify(payload)
      });
      const j = await resp.json().catch(()=> ({}));
      if (!resp.ok){ throw new Error(j?.error || 'Errore funzione'); }

      out.innerHTML = `<span class="ok">OK</span> — Inseriti <b>${j.inserted_events}</b> eventi e <b>${j.inserted_occurrences}</b> occorrenze`;
    }catch(e){
      err.textContent = String(e.message||e);
    }
  });
})();
</script>
</body>
</html>
