<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Importa Eventi — Stasera Qui</title>

  <!-- Font & base -->
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;600&display=swap" rel="stylesheet">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- PapaParse per CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Config condivisa del sito (deve definire window.APP_CONFIG.SUPABASE_URL / SUPABASE_ANON_KEY) -->
  <script src="/js/app-config.js?v=6"></script>

  <style>
    :root { --bg:#081623; --fg:#fff; --muted:#9bb0c3; --pin:#1E88E5; }
    *{box-sizing:border-box}
    body{margin:0;background:#000; font-family:Rubik,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial; color:var(--fg)}
    header{background:var(--bg); padding:20px 16px; border-bottom:1px solid #0f263a}
    .brand{display:flex; align-items:center; gap:12px}
    .pin{width:28px;height:28px;background:var(--pin);border-radius:8px}
    h1{margin:0;font-size:20px;font-weight:600}
    main{padding:18px; max-width:980px; margin:0 auto}
    .card{background:#0c1b2b;border:1px solid #14314a;border-radius:12px;padding:16px;margin-bottom:16px}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .col{flex:1 1 280px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"], input[type="file"], textarea, select{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid #18344d;
      background:#0a1826; color:#e7f0f8; font-size:14px
    }
    textarea{min-height:120px; resize:vertical}
    button{
      background:var(--pin); color:#fff; border:0; border-radius:10px; padding:10px 14px;
      font-weight:600; cursor:pointer
    }
    button[disabled]{opacity:0.5; cursor:not-allowed}
    table{width:100%; border-collapse:collapse; font-size:13px}
    th,td{padding:8px 10px; border-bottom:1px solid #14314a; vertical-align:top}
    th{position:sticky; top:0; background:#0f2236; z-index:1}
    .muted{color:var(--muted)}
    .ok{color:#66ffb2}
    .warn{color:#ffd166}
    .err{color:#ff6b6b}
    .small{font-size:12px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2b4f6b;background:#0c1e2e}
    details{border:1px dashed #20415d;border-radius:10px;padding:10px 12px}
    details>summary{cursor:pointer;font-weight:600}
    .grid-2{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    .progress{height:8px;background:#07101a;border-radius:999px;overflow:hidden;border:1px solid #1a3850}
    .bar{height:100%; background:linear-gradient(90deg,#1E88E5,#49a2ff); width:0%}
    .legend{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="pin"></div>
      <h1>Importa Eventi — Stasera Qui</h1>
    </div>
  </header>

  <main>
    <div class="card">
      <p class="muted small">Carica un CSV con intestazioni colonne come nel file che mi hai passato. Anteprima, controlli, poi importazione su Supabase (tabelle <code>events</code> e <code>occurrences</code>).</p>

      <div class="row">
        <div class="col">
          <label for="csvfile">Carica CSV</label>
          <input id="csvfile" type="file" accept=".csv">
        </div>
        <div class="col">
          <label>&nbsp;</label>
          <button id="parseBtn">Anteprima CSV</button>
        </div>
      </div>

      <details style="margin-top:12px">
        <summary>Oppure incolla righe CSV</summary>
        <textarea id="csvpaste" placeholder="Incolla qui il contenuto CSV (inclusa la riga header)…"></textarea>
      </details>
    </div>

    <div class="card">
      <div class="legend small">
        <span class="pill">Richiesti: titolo, data_inizio, indirizzo, citta, provincia</span>
        <span class="muted">Suggeriti: categoria, sottocategorie, orari, descrizione_breve</span>
      </div>
      <div id="previewWrap" style="margin-top:12px"></div>
    </div>

    <div class="card">
      <div class="grid-2">
        <div>
          <label>Modalità</label>
          <select id="mode">
            <option value="create">Crea sempre nuovi eventi</option>
            <option value="upsert">Evita duplicati (match: titolo+città+data_inizio)</option>
          </select>
        </div>
        <div>
          <label>Generazione occorrenze</label>
          <select id="occMode">
            <option value="daily">Giornaliera tra data_inizio e data_fine (inclusi)</option>
            <option value="single">Una sola occorrenza su data_inizio</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="col">
          <label class="small">Seleziona righe da importare</label>
          <div id="selectInfo" class="muted small">Nessuna riga caricata.</div>
        </div>
        <div class="col" style="display:flex; gap:8px; align-items:flex-end; justify-content:flex-end">
          <button id="importBtn" disabled>Importa selezionati</button>
          <button id="resetBtn" class="pill" style="border-color:#3a5b77">Reset</button>
        </div>
      </div>

      <div style="margin-top:14px">
        <div class="progress"><div class="bar" id="progBar"></div></div>
        <div id="log" class="small muted" style="margin-top:8px; white-space:pre-wrap;"></div>
      </div>
    </div>

    <details class="card">
      <summary>ⓘ MAPPATURA CAMPI (modifica solo se i nomi nel database sono diversi)</summary>
      <pre class="small muted" id="mappingView"></pre>
    </details>
  </main>

<script>
(function(){
  // =========================
  // CONFIG / SUPABASE CLIENT
  // =========================
  if(!window.APP_CONFIG || !APP_CONFIG.SUPABASE_URL || !APP_CONFIG.SUPABASE_ANON_KEY){
    alert("app-config.js non trovato o privo di SUPABASE_URL / SUPABASE_ANON_KEY.");
  }
  const supabase = window.supabase.createClient(APP_CONFIG.SUPABASE_URL, APP_CONFIG.SUPABASE_ANON_KEY, {
    auth: { persistSession: false }
  });

  // =========================
  // MAPPATURA COLONNE CSV -> DB
  // =========================
  // CSV headers reali dal tuo file allegato:
  // titolo, categoria, sottocategorie, data_inizio, data_fine, ora_inizio, ora_fine,
  // indirizzo, citta, provincia, descrizione_breve, prezzo_testo,
  // referente_nome, referente_tel, referente_email, sito_evento, evento_esteso_flag, locandina_url
  //
  // Adatta qui i nomi DB se i tuoi sono diversi.
  const MAP = {
    // Tabella EVENTS
    eventsTable: "events",
    events: {
      title:            "title",
      category:         "category",
      subcategories:    "subcategories",   // array di stringhe
      address:          "address",
      city:             "city",
      province:         "province",
      region:           "region",          // opzionale: deriviamo NULL (puoi popolarla in seguito)
      description:      "description_short",
      price_text:       "price_text",
      contact_name:     "contact_name",
      contact_phone:    "contact_phone",
      contact_email:    "contact_email",
      website_url:      "website_url",
      is_extended:      "is_evento_esteso",
      cover_image_url:  "cover_image_url",
      // per deduplica/ricerche:
      slug:             "slug"             // opzionale: se esiste, lo creiamo
    },

    // Tabella OCCURRENCES
    occTable: "occurrences",
    occurrences: {
      event_id:   "event_id",
      date:       "date",        // se hai start_date/end_date separati, adatta qui
      start_time: "start_time",
      end_time:   "end_time"
    },

    // Colonne CSV attese -> alias locali
    csv: {
      titolo: "titolo",
      categoria: "categoria",
      sottocategorie: "sottocategorie",
      data_inizio: "data_inizio",
      data_fine: "data_fine",
      ora_inizio: "ora_inizio",
      ora_fine: "ora_fine",
      indirizzo: "indirizzo",
      citta: "citta",
      provincia: "provincia",
      descrizione_breve: "descrizione_breve",
      prezzo_testo: "prezzo_testo",
      referente_nome: "referente_nome",
      referente_tel: "referente_tel",
      referente_email: "referente_email",
      sito_evento: "sito_evento",
      evento_esteso_flag: "evento_esteso_flag",
      locandina_url: "locandina_url"
    }
  };

  document.getElementById("mappingView").textContent = JSON.stringify(MAP, null, 2);

  // =========================
  // HELPER
  // =========================
  const $ = (sel)=>document.querySelector(sel);
  const previewWrap = $("#previewWrap");
  const parseBtn = $("#parseBtn");
  const importBtn = $("#importBtn");
  const resetBtn = $("#resetBtn");
  const progBar = $("#progBar");
  const logEl = $("#log");
  const selectInfo = $("#selectInfo");
  const modeSel = $("#mode");
  const occModeSel = $("#occMode");

  let rows = [];            // righe CSV parsed (oggetti)
  let selectedIdx = new Set(); // indici selezionati per import
  let csvHeaders = [];

  function log(msg, type="info"){
    const color = type==="error"?"err":(type==="warn"?"warn":"muted");
    logEl.innerHTML += `<div class="${color}">${msg}</div>`;
    logEl.scrollTop = logEl.scrollHeight;
  }
  function setProgress(pct){
    progBar.style.width = Math.max(0, Math.min(100, pct)) + "%";
  }
  function norm(t){ return (t??"").toString().trim(); }
  function isEmpty(v){ return v===null || v===undefined || norm(v)===""; }
  function toBool(v){
    if (typeof v==="number") return v!==0;
    const s = norm(v).toLowerCase();
    return ["1","true","si","sì","yes","y"].includes(s);
  }
  function parseDate(s){
    // atteso YYYY-MM-DD
    const n = norm(s);
    if(!n) return null;
    // quick sanity
    if(!/^\d{4}-\d{2}-\d{2}$/.test(n)) return null;
    const d = new Date(n+"T00:00:00");
    return isNaN(d.getTime())?null:d;
  }
  function* eachDay(d1,d2){
    const dd = new Date(d1.getTime());
    while(dd <= d2){
      yield new Date(dd);
      dd.setDate(dd.getDate()+1);
    }
  }
  function makeSlug(str){
    return norm(str).toLowerCase()
      .replace(/[àáâä]/g,"a").replace(/[èéêë]/g,"e").replace(/[ìíîï]/g,"i")
      .replace(/[òóôö]/g,"o").replace(/[ùúûü]/g,"u").replace(/[^a-z0-9]+/g,"-")
      .replace(/(^-|-$)/g,"");
  }

  // =========================
  // PARSE CSV
  // =========================
  parseBtn.addEventListener("click", ()=>{
    logEl.textContent = "";
    setProgress(0);
    const file = document.getElementById("csvfile").files[0];
    const pasted = document.getElementById("csvpaste").value.trim();

    if(!file && !pasted){
      alert("Carica un file CSV oppure incolla il contenuto CSV.");
      return;
    }

    const papaOpts = {
      header: true,
      skipEmptyLines: true,
      transformHeader: h => h.trim(),
      complete: onParsed,
      error: err => { log("Errore parsing CSV: "+err.message, "error"); }
    };

    if(file){
      Papa.parse(file, papaOpts);
    } else {
      Papa.parse(pasted, papaOpts);
    }
  });

  function onParsed(res){
    rows = res.data.map(r => Object.fromEntries(Object.entries(r).map(([k,v])=>[k.trim(), v])));
    csvHeaders = res.meta?.fields||[];
    if(!rows.length){
      previewWrap.innerHTML = `<div class="muted">Nessuna riga valida rilevata.</div>`;
      importBtn.disabled = true;
      selectInfo.textContent = "Nessuna riga caricata.";
      return;
    }
    drawPreview();
  }

  function drawPreview(){
    selectedIdx = new Set(rows.map((_,i)=>i)); // seleziona tutto di default
    selectInfo.textContent = `${selectedIdx.size} righe selezionate su ${rows.length}.`;

    // Validazione minima
    const miss = [];
    ["titolo","data_inizio","indirizzo","citta","provincia"].forEach(h=>{
      if(!csvHeaders.includes(h)) miss.push(h);
    });
    const missHtml = miss.length ? `<div class="err small">ATTENZIONE: mancano colonne richieste: ${miss.join(", ")}</div>` : "";

    // Tabella anteprima (prime 50 righe per non appesantire)
    const maxShow = Math.min(rows.length, 50);
    const headers = [
      "Sel","titolo","categoria","sottocategorie",
      "data_inizio","data_fine","ora_inizio","ora_fine",
      "indirizzo","citta","provincia",
      "descrizione_breve","prezzo_testo",
      "referente_nome","referente_tel","referente_email",
      "sito_evento","evento_esteso_flag","locandina_url"
    ].filter(h=>csvHeaders.includes(h) || ["Sel"].includes(h));

    let thead = headers.map(h=>`<th>${h}</th>`).join("");
    let tbody = "";
    for(let i=0;i<maxShow;i++){
      const r = rows[i];
      const cells = headers.map(h=>{
        if(h==="Sel"){
          return `<td><input type="checkbox" data-idx="${i}" class="rowSel" checked></td>`;
        }
        const v = r[h] ?? "";
        return `<td>${String(v).length>120 ? `<span title="${String(v).replace(/"/g,'&quot;')}">${String(v).slice(0,120)}…</span>` : String(v)}</td>`;
      }).join("");
      tbody += `<tr>${cells}</tr>`;
    }

    previewWrap.innerHTML = `
      ${missHtml}
      <div class="small muted" style="margin-bottom:8px">Visualizzate ${maxShow}/${rows.length} righe (tutte saranno importabili).</div>
      <table>
        <thead><tr>${thead}</tr></thead>
        <tbody>${tbody}</tbody>
      </table>
    `;

    previewWrap.querySelectorAll(".rowSel").forEach(cb=>{
      cb.addEventListener("change", (e)=>{
        const idx = Number(e.target.getAttribute("data-idx"));
        if(e.target.checked) selectedIdx.add(idx); else selectedIdx.delete(idx);
        selectInfo.textContent = `${selectedIdx.size} righe selezionate su ${rows.length}.`;
        importBtn.disabled = selectedIdx.size===0;
      });
    });

    importBtn.disabled = selectedIdx.size===0 || miss.length>0;
  }

  resetBtn.addEventListener("click", ()=>{
    rows = [];
    selectedIdx.clear();
    document.getElementById("csvfile").value = "";
    document.getElementById("csvpaste").value = "";
    previewWrap.innerHTML = "";
    selectInfo.textContent = "Nessuna riga caricata.";
    importBtn.disabled = true;
    logEl.textContent = "";
    setProgress(0);
  });

  // =========================
  // IMPORT
  // =========================
  importBtn.addEventListener("click", async ()=>{
    if(selectedIdx.size===0){ alert("Seleziona almeno una riga."); return; }
    logEl.textContent = "";
    setProgress(0);

    const idxList = Array.from(selectedIdx.values());
    const total = idxList.length;
    let ok=0, skip=0, fail=0;

    for(let n=0; n<idxList.length; n++){
      const i = idxList[n];
      const r = rows[i];

      try{
        // --- Estrazione & normalizzazione ---
        const titolo  = norm(r[MAP.csv.titolo]);
        const cat     = norm(r[MAP.csv.categoria]);
        const subcats = norm(r[MAP.csv.sottocategorie]);
        const di      = parseDate(r[MAP.csv.data_inizio]);
        const df      = parseDate(r[MAP.csv.data_fine]) || di;
        const tStart  = norm(r[MAP.csv.ora_inizio]) || null;
        const tEnd    = norm(r[MAP.csv.ora_fine]) || null;
        const addr    = norm(r[MAP.csv.indirizzo]);
        const citta   = norm(r[MAP.csv.citta]);
        const prov    = norm(r[MAP.csv.provincia]);
        const desc    = norm(r[MAP.csv.descrizione_breve]);
        const price   = norm(r[MAP.csv.prezzo_testo]);
        const refN    = norm(r[MAP.csv.referente_nome]);
        const refT    = norm(r[MAP.csv.referente_tel]);
        const refE    = norm(r[MAP.csv.referente_email]);
        const site    = norm(r[MAP.csv.sito_evento]);
        const esteso  = toBool(r[MAP.csv.evento_esteso_flag]);
        const cover   = norm(r[MAP.csv.locandina_url]);

        if(isEmpty(titolo) || !di || isEmpty(addr) || isEmpty(citta) || isEmpty(prov)){
          fail++; log(`Riga ${i+1}: campi richiesti mancanti (titolo/data_inizio/indirizzo/citta/provincia).`, "error");
          setProgress(Math.round((n+1)*100/total)); continue;
        }

        const subsArr = subcats ? subcats.split(",").map(s=>norm(s)).filter(Boolean) : [];

        // --- Deduplica (modalità upsert) ---
        let existingId = null;
        if(modeSel.value === "upsert"){
          const diStr = di.toISOString().slice(0,10);
          const { data: found, error: qErr } = await supabase
            .from(MAP.eventsTable)
            .select("id, "+MAP.events.title+" , "+MAP.events.city+", created_at")
            .ilike(MAP.events.title, titolo)
            .ilike(MAP.events.city, citta)
            .limit(1);
          if(qErr){ throw qErr; }
          if(found && found.length){
            existingId = found[0].id;
          }
        }

        // --- INSERT/UPDATE events ---
        const payloadEvent = {};
        payloadEvent[MAP.events.title] = titolo;
        if(MAP.events.category)      payloadEvent[MAP.events.category] = cat || null;
        if(MAP.events.subcategories) payloadEvent[MAP.events.subcategories] = subsArr.length? subsArr : null;
        if(MAP.events.address)       payloadEvent[MAP.events.address] = addr;
        if(MAP.events.city)          payloadEvent[MAP.events.city] = citta;
        if(MAP.events.province)      payloadEvent[MAP.events.province] = prov;
        if(MAP.events.region)        payloadEvent[MAP.events.region] = null; // opzionale
        if(MAP.events.description)   payloadEvent[MAP.events.description] = desc || null;
        if(MAP.events.price_text)    payloadEvent[MAP.events.price_text] = price || null;
        if(MAP.events.contact_name)  payloadEvent[MAP.events.contact_name] = refN || null;
        if(MAP.events.contact_phone) payloadEvent[MAP.events.contact_phone] = refT || null;
        if(MAP.events.contact_email) payloadEvent[MAP.events.contact_email] = refE || null;
        if(MAP.events.website_url)   payloadEvent[MAP.events.website_url] = site || null;
        if(MAP.events.is_extended)   payloadEvent[MAP.events.is_extended] = esteso;
        if(MAP.events.cover_image_url) payloadEvent[MAP.events.cover_image_url] = cover || null;
        if(MAP.events.slug)          payloadEvent[MAP.events.slug] = makeSlug(`${titolo}-${citta}-${di.toISOString().slice(0,10)}`);

        let eventId = existingId;
        if(existingId){
          const { error: upErr } = await supabase.from(MAP.eventsTable).update(payloadEvent).eq("id", existingId);
          if(upErr) throw upErr;
        } else {
          const { data: ins, error: insErr } = await supabase
            .from(MAP.eventsTable)
            .insert(payloadEvent)
            .select("id")
            .single();
          if(insErr) throw insErr;
          eventId = ins.id;
        }

        // --- OCCORRENZE ---
        if(eventId){
          // opzionale: cancella occorrenze esistenti in upsert (per rigenerare pulito)
          if(existingId && modeSel.value==="upsert"){
            await supabase.from(MAP.occTable).delete().eq(MAP.occurrences.event_id, eventId);
          }

          const occs = [];
          if(occModeSel.value==="single"){
            const diStr = di.toISOString().slice(0,10);
            const occ = {};
            occ[MAP.occurrences.event_id] = eventId;
            occ[MAP.occurrences.date] = diStr;
            if(MAP.occurrences.start_time) occ[MAP.occurrences.start_time] = tStart || null;
            if(MAP.occurrences.end_time)   occ[MAP.occurrences.end_time] = tEnd || null;
            occs.push(occ);
          } else {
            const end = df || di;
            for(const d of eachDay(di, end)){
              const dStr = d.toISOString().slice(0,10);
              const occ = {};
              occ[MAP.occurrences.event_id] = eventId;
              occ[MAP.occurrences.date] = dStr;
              if(MAP.occurrences.start_time) occ[MAP.occurrences.start_time] = tStart || null;
              if(MAP.occurrences.end_time)   occ[MAP.occurrences.end_time] = tEnd || null;
              occs.push(occ);
            }
          }

          if(occs.length){
            // Inserimento batch a chunk per non superare limiti
            const chunkSize = 500;
            for(let k=0; k<occs.length; k+=chunkSize){
              const slice = occs.slice(k, k+chunkSize);
              const { error: occErr } = await supabase.from(MAP.occTable).insert(slice);
              if(occErr) throw occErr;
            }
          }
        }

        ok++;
        log(`Riga ${i+1}: OK — ${titolo} (${citta})`);
      } catch(e){
        fail++;
        log(`Riga ${i+1}: ERRORE — ${e.message||e}`, "error");
      }

      setProgress(Math.round((n+1)*100/total));
    }

    const msg = `Completato. OK: ${ok} — Fallite: ${fail} — Saltate: ${skip}`;
    log(msg, fail ? "warn" : "info");
    alert(msg);
  });
})();
</script>
</body>
</html>
