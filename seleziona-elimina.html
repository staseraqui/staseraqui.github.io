<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Modifica & Elimina ‚Äî Stasera Qui</title>

  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/style.css?v=12">

  <!-- Leaflet (fallback) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Supabase (jsdelivr, stabile) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Config condivisa -->
  <script src="assets/app-config.js?v=6"></script>

  <style>
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    #map{height:62vh;border-radius:12px;border:1px solid rgba(255,255,255,.15);margin-bottom:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.25);padding:6px 10px;border-radius:999px;background:#0f1c2d}
    .list{margin-top:8px;background:#0f1c2d;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:10px;max-height:22vh;overflow:auto;font-size:14px}
    .item{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,.12)}
    .item:last-child{border-bottom:none}
    .muted{color:#b8c2ce}
    .help{font-size:13px;color:#b8c2ce;margin:4px 0 0}

    /* Modali */
    .modal{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;background:rgba(0,0,0,.5);z-index:99999}
    .modal .box{margin-top:60px;background:#0f1c2d;border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:14px;min-width:320px;max-width:1100px;width:92%}
    .filters{display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:8px}
    @media (max-width:780px){ .filters{grid-template-columns:1fr 1fr;grid-auto-rows:auto} }
    .results{margin-top:10px;max-height:48vh;overflow:auto;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:8px;background:#0b1623}
    .row{display:flex;gap:8px;justify-content:space-between;align-items:center;border-bottom:1px dashed rgba(255,255,255,.1);padding:8px 0}
    .row:last-child{border-bottom:none}
    .pillCat{display:inline-block;background:#17304d;border:1px solid #2e6e8f;color:#d7f2ff;padding:4px 8px;border-radius:999px;font-size:12px;margin-right:6px}

    /* Giallo su "Elimina definitivamente" */
    .btn.warning{background:var(--primary); border-color:var(--primary-border); color:#081421; font-weight:800}
    .btn.ghost{background:#111f31;border:1px solid rgba(255,255,255,.25);color:#fff}

    /* Overlay login semplice */
    #authGate{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:999999}
    #authBox{background:#0f1c2d;border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:16px;max-width:360px;width:92%}
    #authBox h3{margin:0 0 8px}
    #authErr{color:#ff9a9a;margin-top:8px;display:none}

    /* ====== MODIFICA ====== */
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:840px){ .form-grid{grid-template-columns:1fr} }
    .form-grid textarea{min-height:120px}
    .cats{display:flex;gap:6px;flex-wrap:wrap}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.25);background:#0f1c2d;cursor:pointer}
    .chip.on{outline:3px solid #ffd24d}
    .tbl{width:100%;border-collapse:collapse}
    .tbl th,.tbl td{border:1px solid rgba(255,255,255,.15);padding:6px;vertical-align:top}
    .tbl th{background:#0f1c2d}
    .smallmuted{font-size:12px;color:#b8c2ce}
  </style>
</head>
<body>
<header class="header" style="padding:0 16px">
  <a href="admin.html" class="logo" aria-label="Torna all'area admin">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true">
      <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/>
      <circle cx="32" cy="24" r="9" fill="#ffffff"/>
    </svg>
    <span class="wordmark">stasera qui</span>
  </a>
</header>

<main class="wrap">
  <h1 style="margin:8px 0 10px">Seleziona, <span style="color:#ffd24d">modifica</span> o elimina eventi</h1>
  <p class="help">Tocca/clicca i pin per selezionare gli eventi. Poi puoi <b>Modificare</b>, <b>Nascondere</b> (soft: <i>published=false</i>) oppure <b>Eliminare definitivamente</b> (cestino con <i>deleted_at</i>; gli <b>scaduti</b> non si ripristinano).</p>

  <div id="map"></div>

  <div class="toolbar" style="margin-bottom:8px">
    <span class="badge">Selezionati: <b id="selCount">0</b></span>
    <button class="btn" id="clearSel" type="button">Pulisci selezione</button>
    <span class="muted" id="lastAction"></span>
  </div>

  <div class="list" id="selList" aria-live="polite"></div>

  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
    <button class="btn primary" id="btnEdit"  type="button">Modifica eventi selezionati</button>
    <button class="btn accent"  id="btnSoft"  type="button">Nascondi (published=false)</button>
    <button class="btn warning" id="btnHard"  type="button">Elimina definitivamente ‚Üí Cestino</button>
    <a class="btn" href="admin.html">‚Üê Torna all‚Äôarea admin</a>
  </div>

  <hr class="divider">

  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
    <button class="btn" id="btnViewHidden" type="button">üîé Vedi eventi nascosti</button>
    <button class="btn" id="btnViewDeleted" type="button">üóëÔ∏è Cestino eventi (eliminati)</button>
  </div>
</main>

<!-- MODALE: Nascosti (invariato) -->
<div id="modalHidden" class="modal" aria-hidden="true">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <h3 style="margin:0">Eventi nascosti (published=false)</h3>
      <button class="btn" data-close="modalHidden" type="button">Chiudi</button>
    </div>

    <div class="filters" style="margin:10px 0">
      <div><label class="small">Dal (data evento)</label><input type="date" id="hFrom"></div>
      <div><label class="small">Al (data evento)</label><input type="date" id="hTo"></div>
      <div><label class="small">Citt√†</label><input id="hCity" placeholder="Es. Torino"></div>
      <div>
        <label class="small">Categoria</label>
        <select id="hCat">
          <option value="">Tutte</option>
          <option>Musica</option><option>Food & Drink</option><option>Nightlife</option>
          <option>Cultura/Spettacolo</option><option>Famiglie & Bambini</option>
          <option>Sport</option><option>Sagre & Fiere</option><option>Mercatini</option>
        </select>
      </div>
      <div style="display:flex;gap:6px;align-items:flex-end">
        <button class="btn primary" id="hFilter" type="button">Filtra</button>
        <button class="btn ghost"   id="hReset"  type="button">Azzera</button>
      </div>
    </div>

    <div class="results" id="hResults" aria-live="polite"></div>
  </div>
</div>

<!-- MODALE: Eliminati (cestino) ‚Äî invariato -->
<div id="modalDeleted" class="modal" aria-hidden="true">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <h3 style="margin:0">Cestino ‚Äî Eventi eliminati</h3>
      <button class="btn" data-close="modalDeleted" type="button">Chiudi</button>
    </div>

    <div class="filters" style="margin:10px 0">
      <div><label class="small">Dal (data evento)</label><input type="date" id="dFrom"></div>
      <div><label class="small">Al (data evento)</label><input type="date" id="dTo"></div>
      <div><label class="small">Citt√†</label><input id="dCity" placeholder="Es. Genova"></div>
      <div>
        <label class="small">Categoria</label>
        <select id="dCat">
          <option value="">Tutte</option>
          <option>Musica</option><option>Food & Drink</option><option>Nightlife</option>
          <option>Cultura/Spettacolo</option><option>Famiglie & Bambini</option>
          <option>Sport</option><option>Sagre & Fiere</option><option>Mercatini</option>
        </select>
      </div>
      <div style="display:flex;gap:6px;align-items:flex-end">
        <button class="btn primary" id="dFilter" type="button">Filtra</button>
        <button class="btn ghost"   id="dReset"  type="button">Azzera</button>
      </div>
    </div>

    <div class="results" id="dResults" aria-live="polite"></div>
    <p class="small" style="margin-top:8px;opacity:.8">Gli eventi ‚Äúscaduti‚Äù (tutte le date &lt; oggi) non sono ripristinabili; puoi solo eliminarli definitivamente.</p>
  </div>
</div>

<!-- OVERLAY LOGIN (email + password) ‚Äî invariato -->
<div id="authGate" aria-hidden="true">
  <div id="authBox">
    <h3>Accedi</h3>
    <p class="small" style="margin-top:0">Usa la tua email e password.</p>
    <label class="small">Email</label>
    <input id="authEmail" placeholder="es. andrea.cordero@staseraqui.it">
    <label class="small">Password</label>
    <input id="authPass" type="password" placeholder="Password">
    <div class="footer-actions" style="justify-content:flex-end;margin-top:10px">
      <button class="btn primary" id="authLogin" type="button">Entra</button>
    </div>
    <div id="authErr" class="small"></div>
  </div>
</div>

<!-- MODALE: Modifica eventi selezionati -->
<div id="modalEdit" class="modal" aria-hidden="true">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <h3 id="edHdr" style="margin:0">Modifica eventi selezionati</h3>
      <button class="btn" data-close="modalEdit" type="button">Chiudi</button>
    </div>

    <div id="edNav" class="smallmuted" style="margin:6px 0 10px"></div>

    <div id="edForm">
      <!-- il form viene generato via JS -->
    </div>
  </div>
</div>

<script>
(async function(){
  // ====== CONFIG / SUPABASE ======
  const CFG = window.SQ_CONFIG || {};
  const SB_URL  = CFG.SUPABASE_URL;
  const SB_ANON = CFG.SUPABASE_ANON;
  const GMAPS_KEY = CFG.GOOGLE_MAPS_API_KEY;
  const hasGoogleKey = GMAPS_KEY && !/^INSERISCI_/.test(GMAPS_KEY);

  if (!SB_URL || !SB_ANON) alert('Configurazione Supabase mancante (assets/app-config.js).');
  const sb = supabase.createClient(SB_URL, SB_ANON, {
    auth: { persistSession: true, autoRefreshToken: true }
  });

  // ====== LOGIN SOLO PASSWORD ======
  const AUTH_EMAIL_WHITELIST = ['andrea.cordero@staseraqui.it']; // aggiungi qui eventuali altri admin

  async function requireLogin(){
    const { data:{ session } } = await sb.auth.getSession();
    if (session && AUTH_EMAIL_WHITELIST.includes(session.user.email)) {
      document.getElementById('authGate').style.display='none';
      return true;
    }
    const gate = document.getElementById('authGate');
    const email = document.getElementById('authEmail');
    const pass  = document.getElementById('authPass');
    const btn   = document.getElementById('authLogin');
    const err   = document.getElementById('authErr');

    gate.style.display='flex';
    email.value = AUTH_EMAIL_WHITELIST[0] || '';
    err.style.display='none'; err.textContent='';

    return new Promise((resolve)=>{
      btn.onclick = async ()=>{
        err.style.display='none'; err.textContent='';
        const e = (email.value||'').trim();
        const p = pass.value||'';
        if (!e || !p){ err.textContent='Inserisci email e password.'; err.style.display='block'; return; }
        try{
          const { data, error } = await sb.auth.signInWithPassword({ email:e, password:p });
          if (error){ err.textContent = error.message || 'Accesso non riuscito.'; err.style.display='block'; return; }
          if (!AUTH_EMAIL_WHITELIST.includes(data.user.email)) {
            await sb.auth.signOut();
            err.textContent='Utente non autorizzato per questa pagina.'; err.style.display='block'; return;
          }
          gate.style.display='none';
          resolve(true);
        }catch(ex){
          err.textContent = String(ex && ex.message || ex); err.style.display='block';
        }
      };
    });
  }

  // ====== UTILS ======
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const todayISO = () => new Date().toISOString().slice(0,10);
  const getTitle = e => e.title || e.titolo || '(evento)';
  const getCats  = e => Array.isArray(e.categories) ? e.categories : (Array.isArray(e.categorie) ? e.categorie : []);

  // ====== Categorie standard ======
  const CATS = ['Musica','Food & Drink','Sagre & Fiere','Famiglie & Bambini','Sport','Nightlife','Cultura/Spettacolo','Mercatini'];

  // ====== MAPPE: Google (preferito) con fallback OSM ======
  let USE_GMAPS = false;
  let GMAPS = { map:null, markers:new Map(), bounds:null };
  let LEAF  = { map:null, pinIcon:null, markers:new Map() };

  function pinSvgUrl(color = '#22b3f0', outline = '#ffffff'){
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 72">
      <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z"
            fill="${color}" stroke="${outline}" stroke-width="3"/>
      <circle cx="32" cy="24" r="9" fill="#ffffff"/>
    </svg>`;
    return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
  }
  const ICON_NORMAL   = pinSvgUrl('#22b3f0', '#ffffff');
  const ICON_SELECTED = pinSvgUrl('#22b3f0', '#ffd24d');

  function setupMap(){
    if (hasGoogleKey){
      USE_GMAPS = true;
      const s = document.createElement('script');
      s.src = `https://maps.googleapis.com/maps/api/js?key=${GMAPS_KEY}&v=quarterly`;
      s.async = true; s.defer = true;
      s.onload = initGoogle;
      s.onerror = ()=>{ console.warn('Google Maps KO ‚Üí fallback OSM'); USE_GMAPS=false; initLeaf(); };
      document.head.appendChild(s);
      setTimeout(()=>{ if(!GMAPS.map && USE_GMAPS){ console.warn('Timeout Google ‚Üí OSM'); USE_GMAPS=false; initLeaf(); }}, 4000);
    } else {
      initLeaf();
    }
  }
  function initGoogle(){
    GMAPS.map = new google.maps.Map(document.getElementById('map'), {
      center:{lat:45.0703, lng:7.6869}, zoom:6, mapTypeControl:false, streetViewControl:false
    });
    GMAPS.bounds = new google.maps.LatLngBounds();
  }
  function gAddMarker(eventId, lat, lng, title){
    const m = new google.maps.Marker({
      position:{lat,lng}, map: GMAPS.map,
      icon:{ url: ICON_NORMAL, scaledSize:new google.maps.Size(34,38), anchor:new google.maps.Point(19,38) },
      title
    });
    m.addListener('click', ()=> toggleSelect(eventId));
    if (!GMAPS.markers.has(eventId)) GMAPS.markers.set(eventId, []);
    GMAPS.markers.get(eventId).push(m);
    GMAPS.bounds.extend(new google.maps.LatLng(lat,lng));
  }
  function gClearMarkers(){
    GMAPS.markers.forEach(list=> list.forEach(m=> m.setMap(null)));
    GMAPS.markers.clear();
    GMAPS.bounds = new google.maps.LatLngBounds();
  }
  function gFit(){ if (!GMAPS.bounds.isEmpty()) GMAPS.map.fitBounds(GMAPS.bounds); }
  function gSetSelected(eventId, on){
    (GMAPS.markers.get(eventId)||[]).forEach(m=>{
      m.setIcon({
        url: on ? ICON_SELECTED : ICON_NORMAL,
        scaledSize:new google.maps.Size(34,38),
        anchor:new google.maps.Point(19,38)
      });
    });
  }

  function initLeaf(){
    LEAF.map = L.map('map', { attributionControl:false }).setView([45.0703,7.6869], 6);
    L.control.attribution({prefix:false}).addTo(LEAF.map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap contributors'}).addTo(LEAF.map);
    LEAF.pinIcon = L.divIcon({
      className:'sq-pin',
      html:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 72" width="30" height="34" style="display:block;filter:drop-shadow(0 0 2px #fff)">
              <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0" stroke="#ffffff" stroke-width="2"/>
              <circle cx="32" cy="24" r="9" fill="#ffffff"/></svg>`,
      iconSize:[30,34], iconAnchor:[15,34], popupAnchor:[0,-30]
    });
  }
  function lAddMarker(eventId, lat, lng, title){
    const m = L.marker([lat,lng], {icon:LEAF.pinIcon}).addTo(LEAF.map).bindPopup(`<div style="color:#081421"><b>${title}</b></div>`);
    m.on('click', ()=> toggleSelect(eventId));
    if (!LEAF.markers.has(eventId)) LEAF.markers.set(eventId, []);
    LEAF.markers.get(eventId).push(m);
  }
  function lClearMarkers(){
    LEAF.markers.forEach(list=> list.forEach(m=> LEAF.map.removeLayer(m)));
    LEAF.markers.clear();
  }
  function lFit(){
    const all = [];
    LEAF.markers.forEach(list=> list.forEach(m=> all.push(m.getLatLng())));
    if (all.length) LEAF.map.fitBounds(L.latLngBounds(all), {padding:[40,40]});
  }
  function lSetSelected(eventId, on){
    (LEAF.markers.get(eventId)||[]).forEach(m=>{
      const el = m.getElement(); if (!el) return;
      el.style.outline = on ? '3px solid #ffd24d' : '';
    });
  }

  // ======= Geocoding ibrido (Google ‚Üí OSM) per la MODIFICA =======
  async function geocodeAddrSmart(addr){
    const q=(addr||'').trim(); if(!q) return null;
    // 1) Google (se disponibile)
    try{
      if (window.google && google.maps){
        const geocoder = new google.maps.Geocoder();
        const g = await new Promise((resolve)=>{
          geocoder.geocode({ address:q, componentRestrictions:{ country:'IT' }, region:'it' }, (res, status)=>{
            if(status==='OK' && res && res[0]){
              const r = res[0], loc = r.geometry.location;
              resolve({ lat: loc.lat(), lng: loc.lng(), label: r.formatted_address });
            } else resolve(null);
          });
        });
        if (g) return g;
      }
    }catch(_){}
    // 2) OSM
    try{
      const url='https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=it&q='+encodeURIComponent(q);
      const r=await fetch(url,{headers:{'Accept-Language':'it'}});
      const j=await r.json();
      if (Array.isArray(j) && j.length){
        return { lat:parseFloat(j[0].lat), lng:parseFloat(j[0].lon), label:j[0].display_name };
      }
    }catch(_){}
    return null;
  }

  // ====== STATO & DATI ======
  const EVENTS = new Map();         // id -> { id, title, published, deleted_at, cats }
  const OCCS_BY_EVENT = new Map();  // id -> [ occ non cestinate ]
  const ALL_OCCS_BY_EVENT = new Map(); // id -> tutte le occ (anche cestinate)
  const SELECTED = new Set();
  function setSelectedIcon(id, on){ USE_GMAPS ? gSetSelected(id,on) : lSetSelected(id,on); }

  async function loadData(){
    // Eventi
    const { data: evs, error: evErr } = await sb
      .from('events')
      .select('id, title, titolo, description, descrizione, categories, categorie, locandina_url, published, deleted_at');
    if (evErr){ console.error(evErr); alert('Errore lettura events'); return; }

    // Occorrenze (tutte)
    const { data: occs, error: ocErr } = await sb
      .from('occurrences')
      .select('id, event_id, lat, lng, data, ora, luogo, indirizzo, citta, city, deleted_at');
    if (ocErr){ console.error(ocErr); alert('Errore lettura occurrences'); return; }

    EVENTS.clear();
    (evs||[]).forEach(e=>{
      EVENTS.set(e.id, {
        id: e.id,
        title: getTitle(e),
        raw: e, // per la modale di modifica
        published: e.published,
        deleted_at: e.deleted_at || null,
        cats: getCats(e)
      });
    });

    OCCS_BY_EVENT.clear();
    ALL_OCCS_BY_EVENT.clear();
    (occs||[]).forEach(o=>{
      if (!ALL_OCCS_BY_EVENT.has(o.event_id)) ALL_OCCS_BY_EVENT.set(o.event_id, []);
      ALL_OCCS_BY_EVENT.get(o.event_id).push(o);
      // mappa: solo occorrenze non cestinate E non scadute
      if (o.deleted_at) return;
      if (o.data && o.data < todayISO()) return;
      if (o.lat==null || o.lng==null) return;
      if (!OCCS_BY_EVENT.has(o.event_id)) OCCS_BY_EVENT.set(o.event_id, []);
      OCCS_BY_EVENT.get(o.event_id).push(o);
    });

    drawMarkers();
  }

  function drawMarkers(){
    if (USE_GMAPS){ gClearMarkers(); } else { lClearMarkers(); }
    SELECTED.clear();
    updateSelectionUI();

    OCCS_BY_EVENT.forEach((list, eventId)=>{
      const ev = EVENTS.get(eventId); if (!ev) return;
      if (ev.deleted_at || ev.published !== true) return; // mappa SOLO attivi
      list.forEach(occ=>{
        if (USE_GMAPS) gAddMarker(eventId, occ.lat, occ.lng, ev.title);
        else           lAddMarker(eventId, occ.lat, occ.lng, ev.title);
      });
    });

    if (USE_GMAPS) gFit(); else lFit();
  }

  // ====== SELEZIONE ======
  function toggleSelect(eventId){
    if (!EVENTS.has(eventId)) return;
    const on = !SELECTED.has(eventId);
    if (on) SELECTED.add(eventId); else SELECTED.delete(eventId);
    setSelectedIcon(eventId, on);
    updateSelectionUI();
  }
  $('#clearSel').addEventListener('click', ()=>{
    [...SELECTED].forEach(id=> setSelectedIcon(id,false));
    SELECTED.clear();
    updateSelectionUI();
  });

  function updateSelectionUI(){
    $('#selCount').textContent = SELECTED.size;
    const box = $('#selList');
    if (!SELECTED.size){ box.innerHTML = '<div class="muted">Nessun evento selezionato.</div>'; return; }
    const rows = [...SELECTED].map(id=>{
      const ev = EVENTS.get(id);
      const occs = OCCS_BY_EVENT.get(id)||[];
      const city = occs[0]?.citta || occs[0]?.city || '';
      return `<div class="item">
        <div><b>${ev?.title||'(evento)'}</b> <span class="muted">‚Äî ${city}</span> <span class="muted" title="ID evento">${id}</span></div>
        <button class="btn small" data-unselect="${id}" type="button">Rimuovi</button>
      </div>`;
    }).join('');
    box.innerHTML = rows;
    box.querySelectorAll('[data-unselect]').forEach(b=>{
      b.addEventListener('click', ()=> toggleSelect(b.getAttribute('data-unselect')));
    });
  }

  // ====== AZIONI: soft/hard delete (invariato) ======
  async function softHide(){
    if (!SELECTED.size) { alert('Seleziona almeno un evento.'); return; }
    if (!confirm(`Nascondere ${SELECTED.size} evento/i? (published=false)`)) return;
    const ids = [...SELECTED];
    const { error } = await sb.from('events').update({ published:false }).in('id', ids);
    if (error){ alert('Errore: '+(error.message||String(error))); return; }
    ids.forEach(id=>{ const e=EVENTS.get(id); if (e){ e.published=false; } });
    drawMarkers();
    $('#lastAction').textContent = 'Fatto: eventi nascosti.';
  }

  async function hardDelete(){
    if (!SELECTED.size) { alert('Seleziona almeno un evento.'); return; }
    if (!confirm(`Spostare nel CESTINO ${SELECTED.size} evento/i?`)) return;
    const ids = [...SELECTED];
    const nowIso = new Date().toISOString();
    const r1 = await sb.from('occurrences').update({ deleted_at: nowIso }).in('event_id', ids);
    if (r1.error && String(r1.error.code)!=='42703'){ alert('Errore occorrenze: '+(r1.error.message||String(r1.error))); return; }
    const r2 = await sb.from('events').update({ deleted_at: nowIso, published:false }).in('id', ids);
    if (r2.error && String(r2.error.code)!=='42703'){ alert('Errore eventi: '+(r2.error.message||String(r2.error))); return; }
    ids.forEach(id=>{ const e=EVENTS.get(id); if (e){ e.deleted_at=nowIso; e.published=false; } });
    drawMarkers();
    $('#lastAction').textContent = 'Fatto: eventi nel cestino.';
  }

  $('#btnSoft').addEventListener('click', softHide);
  $('#btnHard').addEventListener('click', hardDelete);

  // ====== MODALI standard ======
  function openModal(id){ const m=$('#'+id); if(m) m.style.display='flex'; }
  function closeModal(id){ const m=$('#'+id); if(m) m.style.display='none'; }
  $$('[data-close]').forEach(b=> b.addEventListener('click', ()=> closeModal(b.getAttribute('data-close')) ));

  // --- Nascosti ---
  $('#btnViewHidden').addEventListener('click', ()=> { openModal('modalHidden'); renderHidden(); });
  $('#hReset').addEventListener('click', ()=>{ $('#hFrom').value=''; $('#hTo').value=''; $('#hCity').value=''; $('#hCat').value=''; renderHidden(); });
  $('#hFilter').addEventListener('click', renderHidden);

  async function renderHidden(){
    const from = $('#hFrom').value || null;
    const to   = $('#hTo').value   || null;
    const city = ($('#hCity').value||'').trim().toLowerCase();
    const cat  = $('#hCat').value || '';

    const { data: evs, error } = await sb.from('events')
      .select('id, title, titolo, published, deleted_at, categories, categorie')
      .eq('published', false).is('deleted_at', null);
    if (error){ $('#hResults').innerHTML = `<div class="small">Errore: ${error.message}</div>`; return; }

    const evFiltered = (evs||[]).filter(e=> !cat || getCats(e).includes(cat));
    const ids = evFiltered.map(e=>e.id);
    if (!ids.length){ $('#hResults').innerHTML = '<div class="small">Nessun evento nascosto.</div>'; return; }

    const { data: occs } = await sb.from('occurrences')
      .select('event_id, data, citta, city, deleted_at')
      .in('event_id', ids).is('deleted_at', null);

    const byEvent = new Map();
    (occs||[]).forEach(o=>{
      const d=o.data, c=(o.citta||o.city||'').toLowerCase();
      if (from && (!d || d<from)) return;
      if (to   && (!d || d>to))   return;
      if (city && !c.includes(city)) return;
      if (!byEvent.has(o.event_id)) byEvent.set(o.event_id, []);
      byEvent.get(o.event_id).push(o);
    });

    let html='';
    evFiltered.forEach(e=>{
      const occsOk = byEvent.get(e.id)||[];
      if ((from||to||city) && !occsOk.length) return;
      const cats = getCats(e);
      const cityTxt = occsOk[0]?.citta || occsOk[0]?.city || '';
      html += `<div class="row">
        <div>
          <div><b>${getTitle(e)}</b> <span class="muted">‚Äî ${cityTxt}</span> <span class="muted" title="ID evento">${e.id}</span></div>
          <div>${cats.map(c=>`<span class="pillCat">${c}</span>`).join('')}</div>
        </div>
        <div><button class="btn small" data-restore-hidden="${e.id}" type="button">Ripristina</button></div>
      </div>`;
    });
    $('#hResults').innerHTML = html || '<div class="small">Nessun evento nascosto per i filtri impostati.</div>';

    $$('#hResults [data-restore-hidden]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = b.getAttribute('data-restore-hidden');
        const r = await sb.from('events').update({ published:true }).eq('id', id);
        if (r.error){ alert('Errore ripristino: '+(r.error.message||String(r.error))); return; }
        $('#lastAction').textContent = 'Evento ripristinato.';
        await loadData(); renderHidden();
      });
    });
  }

  // --- Eliminati (Cestino) ---
  $('#btnViewDeleted').addEventListener('click', ()=> { openModal('modalDeleted'); renderDeleted(); });
  $('#dReset').addEventListener('click', ()=>{ $('#dFrom').value=''; $('#dTo').value=''; $('#dCity').value=''; $('#dCat').value=''; renderDeleted(); });
  $('#dFilter').addEventListener('click', renderDeleted);

  async function renderDeleted(){
    const from = $('#dFrom').value || null;
    const to   = $('#dTo').value   || null;
    const city = ($('#dCity').value||'').trim().toLowerCase();
    const cat  = $('#dCat').value || '';
    const today = todayISO();

    const rOcc = await sb.from('occurrences')
      .select('event_id, data, citta, city, deleted_at')
      .not('deleted_at','is',null);
    if (rOcc.error){ $('#dResults').innerHTML = `<div class="small">Errore: ${rOcc.error.message}</div>`; return; }
    const ids = [...new Set((rOcc.data||[]).map(o=>o.event_id))];

    let evs = [];
    if (ids.length){
      const rEv = await sb.from('events').select('id, title, titolo, published, deleted_at, categories, categorie').in('id', ids);
      if (!rEv.error) evs = rEv.data||[];
    }

    const evFiltered = evs.filter(e=> !cat || getCats(e).includes(cat));
    if (!evFiltered.length){ $('#dResults').innerHTML = '<div class="small">Cestino vuoto per i filtri impostati.</div>'; return; }

    const byEvent = new Map();
    (rOcc.data||[]).forEach(o=>{
      const c=(o.citta||o.city||'').toLowerCase();
      if (from && (!o.data || o.data<from)) return;
      if (to   && (!o.data || o.data>to))   return;
      if (city && !c.includes(city)) return;
      if (!byEvent.has(o.event_id)) byEvent.set(o.event_id, []);
      byEvent.get(o.event_id).push(o);
    });

    let html='';
    evFiltered.forEach(e=>{
      const occsAll = (ALL_OCCS_BY_EVENT.get(e.id)||[]);
      const hasFuture = occsAll.some(o => o.data && o.data >= today);
      const occsOk = byEvent.get(e.id)||[];
      if ((from||to||city) && !occsOk.length) return;

      const cats = getCats(e);
      const cityTxt = occsOk[0]?.citta || occsOk[0]?.city || '';

      html += `<div class="row">
        <div>
          <div><b>${getTitle(e)}</b> <span class="muted">‚Äî ${cityTxt||'‚Äî'}</span> <span class="muted" title="ID evento">${e.id}</span></div>
          <div>${cats.map(c=>`<span class="pillCat">${c}</span>`).join('')}</div>
        </div>
        <div>
          ${hasFuture
            ? `<button class="btn small" data-restore-deleted="${e.id}" type="button">Ripristina</button>
               <button class="btn warning small" data-hardpurge="${e.id}" type="button">Elimina definitivamente</button>`
            : `<button class="btn warning small" data-hardpurge="${e.id}" type="button">Elimina definitivamente</button>`
          }
        </div>
      </div>`;
    });

    $('#dResults').innerHTML = html || '<div class="small">Cestino vuoto per i filtri impostati.</div>';

    $$('#dResults [data-restore-deleted]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = b.getAttribute('data-restore-deleted');
        const r1 = await sb.from('occurrences').update({ deleted_at:null }).eq('event_id', id);
        if (r1.error && String(r1.error.code)!=='42703'){ alert('Errore ripristino occorrenze: '+(r1.error.message||String(r1.error))); return; }
        const r2 = await sb.from('events').update({ deleted_at:null, published:true }).eq('id', id);
        if (r2.error && String(r2.error.code)!=='42703'){ alert('Errore ripristino evento: '+(r2.error.message||String(r2.error))); return; }
        $('#lastAction').textContent = 'Evento ripristinato dal cestino.';
        await loadData(); renderDeleted();
      });
    });

    $$('#dResults [data-hardpurge]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = b.getAttribute('data-hardpurge');
        if (!confirm('Eliminare DEFINITIVAMENTE questo evento? Verr√† rimosso dal DB.')) return;
        try{
          await sb.from('occurrences').delete().eq('event_id', id);
          await sb.from('events').delete().eq('id', id);
        }catch(e){ alert('Errore: '+(e?.message||e)); return; }
        $('#lastAction').textContent = 'Evento eliminato definitivamente.';
        await loadData(); renderDeleted();
      });
    });
  }

  // ====== MODIFICA EVENTI ======
  const editModal = $('#modalEdit');
  let editIds = [];
  let editIndex = 0;
  let current = null; // { ev, occs:[], deleted:Set, added:[] }

  $('#btnEdit').addEventListener('click', openEdit);

  async function openEdit(){
    if (!SELECTED.size){ alert('Seleziona almeno un evento.'); return; }
    editIds = [...SELECTED];
    editIndex = 0;
    await loadEditItem();
    openModal('modalEdit');
  }

  async function loadEditItem(){
    const id = editIds[editIndex];
    const evRec = EVENTS.get(id)?.raw;
    if (!evRec){
      const { data } = await sb.from('events').select('*').eq('id', id).single();
      current = { ev:data, occs:[], deleted:new Set(), added:[] };
    } else {
      current = { ev: evRec, occs:[], deleted:new Set(), added:[] };
    }
    const { data: occs } = await sb.from('occurrences')
      .select('id,event_id,lat,lng,data,ora,luogo,indirizzo,citta,city,deleted_at')
      .eq('event_id', id).is('deleted_at', null).order('data');
    current.occs = (occs||[]).map(o=>({ ...o, city: o.citta || o.city || '' }));

    renderEditForm();
  }

  function renderEditForm(){
    const e = current.ev || {};
    const cats = getCats(e);
    const idxInfo = `Evento ${editIndex+1} di ${editIds.length} ‚Äî ID: ${e.id||'-'}`;
    $('#edNav').textContent = idxInfo;

    const checked = c => cats.includes(c) ? 'on' : '';

    const html = `
      <div class="form-grid">
        <div>
          <label>Titolo*</label>
          <input id="edTitle" value="${(e.title||e.titolo||'').replaceAll('"','&quot;')}">
        </div>
        <div>
          <label>Locandina (URL)</label>
          <input id="edPoster" value="${(e.locandina_url||'').replaceAll('"','&quot;')}">
        </div>
        <div style="grid-column:1/-1">
          <label>Descrizione</label>
          <textarea id="edDesc">${(e.description||e.descrizione||'').replaceAll('<','&lt;')}</textarea>
        </div>
        <div>
          <label>Categorie</label>
          <div class="cats" id="edCats">
            ${CATS.map(c=>`<span class="chip ${checked(c)}" data-cat="${c}">${c}</span>`).join('')}
          </div>
          <div class="smallmuted" style="margin-top:6px">Clicca per attivare/disattivare.</div>
        </div>
        <div>
          <label>Pubblicato</label>
          <select id="edPublished"><option value="true"${e.published===false?'':' selected'}>S√¨ (visibile)</option><option value="false"${e.published===false?' selected':''}>No (nascosto)</option></select>
        </div>
      </div>

      <h3 style="margin:14px 0 6px">Occorrenze</h3>
      <table class="tbl" id="edOccTbl" aria-label="Occorrenze">
        <thead><tr>
          <th>Data</th><th>Ora</th><th>Luogo</th><th>Indirizzo</th><th>Citt√†</th><th>Lat</th><th>Lng</th><th></th>
        </tr></thead>
        <tbody>
          ${current.occs.map((o,i)=>rowOccHtml(o,i)).join('')}
        </tbody>
      </table>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
        <button class="btn" id="edAddOcc" type="button">Aggiungi occorrenza</button>
        <span class="smallmuted">Suggerimento: dopo aver cambiato indirizzo/citt√†, usa ‚ÄúGeocoda‚Äù per compilare Lat/Lng.</span>
      </div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin-top:12px">
        <button class="btn" id="edPrev" ${editIndex===0?'disabled':''} type="button">‚óÄ Precedente</button>
        <button class="btn primary" id="edSave" type="button">üíæ Salva</button>
        <button class="btn" id="edNext" ${editIndex===editIds.length-1?'disabled':''} type="button">Successivo ‚ñ∂</button>
      </div>
    `;
    $('#edForm').innerHTML = html;

    // bind categorie
    $$('#edCats .chip').forEach(ch=>{
      ch.addEventListener('click', ()=> ch.classList.toggle('on'));
    });

    // bind occorrenze
    $('#edAddOcc').addEventListener('click', ()=>{
      current.occs.push({ id:null, event_id: current.ev.id, data:'', ora:'', luogo:'', indirizzo:'', city:'', lat:'', lng:'' });
      renderEditForm();
    });
    $$('#edOccTbl [data-del]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const i = parseInt(b.getAttribute('data-del'),10);
        const row = current.occs[i];
        if (row.id){ current.deleted = current.deleted || new Set(); current.deleted.add(row.id); }
        current.occs.splice(i,1);
        renderEditForm();
      });
    });
    $$('#edOccTbl [data-geocode]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const i = parseInt(b.getAttribute('data-geocode'),10);
        const tr = $('#edOccTbl tbody').children[i];
        const addr = (tr.querySelector('[data-f=indirizzo]').value||'') + ', ' + (tr.querySelector('[data-f=city]').value||'');
        const g = await geocodeAddrSmart(addr);
        if (g){
          tr.querySelector('[data-f=lat]').value = g.lat;
          tr.querySelector('[data-f=lng]').value = g.lng;
        }else{
          alert('Indirizzo non trovato.');
        }
      });
    });

    // nav & save
    $('#edPrev').addEventListener('click', async ()=>{ if(await saveEdit(false)) { editIndex--; await loadEditItem(); } });
    $('#edNext').addEventListener('click', async ()=>{ if(await saveEdit(false)) { editIndex++; await loadEditItem(); } });
    $('#edSave').addEventListener('click', async ()=>{ await saveEdit(true); });
  }

  function rowOccHtml(o,i){
    return `<tr>
      <td><input data-f="data" value="${o.data||''}" type="date"></td>
      <td><input data-f="ora"  value="${o.ora||''}"  placeholder="es. 21:00"></td>
      <td><input data-f="luogo" value="${o.luogo||''}"></td>
      <td><input data-f="indirizzo" value="${o.indirizzo||''}"></td>
      <td><input data-f="city" value="${o.citta||o.city||''}"></td>
      <td style="min-width:100px"><input data-f="lat" value="${o.lat??''}" placeholder="45.x"></td>
      <td style="min-width:100px"><input data-f="lng" value="${o.lng??''}" placeholder="7.x"></td>
      <td style="white-space:nowrap">
        <button class="btn small" data-geocode="${i}" type="button">Geocoda</button>
        <button class="btn small" data-del="${i}" type="button">Elimina</button>
      </td>
    </tr>`;
  }

  async function saveEdit(showAlert){
    try{
      // raccogli campi evento
      const title = ($('#edTitle').value||'').trim();
      if (!title){ alert('Inserisci un titolo.'); return false; }
      const desc  = ($('#edDesc').value||'').trim();
      const poster= ($('#edPoster').value||'').trim();
      const published = $('#edPublished').value==='true';
      const cats = $$('#edCats .chip.on').map(x=> x.getAttribute('data-cat'));

      const payload = {
        title, titolo:title,
        description:desc, descrizione:desc,
        categories:cats,  categorie:cats,
        locandina_url: poster || null,
        published
      };
      const r1 = await sb.from('events').update(payload).eq('id', current.ev.id);
      if (r1.error){ alert('Errore salvataggio evento: '+(r1.error.message||String(r1.error))); return false; }

      // raccogli occorrenze dalla tabella
      const rows = Array.from($('#edOccTbl tbody').children);
      const occs = rows.map(tr=>{
        const get = f => tr.querySelector(`[data-f="${f}"]`).value;
        return {
          id: current.occs[rows.indexOf(tr)]?.id || null,
          event_id: current.ev.id,
          data: (get('data')||'').trim() || null,
          ora: (get('ora')||'').trim(),
          luogo: (get('luogo')||'').trim(),
          indirizzo: (get('indirizzo')||'').trim(),
          citta: (get('city')||'').trim(),
          lat: get('lat') ? Number(get('lat')) : null,
          lng: get('lng') ? Number(get('lng')) : null
        };
      });

      // elimina quelli rimossi
      const toDelete = (current.deleted? Array.from(current.deleted) : []).filter(Boolean);
      if (toDelete.length){
        const rDel = await sb.from('occurrences').delete().in('id', toDelete);
        if (rDel.error){ alert('Errore eliminazione occorrenze: '+(rDel.error.message||String(rDel.error))); return false; }
      }

      // split update/insert
      const updates = occs.filter(o=> o.id);
      const inserts = occs.filter(o=> !o.id);

      for (const u of updates){
        const row = {
          data: u.data, ora: u.ora, luogo: u.luogo, indirizzo: u.indirizzo,
          citta: u.citta, city: u.citta, lat: u.lat, lng: u.lng
        };
        const ru = await sb.from('occurrences').update(row).eq('id', u.id);
        if (ru.error){ alert('Errore update occorrenza: '+(ru.error.message||String(ru.error))); return false; }
      }

      if (inserts.length){
        const rowsIns = inserts.map(o=>({
          event_id: current.ev.id,
          data: o.data, ora:o.ora, luogo:o.luogo, indirizzo:o.indirizzo,
          citta:o.citta, city:o.citta, lat:o.lat, lng:o.lng
        }));
        const ri = await sb.from('occurrences').insert(rowsIns);
        if (ri.error){ alert('Errore inserimento occorrenze: '+(ri.error.message||String(ri.error))); return false; }
      }

      // aggiorna cache locale e mappa
      await loadData();
      if (showAlert) { alert('Salvato.'); }
      $('#lastAction').textContent = 'Modifica salvata.';
      return true;
    }catch(e){
      alert('Errore salvataggio: '+(e?.message||e));
      return false;
    }
  }

  // ====== AVVIO (dopo login) ======
  const ok = await requireLogin();
  if (ok){
    setupMap();
    setTimeout(()=> loadData(), 300);
  }
})();
</script>
</body>
</html>
