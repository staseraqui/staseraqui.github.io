<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Seleziona & Elimina — Stasera Qui</title>

  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/style.css?v=12">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- Config condivisa -->
  <script src="assets/app-config.js?v=6"></script>

  <style>
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    #map{height:62vh;border-radius:12px;border:1px solid rgba(255,255,255,.15);margin-bottom:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.25);padding:6px 10px;border-radius:999px;background:#0f1c2d}
    .list{margin-top:8px;background:#0f1c2d;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:10px;max-height:22vh;overflow:auto;font-size:14px}
    .item{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,.12)}
    .item:last-child{border-bottom:none}
    .muted{color:#b8c2ce}
    .pin-btn{cursor:pointer}
    .pin-selected{outline:3px solid #ffd24d;box-shadow:0 0 0 3px rgba(255,210,77,.25)}
    .help{font-size:13px;color:#b8c2ce;margin:4px 0 0}
  </style>
</head>
<body>
<header class="header" style="padding:0 16px">
  <a href="admin.html" class="logo" aria-label="Torna all'area admin">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true">
      <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/>
      <circle cx="32" cy="24" r="9" fill="#ffffff"/>
    </svg>
    <span class="wordmark">stasera qui</span>
  </a>
</header>

<main class="wrap">
  <h1 style="margin:8px 0 10px">Seleziona & elimina eventi</h1>
  <p class="help">Tocca/clicca i pin per selezionare gli eventi. Poi scegli se <b>Nascondere</b> (soft-delete: <i>published=false</i>) oppure <b>Eliminare definitivamente</b> (hard-delete: rimuove anche le occorrenze).</p>

  <div id="map"></div>

  <div class="toolbar">
    <span class="badge">Selezionati: <b id="selCount">0</b></span>
    <button class="btn" id="clearSel" type="button">Pulisci selezione</button>
    <span class="muted" id="lastAction"></span>
  </div>

  <div class="list" id="selList" aria-live="polite"></div>

  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
    <button class="btn accent"  id="btnSoft" type="button">Nascondi (published=false)</button>
    <button class="btn danger"  id="btnHard" type="button">Elimina definitivamente</button>
    <a class="btn" href="admin.html">← Torna all’area admin</a>
  </div>
</main>

<script>
(function(){
  // --- Config/Supabase ---
  const CFG = window.SQ_CONFIG || {};
  const SB_URL  = CFG.SUPABASE_URL;
  const SB_ANON = CFG.SUPABASE_ANON;
  if (!SB_URL || !SB_ANON) {
    alert('Configurazione Supabase mancante (assets/app-config.js).');
  }
  const sb = supabase.createClient(SB_URL, SB_ANON);

  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  // --- Stato ---
  let MAP=null, PINICON=null;
  const EVENTS = new Map();      // idEvento -> { id, title/titolo, published }
  const OCCS_BY_EVENT = new Map(); // idEvento -> [ occorrenze ]
  const MARKERS = new Map();     // idEvento -> [markers Leaflet]
  const SELECTED = new Set();    // idEvento selezionati

  // --- Map UI ---
  function initMap(){
    MAP = L.map('map', { attributionControl:false }).setView([45.0703,7.6869], 6);
    L.control.attribution({prefix:false}).addTo(MAP);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap contributors'}).addTo(MAP);

    PINICON = L.divIcon({
      className:'sq-pin',
      html:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 72" width="30" height="34" style="display:block;filter:drop-shadow(0 0 2px #fff)">
              <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0" stroke="#ffffff" stroke-width="2"/>
              <circle cx="32" cy="24" r="9" fill="#ffffff"/></svg>`,
      iconSize:[30,34], iconAnchor:[15,34], popupAnchor:[0,-30]
    });
  }

  // --- Data load ---
  function isTruthyPub(v){ return (v===true || v===1 || v==='1' || v==='t' || v==='true' || v==='T' || v==='TRUE'); }

  async function loadData(){
    const { data: evs, error: evErr } = await sb.from('events')
      .select('id, title, titolo, published');
    if (evErr){ console.error(evErr); alert('Errore lettura events'); return; }

    // Carico occorrenze (tutte, poi raggruppo per evento)
    const { data: occs, error: occErr } = await sb.from('occurrences')
      .select('id, event_id, lat, lng, data, ora, luogo, indirizzo, citta');
    if (occErr){ console.error(occErr); alert('Errore lettura occurrences'); return; }

    evs.forEach(e => {
      EVENTS.set(e.id, {
        id: e.id,
        title: e.title || e.titolo || '(evento)',
        published: e.published
      });
    });

    // raggruppo
    (occs||[]).forEach(o=>{
      if (o.lat==null || o.lng==null) return;
      if (!OCCS_BY_EVENT.has(o.event_id)) OCCS_BY_EVENT.set(o.event_id, []);
      OCCS_BY_EVENT.get(o.event_id).push(o);
    });

    drawMarkers();
  }

  function drawMarkers(){
    // pulisci markers esistenti
    MARKERS.forEach(list => list.forEach(m => MAP.removeLayer(m)));
    MARKERS.clear();

    // bounds
    const all = [];
    OCCS_BY_EVENT.forEach((list, eventId)=>{
      const ev = EVENTS.get(eventId); if (!ev) return;
      const markers = [];
      list.forEach(occ=>{
        const m = L.marker([occ.lat,occ.lng], {icon:PINICON});
        const html = `<div style="color:#081421"><b>${ev.title}</b><br><small>${occ.citta||''}</small></div>`;
        m.bindPopup(html);
        m.on('click', ()=> toggleSelect(eventId, true));
        m.addTo(MAP);
        markers.push(m);
        all.push([occ.lat,occ.lng]);
      });
      MARKERS.set(eventId, markers);
    });

    if (all.length){
      const b = L.latLngBounds(all);
      MAP.fitBounds(b, {padding:[40,40]});
    }

    updateSelectionUI();
  }

  // --- Selezione ---
  function toggleSelect(eventId, fromMap=false){
    if (!EVENTS.has(eventId)) return;
    if (SELECTED.has(eventId)) SELECTED.delete(eventId);
    else SELECTED.add(eventId);
    // evidenzia markers dell’evento
    const list = MARKERS.get(eventId) || [];
    list.forEach(m=>{
      const el = m.getElement();
      if (el){
        if (SELECTED.has(eventId)) el.classList.add('pin-selected');
        else el.classList.remove('pin-selected');
      }
    });
    updateSelectionUI();
  }

  function updateSelectionUI(){
    $('#selCount').textContent = SELECTED.size;
    const box = $('#selList');
    if (!SELECTED.size){ box.innerHTML = '<div class="muted">Nessun evento selezionato.</div>'; return; }
    const rows = [...SELECTED].map(id=>{
      const ev = EVENTS.get(id);
      const occs = OCCS_BY_EVENT.get(id)||[];
      const city = occs[0]?.citta || '';
      return `<div class="item">
        <div><b>${ev?.title||'(evento)'}</b> <span class="muted">— ${city}</span></div>
        <button class="btn small" data-unselect="${id}" type="button">Rimuovi</button>
      </div>`;
    }).join('');
    box.innerHTML = rows;
    box.querySelectorAll('[data-unselect]').forEach(b=>{
      b.addEventListener('click', ()=> toggleSelect(b.getAttribute('data-unselect')));
    });
  }

  $('#clearSel').addEventListener('click', ()=>{
    const ids = [...SELECTED];
    ids.forEach(id => toggleSelect(id));
  });

  // --- Azioni ---
  async function softHide(){
    if (!SELECTED.size) { alert('Seleziona almeno un evento.'); return; }
    if (!confirm(`Nascondere ${SELECTED.size} evento/i? Verranno esclusi dalla home (published=false).`)) return;

    const ids = [...SELECTED];

    // 1) prova UPDATE published=false
    let ok = false, fallBackToHard = false, errorMsg = '';
    try{
      const { error } = await sb.from('events').update({ published: false }).in('id', ids);
      if (error){
        // se la colonna non esiste, Postgres risponde con 42703
        if (String(error.code) === '42703') fallBackToHard = true;
        else errorMsg = error.message || String(error);
      } else ok = true;
    }catch(e){ errorMsg = String(e&&e.message||e); }

    if (fallBackToHard){
      if (confirm('La colonna "published" non esiste: vuoi procedere con ELIMINAZIONE DEFINITIVA?')) {
        return hardDelete(); // passa alla hard
      } else {
        return;
      }
    }

    if (!ok){
      alert('Aggiornamento non riuscito.\n\nDettagli: ' + (errorMsg || 'errore sconosciuto'));
      return;
    }

    // Aggiorna UI: rimuovi subito i marker (non servono refresh)
    ids.forEach(id=>{
      (MARKERS.get(id)||[]).forEach(m => MAP.removeLayer(m));
      MARKERS.delete(id);
      SELECTED.delete(id);
      EVENTS.delete(id); // fuori dalla home non comparirà più
    });
    updateSelectionUI();
    $('#lastAction').textContent = 'Fatto: eventi nascosti (published=false).';
  }

  async function hardDelete(){
    if (!SELECTED.size) { alert('Seleziona almeno un evento.'); return; }
    if (!confirm(`Eliminare DEFINITIVAMENTE ${SELECTED.size} evento/i? Saranno cancellate anche le relative occorrenze.`)) return;

    const ids = [...SELECTED];
    let step1 = null, step2 = null;

    try{
      // 1) cancella occorrenze
      const r1 = await sb.from('occurrences').delete().in('event_id', ids);
      if (r1.error) throw r1.error;
      step1 = 'ok';

      // 2) cancella eventi
      const r2 = await sb.from('events').delete().in('id', ids);
      if (r2.error) throw r2.error;
      step2 = 'ok';
    }catch(e){
      const msg = String(e?.message||e);
      alert('Cancellazione bloccata (probabile policy RLS).\n\nDettagli: '+msg+'\n\nSuggerimento rapido: usa "Nascondi (published=false)" che non richiede ON DELETE CASCADE.');
      return;
    }

    // Aggiorna UI: rimuovi i marker
    ids.forEach(id=>{
      (MARKERS.get(id)||[]).forEach(m => MAP.removeLayer(m));
      MARKERS.delete(id);
      SELECTED.delete(id);
      EVENTS.delete(id);
      OCCS_BY_EVENT.delete(id);
    });
    updateSelectionUI();
    $('#lastAction').textContent = 'Fatto: eventi eliminati definitivamente.';
  }

  // Bind bottoni
  $('#btnSoft').addEventListener('click', softHide);
  $('#btnHard').addEventListener('click', hardDelete);

  // Avvio
  initMap();
  loadData();
})();
</script>
</body>
</html>
