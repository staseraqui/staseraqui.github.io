<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Seleziona & Elimina — Stasera Qui</title>

  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/style.css?v=12">

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- Config condivisa -->
  <script src="assets/app-config.js?v=6"></script>

  <style>
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    #map{height:62vh;border-radius:12px;border:1px solid rgba(255,255,255,.15);margin-bottom:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.25);padding:6px 10px;border-radius:999px;background:#0f1c2d}
    .list{margin-top:8px;background:#0f1c2d;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:10px;max-height:22vh;overflow:auto;font-size:14px}
    .item{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,.12)}
    .item:last-child{border-bottom:none}
    .muted{color:#b8c2ce}
    .help{font-size:13px;color:#b8c2ce;margin:4px 0 0}
    .flag{display:inline-block;font-size:11px;padding:2px 6px;border-radius:6px;background:#ffd24d;color:#081421;font-weight:800;margin-left:8px}
    label.chk{display:inline-flex;gap:8px;align-items:center;font-size:13px;color:#b8c2ce}
    #map > div { border-radius: 12px; overflow: hidden; } /* arrotonda anche il canvas di Google */
  </style>
</head>
<body>
<header class="header" style="padding:0 16px">
  <a href="admin.html" class="logo" aria-label="Torna all'area admin">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true">
      <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/>
      <circle cx="32" cy="24" r="9" fill="#ffffff"/>
    </svg>
    <span class="wordmark">stasera qui</span>
  </a>
</header>

<main class="wrap">
  <h1 style="margin:8px 0 10px">Seleziona & elimina eventi</h1>
  <p class="help">Tocca/clicca i pin per selezionare gli eventi. Poi scegli se <b>Nascondere</b> (soft-delete: <i>published=false</i>) oppure <b>Eliminare definitivamente</b> (hard-delete: rimuove anche le occorrenze).</p>

  <label class="chk" style="margin:6px 0 10px">
    <input type="checkbox" id="showHidden"> Mostra anche gli eventi nascosti (published=false)
  </label>

  <div id="map"></div>

  <div class="toolbar">
    <span class="badge">Selezionati: <b id="selCount">0</b></span>
    <button class="btn" id="clearSel" type="button">Pulisci selezione</button>
    <span class="muted" id="lastAction"></span>
  </div>

  <div class="list" id="selList" aria-live="polite"></div>

  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
    <button class="btn accent"  id="btnSoft" type="button">Nascondi (published=false)</button>
    <button class="btn danger"  id="btnHard" type="button">Elimina definitivamente</button>
    <a class="btn" href="admin.html">← Torna all’area admin</a>
  </div>
</main>

<script>
(function(){
  // ===== CONFIG =====
  const CFG = window.SQ_CONFIG || {};
  const SB_URL  = CFG.SUPABASE_URL;
  const SB_ANON = CFG.SUPABASE_ANON;
  const GMAPS_KEY = CFG.GOOGLE_MAPS_API_KEY;
  const sb = supabase.createClient(SB_URL, SB_ANON);

  // ===== Google Maps =====
  function loadGoogleJs(){
    return new Promise((resolve, reject)=>{
      if (!GMAPS_KEY) return reject(new Error('Manca GOOGLE_MAPS_API_KEY in assets/app-config.js'));
      if (window.google && window.google.maps) return resolve();
      const s = document.createElement('script');
      s.src = 'https://maps.googleapis.com/maps/api/js?key='+encodeURIComponent(GMAPS_KEY);
      s.async = true; s.defer = true;
      s.onload = resolve; s.onerror = ()=>reject(new Error('Caricamento Google Maps fallito'));
      document.head.appendChild(s);
    });
  }

  let MAP=null, INFOWIN=null;
  function initGoogleMap(){
    MAP = new google.maps.Map(document.getElementById('map'), {
      center:{lat:43.8, lng:11.2}, zoom:6, streetViewControl:false, mapTypeControl:false
    });
    INFOWIN = new google.maps.InfoWindow();
  }

  function pinSvgUrl({selected=false}={}){
    const stroke = selected ? '#ffd24d' : '#ffffff';
    const sw = selected ? 4 : 3;
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 72">
      <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z"
            fill="#22b3f0" stroke="${stroke}" stroke-width="${sw}"/>
      <circle cx="32" cy="24" r="9" fill="#ffffff"/>
    </svg>`;
    return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
  }
  function icon(selected){ return { url:pinSvgUrl({selected}), scaledSize:new google.maps.Size(34,38), anchor:new google.maps.Point(19,38) }; }

  // ===== Stato =====
  const EVENTS = new Map();          // id -> {id,title,published}
  const OCCS_BY_EVENT = new Map();   // id -> [occ,...]
  const MARKERS = new Map();         // id -> [marker,...]
  const SELECTED = new Set();        // id selezionati
  let SHOW_HIDDEN = false;

  // ===== Data =====
  function visible(ev){ return (ev.published==null || ev.published===true) || SHOW_HIDDEN; }

  async function loadData(){
    const { data: evs, error: e1 } = await sb.from('events').select('id, title, titolo, published');
    if (e1){ alert('Errore lettura events: '+(e1.message||e1)); return; }
    EVENTS.clear();
    (evs||[]).forEach(e=> EVENTS.set(e.id, { id:e.id, title: e.title || e.titolo || '(evento)', published: e.published }));

    const { data: occs, error: e2 } = await sb.from('occurrences').select('id, event_id, lat, lng, citta, data, ora');
    if (e2){ alert('Errore lettura occurrences: '+(e2.message||e2)); return; }
    OCCS_BY_EVENT.clear();
    (occs||[]).forEach(o=>{
      if (o.lat==null || o.lng==null) return;
      if (!OCCS_BY_EVENT.has(o.event_id)) OCCS_BY_EVENT.set(o.event_id, []);
      OCCS_BY_EVENT.get(o.event_id).push(o);
    });

    drawMarkers();
  }

  function clearMarkers(){ MARKERS.forEach(list=>list.forEach(m=>m.setMap(null))); MARKERS.clear(); }

  function drawMarkers(){
    clearMarkers();
    const bounds = new google.maps.LatLngBounds();
    let any=false;

    OCCS_BY_EVENT.forEach((list, id)=>{
      const ev = EVENTS.get(id); if (!ev) return;
      if (!visible(ev)) return;

      const arr=[];
      list.forEach(o=>{
        const m = new google.maps.Marker({ position:{lat:o.lat,lng:o.lng}, map:MAP, icon:icon(SELECTED.has(id)) });
        const flag = (ev.published===false) ? '<span class="flag">nascosto</span>' : '';
        const html = `<div style="color:#081421;max-width:260px"><b>${ev.title}</b> ${flag}<br><small>${o.citta||''}${o.data?' — '+o.data:''}${o.ora?' ore '+o.ora:''}</small></div>`;
        m.addListener('click', ()=>{
          INFOWIN.setContent(html);
          INFOWIN.open(MAP, m);
          toggleSelect(id);
        });
        arr.push(m);
        bounds.extend(m.getPosition());
        any=true;
      });
      MARKERS.set(id, arr);
    });

    if (any) MAP.fitBounds(bounds, { top:40, bottom:40, left:40, right:40 });
    updateList();
  }

  function toggleSelect(id){
    if (!EVENTS.has(id)) return;
    if (SELECTED.has(id)) SELECTED.delete(id); else SELECTED.add(id);
    const list = MARKERS.get(id)||[];
    list.forEach(m => m.setIcon(icon(SELECTED.has(id))));
    updateList();
  }

  function updateList(){
    document.getElementById('selCount').textContent = SELECTED.size;
    const box = document.getElementById('selList');
    if (!SELECTED.size){ box.innerHTML = '<div class="muted">Nessun evento selezionato.</div>'; return; }
    box.innerHTML = [...SELECTED].map(id=>{
      const ev = EVENTS.get(id); const occs = OCCS_BY_EVENT.get(id)||[]; const city=occs[0]?.citta||'';
      const hidden = (ev?.published===false) ? ' <span class="flag">nascosto</span>' : '';
      return `<div class="item">
        <div><b>${ev?.title||'(evento)'}</b>${hidden} <span class="muted">— ${city}</span></div>
        <button class="btn small" data-id="${id}" type="button">Rimuovi</button>
      </div>`;
    }).join('');
    box.querySelectorAll('button[data-id]').forEach(b=>{
      b.addEventListener('click', ()=> toggleSelect(b.getAttribute('data-id')));
    });
  }

  document.getElementById('clearSel').addEventListener('click', ()=>{
    const ids=[...SELECTED]; SELECTED.clear();
    ids.forEach(id => (MARKERS.get(id)||[]).forEach(m=>m.setIcon(icon(false))));
    updateList();
  });

  // ===== Azioni (via RPC) =====
  async function softHide(){
    if (!SELECTED.size) { alert('Seleziona almeno un evento.'); return; }
    if (!confirm(`Nascondere ${SELECTED.size} evento/i? (published=false)`)) return;
    const ids=[...SELECTED];

    try{
      const { error } = await sb.rpc('hide_events', { ids });
      if (error) throw error;
    }catch(e){
      alert('Aggiornamento fallito: '+(e?.message||String(e)));
      return;
    }

    ids.forEach(id=>{ const ev=EVENTS.get(id); if (ev) ev.published=false; });
    if (document.getElementById('showHidden').checked){
      ids.forEach(id => (MARKERS.get(id)||[]).forEach(m=>m.setIcon(icon(SELECTED.has(id)))));
    } else {
      ids.forEach(id=>{
        (MARKERS.get(id)||[]).forEach(m=>m.setMap(null));
        MARKERS.delete(id);
        SELECTED.delete(id);
      });
    }
    updateList();
    document.getElementById('lastAction').textContent = 'Fatto: eventi nascosti.';
  }

  async function hardDelete(){
    if (!SELECTED.size) { alert('Seleziona almeno un evento.'); return; }
    if (!confirm(`Eliminare DEFINITIVAMENTE ${SELECTED.size} evento/i?\nVerranno eliminate anche le occorrenze.`)) return;
    const ids=[...SELECTED];

    try{
      const { error } = await sb.rpc('delete_events', { ids });
      if (error) throw error;
    }catch(e){
      alert('Eliminazione fallita: '+(e?.message||String(e)));
      return;
    }

    ids.forEach(id=>{
      (MARKERS.get(id)||[]).forEach(m=>m.setMap(null));
      MARKERS.delete(id);
      SELECTED.delete(id);
      EVENTS.delete(id);
      OCCS_BY_EVENT.delete(id);
    });
    updateList();
    document.getElementById('lastAction').textContent = 'Fatto: eventi eliminati.';
  }

  document.getElementById('btnSoft').addEventListener('click', softHide);
  document.getElementById('btnHard').addEventListener('click', hardDelete);
  document.getElementById('showHidden').addEventListener('change', (e)=>{ SHOW_HIDDEN = !!e.target.checked; drawMarkers(); });

  // ===== Boot =====
  (async function(){
    try{
      await loadGoogleJs();
      initGoogleMap();
      await loadData();
    }catch(e){
      alert('Google Maps non caricato: '+(e?.message||String(e))+'\nControlla GOOGLE_MAPS_API_KEY in assets/app-config.js');
    }
  })();
})();
</script>
</body>
</html>
