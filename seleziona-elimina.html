<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Seleziona & Elimina ‚Äî Stasera Qui</title>

  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/style.css?v=12">

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- Config condivisa -->
  <script src="assets/app-config.js?v=6"></script>

  <style>
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    #map{height:62vh;border-radius:12px;border:1px solid rgba(255,255,255,.15);margin-bottom:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.25);padding:6px 10px;border-radius:999px;background:#0f1c2d}
    .list{margin-top:8px;background:#0f1c2d;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:10px;max-height:22vh;overflow:auto;font-size:14px}
    .item{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,.12)}
    .item:last-child{border-bottom:none}
    .muted{color:#b8c2ce}
    .help{font-size:13px;color:#b8c2ce;margin:4px 0 0}
    .flag{display:inline-block;font-size:11px;padding:2px 6px;border-radius:6px;background:#ffd24d;color:#081421;font-weight:800;margin-left:8px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label.chk{display:inline-flex;gap:8px;align-items:center;font-size:13px;color:#b8c2ce}
    /* Google map container rounds */
    #map > div { border-radius: 12px; overflow: hidden; }
  </style>
</head>
<body>
<header class="header" style="padding:0 16px">
  <a href="admin.html" class="logo" aria-label="Torna all'area admin">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true">
      <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/>
      <circle cx="32" cy="24" r="9" fill="#ffffff"/>
    </svg>
    <span class="wordmark">stasera qui</span>
  </a>
</header>

<main class="wrap">
  <h1 style="margin:8px 0 10px">Seleziona & elimina eventi</h1>
  <p class="help">Tocca/clicca i pin per selezionare gli eventi. Poi scegli se <b>Nascondere</b> (soft-delete: <i>published=false</i>) oppure <b>Eliminare definitivamente</b> (hard-delete: rimuove anche le occorrenze).</p>

  <div class="row" style="margin-bottom:8px">
    <label class="chk"><input type="checkbox" id="showHidden"> Mostra anche gli eventi nascosti (published=false)</label>
  </div>

  <div id="map"></div>

  <div class="toolbar">
    <span class="badge">Selezionati: <b id="selCount">0</b></span>
    <button class="btn" id="clearSel" type="button">Pulisci selezione</button>
    <span class="muted" id="lastAction"></span>
  </div>

  <div class="list" id="selList" aria-live="polite"></div>

  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
    <button class="btn accent"  id="btnSoft" type="button">Nascondi (published=false)</button>
    <button class="btn danger"  id="btnHard" type="button">Elimina definitivamente</button>
    <a class="btn" href="admin.html">‚Üê Torna all‚Äôarea admin</a>
  </div>
</main>

<script>
(function(){
  // --- Config / Supabase ---
  const CFG = window.SQ_CONFIG || {};
  const SB_URL  = CFG.SUPABASE_URL;
  const SB_ANON = CFG.SUPABASE_ANON;
  const GMAPS_KEY = CFG.GOOGLE_MAPS_API_KEY;

  if (!SB_URL || !SB_ANON) { alert('Configurazione Supabase mancante (assets/app-config.js).'); }

  const sb = supabase.createClient(SB_URL, SB_ANON);

  const $  = s => document.querySelector(s);

  // --- Stato ---
  let GMAP = null, INFO = null, GEOCODER = null;
  const MARKERS = new Map();      // eventId -> Marker[]
  const EVENTS  = new Map();      // eventId -> { id, title, published }
  const OCCS_BY_EVENT = new Map();// eventId -> occorrenze[]
  const SELECTED = new Set();     // eventId selezionati
  let SHOW_HIDDEN = false;        // toggle UI

  // --- Pin SVG (normale / selezionato) ---
  function pinSvgUrl({selected=false}={}){
    const stroke = selected ? '#ffd24d' : '#ffffff';
    const sw = selected ? 4 : 3;
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 72">
      <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z"
            fill="#22b3f0" stroke="${stroke}" stroke-width="${sw}"/>
      <circle cx="32" cy="24" r="9" fill="#ffffff"/>
    </svg>`;
    return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
  }

  function makeMarkerIcon(selected){
    return {
      url: pinSvgUrl({selected}),
      scaledSize: new google.maps.Size(34, 38),
      anchor: new google.maps.Point(19, 38)
    };
  }

  // --- Init Google Maps ---
  function initGoogle(){
    GMAP = new google.maps.Map(document.getElementById('map'), {
      center:{lat:43.8, lng:11.2}, // Italia ‚Äúcentrale‚Äù
      zoom:6,
      streetViewControl:false,
      mapTypeControl:false
    });
    INFO = new google.maps.InfoWindow();
  }

  function loadGoogleJs(){
    return new Promise((resolve, reject)=>{
      if (!GMAPS_KEY){ reject(new Error('Manca GOOGLE_MAPS_API_KEY.')); return; }
      if (window.google && window.google.maps){ resolve(); return; }
      const s = document.createElement('script');
      s.src = 'https://maps.googleapis.com/maps/api/js?key='+encodeURIComponent(GMAPS_KEY);
      s.async = true; s.defer = true;
      s.onload = resolve; s.onerror = ()=>reject(new Error('Caricamento Google Maps fallito'));
      document.head.appendChild(s);
    });
  }

  // --- Data load ---
  function eventIsVisible(ev){
    // Se published √® undefined/null (schemi vecchi), consideriamo visibile.
    if (ev.published === undefined || ev.published === null) return true;
    return !!ev.published || SHOW_HIDDEN;
  }

  async function loadData(){
    // 1) events
    const { data: evs, error: evErr } = await sb.from('events')
      .select('id, title, titolo, published');

    if (evErr){ console.error(evErr); alert('Errore lettura events'); return; }

    EVENTS.clear();
    (evs||[]).forEach(e=>{
      EVENTS.set(e.id, {
        id: e.id,
        title: e.title || e.titolo || '(evento)',
        published: e.published
      });
    });

    // 2) occurrences
    const { data: occs, error: occErr } = await sb.from('occurrences')
      .select('id, event_id, lat, lng, citta, data, ora');
    if (occErr){ console.error(occErr); alert('Errore lettura occurrences'); return; }

    OCCS_BY_EVENT.clear();
    (occs||[]).forEach(o=>{
      if (o.lat==null || o.lng==null) return;
      if (!OCCS_BY_EVENT.has(o.event_id)) OCCS_BY_EVENT.set(o.event_id, []);
      OCCS_BY_EVENT.get(o.event_id).push(o);
    });

    drawMarkers();
  }

  function clearAllMarkers(){
    MARKERS.forEach(list => list.forEach(m => m.setMap(null)));
    MARKERS.clear();
  }

  function drawMarkers(){
    clearAllMarkers();

    const bounds = new google.maps.LatLngBounds();
    let any = false;

    OCCS_BY_EVENT.forEach((occs, eventId)=>{
      const ev = EVENTS.get(eventId);
      if (!ev) return;
      if (!eventIsVisible(ev)) return; // üëà nascondi i published=false (a meno che SHOW_HIDDEN)

      const mList=[];
      occs.forEach(o=>{
        const m = new google.maps.Marker({
          position:{lat:o.lat, lng:o.lng},
          map: GMAP,
          icon: makeMarkerIcon(SELECTED.has(eventId))
        });
        const flag = (ev.published===false) ? '<span class="flag">nascosto</span>' : '';
        const html = `<div style="color:#081421;max-width:260px">
          <b>${ev.title}</b> ${flag}<br>
          <small>${o.citta || ''}${o.data ? ' ‚Äî '+o.data : ''}${o.ora ? ' ore '+o.ora : ''}</small>
        </div>`;
        m.addListener('click', ()=>{
          INFO.setContent(html);
          INFO.open(GMAP, m);
          toggleSelect(eventId, /*fromMap=*/true);
        });
        mList.push(m);
        bounds.extend(m.getPosition());
        any = true;
      });
      MARKERS.set(eventId, mList);
    });

    if (any){
      GMAP.fitBounds(bounds, { top: 40, bottom: 40, left: 40, right: 40 });
    }

    updateSelectionUI();
  }

  // --- Selezione ---
  function toggleSelect(eventId){
    if (!EVENTS.has(eventId)) return;
    if (SELECTED.has(eventId)) SELECTED.delete(eventId);
    else SELECTED.add(eventId);

    // Aggiorna stile marker (icona selezionata)
    const list = MARKERS.get(eventId) || [];
    list.forEach(m => m.setIcon(makeMarkerIcon(SELECTED.has(eventId))));

    updateSelectionUI();
  }

  function updateSelectionUI(){
    $('#selCount').textContent = SELECTED.size;
    const box = $('#selList');
    if (!SELECTED.size){ box.innerHTML = '<div class="muted">Nessun evento selezionato.</div>'; return; }
    const rows = [...SELECTED].map(id=>{
      const ev = EVENTS.get(id);
      const occs = OCCS_BY_EVENT.get(id)||[];
      const city = occs[0]?.citta || '';
      const hidden = (ev?.published===false) ? ' <span class="flag">nascosto</span>' : '';
      return `<div class="item">
        <div><b>${ev?.title||'(evento)'}</b> ${hidden} <span class="muted">‚Äî ${city}</span></div>
        <button class="btn small" data-unselect="${id}" type="button">Rimuovi</button>
      </div>`;
    }).join('');
    box.innerHTML = rows;
    box.querySelectorAll('[data-unselect]').forEach(b=>{
      b.addEventListener('click', ()=> toggleSelect(b.getAttribute('data-unselect')));
    });
  }

  $('#clearSel').addEventListener('click', ()=>{
    const ids = [...SELECTED];
    ids.forEach(id=>{
      SELECTED.delete(id);
      const list = MARKERS.get(id) || [];
      list.forEach(m => m.setIcon(makeMarkerIcon(false)));
    });
    updateSelectionUI();
  });

  // --- Azioni ---
  async function softHide(){
    if (!SELECTED.size) { alert('Seleziona almeno un evento.'); return; }
    if (!confirm(`Nascondere ${SELECTED.size} evento/i? Verranno esclusi dalla home (published=false).`)) return;

    const ids = [...SELECTED];

    try{
      const { error } = await sb.from('events').update({ published: false }).in('id', ids);
      if (error){
        // Colonna mancante => Postgres 42703
        if (String(error.code) === '42703'){
          alert('La colonna "published" non esiste.\n\nEsegui una volta questo SQL:\n\nALTER TABLE public.events ADD COLUMN IF NOT EXISTS published boolean NOT NULL DEFAULT true;');
          return;
        }
        throw error;
      }
    }catch(e){
      alert('Aggiornamento non riuscito.\n\nDettagli: ' + (e?.message || String(e)));
      return;
    }

    // Aggiorna stato locale
    ids.forEach(id=>{
      const ev = EVENTS.get(id); if (ev) ev.published = false;
    });

    // Se non sto mostrando i nascosti, rimuovo i marker; altrimenti tengo e mostro il badge
    if (!SHOW_HIDDEN){
      ids.forEach(id=>{
        (MARKERS.get(id)||[]).forEach(m => m.setMap(null));
        MARKERS.delete(id);
        SELECTED.delete(id);
      });
      updateSelectionUI();
    }else{
      // Dentro ‚Äúmostra nascosti‚Äù: aggiorno l‚Äôicona (selezione pu√≤ rimanere)
      ids.forEach(id=>{
        const list = MARKERS.get(id) || [];
        list.forEach(m => m.setIcon(makeMarkerIcon(SELECTED.has(id))));
      });
      updateSelectionUI();
    }

    $('#lastAction').textContent = 'Fatto: eventi nascosti (published=false).';
  }

  async function hardDelete(){
    if (!SELECTED.size) { alert('Seleziona almeno un evento.'); return; }
    if (!confirm(`Eliminare DEFINITIVAMENTE ${SELECTED.size} evento/i?\nSaranno cancellate anche le relative occorrenze.`)) return;

    const ids = [...SELECTED];

    try{
      // 1) occorrenze
      const r1 = await sb.from('occurrences').delete().in('event_id', ids);
      if (r1.error) throw r1.error;

      // 2) eventi
      const r2 = await sb.from('events').delete().in('id', ids);
      if (r2.error) throw r2.error;
    }catch(e){
      alert('Cancellazione bloccata (probabile policy RLS o permessi insufficienti).\n\nDettagli: ' + (e?.message || String(e)) + '\n\nSuggerimento: usa "Nascondi (published=false)".');
      return;
    }

    // Pulizia UI
    ids.forEach(id=>{
      (MARKERS.get(id)||[]).forEach(m => m.setMap(null));
      MARKERS.delete(id);
      SELECTED.delete(id);
      EVENTS.delete(id);
      OCCS_BY_EVENT.delete(id);
    });
    updateSelectionUI();
    $('#lastAction').textContent = 'Fatto: eventi eliminati definitivamente.';
  }

  // --- Toggle mostra nascosti ---
  $('#showHidden').addEventListener('change', (e)=>{
    SHOW_HIDDEN = !!e.target.checked;
    drawMarkers();
  });

  // --- Avvio ---
  (async function boot(){
    try{
      await loadGoogleJs();
      initGoogle();
      await loadData();
    }catch(e){
      alert('Impossibile caricare Google Maps. Verifica la chiave in assets/app-config.js.');
    }
  })();

  // Bottoni azione
  $('#btnSoft').addEventListener('click', softHide);
  $('#btnHard').addEventListener('click', hardDelete);
})();
</script>
</body>
</html>
