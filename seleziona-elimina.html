<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Modifica & Elimina ‚Äî Stasera Qui</title>

  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/style.css?v=12">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- Config condivisa -->
  <script src="assets/app-config.js?v=6"></script>

  <style>
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    #map{height:62vh;border-radius:12px;border:1px solid rgba(255,255,255,.15);margin-bottom:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.25);padding:6px 10px;border-radius:999px;background:#0f1c2d}
    .list{margin-top:8px;background:#0f1c2d;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:10px;max-height:22vh;overflow:auto;font-size:14px}
    .item{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,.12)}
    .item:last-child{border-bottom:none}
    .muted{color:#b8c2ce}
    .help{font-size:13px;color:#b8c2ce;margin:4px 0 0}

    /* Modali */
.modal{
  position:fixed;inset:0;display:none;
  align-items:flex-start;justify-content:center;
  background:rgba(0,0,0,.5);z-index:99999;
  overflow:auto;
}
.modal .box{
  margin-top:40px;background:#0f1c2d;
  border:1px solid rgba(255,255,255,.15);border-radius:12px;
  padding:14px;min-width:320px;max-width:1100px;width:92%;
  max-height:calc(100vh - 80px);
  overflow:auto;
  -webkit-overflow-scrolling:touch;
}
    .small{font-size:13px}
    .smallmuted{font-size:13px;color:#b8c2ce}

    /* Giallo su "Elimina definitivamente" */
    .btn.warning{background:var(--primary); border-color:var(--primary-border); color:#081421; font-weight:800}
    .btn.ghost{background:#111f31;border:1px solid rgba(255,255,255,.25);color:#fff}

    /* Overlay login semplice */
    #authGate{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:999999}
    #authBox{background:#0f1c2d;border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:16px;max-width:360px;width:92%}
    #authBox h3{margin:0 0 8px}
    #authErr{color:#ff9a9a;margin-top:8px;display:none}

    /* ===== Editor evento ===== */
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:860px){ .grid{grid-template-columns:1fr} }
    .occ{background:#0b1623;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px;margin-top:8px}
    .occ .grid{grid-template-columns:1fr 1fr}
    .occ .head{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px}
    .err{color:#ffb4b4;min-height:18px;margin-top:6px}
    .ok{color:#b8ffc2}

    /* Chip categorie */
    .chip{color:#fff !important}

    /* Badge categorie selezionate */
    #catBadges .badge{background:#17304d;color:#d7f2ff;border:1px solid #2e6e8f}

    /* Bottone upload locandina: layout */
    .posterRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .posterRow input[type="text"]{flex:1;min-width:260px}
  </style>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-SDBGY51C46"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date()); gtag('config', 'G-SDBGY51C46');
  </script>
</head>
<body>
<header class="header" style="padding:0 16px">
  <a href="admin.html" class="logo" aria-label="Torna all'area admin">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true">
      <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/>
      <circle cx="32" cy="24" r="9" fill="#ffffff"/>
    </svg>
    <span class="wordmark">stasera qui</span>
  </a>
</header>

<main class="wrap">
  <h1 style="margin:8px 0 10px">Modifica & elimina eventi</h1>
  <p class="help">Tocca/clicca i pin per selezionare gli eventi. Poi scegli <b>Modifica</b>, <b>Nascondi</b> (soft: <i>published=false</i>) o <b>Elimina definitivamente</b> (cestino con <i>deleted_at</i>, ripristinabile; gli <b>scaduti</b> non si ripristinano).</p>

  <div id="map"></div>

  <div class="toolbar" style="margin-bottom:8px">
    <span class="badge">Selezionati: <b id="selCount">0</b></span>
    <button class="btn" id="clearSel" type="button">Pulisci selezione</button>
    <button class="btn primary" id="btnEdit" type="button">‚úèÔ∏è Modifica eventi selezionati</button>
    <span class="muted" id="lastAction"></span>
  </div>

  <div class="list" id="selList" aria-live="polite"></div>

  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
    <button class="btn accent"  id="btnSoft" type="button">Nascondi (published=false)</button>
    <button class="btn warning" id="btnHard" type="button">Elimina definitivamente ‚Üí Cestino</button>
    <a class="btn" href="admin.html">‚Üê Torna all‚Äôarea admin</a>
  </div>

  <hr class="divider">

  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
    <button class="btn" id="btnViewHidden" type="button">üîé Vedi eventi nascosti</button>
    <button class="btn" id="btnViewDeleted" type="button">üóëÔ∏è Cestino eventi (eliminati)</button>
  </div>
</main>

<!-- MODALE: Editor evento -->
<div id="editModal" class="modal" aria-hidden="true">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <h3 style="margin:0"><span id="edTitle">Modifica evento</span> <span class="smallmuted" id="edIdx"></span></h3>
      <div style="display:flex;gap:6px;align-items:center">
        <button class="btn ghost" id="edPrev" type="button" title="Evento precedente">‚óÄ</button>
        <button class="btn ghost" id="edNext" type="button" title="Evento successivo">‚ñ∂</button>
        <button class="btn" id="edClose" type="button">Chiudi</button>
      </div>
    </div>

    <div id="edErr" class="err"></div>

    <div class="grid" style="margin-top:8px">
      <div>
        <label for="e_titolo">Titolo*</label>
        <input id="e_titolo" maxlength="80" required>
      </div>
      <div>
        <label for="e_catBtn">Categorie*</label><br>
        <button class="btn secondary" id="e_catBtn" type="button">Scegli categorie</button>
        <div id="catBadges" style="margin-top:6px"></div>
      </div>
    </div>

    <div class="grid">
      <div>
        <label for="e_loc_url">Locandina/Foto (JPG/PNG/WebP)</label>
        <div class="posterRow">
          <input id="e_loc_url" type="text" placeholder="oppure incolla un URL‚Ä¶">
          <input id="e_loc_file" type="file" accept="image/png,image/jpeg,image/webp" style="display:none">
          <button class="btn" id="e_loc_btn" type="button">Carica locandina</button>
          <span class="small" id="e_loc_msg" style="opacity:.85"></span>
        </div>
      </div>
      <div>
        <label for="e_published">Pubblicato</label>
        <select id="e_published">
          <option value="true">S√¨</option>
          <option value="false">No</option>
        </select>
      </div>
    </div>

    <!-- Evento diffuso (esteso) -->
    <div class="grid" style="margin-top:8px">
      <div>
        <label for="e_extended">Evento diffuso (esteso)</label>
        <select id="e_extended">
          <option value="false">No</option>
          <option value="true">S√¨</option>
        </select>
        <p class="smallmuted">Se S√¨, l‚Äôevento √® ‚Äúdiffuso‚Äù (pi√π luoghi o area).</p>
      </div>
      <div></div>
    </div>

    <div style="margin-top:8px">
      <label for="e_descr">Descrizione breve (max 400)*</label>
      <textarea id="e_descr" maxlength="400" required style="min-height:180px"></textarea>
    </div>

    <h4 style="margin:12px 0 6px">Occorrenze</h4>
    <div id="occWrap"></div>
    <div style="margin-top:8px">
      <button class="btn primary" id="addOcc" type="button">Aggiungi occorrenza</button>
    </div>

    <div class="footer-actions">
      <button class="btn primary" id="edSave" type="button">üíæ Salva modifiche</button>
      <button class="btn" id="edSaveNext" type="button">üíæ Salva & vai al prossimo ‚ñ∂</button>
    </div>
  </div>
</div>

<!-- MODALE: Categorie -->
<div id="catModal" class="modal" aria-hidden="true">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <h3 style="margin:0">Categorie (multi)</h3>
      <button class="btn" id="catClose" type="button">Chiudi</button>
    </div>
    <div id="chipsModal" style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 6px"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn secondary" id="catClear" type="button">Azzera</button>
      <button class="btn primary" id="catOk" type="button">Conferma</button>
    </div>
  </div>
</div>

<!-- MODALE: Nascosti -->
<div id="modalHidden" class="modal" aria-hidden="true">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <h3 style="margin:0">Eventi nascosti (published=false)</h3>
      <button class="btn" data-close="modalHidden" type="button">Chiudi</button>
    </div>

    <div class="grid" style="margin:10px 0">
      <div>
        <label class="small">Dal (data evento)</label>
        <input type="date" id="hFrom">
      </div>
      <div>
        <label class="small">Al (data evento)</label>
        <input type="date" id="hTo">
      </div>
      <div>
        <label class="small">Citt√†</label>
        <input id="hCity" placeholder="Es. Torino">
      </div>
      <div>
        <label class="small">Categoria</label>
        <select id="hCat">
          <option value="">Tutte</option>
          <option>Musica</option><option>Food & Drink</option><option>Nightlife</option>
          <option>Cultura/Spettacolo</option><option>Famiglie & Bambini</option>
          <option>Sport</option><option>Sagre & Fiere</option><option>Mercatini</option>
        </select>
      </div>
    </div>

    <div class="list" id="hResults" aria-live="polite"></div>
  </div>
</div>

<!-- MODALE: Eliminati (Cestino) -->
<div id="modalDeleted" class="modal" aria-hidden="true">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <h3 style="margin:0">Cestino ‚Äî Eventi eliminati</h3>
      <button class="btn" data-close="modalDeleted" type="button">Chiudi</button>
    </div>

    <div class="grid" style="margin:10px 0">
      <div>
        <label class="small">Dal (data evento)</label>
        <input type="date" id="dFrom">
      </div>
      <div>
        <label class="small">Al (data evento)</label>
        <input type="date" id="dTo">
      </div>
      <div>
        <label class="small">Citt√†</label>
        <input id="dCity" placeholder="Es. Genova">
      </div>
      <div>
        <label class="small">Categoria</label>
        <select id="dCat">
          <option value="">Tutte</option>
          <option>Musica</option><option>Food & Drink</option><option>Nightlife</option>
          <option>Cultura/Spettacolo</option><option>Famiglie & Bambini</option>
          <option>Sport</option><option>Sagre & Fiere</option><option>Mercatini</option>
        </select>
      </div>
    </div>

    <div class="list" id="dResults" aria-live="polite"></div>
    <p class="small" style="margin-top:8px;opacity:.8">Gli eventi ‚Äúscaduti‚Äù (tutte le date &lt; oggi) non sono ripristinabili; puoi solo eliminarli definitivamente.</p>
  </div>
</div>

<!-- OVERLAY LOGIN (email + password) -->
<div id="authGate" aria-hidden="true">
  <div id="authBox">
    <h3>Accedi</h3>
    <p class="small" style="margin-top:0">Usa la tua email e password.</p>
    <label class="small">Email</label>
    <input id="authEmail" placeholder="es. andrea.cordero@staseraqui.it">
    <label class="small">Password</label>
    <input id="authPass" type="password" placeholder="Password">
    <div class="footer-actions" style="justify-content:flex-end;margin-top:10px">
      <button class="btn primary" id="authLogin" type="button">Entra</button>
    </div>
    <div id="authErr" class="small"></div>
  </div>
</div>

<script>
(async function(){
  // ====== CONFIG / SUPABASE ======
  const CFG = window.SQ_CONFIG || {};
  const SB_URL  = CFG.SUPABASE_URL;
  const SB_ANON = CFG.SUPABASE_ANON;
  const GMAPS_KEY = CFG.GOOGLE_MAPS_API_KEY;
  const hasGoogleKey = GMAPS_KEY && !/^INSERISCI_/.test(GMAPS_KEY);

  if (!SB_URL || !SB_ANON) alert('Configurazione Supabase mancante (assets/app-config.js).');
  const sb = supabase.createClient(SB_URL, SB_ANON, { auth: { persistSession: true, autoRefreshToken: true } });

  // ====== LOGIN SOLO PASSWORD ======
  const AUTH_EMAIL_WHITELIST = ['andrea.cordero@staseraqui.it'];
  async function requireLogin(){
    const { data:{ session } } = await sb.auth.getSession();
    if (session && AUTH_EMAIL_WHITELIST.includes(session.user.email)) {
      document.getElementById('authGate').style.display='none';
      return true;
    }
    const gate = document.getElementById('authGate');
    const email = document.getElementById('authEmail');
    const pass  = document.getElementById('authPass');
    const btn   = document.getElementById('authLogin');
    const err   = document.getElementById('authErr');

    gate.style.display='flex';
    email.value = AUTH_EMAIL_WHITELIST[0] || '';
    err.style.display='none'; err.textContent='';

    return new Promise((resolve)=>{
      btn.onclick = async ()=>{
        err.style.display='none'; err.textContent='';
        const e = (email.value||'').trim();
        const p = pass.value||'';
        if (!e || !p){ err.textContent='Inserisci email e password.'; err.style.display='block'; return; }
        try{
          const { data, error } = await sb.auth.signInWithPassword({ email:e, password:p });
          if (error){ err.textContent = error.message || 'Accesso non riuscito.'; err.style.display='block'; return; }
          if (!AUTH_EMAIL_WHITELIST.includes(data.user.email)) {
            await sb.auth.signOut();
            err.textContent='Utente non autorizzato per questa pagina.'; err.style.display='block'; return;
          }
          gate.style.display='none';
          resolve(true);
        }catch(ex){
          err.textContent = String(ex && ex.message || ex); err.style.display='block';
        }
      };
    });
  }

  // ====== UTILS ======
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const todayISO = () => new Date().toISOString().slice(0,10);
  const getTitle = e => e.title || e.titolo || '(evento)';
  const getCats  = e => Array.isArray(e.categories) ? e.categories : (Array.isArray(e.categorie) ? e.categorie : (typeof e.categories==='string' ? safeParseCats(e.categories) : []));
  const safeParseCats = s => { try{ const j=JSON.parse(s); return Array.isArray(j)?j:[]; }catch(_){ return (s||'').split(',').map(x=>x.trim()).filter(Boolean); } };
  const uniqueId = ()=> Math.random().toString(36).slice(2,10);

  // helper: aggiorna 1 colonna evento ma ignora se la colonna non esiste
  async function tryUpdateEventColumn(id, set){
    const r = await sb.from('events').update(set).eq('id', id);
    // se la colonna non esiste, supabase pu√≤ dare un errore generico:
    // lo ignoriamo sempre qui per evitare blocchi lato UI
    return !!r.error ? false : true;
  }
  // helper: aggiorna 1 colonna occorrenza ma ignora se la colonna non esiste
  async function tryUpdateOccColumn(occId, eventId, set){
    const r = await sb.from('occurrences').update(set).eq('id', occId).eq('event_id', eventId);
    return !!r.error ? false : true;
  }

  function pinSvgUrl(color = '#22b3f0', outline = '#ffffff'){
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 72">
      <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z"
            fill="${color}" stroke="${outline}" stroke-width="3"/>
      <circle cx="32" cy="24" r="9" fill="#ffffff"/>
    </svg>`;
    return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
  }
  const ICON_NORMAL   = pinSvgUrl('#22b3f0', '#ffffff');
  const ICON_SELECTED = pinSvgUrl('#22b3f0', '#ffd24d');

  // ====== MAPPE: Leaflet ======
  let LEAF  = { map:null, pinIcon:null, markers:new Map() };
  function initLeaf(){
    LEAF.map = L.map('map', { attributionControl:false }).setView([45.0703,7.6869], 6);
    L.control.attribution({prefix:false}).addTo(LEAF.map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap contributors'}).addTo(LEAF.map);
    LEAF.pinIcon = L.divIcon({
      className:'sq-pin',
      html:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 72" width="30" height="34" style="display:block;filter:drop-shadow(0 0 2px #fff)">
              <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0" stroke="#ffffff" stroke-width="2"/>
              <circle cx="32" cy="24" r="9" fill="#ffffff"/></svg>`,
      iconSize:[30,34], iconAnchor:[15,34], popupAnchor:[0,-30]
    });
  }
  function lAddMarker(eventId, lat, lng, title){
    const m = L.marker([lat,lng], {icon:LEAF.pinIcon}).addTo(LEAF.map).bindPopup(`<div style="color:#081421"><b>${title}</b></div>`);
    m.on('click', ()=> toggleSelect(eventId));
    if (!LEAF.markers.has(eventId)) LEAF.markers.set(eventId, []);
    LEAF.markers.get(eventId).push(m);
  }
  function lClearMarkers(){
    LEAF.markers.forEach(list=> list.forEach(m=> LEAF.map.removeLayer(m)));
    LEAF.markers.clear();
  }
  function lFit(){
    const all = [];
    LEAF.markers.forEach(list=> list.forEach(m=> all.push(m.getLatLng())));
    if (all.length) LEAF.map.fitBounds(L.latLngBounds(all), {padding:[40,40]});
  }
  function lSetSelected(eventId, on){
    (LEAF.markers.get(eventId)||[]).forEach(m=>{
      const el = m.getElement(); if (!el) return;
      el.style.outline = on ? '3px solid #ffd24d' : '';
    });
  }

  // ====== STATO & DATI ======
  const EVENTS = new Map(); // id -> evento
  const OCCS_BY_EVENT = new Map(); // id -> [occ non cestinate future]
  const ALL_OCCS_BY_EVENT = new Map(); // id -> [tutte le occ (per cestino)]
  const SELECTED = new Set();
  function setSelectedIcon(id, on){ lSetSelected(id, on); }

  // ====== CARICA DATI ======
  async function loadData(){
    const { data: evs, error: evErr } = await sb.from('events')
      .select('id, title, titolo, description, descrizione, categories, categorie, locandina_url, published, deleted_at');
    if (evErr){ console.error(evErr); alert('Errore lettura events'); return; }

    const { data: occs, error: ocErr } = await sb.from('occurrences')
      .select('id, event_id, lat, lng, data, ora, luogo, indirizzo, citta, city, address, time, venue, deleted_at');
    if (ocErr){ console.error(ocErr); alert('Errore lettura occorrenze'); return; }

    EVENTS.clear();
    (evs||[]).forEach(e=>{
      EVENTS.set(e.id, { id: e.id, title: getTitle(e), raw: e });
    });

    OCCS_BY_EVENT.clear();
    ALL_OCCS_BY_EVENT.clear();
    (occs||[]).forEach(o=>{
      if (!ALL_OCCS_BY_EVENT.has(o.event_id)) ALL_OCCS_BY_EVENT.set(o.event_id, []);
      ALL_OCCS_BY_EVENT.get(o.event_id).push(o);

      if (o.deleted_at) return;
      if (o.data && o.data < todayISO()) return;
      if (o.lat==null || o.lng==null) return;
      if (!OCCS_BY_EVENT.has(o.event_id)) OCCS_BY_EVENT.set(o.event_id, []);
      OCCS_BY_EVENT.get(o.event_id).push(o);
    });

    drawMarkers();
  }

  function drawMarkers(){
    lClearMarkers(); SELECTED.clear(); updateSelectionUI();
    OCCS_BY_EVENT.forEach((list, eventId)=>{
      const ev = EVENTS.get(eventId); if (!ev) return;
      if (ev.raw.deleted_at || ev.raw.published === false) return; // sulla mappa solo attivi
      list.forEach(occ=> lAddMarker(eventId, occ.lat, occ.lng, ev.title));
    });
    lFit();
  }

  // ====== SELEZIONE ======
  function toggleSelect(eventId){
    if (!EVENTS.has(eventId)) return;
    const on = !SELECTED.has(eventId);
    if (on) SELECTED.add(eventId); else SELECTED.delete(eventId);
    setSelectedIcon(eventId, on);
    updateSelectionUI();
  }
  $('#clearSel').addEventListener('click', ()=>{
    [...SELECTED].forEach(id=> setSelectedIcon(id,false));
    SELECTED.clear();
    updateSelectionUI();
  });

  function updateSelectionUI(){
    $('#selCount').textContent = SELECTED.size;
    const box = $('#selList');
    if (!SELECTED.size){ box.innerHTML = '<div class="muted">Nessun evento selezionato.</div>'; return; }
    const rows = [...SELECTED].map(id=>{
      const ev = EVENTS.get(id);
      const occs = OCCS_BY_EVENT.get(id)||[];
      const city = occs[0]?.citta || occs[0]?.city || '';
      return `<div class="item">
        <div><b>${ev?.title||'(evento)'}</b> <span class="muted">‚Äî ${city}</span> <span class="muted" title="ID evento">${id}</span></div>
        <button class="btn small" data-unselect="${id}" type="button">Rimuovi</button>
      </div>`;
    }).join('');
    box.innerHTML = rows;
    box.querySelectorAll('[data-unselect]').forEach(b=>{
      b.addEventListener('click', ()=> toggleSelect(b.getAttribute('data-unselect')));
    });
  }

  // ====== AZIONI: Nascondi / Cestino ======
  async function softHide(){
    if (!SELECTED.size) { alert('Seleziona almeno un evento.'); return; }
    if (!confirm(`Nascondere ${SELECTED.size} evento/i? (published=false)`)) return;
    const ids = [...SELECTED];
    const r = await sb.from('events').update({ published:false }).in('id', ids);
    if (r.error){ alert('Errore: '+(r.error.message||String(r.error))); return; }
    ids.forEach(id=>{ const e=EVENTS.get(id); if (e){ e.raw.published=false; } });
    drawMarkers();
    $('#lastAction').textContent = 'Fatto: eventi nascosti.';
    window.notifyEventsChanged();
  }
  async function hardDelete(){
    if (!SELECTED.size) { alert('Seleziona almeno un evento.'); return; }
    if (!confirm(`Spostare nel CESTINO ${SELECTED.size} evento/i?`)) return;
    const ids = [...SELECTED];
    const nowIso = new Date().toISOString();
    const r1 = await sb.from('occurrences').update({ deleted_at: nowIso }).in('event_id', ids);
    if (r1.error){ alert('Errore occorrenze: '+(r1.error.message||String(r1.error))); return; }
    const r2 = await sb.from('events').update({ deleted_at: nowIso, published:false }).in('id', ids);
    if (r2.error){ alert('Errore eventi: '+(r2.error.message||String(r2.error))); return; }
    ids.forEach(id=>{ const e=EVENTS.get(id); if (e){ e.raw.deleted_at=nowIso; e.raw.published=false; } });
    drawMarkers();
    $('#lastAction').textContent = 'Fatto: eventi nel cestino.';
    window.notifyEventsChanged();
  }
  $('#btnSoft').addEventListener('click', softHide);
  $('#btnHard').addEventListener('click', hardDelete);

  // ====== MODALI di servizio (Nascosti / Cestino) ======
  function openModal(id){ const m=$('#'+id); if(m) m.style.display='flex'; }
  function closeModal(id){ const m=$('#'+id); if(m) m.style.display='none'; }
  $$('[data-close]').forEach(b=> b.addEventListener('click', ()=> closeModal(b.getAttribute('data-close')) ));

  $('#btnViewHidden').addEventListener('click', ()=> { openModal('modalHidden'); renderHidden(); });
  $('#btnViewDeleted').addEventListener('click', ()=> { openModal('modalDeleted'); renderDeleted(); });

  async function renderHidden(){
    const from = $('#hFrom').value || null;
    const to   = $('#hTo').value   || null;
    const city = ($('#hCity').value||'').trim().toLowerCase();
    const cat  = $('#hCat').value || '';

    const { data: evs, error } = await sb.from('events')
      .select('id, title, titolo, categories, categorie, published, deleted_at')
      .eq('published', false).is('deleted_at', null);
    if (error){ $('#hResults').innerHTML = `<div class="small">Errore: ${error.message}</div>`; return; }

    const evFiltered = (evs||[]).filter(e=> !cat || getCats(e).includes(cat));
    const ids = evFiltered.map(e=>e.id);
    if (!ids.length){ $('#hResults').innerHTML = '<div class="small">Nessun evento nascosto.</div>'; return; }

    const { data: occs } = await sb.from('occurrences')
      .select('event_id, data, citta, city, deleted_at')
      .in('event_id', ids).is('deleted_at', null);

    const byEvent = new Map();
    (occs||[]).forEach(o=>{
      const d=o.data, c=(o.citta||o.city||'').toLowerCase();
      if (from && (!d || d<from)) return;
      if (to   && (!d || d>to))   return;
      if (city && !c.includes(city)) return;
      if (!byEvent.has(o.event_id)) byEvent.set(o.event_id, []);
      byEvent.get(o.event_id).push(o);
    });

    let html='';
    evFiltered.forEach(e=>{
      const occsOk = byEvent.get(e.id)||[];
      if ((from||to||city) && !occsOk.length) return;
      const cityTxt = occsOk[0]?.citta || occsOk[0]?.city || '';
      html += `<div class="item">
        <div><b>${getTitle(e)}</b> <span class="muted">‚Äî ${cityTxt}</span> <span class="muted">${e.id}</span></div>
        <div><button class="btn small" data-restore-hidden="${e.id}" type="button">Ripristina</button></div>
      </div>`;
    });
    $('#hResults').innerHTML = html || '<div class="small">Nessun evento nascosto per i filtri impostati.</div>';

    $$('#hResults [data-restore-hidden]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = b.getAttribute('data-restore-hidden');
        const r = await sb.from('events').update({ published:true }).eq('id', id);
        if (r.error){ alert('Errore ripristino: '+(r.error.message||String(r.error))); return; }
        $('#lastAction').textContent = 'Evento ripristinato.';
        await loadData(); renderHidden();
        window.notifyEventsChanged();
      });
    });
  }

  async function renderDeleted(){
    const from = $('#dFrom').value || null;
    const to   = $('#dTo').value   || null;
    const city = ($('#dCity').value||'').trim().toLowerCase();
    const cat  = $('#dCat').value || '';
    const today = todayISO();

    const rOcc = await sb.from('occurrences')
      .select('event_id, data, citta, city, deleted_at')
      .not('deleted_at','is',null);
    if (rOcc.error){ $('#dResults').innerHTML = `<div class="small">Errore: ${rOcc.error.message}</div>`; return; }
    const ids = [...new Set((rOcc.data||[]).map(o=>o.event_id))];

    let evs = [];
    if (ids.length){
      const rEv = await sb.from('events').select('id, title, titolo, categories, categorie').in('id', ids);
      if (!rEv.error) evs = rEv.data||[];
    }

    const evFiltered = evs.filter(e=> !cat || getCats(e).includes(cat));
    if (!evFiltered.length){ $('#dResults').innerHTML = '<div class="small">Cestino vuoto per i filtri impostati.</div>'; return; }

    const byEvent = new Map();
    (rOcc.data||[]).forEach(o=>{
      const c=(o.citta||o.city||'').toLowerCase();
      if (from && (!o.data || o.data<from)) return;
      if (to   && (!o.data || o.data>to))   return;
      if (city && !c.includes(city)) return;
      if (!byEvent.has(o.event_id)) byEvent.set(o.event_id, []);
      byEvent.get(o.event_id).push(o);
    });

    let html='';
    evFiltered.forEach(e=>{
      const occsAll = (ALL_OCCS_BY_EVENT.get(e.id)||[]);
      const hasFuture = occsAll.some(o => o.data && o.data >= today);
      const occsOk = byEvent.get(e.id)||[];
      if ((from||to||city) && !occsOk.length) return;
      const cityTxt = occsOk[0]?.citta || occsOk[0]?.city || '';
      html += `<div class="item">
        <div><b>${getTitle(e)}</b> <span class="muted">‚Äî ${cityTxt||'‚Äî'}</span> <span class="muted">${e.id}</span></div>
        <div>
          ${hasFuture
            ? `<button class="btn small" data-restore-deleted="${e.id}" type="button">Ripristina</button>
               <button class="btn warning small" data-hardpurge="${e.id}" type="button">Elimina definitivamente</button>`
            : `<button class="btn warning small" data-hardpurge="${e.id}" type="button">Elimina definitivamente</button>`
          }
        </div>
      </div>`;
    });

    $('#dResults').innerHTML = html || '<div class="small">Cestino vuoto per i filtri impostati.</div>';

    $$('#dResults [data-restore-deleted]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = b.getAttribute('data-restore-deleted');
        const r1 = await sb.from('occurrences').update({ deleted_at:null }).eq('event_id', id);
        if (r1.error){ alert('Errore ripristino occorrenze: '+(r1.error.message||String(r1.error))); return; }
        const r2 = await sb.from('events').update({ deleted_at:null, published:true }).eq('id', id);
        if (r2.error){ alert('Errore ripristino evento: '+(r2.error.message||String(r2.error))); return; }
        $('#lastAction').textContent = 'Evento ripristinato dal cestino.';
        await loadData(); renderDeleted();
        window.notifyEventsChanged();
      });
    });

    $$('#dResults [data-hardpurge]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = b.getAttribute('data-hardpurge');
        if (!confirm('Eliminare DEFINITIVAMENTE questo evento? Verr√† rimosso dal DB.')) return;

        // log (best-effort)
        try{
          const ev = EVENTS.get(id)?.raw;
          const occs = ALL_OCCS_BY_EVENT.get(id)||[];
          if (ev){ await sb.from('events_log').insert([{ event_id:id, action:'hard_delete', snapshot:ev, action_at:new Date().toISOString() }]); }
          if (occs.length){
            const rows = occs.map(o=>({ event_id:id, occ_id:o.id, action:'hard_delete', snapshot:o, action_at: new Date().toISOString() }));
            await sb.from('occurrences_log').insert(rows);
          }
        }catch(_){}

        const r1 = await sb.from('occurrences').delete().eq('event_id', id);
        if (r1.error){ alert('Errore delete occorrenze: '+(r1.error.message||String(r1.error))); return; }
        const r2 = await sb.from('events').delete().eq('id', id);
        if (r2.error){ alert('Errore delete evento: '+(r2.error.message||String(r2.error))); return; }

        $('#lastAction').textContent = 'Evento eliminato definitivamente.';
        await loadData(); renderDeleted();
        window.notifyEventsChanged();
      });
    });
  }

  // ====== EDITOR: UI ======
  const editModal = $('#editModal');
  const edTitle   = $('#edTitle');
  const edIdx     = $('#edIdx');
  const edErr     = $('#edErr');
  const eTitolo   = $('#e_titolo');
  const eCatBtn   = $('#e_catBtn');
  const eLocUrl   = $('#e_loc_url');
  const eLocFile  = $('#e_loc_file');
  const eLocBtn   = $('#e_loc_btn');
  const eLocMsg   = $('#e_loc_msg');
  const eDescr    = $('#e_descr');
  const ePublished= $('#e_published');
  const eExtended = $('#e_extended');
  const occWrap   = $('#occWrap');
  const edPrev    = $('#edPrev');
  const edNext    = $('#edNext');
  const edClose   = $('#edClose');
  const edSave    = $('#edSave');
  const edSaveNext= $('#edSaveNext');

  let CURRENT_IDS = [];   // array di event_id selezionati
  let CUR_INDEX   = 0;    // indice corrente in CURRENT_IDS
  let CUR_EVENT   = null; // snapshot originale dell'evento corrente
  let CUR_OCCS    = [];   // snapshot originale occorrenze correnti (non cestinate)

  // Categorie (modal)
  const catModal = $('#catModal');
  const chipsModal = $('#chipsModal');
  const catBadges = $('#catBadges');
  const ALL_CATS = ['Musica','Food & Drink','Nightlife','Cultura/Spettacolo','Famiglie & Bambini','Sport','Sagre & Fiere','Mercatini'];
  function renderChipSet(selected){
    chipsModal.innerHTML = ALL_CATS.map(c=>{
      const on = selected.includes(c);
      return `<div class="chip ${on?'active':''}" data-cat="${c}" style="background:${on?'#22b3f0':'#17304d'};border:1px solid ${on?'#22b3f0':'#2e6e8f'};color:#fff;border-radius:28px;padding:10px 18px;font-weight:700;cursor:pointer;user-select:none">${c}</div>`;
    }).join('');
  }
  function renderBadges(selected){
    catBadges.innerHTML = selected.map(c=> `<span class="badge">${c}</span>`).join('');
  }
  function getSelectedCatsFromUI(){
    return Array.from(catBadges.querySelectorAll('.badge')).map(x=>x.textContent);
  }
  eCatBtn.addEventListener('click', ()=>{
    const sel = getSelectedCatsFromUI();
    renderChipSet(sel);
    openModal('catModal');
  });
  chipsModal.addEventListener('click', e=>{
    if(e.target.classList.contains('chip')){
      const ch=e.target;
      const on = !ch.classList.contains('active');
      ch.classList.toggle('active', on);
      ch.style.background = on ? '#22b3f0' : '#17304d';
      ch.style.borderColor = on ? '#22b3f0' : '#2e6e8f';
    }
  });
  $('#catClear').addEventListener('click', ()=>{
    catBadges.innerHTML='';
    renderChipSet([]);
  });
  $('#catOk').addEventListener('click', ()=>{
    const sel = Array.from(chipsModal.querySelectorAll('.chip.active')).map(ch=> ch.getAttribute('data-cat'));
    renderBadges(sel);
    closeModal('catModal');
  });
  $('#catClose').addEventListener('click', ()=> closeModal('catModal'));

  // Occorrenze UI
  function occRow(o){
    // o: {id, luogo, indirizzo, citta, data, ora, ora_feriale, ora_festivo, lat, lng}
    const occId = o?.id || '';
    const rid = 'occ_' + uniqueId();
    return `<div class="occ" data-occ="${rid}">
      <div class="head">
        <b>Occorrenza</b>
        <button class="btn secondary small del-occ" type="button">Rimuovi</button>
      </div>
      <input type="hidden" class="occ_id" value="${occId}">
      <div class="grid">
        <div><label>Luogo/Nome locale*</label><input class="luogo" value="${o?.luogo||o?.venue||''}" placeholder="Es. Bar Centrale"></div>
        <div><label>Indirizzo*</label><input class="indirizzo" value="${o?.indirizzo||o?.address||''}" placeholder="Via Roma 1"></div>
      </div>
      <div class="grid">
        <div><label>Citt√†*</label><input class="citta" value="${o?.citta||o?.city||''}" placeholder="Es. Torino"></div>
        <div><label>Data*</label><input class="data" type="date" value="${o?.data||''}"></div>
      </div>
      <div class="grid">
        <div>
          <label>Orario feriale (opzionale)</label>
          <input class="ora_feriale" type="text" placeholder="es. 15:00‚Äì21:00" value="${o?.ora_feriale||o?.time_weekday||''}">
        </div>
        <div>
          <label>Orario festivo/prefestivo (opzionale)</label>
          <input class="ora_festivo" type="text" placeholder="es. 10:00‚Äì23:00" value="${o?.ora_festivo||o?.time_weekend||''}">
        </div>
      </div>
      <div class="grid">
        <div>
          <label>Orario generico (fallback)</label>
          <input class="ora" type="text" placeholder="es. 15:00‚Äì21:00 (se vuoto usiamo i due sopra)" value="${o?.ora||o?.time||''}">
        </div>
        <div></div>
      </div>
    </div>`;
  }
  $('#addOcc').addEventListener('click', ()=> { occWrap.insertAdjacentHTML('beforeend', occRow({})); });
  occWrap.addEventListener('click', e=>{
    if (e.target.classList.contains('del-occ')) {
      const box = e.target.closest('.occ'); if (box) box.remove();
    }
  });

  // ====== Google Maps JS per geocoding ======
  let gmLoadedPromise=null;
  function loadGoogle(){
    if (window.google && window.google.maps) return Promise.resolve();
    if (gmLoadedPromise) return gmLoadedPromise;
    gmLoadedPromise = new Promise((resolve, reject)=>{
      if(!hasGoogleKey){ reject(new Error('Manca GOOGLE_MAPS_API_KEY')); return; }
      const s = document.createElement('script');
      s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GMAPS_KEY)}&libraries=places&v=quarterly`;
      s.async = true; s.defer = true;
      s.onload = ()=> resolve(); s.onerror = ()=> reject(new Error('Caricamento Google Maps JS fallito'));
      document.head.appendChild(s);
    });
    return gmLoadedPromise;
  }
  async function geocode(indirizzo, citta){
    await loadGoogle();
    const geocoder = new google.maps.Geocoder();
    const tentativi = [
      { address: `${indirizzo}, ${citta}`, componentRestrictions: { country:'IT', locality: citta } },
      { address: `${indirizzo}, ${citta}`, componentRestrictions: { country:'IT' } },
      { address: `${indirizzo}, ${citta}, Italia`, componentRestrictions: { country:'IT' } },
    ];
    for (const t of tentativi){
      const res = await new Promise((resolve)=>{
        geocoder.geocode(t, (results, status)=>{
          if(status==='OK' && results && results[0] && results[0].geometry){
            const loc = results[0].geometry.location;
            resolve({ok:true, lat:+loc.lat().toFixed(6), lng:+loc.lng().toFixed(6)});
          } else resolve({ok:false});
        });
      });
      if (res.ok) return res;
    }
    throw new Error('Geocoding fallito');
  }

  // ====== Upload locandina (Supabase Storage) ======
  const POSTERS_BUCKET = 'event-images';
  eLocBtn.addEventListener('click', ()=> eLocFile.click());
  eLocFile.addEventListener('change', async (e)=>{
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    eLocMsg.textContent=''; eLocMsg.className='small';
    if (!/^image\/(png|jpe?g|webp)$/.test(file.type)){ eLocMsg.textContent='Formato non valido. Usa PNG/JPG/WebP.'; eLocMsg.classList.add('err'); eLocFile.value=''; return; }
    if (file.size > 6*1024*1024){ eLocMsg.textContent='File troppo grande (max 6 MB).'; eLocMsg.classList.add('err'); eLocFile.value=''; return; }
    try{
      eLocMsg.textContent='Upload in corso‚Ä¶'; eLocMsg.classList.remove('err'); eLocMsg.classList.add('ok');
      const ts = new Date().toISOString().replace(/[:.]/g,'-');
      const rnd = Math.random().toString(36).slice(2,8);
      const ext = file.type==='image/png'?'png':(file.type==='image/webp'?'webp':'jpg');
      const path = `events/${ts}_${rnd}.${ext}`;
      const up = await sb.storage.from(POSTERS_BUCKET).upload(path, file, { upsert:false, contentType:file.type });
      if (up.error){ throw new Error(up.error.message); }
      const pub = sb.storage.from(POSTERS_BUCKET).getPublicUrl(path);
      const url = pub?.data?.publicUrl || '';
      if (!url) throw new Error('URL pubblico non disponibile');
      eLocUrl.value = url;
      eLocMsg.textContent='Caricata ‚úî, URL impostata';
      eLocMsg.classList.add('ok');
    }catch(ex){
      eLocMsg.textContent = 'Errore upload: ' + (ex?.message||String(ex));
      eLocMsg.classList.remove('ok'); eLocMsg.classList.add('err');
    }finally{
      eLocFile.value='';
    }
  });

  // ====== Caricamento in editor ======
  function openEditorFor(index){
    if (!CURRENT_IDS.length) return;
    CUR_INDEX = Math.max(0, Math.min(index, CURRENT_IDS.length-1));
    const id = CURRENT_IDS[CUR_INDEX];
    const ev = EVENTS.get(id)?.raw;
    const occs = (ALL_OCCS_BY_EVENT.get(id)||[]).filter(o=>!o.deleted_at); // mostro non cestinate

    CUR_EVENT = JSON.parse(JSON.stringify(ev||{})); // snapshot
    CUR_OCCS  = JSON.parse(JSON.stringify(occs||[]));

    edTitle.textContent = 'Modifica evento';
    edIdx.textContent   = CURRENT_IDS.length>1 ? `(${CUR_INDEX+1} di ${CURRENT_IDS.length})` : '';
    edErr.textContent   = '';

    eTitolo.value = ev?.titolo || ev?.title || '';
    eDescr.value  = ev?.descrizione || ev?.description || '';
    ePublished.value = String(ev?.published!==false);
    eLocUrl.value = ev?.locandina_url || '';

    // Extended flag (supporto pi√π nomi colonna)
    const extVal = (ev?.is_extended ?? ev?.extended ?? ev?.evento_diffuso ?? ev?.diffuso) ? 'true' : 'false';
    eExtended.value = extVal;

    const cats = getCats(ev||{});
    renderBadges(cats);

    occWrap.innerHTML = '';
    if (CUR_OCCS.length){
      CUR_OCCS.forEach(o=> occWrap.insertAdjacentHTML('beforeend', occRow(o)));
    } else {
      occWrap.insertAdjacentHTML('beforeend', occRow({}));
    }

    editModal.style.display='flex';
    document.body.style.overflow='hidden';
  }

  function closeEditor(){
    editModal.style.display='none';
    document.body.style.overflow='auto';
  }
  edClose.addEventListener('click', closeEditor);
  edPrev.addEventListener('click', ()=> openEditorFor(Math.max(0, CUR_INDEX-1)));
  edNext.addEventListener('click', ()=> openEditorFor(Math.min(CURRENT_IDS.length-1, CUR_INDEX+1)));

  $('#btnEdit').addEventListener('click', ()=>{
    if (!SELECTED.size){ alert('Seleziona almeno un evento sulla mappa.'); return; }
    CURRENT_IDS = [...SELECTED];
    openEditorFor(0);
  });

  // ====== Salvataggio ======
  function clean(t){ t=(t||'').trim().replace(/\s+/g,' '); return t; }
  function collectOccFromUI(){
    const rows = Array.from(occWrap.querySelectorAll('.occ'));
    const occ = [];
    for (const box of rows){
      const id = (box.querySelector('.occ_id')||{}).value||'';
      const luogo = clean((box.querySelector('.luogo')||{}).value||'');
      const indirizzo = clean((box.querySelector('.indirizzo')||{}).value||'');
      const citta = clean((box.querySelector('.citta')||{}).value||'');
      const data = (box.querySelector('.data')||{}).value||'';
      const ora  = (box.querySelector('.ora')||{}).value||'';
      const ora_feriale = (box.querySelector('.ora_feriale')||{}).value||'';
      const ora_festivo = (box.querySelector('.ora_festivo')||{}).value||'';
      if (!luogo || !indirizzo || !citta || !data) return null;
      occ.push({ id, luogo, indirizzo, citta, data, ora, ora_feriale, ora_festivo });
    }
    return occ;
  }

  async function saveCurrentEvent(){
    edErr.textContent='';
    const eventId = CURRENT_IDS[CUR_INDEX];
    if (!eventId){ edErr.textContent='ID evento mancante.'; return false; }

    const titolo = clean(eTitolo.value);
    const descr  = clean(eDescr.value);
    const pub    = ePublished.value === 'true';
    const isExtended = eExtended.value === 'true';
    const locUrl = clean(eLocUrl.value);
    const cats   = getSelectedCatsFromUI();
    if (!titolo || !descr || !cats.length){ edErr.textContent='Compila Titolo*, Descrizione* e almeno 1 Categoria*.'; return false; }

    // --- Occorrenze
    const occUI = collectOccFromUI();
    if (!occUI){ edErr.textContent='Completa tutti i campi di ogni occorrenza.'; return false; }

    // Map originale per capire cosa √® cambiato
    const origById = new Map(CUR_OCCS.map(o=> [String(o.id), o]));

    // Geocoding solo se indirizzo/citt√† sono cambiati o se √® una nuova occ
    const occReady = [];
    for (const o of occUI){
      let lat=null, lng=null;
      if (o.id && origById.has(String(o.id))){
        const prev = origById.get(String(o.id));
        const sameAddr = (clean(prev.indirizzo||prev.address||'')===o.indirizzo) && (clean(prev.citta||prev.city||'')===o.citta);
        if (sameAddr){
          lat = +(+prev.lat||0).toFixed(6);
          lng = +(+prev.lng||0).toFixed(6);
        } else {
          try{
            const g = await geocode(o.indirizzo, o.citta);
            lat = g.lat; lng = g.lng;
          }catch(_){ edErr.textContent=`Indirizzo non trovato: ${o.indirizzo}, ${o.citta}`; return false; }
        }
      } else { // nuova
        try{
          const g = await geocode(o.indirizzo, o.citta);
          lat = g.lat; lng = g.lng;
        }catch(_){ edErr.textContent=`Indirizzo non trovato: ${o.indirizzo}, ${o.citta}`; return false; }
      }
      occReady.push({ ...o, lat, lng });
    }

    // --- Salvataggio evento (SOLO campi sicuri)
    const payloadEvent = {
      title: titolo,
      titolo: titolo,
      description: descr,
      descrizione: descr,
      categories: cats,
      categorie: cats,
      locandina_url: locUrl,
      published: pub
    };
    const rEv = await sb.from('events').update(payloadEvent).eq('id', eventId).select('id').single();
    if (rEv.error){ edErr.textContent='Errore salvataggio evento: '+(rEv.error.message||String(rEv.error)); return false; }

    // Prova ad aggiornare "evento diffuso" su eventuali nomi di colonna (ignora se non esistono)
    await tryUpdateEventColumn(eventId, { is_extended: isExtended });
    await tryUpdateEventColumn(eventId, { extended: isExtended });
    await tryUpdateEventColumn(eventId, { evento_diffuso: isExtended });
    await tryUpdateEventColumn(eventId, { diffuso: isExtended });

    // --- Gestione occorrenze: upsert/soft-delete + orari feriale/festivo
    const nowIso = new Date().toISOString();
    const keepIds = [];
    for (const o of occReady){
      if (o.id){ // update
        const up = {
          luogo: o.luogo, venue: o.luogo,
          indirizzo: o.indirizzo, address: o.indirizzo,
          citta: o.citta, city: o.citta,
          data: o.data, time: o.ora, ora: o.ora,
          lat: o.lat, lng: o.lng
        };
        const r = await sb.from('occurrences').update(up).eq('id', o.id).eq('event_id', eventId);
        if (r.error){ edErr.textContent='Errore update occorrenza: '+(r.error.message||String(r.error)); return false; }
        keepIds.push(String(o.id));

        // tentativi colonne opzionali (ignorati se non esistono)
        if (o.ora_feriale) { await tryUpdateOccColumn(o.id, eventId, { ora_feriale: o.ora_feriale }); await tryUpdateOccColumn(o.id, eventId, { time_weekday: o.ora_feriale }); }
        if (o.ora_festivo) { await tryUpdateOccColumn(o.id, eventId, { ora_festivo: o.ora_festivo }); await tryUpdateOccColumn(o.id, eventId, { time_weekend: o.ora_festivo }); }
        if (!o.ora && (o.ora_feriale || o.ora_festivo)){
          const combo = `${o.ora_feriale ? 'Feriale: '+o.ora_feriale : ''}${(o.ora_feriale && o.ora_festivo)?' | ':''}${o.ora_festivo ? 'Festivo: '+o.ora_festivo : ''}`;
          const rF = await sb.from('occurrences').update({ ora: combo, time: combo }).eq('id', o.id).eq('event_id', eventId);
          if (rF.error){ edErr.textContent='Errore salvataggio orario combinato: '+(rF.error.message||String(rF.error)); return false; }
        }

      } else { // insert
        const row = {
          event_id: eventId,
          luogo: o.luogo, venue: o.luogo,
          indirizzo: o.indirizzo, address: o.indirizzo,
          citta: o.citta, city: o.citta,
          data: o.data, time: o.ora, ora: o.ora,
          lat: o.lat, lng: o.lng
        };
        const r = await sb.from('occurrences').insert(row).select('id').single();
        if (r.error){ edErr.textContent='Errore inserimento occorrenza: '+(r.error.message||String(r.error))); return false; }
        const occId = String(r.data.id);
        keepIds.push(occId);

        if (o.ora_feriale) { await tryUpdateOccColumn(occId, eventId, { ora_feriale: o.ora_feriale }); await tryUpdateOccColumn(occId, eventId, { time_weekday: o.ora_feriale }); }
        if (o.ora_festivo) { await tryUpdateOccColumn(occId, eventId, { ora_festivo: o.ora_festivo }); await tryUpdateOccColumn(occId, eventId, { time_weekend: o.ora_festivo }); }
        if (!o.ora && (o.ora_feriale || o.ora_festivo)){
          const combo = `${o.ora_feriale ? 'Feriale: '+o.ora_feriale : ''}${(o.ora_feriale && o.ora_festivo)?' | ':''}${o.ora_festivo ? 'Festivo: '+o.ora_festivo : ''}`;
          const rF = await sb.from('occurrences').update({ ora: combo, time: combo }).eq('id', occId).eq('event_id', eventId);
          if (rF.error){ edErr.textContent='Errore salvataggio orario combinato: '+(rF.error.message||String(rF.error))); return false; }
        }
      }
    }

    // Soft-delete occorrenze rimosse dall'editor
    const toDelete = CUR_OCCS
      .filter(x=> !x.deleted_at)
      .filter(x=> !keepIds.includes(String(x.id)))
      .map(x=> String(x.id));
    if (toDelete.length){
      const r = await sb.from('occurrences').update({ deleted_at: nowIso }).in('id', toDelete).eq('event_id', eventId);
      if (r.error){ edErr.textContent='Errore delete occorrenze: '+(r.error.message||String(r.error))); return false; }
    }

    // Aggiorna snapshot locale + mappa
    $('#lastAction').textContent = 'Salvato.';
    await loadData();
    window.notifyEventsChanged();
    return true;
  }

  edSave.addEventListener('click', async ()=> { if (await saveCurrentEvent()) { alert('Modifiche salvate.'); } });
  edSaveNext.addEventListener('click', async ()=>{
    if (await saveCurrentEvent()){
      if (CUR_INDEX < CURRENT_IDS.length-1) openEditorFor(CUR_INDEX+1);
      else { alert('Modifiche salvate su tutti gli eventi selezionati.'); closeEditor(); }
    }
  });

  // ====== AVVIO ======
  const ok = await requireLogin();
  if (ok){
    initLeaf();
    setTimeout(()=> loadData(), 300);
  }
})();
</script>

<footer class="page-footer"><a class="btn" href="index.html">‚Üê Torna alla mappa</a></footer>

<script>
  // Segnale di refresh per altre pagine (se in ascolto)
  window.notifyEventsChanged = function () {
    try { localStorage.setItem('sq-last-change', String(Date.now())); } catch (e) {}
  };
</script>

</body>
</html>
