<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Seleziona & Elimina — Stasera Qui</title>

  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/style.css?v=12">

  <!-- Leaflet (solo fallback) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- Config condivisa -->
  <script src="assets/app-config.js?v=6"></script>

  <style>
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    #map{height:62vh;border-radius:12px;border:1px solid rgba(255,255,255,.15);margin-bottom:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.25);padding:6px 10px;border-radius:999px;background:#0f1c2d}
    .list{margin-top:8px;background:#0f1c2d;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:10px;max-height:22vh;overflow:auto;font-size:14px}
    .item{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,.12)}
    .item:last-child{border-bottom:none}
    .muted{color:#b8c2ce}
    .help{font-size:13px;color:#b8c2ce;margin:4px 0 10px}
    .chip-badge{display:inline-block;background:#17304d;border:1px solid #2e6e8f;color:#d7f2ff;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:6px}
    .id{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px}
    .btn.small{padding:6px 8px;font-size:12px;line-height:1}
    label.inline{display:inline-flex;gap:8px;align-items:center}
    input[type="checkbox"]{width:16px;height:16px}
  </style>
</head>
<body>
<header class="header" style="padding:0 16px">
  <a href="admin.html" class="logo" aria-label="Torna all'area admin">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true">
      <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/>
      <circle cx="32" cy="24" r="9" fill="#ffffff"/>
    </svg>
    <span class="wordmark">stasera qui</span>
  </a>
</header>

<main class="wrap">
  <h1 style="margin:8px 0 4px">Seleziona & elimina eventi</h1>
  <p class="help">
    Tocca/clicca i pin per selezionare gli eventi. Poi scegli se <b>Nascondere</b> (soft-delete: <i>published=false</i>),
    <b>Ripristinare</b> (<i>published=true</i>) oppure <b>Eliminare definitivamente</b> (hard-delete: rimuove evento e occorrenze).
  </p>

  <div id="map"></div>

  <div class="toolbar">
    <span class="badge">Selezionati: <b id="selCount">0</b></span>

    <label class="badge inline" title="Includi in mappa anche gli eventi nascosti (published=false)">
      <input type="checkbox" id="showHidden" checked>
      <span>Mostra anche gli eventi nascosti</span>
    </label>

    <button class="btn" id="clearSel" type="button">Pulisci selezione</button>
    <span class="muted" id="lastAction"></span>
  </div>

  <div class="list" id="selList" aria-live="polite"></div>

  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
    <button class="btn accent"   id="btnSoft"    type="button" title="Imposta published=false">Nascondi (published=false)</button>
    <button class="btn primary"  id="btnRestore" type="button" title="Imposta published=true">Ripristina (published=true)</button>
    <button class="btn danger"   id="btnHard"    type="button">Elimina definitivamente</button>
    <a class="btn" href="admin.html">← Torna all’area admin</a>
  </div>
</main>

<script>
(function(){
  // ====== CONFIG / SUPABASE ======
  const CFG = window.SQ_CONFIG || {};
  const SB_URL  = CFG.SUPABASE_URL;
  const SB_ANON = CFG.SUPABASE_ANON;
  const GMAPS_KEY = CFG.GOOGLE_MAPS_API_KEY;
  if (!SB_URL || !SB_ANON) { alert('Configurazione Supabase mancante (assets/app-config.js).'); }
  const sb = supabase.createClient(SB_URL, SB_ANON);

  const $ = s => document.querySelector(s);

  // ====== STATO DATI ======
  const EVENTS = new Map();        // idEvento -> { id, title, published }
  const OCCS_BY_EVENT = new Map(); // idEvento -> [ occ ]
  const SELECTED = new Set();      // idEvento selezionati

  // ====== GOOGLE vs LEAFLET ======
  let USE_GMAPS = false;
  let GMAPS = { map:null, markers:new Map(), bounds:null };
  let LEAF  = { map:null, markers:new Map(), pinIconPub:null, pinIconHid:null };

  function loadGoogle(){
    if (!GMAPS_KEY){ console.warn('No Google key -> OSM fallback'); initLeaflet(); return; }
    window.initGoogleMap = ()=>{
      USE_GMAPS = true;
      GMAPS.map = new google.maps.Map(document.getElementById('map'), {
        center:{lat:45.0703, lng:7.6869}, zoom:6, mapTypeControl:false, streetViewControl:false
      });
      GMAPS.bounds = new google.maps.LatLngBounds();
      fetchDataAndRender();
    };
    const s = document.createElement('script');
    s.src = `https://maps.googleapis.com/maps/api/js?key=${GMAPS_KEY}&callback=initGoogleMap`;
    s.async = true; s.defer = true;
    s.onerror = ()=>{ console.warn('Google Maps error -> OSM fallback'); initLeaflet(); };
    document.head.appendChild(s);
  }

  function initLeaflet(){
    USE_GMAPS = false;
    LEAF.map = L.map('map', { attributionControl:false }).setView([45.0703,7.6869], 6);
    L.control.attribution({prefix:false}).addTo(LEAF.map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap contributors'}).addTo(LEAF.map);

    LEAF.pinIconPub = (color='#22b3f0') => L.divIcon({
      className:'sq-pin',
      html:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 72" width="30" height="34" style="display:block;filter:drop-shadow(0 0 2px #fff)"><path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="${color}" stroke="#ffffff" stroke-width="2"/><circle cx="32" cy="24" r="9" fill="#ffffff"/></svg>`,
      iconSize:[30,34], iconAnchor:[15,34], popupAnchor:[0,-30]
    });
    LEAF.pinIconHid = () => LEAF.pinIconPub('#9fb7c9');

    fetchDataAndRender();
  }

  // ====== DATI ======
  function isTruthyPub(v){ return (v===true || v===1 || v==='1' || v==='t' || v==='true' || v==='T' || v==='TRUE'); }

  async function fetchDataAndRender(){
    // events: prendo TUTTI, non filtro qui
    const { data: evs, error: evErr } = await sb.from('events')
      .select('id, title, titolo, published');
    if (evErr){ console.error(evErr); alert('Errore lettura events'); return; }

    // occurrences
    const { data: occs, error: occErr } = await sb.from('occurrences')
      .select('id, event_id, lat, lng, data, ora, luogo, indirizzo, citta');
    if (occErr){ console.error(occErr); alert('Errore lettura occurrences'); return; }

    // normalize
    EVENTS.clear(); OCCS_BY_EVENT.clear();
    (evs||[]).forEach(e=>{
      EVENTS.set(e.id, {
        id: e.id,
        title: e.title || e.titolo || '(evento)',
        published: isTruthyPub(e.published)
      });
    });
    (occs||[]).forEach(o=>{
      if (o.lat==null || o.lng==null) return;
      if (!OCCS_BY_EVENT.has(o.event_id)) OCCS_BY_EVENT.set(o.event_id, []);
      OCCS_BY_EVENT.get(o.event_id).push(o);
    });

    drawAllMarkers();
  }

  // ====== ICON GOOGLE (SVG data URL) ======
  function pinSvgUrl({color='#22b3f0', selected=false}={}){
    const stroke = selected ? '#ffd24d' : '#ffffff';
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 72">
      <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="${color}" stroke="${stroke}" stroke-width="3"/>
      <circle cx="32" cy="24" r="9" fill="#ffffff"/></svg>`;
    return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
  }

  // ====== DISEGNO MARKERS ======
  function clearAllMarkers(){
    if (USE_GMAPS){
      GMAPS.markers.forEach(list => list.forEach(m => m.setMap(null)));
      GMAPS.markers.clear();
      GMAPS.bounds = new google.maps.LatLngBounds();
    } else {
      LEAF.markers.forEach(list => list.forEach(m => LEAF.map.removeLayer(m)));
      LEAF.markers.clear();
    }
  }

  function drawAllMarkers(){
    clearAllMarkers();
    const includeHidden = $('#showHidden').checked;

    // per bounds
    const allLatLngs = [];

    OCCS_BY_EVENT.forEach((occs, eventId)=>{
      const ev = EVENTS.get(eventId); if (!ev) return;
      if (!includeHidden && !ev.published) return;

      // colore in base allo stato
      const color = ev.published ? '#22b3f0' : '#9fb7c9';
      const markers = [];

      if (USE_GMAPS){
        occs.forEach(o=>{
          const pos = {lat:o.lat, lng:o.lng};
          const m = new google.maps.Marker({
            position: pos,
            map: GMAPS.map,
            icon: {
              url: pinSvgUrl({color}),
              scaledSize: new google.maps.Size(34, 38),
              anchor: new google.maps.Point(19, 38)
            },
            title: ev.title
          });
          const badge = ev.published ? '' : ' — [nascosto]';
          const iw = new google.maps.InfoWindow({ content: `<div style="color:#081421"><b>${ev.title}</b>${badge}<br><small>${o.citta||''}</small></div>`});
          m.addListener('click', ()=>{
            iw.open(GMAPS.map, m);
            toggleSelect(eventId); // seleziona l’evento al click
          });
          markers.push(m);
          GMAPS.bounds.extend(pos);
          allLatLngs.push(pos);
        });
        GMAPS.markers.set(eventId, markers);
      } else {
        const icon = ev.published ? LEAF.pinIconPub('#22b3f0') : LEAF.pinIconHid();
        occs.forEach(o=>{
          const m = L.marker([o.lat,o.lng], {icon}).addTo(LEAF.map);
          const badge = ev.published ? '' : ' <span class="chip-badge">nascosto</span>';
          m.bindPopup(`<div style="color:#081421"><b>${ev.title}</b>${badge}<br><small>${o.citta||''}</small></div>`);
          m.on('click', ()=> toggleSelect(eventId));
          markers.push(m);
          allLatLngs.push([o.lat,o.lng]);
        });
        LEAF.markers.set(eventId, markers);
      }
    });

    // fit bounds
    if (allLatLngs.length){
      try{
        if (USE_GMAPS && GMAPS.bounds){
          GMAPS.map.fitBounds(GMAPS.bounds);
        } else if (!USE_GMAPS){
          const b = L.latLngBounds(allLatLngs);
          LEAF.map.fitBounds(b, {padding:[40,40]});
        }
      }catch(_){}
    }

    updateSelectionUI();
  }

  // evidenzia/deseleziona su GMAPS cambiando l’icona (bordo giallo)
  function refreshSelectionGlow(eventId){
    const ev = EVENTS.get(eventId); if (!ev) return;
    const color = ev.published ? '#22b3f0' : '#9fb7c9';
    const selected = SELECTED.has(eventId);

    if (USE_GMAPS){
      const list = GMAPS.markers.get(eventId) || [];
      list.forEach(m=>{
        m.setIcon({
          url: pinSvgUrl({color, selected}),
          scaledSize: new google.maps.Size(34, 38),
          anchor: new google.maps.Point(19, 38)
        });
      });
    } else {
      // in Leaflet ridisegno (più semplice tenerlo così come fallback)
      const list = LEAF.markers.get(eventId) || [];
      list.forEach(m=>{
        if (selected) m.getElement()?.classList.add('pin-selected');
        else m.getElement()?.classList.remove('pin-selected');
      });
    }
  }

  // ====== SELEZIONE ======
  function toggleSelect(eventId){
    if (!EVENTS.has(eventId)) return;
    if (SELECTED.has(eventId)) SELECTED.delete(eventId);
    else SELECTED.add(eventId);
    refreshSelectionGlow(eventId);
    updateSelectionUI();
  }

  function updateSelectionUI(){
    $('#selCount').textContent = SELECTED.size;
    const box = $('#selList');
    if (!SELECTED.size){ box.innerHTML = '<div class="muted">Nessun evento selezionato.</div>'; return; }

    const rows = [...SELECTED].map(id=>{
      const ev = EVENTS.get(id);
      const occs = OCCS_BY_EVENT.get(id)||[];
      const city = occs[0]?.citta || '';
      const state = ev?.published ? '' : ' <span class="chip-badge">nascosto</span>';
      return `<div class="item">
        <div>
          <b>${ev?.title||'(evento)'}</b>${state}
          <span class="muted">— ${city}</span><br>
          <span class="muted id">${id}</span>
        </div>
        <button class="btn small" data-copy="${id}" type="button" title="Copia ID">Copia ID</button>
        <button class="btn small" data-unselect="${id}" type="button">Rimuovi</button>
      </div>`;
    }).join('');
    box.innerHTML = rows;

    box.querySelectorAll('[data-unselect]').forEach(b=>{
      b.addEventListener('click', ()=> toggleSelect(b.getAttribute('data-unselect')));
    });
    box.querySelectorAll('[data-copy]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        try{
          await navigator.clipboard.writeText(b.getAttribute('data-copy'));
          $('#lastAction').textContent = 'ID copiato negli appunti.';
        }catch(_){ alert('Non riesco a copiare.'); }
      });
    });
  }

  $('#clearSel').addEventListener('click', ()=>{
    const ids = [...SELECTED];
    ids.forEach(id => { SELECTED.delete(id); refreshSelectionGlow(id); });
    updateSelectionUI();
  });

  // ====== AZIONI ======
  async function softHide(){
    if (!SELECTED.size) { alert('Seleziona almeno un evento.'); return; }
    if (!confirm(`Nascondere ${SELECTED.size} evento/i? Verranno esclusi dalla home (published=false).`)) return;

    const ids = [...SELECTED];
    try{
      const { error } = await sb.from('events').update({ published:false }).in('id', ids);
      if (error){
        if (String(error.code) === '42703'){ // colonna non esiste
          if (confirm('La colonna "published" non esiste. Procedo con ELIMINAZIONE DEFINITIVA?')){
            return hardDelete();
          } else return;
        }
        throw error;
      }
    }catch(e){
      alert('Aggiornamento non riuscito: '+(e?.message||String(e)));
      return;
    }

    ids.forEach(id=>{ const ev = EVENTS.get(id); if (ev) ev.published = false; refreshSelectionGlow(id); });
    drawAllMarkers(); // rispetta il toggle "Mostra nascosti"
    $('#lastAction').textContent = 'Fatto: eventi nascosti.';
  }

  async function restoreEvents(){
    if (!SELECTED.size) { alert('Seleziona almeno un evento.'); return; }
    if (!confirm(`Ripristinare ${SELECTED.size} evento/i? Verranno rimessi online (published=true).`)) return;

    const ids = [...SELECTED];
    try{
      const { error } = await sb.from('events').update({ published:true }).in('id', ids);
      if (error) throw error;
    }catch(e){
      alert('Ripristino non riuscito: '+(e?.message||String(e)));
      return;
    }

    ids.forEach(id=>{ const ev = EVENTS.get(id); if (ev) ev.published = true; refreshSelectionGlow(id); });
    drawAllMarkers();
    $('#lastAction').textContent = 'Fatto: eventi ripristinati.';
  }

  async function hardDelete(){
    if (!SELECTED.size) { alert('Seleziona almeno un evento.'); return; }
    if (!confirm(`Eliminare DEFINITIVAMENTE ${SELECTED.size} evento/i? Saranno cancellate anche le relative occorrenze.`)) return;

    const ids = [...SELECTED];
    try{
      const r1 = await sb.from('occurrences').delete().in('event_id', ids);
      if (r1.error) throw r1.error;

      const r2 = await sb.from('events').delete().in('id', ids);
      if (r2.error) throw r2.error;
    }catch(e){
      alert('Cancellazione bloccata (probabile policy RLS).\n\nDettagli: '+(e?.message||String(e)));
      return;
    }

    ids.forEach(id=>{
      SELECTED.delete(id);
      EVENTS.delete(id);
      OCCS_BY_EVENT.delete(id);
    });
    drawAllMarkers();
    $('#lastAction').textContent = 'Fatto: eventi eliminati definitivamente.';
  }

  // Bind bottoni / toggle
  $('#btnSoft').addEventListener('click', softHide);
  $('#btnRestore').addEventListener('click', restoreEvents);
  '#btnHard' in window || true; // evita bundler strani
  document.getElementById('btnHard').addEventListener('click', hardDelete);
  $('#showHidden').addEventListener('change', drawAllMarkers);

  // BOOTSTRAP
  loadGoogle();
})();
</script>
</body>
</html>
