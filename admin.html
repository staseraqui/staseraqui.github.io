<!doctype html>
<html lang="it">
<head>
  <script src="assets/app-config.js?v=6"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin — Stasera Qui</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/style.css?v=12">
  <style>
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
    .card h2{margin:0 0 8px}
    .table{width:100%;border-collapse:collapse;margin:10px 0}
    .table th,.table td{border:1px solid rgba(255,255,255,.15);padding:8px;text-align:left}
    .table th{background:#0f1c2d}
    .smallmuted{font-size:13px;color:#b8c2ce}
    .row-actions{display:flex;gap:6px;flex-wrap:wrap}
    .modal{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;background:rgba(0,0,0,.5);z-index:99999}
    .modal .box{margin-top:60px;background:#0f1c2d;border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:14px;min-width:320px;max-width:920px;width:92%}
    .flex{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn.small{padding:6px 8px;font-size:12px}
    .right{ text-align:right }
  </style>
</head>
<body>
<header class="header" style="padding:0 16px">
  <a href="index.html" class="logo">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true">
      <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/>
      <circle cx="32" cy="24" r="9" fill="#ffffff"/>
    </svg>
    <span class="wordmark">stasera qui</span>
  </a>
</header>

<main class="wrap">
  <h1 style="margin:8px 0 14px">Area admin</h1>

  <!-- Diagnostica -->
  <div class="card" id="diagCard" style="margin-top:16px">
    <h2 style="margin-top:0">Diagnostica</h2>
    <p class="small">Esegue test rapidi su chiavi, DB, storage e funzioni Edge.</p>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
      <button class="btn primary" id="runDiag" type="button">Esegui test</button>
      <button class="btn" id="copyDiag" type="button">Copia report</button>
    </div>
    <pre id="diagOut" style="background:#0b1623;border:1px solid rgba(255,255,255,.12);padding:12px;border-radius:10px;max-height:420px;overflow:auto;margin:0;white-space:pre-wrap"></pre>
  </div>

  <div class="card">
    <h2>Azioni rapide</h2>
    <div class="grid">
      <div>
        <p class="small">Seleziona dalla mappa uno o più eventi e cancellali in blocco.</p>
        <a class="btn accent" href="seleziona-elimina.html">Seleziona ed elimina eventi</a>
      </div>
      <div>
        <p class="small">Importa da CSV (geocoding automatico + upload locandine) e pubblica subito.</p>
        <a class="btn primary" href="importa-eventi.html">Importa eventi (CSV)</a>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Reportistica</h2>
    <p class="small">Statistiche per periodo, città e tipologia.</p>
    <a class="btn" href="report.html">Apri report</a>
  </div>

  <div class="card">
    <h2>Pubblicazione singola</h2>
    <p class="small">Flusso pubblico con pagamento Stripe.</p>
    <a class="btn" href="pubblica-evento.html">Pubblica evento (singolo)</a>
  </div>

  <!-- ================== PARTNER (CRUD) ================== -->
  <div class="card" id="partnersCard">
    <h2>Partner</h2>
    <div class="flex" style="margin-bottom:8px">
      <button class="btn primary" id="btnAddPartner" type="button">➕ Nuovo partner</button>
      <span class="smallmuted">Gestisci l’anagrafica e genera il codice partner univoco.</span>
    </div>
    <div id="partnersTableWrap" class="smallmuted">Caricamento…</div>
  </div>

  <!-- ================== PAYOUT PARTNER ================== -->
  <div class="card" id="payoutsCard">
    <h2>Payout partner</h2>
    <div class="flex" style="margin-bottom:8px">
      <label class="small">Mese:</label>
      <input type="month" id="payMonth">
      <button class="btn" id="btnLoadPayouts" type="button">Carica</button>
      <button class="btn" id="btnCSVMonth" type="button">Scarica CSV (mese)</button>
      <span class="smallmuted">Totali “pending” da pagare; apri il dettaglio e marca come pagato.</span>
    </div>
    <div id="payoutsSummary" class="smallmuted">Seleziona un mese e premi “Carica”.</div>
    <div id="payoutDetail" style="margin-top:12px; display:none">
      <h3 style="margin:0 0 8px" id="payoutDetailTitle">Dettaglio</h3>
      <div class="flex" style="margin-bottom:6px">
        <input id="payRef" placeholder="Riferimento pagamento/bonifico (es. SEPA 2024-09 batch #1)" style="flex:1;min-width:260px">
        <button class="btn primary" id="btnMarkPaid" type="button">Segna tutto come pagato</button>
      </div>
      <div id="payoutDetailTable" class="smallmuted">—</div>
    </div>
  </div>

  <!-- ================== CODICI SCONTO (STRIPE) ================== -->
  <div class="card" id="couponCard">
    <h2>Codici sconto (Stripe)</h2>
    <p class="small">Crea promotion code (una tantum o con limite) che gli utenti possono inserire in Checkout.</p>

    <div class="grid">
      <div>
        <label>Codice*</label>
        <input id="cp_code" placeholder="Es. ADMIN100">
      </div>
      <div>
        <label>Tipo sconto*</label>
        <select id="cp_type">
          <option value="percent">Percentuale (%)</option>
          <option value="amount">Valore fisso (EUR)</option>
        </select>
      </div>
    </div>

    <div class="grid">
      <div id="cp_percent_wrap">
        <label>Percentuale (0–100)</label>
        <input id="cp_percent" type="number" min="1" max="100" step="1" placeholder="es. 100">
      </div>
      <div id="cp_amount_wrap" style="display:none">
        <label>Importo in EUR</label>
        <input id="cp_amount" type="number" min="1" step="1" placeholder="es. 10">
      </div>
    </div>

    <div class="grid">
      <div>
        <label>Max utilizzi</label>
        <input id="cp_max" type="number" min="1" step="1" placeholder="es. 1 per monouso">
      </div>
      <div>
        <label>Scadenza</label>
        <input id="cp_exp" type="datetime-local">
      </div>
    </div>

    <div class="flex" style="justify-content:flex-end;margin-top:6px">
      <button class="btn primary" id="cp_create" type="button">Crea codice sconto</button>
    </div>

    <div class="smallmuted" id="cp_msg" style="margin-top:6px"></div>

    <h3 style="margin:14px 0 6px">Codici attivi</h3>
    <div id="cp_list" class="smallmuted">Caricamento…</div>
  </div>
</main>

<footer class="page-footer"><a class="btn" href="index.html">← Torna alla mappa</a></footer>

<!-- ===== MODALE PARTNER ===== -->
<div id="partnerModal" class="modal" aria-hidden="true">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <h3 style="margin:0" id="pmTitle">Nuovo partner</h3>
      <button class="btn" id="pmClose" type="button">Chiudi</button>
    </div>

    <!-- campi anagrafica -->
    <div class="grid" style="margin-top:8px">
      <div><label>Nome*</label><input id="pmFirst" placeholder="Nome"></div>
      <div><label>Cognome*</label><input id="pmLast" placeholder="Cognome"></div>
    </div>
    <div class="grid">
      <div><label>Email*</label><input id="pmEmail" type="email"></div>
      <div><label>Telefono</label><input id="pmPhone" type="tel"></div>
    </div>
    <div class="grid">
      <div><label>Indirizzo di residenza</label><input id="pmAddr" placeholder="Via / civico / città / CAP"></div>
      <div><label>Data di nascita</label><input id="pmBirth" type="date"></div>
    </div>
    <div class="grid">
      <div><label>IBAN</label><input id="pmIBAN" placeholder="IT.."></div>
      <div><label>Stripe account ID</label><input id="pmStripe" placeholder="acct_..."></div>
    </div>

    <div class="grid">
      <div>
        <label>Codice partner*</label>
        <div class="flex">
          <input id="pmCode" placeholder="ABC123" style="flex:1" maxlength="12">
          <button class="btn small" id="pmGen" type="button" title="Genera e verifica unicità">Genera</button>
        </div>
        <div id="pmCodeMsg" class="smallmuted"></div>
      </div>
      <div>
        <label>Attivo</label>
        <select id="pmActive"><option value="true">Sì</option><option value="false">No</option></select>
      </div>
    </div>

    <div class="flex" style="justify-content:flex-end;margin-top:8px">
      <button class="btn primary" id="pmSave" type="button">Salva</button>
    </div>
    <div id="pmErr" class="smallmuted" style="color:#ff9a9a;margin-top:6px"></div>
  </div>
</div>

<script>
(async function(){
  // === util ===
  const $ = s => document.querySelector(s);
  const out = $('#diagOut');
  function line(msg){ out.textContent += msg + '\\n'; }
  function ok(msg){ line('✅ ' + msg); }
  function ko(msg){ line('❌ ' + msg); }
  function sep(){ line('—'.repeat(48)); }
  const money = c => (c/100).toFixed(2).replace('.',',');

  const CFG = window.SQ_CONFIG || {};
  const SUPABASE_URL  = CFG.SUPABASE_URL;
  const SUPABASE_ANON = CFG.SUPABASE_ANON;

  let sb = null;
  if (window.supabase && SUPABASE_URL && SUPABASE_ANON){
    sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth: { persistSession: true, autoRefreshToken: true }});
  }

  // ===== Guard admin login =====
  async function requireAdmin(){
    if (!sb) throw new Error('Supabase non inizializzato');
    const { data:{ session } } = await sb.auth.getSession();
    if (session) return;
    const email = prompt('Email admin per accedere:');
    if (!email) { alert('Accesso annullato'); throw new Error('no-login'); }
    const { error } = await sb.auth.signInWithOtp({ email });
    if (error) { alert('Errore login: ' + error.message); throw error; }
    alert('Ti ho inviato un link di accesso via email. Aprilo, poi ricarica questa pagina.');
    throw new Error('pending-login');
  }
  try { await requireAdmin(); } catch(e){ if (String(e).includes('pending-login')) return; throw e; }

  // ===== Helper: funzione base URL =====
  function fnBaseFromSupabaseUrl(u){
    try{ const host = new URL(u).host; return 'https://' + host.replace('.supabase.co', '.functions.supabase.co'); }
    catch(_){ return null; }
  }
  const FN_BASE = fnBaseFromSupabaseUrl(SUPABASE_URL);
  const URL_CHECKOUT = FN_BASE ? (FN_BASE + '/create-checkout-session') : null;
  const URL_WEBHOOK  = FN_BASE ? (FN_BASE + '/stripe-webhook')         : null;
  const URL_COUPON   = FN_BASE ? (FN_BASE + '/stripe-admin')           : null;

  // ===== DIAGNOSTICA (come prima) =====
  async function pingFunction(url){
    if (!url) return { ok:false, status:0, note:'URL non costruibile' };
    try{
      let res = await fetch(url, { method:'OPTIONS' });
      if (res.ok || res.status===204) return { ok:true, status:res.status, note:'OPTIONS OK' };
      res = await fetch(url, { method:'POST', headers:{ 'content-type':'application/json', 'apikey': SUPABASE_ANON, 'Authorization': 'Bearer '+SUPABASE_ANON }, body: JSON.stringify({ ping:true }) });
      return { ok:true, status:res.status, note:'POST raggiungibile (expected 400/405)' };
    }catch(e){ return { ok:false, status:0, note:String(e&&e.message||e) }; }
  }
  async function run(){
    out.textContent = '';
    line('DIAGNOSTICA STASERA QUI — '+ new Date().toLocaleString()); sep();
    if (SUPABASE_URL)  ok('SUPABASE_URL presente'); else ko('SUPABASE_URL mancante');
    if (SUPABASE_ANON) ok('SUPABASE_ANON presente'); else ko('SUPABASE_ANON mancante');
    sep();
    if (URL_CHECKOUT){ const r1 = await pingFunction(URL_CHECKOUT); (r1.ok ? ok : ko)(`create-checkout-session — ${r1.status} (${r1.note})`); }
    if (URL_WEBHOOK) { const r2 = await pingFunction(URL_WEBHOOK);  (r2.ok ? ok : ko)(`stripe-webhook — ${r2.status} (${r2.note})`); }
    if (URL_COUPON)  { const r3 = await pingFunction(URL_COUPON);   (r3.ok ? ok : ko)(`stripe-admin — ${r3.status} (${r3.note})`); }
    sep(); line('FINE TEST ✅');
  }
  $('#runDiag')?.addEventListener('click', run);
  $('#copyDiag')?.addEventListener('click', ()=>{ try{ navigator.clipboard.writeText(out.textContent||''); alert('Report copiato.'); }catch(_){ alert('Seleziona e copia manualmente.'); } });

  // ====================== PARTNER: UI/CRUD ======================
  const partnersWrap = $('#partnersTableWrap');
  const pm = $('#partnerModal');
  const pmClose = $('#pmClose');
  const pmTitle = $('#pmTitle');
  const pmFirst = $('#pmFirst');
  const pmLast  = $('#pmLast');
  const pmEmail = $('#pmEmail');
  const pmPhone = $('#pmPhone');
  const pmAddr  = $('#pmAddr');
  const pmBirth = $('#pmBirth');
  const pmIBAN  = $('#pmIBAN');
  const pmStripe= $('#pmStripe');
  const pmCode  = $('#pmCode');
  const pmGen   = $('#pmGen');
  const pmCodeMsg = $('#pmCodeMsg');
  const pmActive= $('#pmActive');
  const pmSave  = $('#pmSave');
  const pmErr   = $('#pmErr');
  let editingPartnerId = null;

  function openPM(title, partner){
    pmTitle.textContent = title;
    pmErr.textContent = ''; pmCodeMsg.textContent='';
    if (partner){
      editingPartnerId = partner.id;
      pmFirst.value = partner.first_name || '';
      pmLast.value  = partner.last_name  || '';
      pmEmail.value = partner.email || '';
      pmPhone.value = partner.phone || '';
      pmAddr.value  = partner.address || '';
      pmBirth.value = partner.birth_date ? String(partner.birth_date).slice(0,10) : '';
      pmIBAN.value  = partner.iban || '';
      pmStripe.value= partner.stripe_account_id || '';
      pmCode.value  = partner.code || '';
      pmActive.value= String(!!partner.active);
    } else {
      editingPartnerId = null;
      pmFirst.value=''; pmLast.value=''; pmEmail.value=''; pmPhone.value=''; pmAddr.value='';
      pmBirth.value=''; pmIBAN.value=''; pmStripe.value=''; pmCode.value=''; pmActive.value='true';
    }
    pm.style.display='flex';
  }
  function closePM(){ pm.style.display='none'; }
  pmClose.onclick = closePM;
  pm.addEventListener('click', e=>{ if(e.target===pm) closePM(); });

  $('#btnAddPartner').onclick = ()=> openPM('Nuovo partner');

  function genCode(){
    const s='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // sans confusione
    let c=''; for(let i=0;i<6;i++) c+=s[Math.floor(Math.random()*s.length)];
    return c;
  }
  async function codeExists(code){
    const { data, error } = await sb.from('partners').select('id').eq('code', code).limit(1);
    if (error) return true; // prudenza
    return Array.isArray(data) && data.length>0;
  }
  pmGen.onclick = async ()=>{
    let tries=0, code='';
    do { code = genCode(); tries++; } while (tries<10 && await codeExists(code));
    pmCode.value = code;
    if (await codeExists(code)) { pmCodeMsg.textContent = '⚠️ impossibile garantire unicità, scegli tu un codice'; }
    else pmCodeMsg.textContent = '✅ codice disponibile';
  };
  pmCode.addEventListener('blur', async ()=>{
    const c=(pmCode.value||'').trim().toUpperCase();
    if (!c) { pmCodeMsg.textContent=''; return; }
    pmCode.value=c;
    pmCodeMsg.textContent = (await codeExists(c)) ? '❌ codice già presente' : '✅ codice disponibile';
  });

  async function loadPartners(){
    partnersWrap.textContent = 'Caricamento…';
    const { data, error } = await sb.from('partners').select('*').order('created_at',{ascending:false});
    if (error){ partnersWrap.textContent = 'Errore: '+error.message; return; }
    if (!data || !data.length){ partnersWrap.textContent='Nessun partner. Clicca “Nuovo partner”.'; return; }
    const rows = data.map(p=>`
      <tr>
        <td>${p.code||'—'}</td>
        <td>${(p.first_name||'')+' '+(p.last_name||'')}</td>
        <td>${p.email||'—'}</td>
        <td>${p.phone||'—'}</td>
        <td>${p.iban||'—'}</td>
        <td>${p.stripe_account_id||'—'}</td>
        <td>${p.active?'Sì':'No'}</td>
        <td class="row-actions">
          <button class="btn small" data-edit="${p.id}">Modifica</button>
          <button class="btn small" data-toggle="${p.id}" data-on="${p.active?0:1}">${p.active?'Disattiva':'Attiva'}</button>
        </td>
      </tr>
    `).join('');
    partnersWrap.innerHTML = `
      <table class="table" aria-label="Partner">
        <thead><tr>
          <th>Codice</th><th>Nome</th><th>Email</th><th>Telefono</th><th>IBAN</th><th>Stripe acct</th><th>Attivo</th><th>Azioni</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
    partnersWrap.querySelectorAll('[data-edit]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const id=b.getAttribute('data-edit');
        const p = data.find(x=>x.id===id);
        openPM('Modifica partner', p);
      });
    });
    partnersWrap.querySelectorAll('[data-toggle]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id=b.getAttribute('data-toggle');
        const on=b.getAttribute('data-on')==='1';
        await sb.from('partners').update({active:on}).eq('id', id);
        loadPartners();
      });
    });
  }

  pmSave.onclick = async ()=>{
    pmErr.textContent='';
    const first = (pmFirst.value||'').trim();
    const last  = (pmLast.value||'').trim();
    const email = (pmEmail.value||'').trim();
    const code  = (pmCode.value||'').trim().toUpperCase();
    if (!first || !last || !email || !code){ pmErr.textContent='Compila Nome, Cognome, Email e Codice partner.'; return; }
    // se nuovo, verifica unicità codice
    if (!editingPartnerId && await codeExists(code)){ pmErr.textContent='Codice già esistente.'; return; }

    const payload:any = {
      first_name:first, last_name:last, email,
      phone:(pmPhone.value||'').trim(),
      address:(pmAddr.value||'').trim(),
      birth_date: pmBirth.value || null,
      iban:(pmIBAN.value||'').trim(),
      stripe_account_id:(pmStripe.value||'').trim(),
      code, active:(pmActive.value==='true'),
      name: `${first} ${last}`.trim()
    };
    let q = sb.from('partners').upsert(editingPartnerId ? { id:editingPartnerId, ...payload } : payload).select('id').single();
    const { error } = await q;
    if (error){ pmErr.textContent='Errore: '+error.message; return; }
    closePM(); loadPartners();
  };

  // Init partners
  loadPartners();

  // ====================== PAYOUTS (come nella tua versione) ======================
  const payMonth = $('#payMonth');
  const payoutsSummary = $('#payoutsSummary');
  const payoutsDetailBox = $('#payoutDetail');
  const payoutsDetailTitle = $('#payoutDetailTitle');
  const payoutsDetailTable = $('#payoutDetailTable');
  const payRef = $('#payRef');
  let currentPartnerCode = null;

  function monthToRange(ym){
    const [y,m] = ym.split('-').map(n=>parseInt(n,10));
    const from = new Date(Date.UTC(y,m-1,1));
    const to   = new Date(Date.UTC(m===12?y+1:y, m===12?1:m, 1));
    const d = x => x.toISOString().slice(0,10);
    return { from: d(from), to: d(to) };
  }
  $('#btnLoadPayouts').onclick = async ()=>{
    payoutsDetailBox.style.display='none';
    payoutsSummary.textContent = 'Caricamento…';
    const ym = payMonth.value; if (!ym){ payoutsSummary.textContent='Seleziona un mese.'; return; }
    const { from } = monthToRange(ym);
    const { data, error } = await sb.from('v_partner_payouts_month').select('*').eq('month', from);
    if (error){ payoutsSummary.textContent = 'Errore: '+error.message; return; }
    if (!data?.length){ payoutsSummary.textContent='Nessun pending per questo mese.'; return; }
    const rows = data.map(r=>`
      <tr>
        <td>${r.partner_code}</td>
        <td>${r.month}</td>
        <td class="right"><b>${Number(r.partner_share_eur).toFixed(2).replace('.',',')} €</b></td>
        <td class="right">${r.items}</td>
        <td><button class="btn small" data-open="${r.partner_code}">Dettaglio</button></td>
      </tr>`).join('');
    payoutsSummary.innerHTML = `
      <table class="table" aria-label="Payout mensile">
        <thead><tr><th>Partner</th><th>Mese</th><th>Totale</th><th>Items</th><th></th></tr></thead>
        <tbody>${rows}</tbody></table>`;
    payoutsSummary.querySelectorAll('[data-open]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const ym = payMonth.value; const range = monthToRange(ym);
        openPayoutDetail(b.getAttribute('data-open'), range);
      });
    });
  };
  async function openPayoutDetail(partnerCode, range){
    currentPartnerCode = partnerCode;
    payoutsDetailTitle.textContent = `Dettaglio ${partnerCode} — ${range.from} → ${range.to}`;
    payRef.value = '';
    payoutsDetailTable.textContent = 'Caricamento…';
    payoutsDetailBox.style.display='block';
    const { data, error } = await sb.from('partner_commissions')
      .select('created_at,item_type,currency,unit_amount_cents,stripe_fee_cents,net_cents,partner_share_cents')
      .eq('status','pending').eq('partner_code', partnerCode)
      .gte('created_at', range.from).lt('created_at', range.to)
      .order('created_at');
    if (error){ payoutsDetailTable.textContent = 'Errore: '+error.message; return; }
    if (!data?.length){ payoutsDetailTable.textContent = 'Nessun elemento in pending.'; return; }
    const total = data.reduce((s,r)=> s+(r.partner_share_cents||0), 0);
    const rows = data.map(r=>`
      <tr>
        <td>${r.created_at?.slice(0,10)||''}</td>
        <td>${r.item_type}</td>
        <td class="right">${money(r.unit_amount_cents)} €</td>
        <td class="right">${money(r.stripe_fee_cents)} €</td>
        <td class="right">${money(r.net_cents)} €</td>
        <td class="right"><b>${money(r.partner_share_cents)} €</b></td>
      </tr>`).join('');
    payoutsDetailTable.innerHTML = `
      <table class="table" aria-label="Dettaglio partner">
        <thead><tr><th>Data</th><th>Tipo</th><th>Lordo</th><th>Fee Stripe</th><th>Netto</th><th>Quota 50%</th></tr></thead>
        <tbody>${rows}</tbody>
        <tfoot><tr><th colspan="5" class="right">Totale</th><th class="right">${money(total)} €</th></tr></tfoot>
      </table>`;

    $('#btnCSVMonth').onclick = async ()=>{
      const ym = payMonth.value; if (!ym){ alert('Seleziona un mese.'); return; }
      const { from, to } = monthToRange(ym);
      const { data: rowsAll, error: errAll } = await sb.from('partner_commissions')
        .select('*').eq('status','pending').gte('created_at',from).lt('created_at',to)
        .order('partner_code').order('created_at');
      if (errAll){ alert('Errore: '+errAll.message); return; }
      if (!rowsAll?.length){ alert('Nessun dato.'); return; }
      const head = ['created_at','partner_code','item_type','currency','unit_amount','stripe_fee','net','partner_share'].join(',');
      const body = rowsAll.map(r=>[
        r.created_at, r.partner_code, r.item_type, r.currency,
        (r.unit_amount_cents/100).toFixed(2),(r.stripe_fee_cents/100).toFixed(2),
        (r.net_cents/100).toFixed(2),(r.partner_share_cents/100).toFixed(2)
      ].join(',')).join('\n');
      const blob = new Blob([head+'\n'+body], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `staseraqui_payout_${from}.csv`; a.click();
    };

    $('#btnMarkPaid').onclick = async ()=>{
      const ref = (payRef.value||'').trim();
      if (!ref){ alert('Inserisci un riferimento pagamento.'); return; }
      if (!confirm('Segnare come pagato tutti gli elementi pending per questo partner e mese?')) return;
      const ym = payMonth.value; const { from,to } = monthToRange(ym);
      const { error } = await sb.from('partner_commissions')
        .update({ status:'paid', payment_ref: ref })
        .eq('status','pending').eq('partner_code', partnerCode).gte('created_at',from).lt('created_at',to);
      if (error){ alert('Errore: '+error.message); return; }
      alert('Aggiornato a paid.');
      $('#btnLoadPayouts').click();
      payoutsDetailBox.style.display='none';
    };
  }

  // ====================== COUPON STRIPE (via Edge: stripe-admin) ======================
  const cpCode = $('#cp_code');
  const cpType = $('#cp_type');
  const cpPercentWrap = $('#cp_percent_wrap');
  const cpAmountWrap  = $('#cp_amount_wrap');
  const cpPercent = $('#cp_percent');
  const cpAmount  = $('#cp_amount');
  const cpMax     = $('#cp_max');
  const cpExp     = $('#cp_exp');
  const cpCreate  = $('#cp_create');
  const cpMsg     = $('#cp_msg');
  const cpListBox = $('#cp_list');

  cpType.addEventListener('change', ()=>{
    const t = cpType.value;
    if (t==='percent'){ cpPercentWrap.style.display='block'; cpAmountWrap.style.display='none'; }
    else { cpPercentWrap.style.display='none'; cpAmountWrap.style.display='block'; }
  });

  async function getAccessToken(){
    const { data:{ session } } = await sb.auth.getSession();
    return session?.access_token || '';
  }

  async function loadPromoList(){
    if (!URL_COUPON){ cpListBox.textContent = 'Function non disponibile.'; return; }
    cpListBox.textContent = 'Caricamento…';
    const token = await getAccessToken();
    const res = await fetch(URL_COUPON + '?active=true&limit=50', { headers:{ 'Authorization':'Bearer '+token } });
    const txt = await res.text();
    if (!res.ok){ cpListBox.textContent = 'Errore: '+txt; return; }
    const j = JSON.parse(txt);
    if (!j?.data?.length){ cpListBox.textContent='Nessun codice attivo.'; return; }
    const rows = j.data.map(p=>`
      <tr>
        <td>${p.code}</td>
        <td>${p.coupon?.percent_off ? (p.coupon.percent_off+'%') : (p.coupon?.amount_off ? ( (p.coupon.amount_off/100).toFixed(2)+' €') : '—')}</td>
        <td class="right">${p.max_redemptions ?? '—'}</td>
        <td class="right">${p.times_redeemed ?? 0}</td>
        <td>${p.expires_at ? new Date(p.expires_at*1000).toISOString().slice(0,16).replace('T',' ') : '—'}</td>
        <td><button class="btn small" data-deact="${p.id}">Disattiva</button></td>
      </tr>`).join('');
    cpListBox.innerHTML = `
      <table class="table" aria-label="Codici attivi">
        <thead><tr><th>Codice</th><th>Sconto</th><th class="right">Max</th><th class="right">Usati</th><th>Scadenza</th><th></th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
    cpListBox.querySelectorAll('[data-deact]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        if (!confirm('Disattivare questo codice?')) return;
        const id = b.getAttribute('data-deact');
        const token = await getAccessToken();
        const r = await fetch(URL_COUPON, {
          method:'POST',
          headers:{ 'content-type':'application/json', 'Authorization':'Bearer '+token },
          body: JSON.stringify({ action:'deactivate_promo', id })
        });
        if (!r.ok){ alert('Errore: '+await r.text()); return; }
        loadPromoList();
      });
    });
  }

  cpCreate.onclick = async ()=>{
    try{
      cpMsg.textContent = '';
      if (!URL_COUPON){ cpMsg.textContent='Function non disponibile.'; return; }
      const code = (cpCode.value||'').trim().toUpperCase();
      if (!code){ cpMsg.textContent='Inserisci il codice.'; return; }
      const type = cpType.value;
      let payload:any = { action:'create_promo', data:{ code } };
      if (type==='percent'){
        const p = Math.max(1, Math.min(100, Math.floor(Number(cpPercent.value||0))));
        if (!p) { cpMsg.textContent='Percentuale non valida.'; return; }
        payload.data.percent_off = p;
      } else {
        const eur = Math.max(1, Math.floor(Number(cpAmount.value||0)));
        if (!eur) { cpMsg.textContent='Importo non valido.'; return; }
        payload.data.amount_off_cents = eur*100; payload.data.currency = 'eur';
      }
      const max = Number(cpMax.value||0);
      if (max>0) payload.data.max_redemptions = max;

      const expIso = cpExp.value; // yyyy-MM-ddTHH:mm
      if (expIso){
        const ts = Math.floor(new Date(expIso).getTime()/1000);
        if (ts>0) payload.data.expires_at = ts;
      }

      const token = await getAccessToken();
      const r = await fetch(URL_COUPON, {
        method:'POST',
        headers:{ 'content-type':'application/json', 'Authorization':'Bearer '+token },
        body: JSON.stringify(payload)
      });
      const txt = await r.text();
      if (!r.ok){ cpMsg.textContent = 'Errore: '+txt; return; }
      cpMsg.textContent = 'Creato ✅';
      cpCode.value=''; cpPercent.value=''; cpAmount.value=''; cpMax.value=''; cpExp.value='';
      loadPromoList();
    }catch(e){ cpMsg.textContent='Errore: '+(e?.message||String(e)); }
  };

  // inizializza lista
  loadPromoList();

})();
</script>
</body>
</html>
