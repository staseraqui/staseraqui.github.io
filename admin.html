<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin — Stasera Qui</title>

  <script src="assets/app-config.js?v=6"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/style.css?v=12">
  <style>
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
    .card h2{margin:0 0 8px}
    pre.console{background:#0b1623;border:1px solid rgba(255,255,255,.12);padding:12px;border-radius:10px;max-height:420px;overflow:auto;margin:0;white-space:pre-wrap}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input[type="text"]{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:#fff;color:#081421}
    .small.muted{color:#97a5b2}
  </style>
</head>
<body>
<header class="header" style="padding:0 16px">
  <a href="index.html" class="logo">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true">
      <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/>
      <circle cx="32" cy="24" r="9" fill="#ffffff"/>
    </svg>
    <span class="wordmark">stasera qui</span>
  </a>
</header>

<main class="wrap">
  <h1 style="margin:8px 0 14px">Area admin</h1>

  <!-- Diagnostica -->
  <div class="card" id="diagCard" style="margin-top:0">
    <h2>Diagnostica</h2>
    <p class="small">Esegue test rapidi su chiavi, DB, storage e funzioni Edge.</p>
    <div class="row" style="margin-bottom:10px">
      <button class="btn primary" id="runDiag" type="button">Esegui test</button>
      <button class="btn" id="copyDiag" type="button">Copia report</button>
    </div>
    <pre id="diagOut" class="console"></pre>
  </div>

  <!-- Azioni rapide -->
  <div class="card">
    <h2>Azioni rapide</h2>
    <div class="grid">
      <div>
        <p class="small">Seleziona dalla mappa uno o più eventi e cancellali in blocco.</p>
        <a class="btn accent" href="seleziona-elimina.html">Seleziona ed elimina eventi</a>
      </div>
      <div>
        <p class="small">Importa da CSV (geocoding automatico + upload locandine) e pubblica subito.</p>
        <a class="btn primary" href="importa-eventi.html">Importa eventi (CSV)</a>
      </div>
    </div>
  </div>

  <!-- Manutenzione dati: cancellazione cascata e pulizia orfani -->
  <div class="card">
    <h2>Manutenzione dati</h2>

    <div class="row" style="margin-bottom:8px">
      <input id="delId" type="text" placeholder="ID evento (UUID)" style="min-width:260px">
      <button class="btn danger" id="btnDelCascade" type="button">Elimina evento (cancellazione sicura)</button>
    </div>
    <p class="small muted" style="margin-top:-4px">Esegue: DELETE su <code>occurrences</code> per <code>event_id</code> poi DELETE su <code>events</code>.</p>

    <div class="row" style="margin-top:14px">
      <button class="btn" id="btnCleanOrphans" type="button">Pulisci occorrenze orfane</button>
      <span class="small muted">Rimuove le righe di <code>occurrences</code> senza evento esistente.</span>
    </div>

    <pre id="maintOut" class="console" style="margin-top:10px"></pre>
  </div>

  <!-- Reportistica / pubblicazione singola -->
  <div class="card">
    <h2>Reportistica</h2>
    <p class="small">Statistiche per periodo, città e tipologia.</p>
    <a class="btn" href="report.html">Apri report</a>
  </div>

  <div class="card">
    <h2>Pubblicazione singola</h2>
    <p class="small">Flusso pubblico con pagamento Stripe.</p>
    <a class="btn" href="pubblica-evento.html">Pubblica evento (singolo)</a>
  </div>
</main>

<footer class="page-footer"><a class="btn" href="index.html">← Torna alla mappa</a></footer>

<script>
(function(){
  // --- util ---
  const $ = s => document.querySelector(s);
  const out = $('#diagOut');
  const mout = $('#maintOut');
  function line(msg){ out.textContent += msg + '\\n'; }
  function ok(msg){ line('✅ ' + msg); }
  function ko(msg){ line('❌ ' + msg); }
  function sep(){ line('—'.repeat(48)); }
  function mlog(msg){ mout.textContent += msg + '\\n'; }

  // --- config da assets/app-config.js ---
  const CFG = window.SQ_CONFIG || {};
  const SUPABASE_URL  = CFG.SUPABASE_URL;
  const SUPABASE_ANON = CFG.SUPABASE_ANON;
  const GOOGLE_KEY    = CFG.GOOGLE_MAPS_API_KEY;

  // Edge base: https://<project>.functions.supabase.co
  function fnBaseFromSupabaseUrl(u){
    try{
      const host = new URL(u).host;
      return 'https://' + host.replace('.supabase.co', '.functions.supabase.co');
    }catch(_){ return null; }
  }
  const FN_BASE = fnBaseFromSupabaseUrl(SUPABASE_URL);
  const URL_CHECKOUT = FN_BASE ? (FN_BASE + '/create-checkout-session') : null;
  const URL_WEBHOOK  = FN_BASE ? (FN_BASE + '/stripe-webhook')         : null;

  let sb = null;
  if (window.supabase && SUPABASE_URL && SUPABASE_ANON){
    sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
  }

  async function pingFunction(url){
    if (!url) return { ok:false, status:0, note:'URL non costruibile' };
    try{
      let res = await fetch(url, { method:'OPTIONS' });
      if (res.ok || res.status===204) return { ok:true, status:res.status, note:'OPTIONS OK' };

      res = await fetch(url, {
        method:'POST',
        headers:{ 'content-type':'application/json', 'apikey': SUPABASE_ANON, 'Authorization': 'Bearer '+SUPABASE_ANON },
        body: JSON.stringify({ ping:true })
      });
      return { ok:true, status:res.status, note:'POST raggiungibile (expected 400/405)' };
    }catch(e){
      return { ok:false, status:0, note:String(e&&e.message||e) };
    }
  }

  async function run(){
    out.textContent = '';
    line('DIAGNOSTICA STASERA QUI — '+ new Date().toLocaleString());
    sep();

    if (SUPABASE_URL)  ok('SUPABASE_URL presente'); else ko('SUPABASE_URL mancante (assets/app-config.js)');
    if (SUPABASE_ANON) ok('SUPABASE_ANON presente'); else ko('SUPABASE_ANON mancante (assets/app-config.js)');
    if (GOOGLE_KEY)    ok('GOOGLE_MAPS_API_KEY presente'); else ko('GOOGLE_MAPS_API_KEY mancante (assets/app-config.js)');
    if (FN_BASE){ ok('Functions base: '+FN_BASE); } else { ko('Functions base non derivabile da SUPABASE_URL'); }
    sep();

    if (!sb){
      ko('Client Supabase non inizializzato (manca SDK o chiavi)');
    } else {
      try{
        const ev = await sb.from('events').select('id', { count:'exact', head:true });
        if (ev.error) throw ev.error;
        ok('DB events accessibile — totale stimato: '+ (ev.count ?? 'n/d'));

        const oc = await sb.from('occurrences').select('id', { count:'exact', head:true });
        if (oc.error) throw oc.error;
        ok('DB occurrences accessibile — totale stimato: '+ (oc.count ?? 'n/d'));
      }catch(e){
        ko('DB select error: ' + (e?.message||String(e)));
      }

      try{
        const st = await sb.storage.from('event-images').list('', { limit:1 });
        if (st.error) throw st.error;
        ok('Storage event-images accessibile (list 1) — elementi: '+ (st.data?.length ?? 0));
      }catch(e){
        ko('Storage list fallita: ' + (e?.message||String(e)) + ' (nota: ok se listing non permesso, ma public URL deve funzionare)');
      }
    }
    sep();

    if (URL_CHECKOUT){
      const r1 = await pingFunction(URL_CHECKOUT);
      (r1.ok ? ok : ko)(`create-checkout-session raggiungibile — status ${r1.status} (${r1.note})`);
    } else ko('create-checkout-session: URL non disponibile');

    if (URL_WEBHOOK){
      const r2 = await pingFunction(URL_WEBHOOK);
      (r2.ok ? ok : ko)(`stripe-webhook raggiungibile — status ${r2.status} (${r2.note})`);
    } else ko('stripe-webhook: URL non disponibile');

    sep();
    line('FINE TEST ✅');
  }

  // ====== Manutenzione ======
  async function deleteEventCascade(eventId){
    if (!sb) { mlog('❌ Supabase client non inizializzato'); return; }
    if (!eventId) { mlog('❌ Inserisci un ID evento'); return; }
    mlog(`— Eliminazione sicura evento ${eventId}`);

    const { error: e1 } = await sb.from('occurrences').delete().eq('event_id', eventId);
    if (e1){ mlog('❌ Errore eliminando occorrenze: ' + e1.message); return; }
    mlog('✔ Occorrenze collegate eliminate');

    const { error: e2 } = await sb.from('events').delete().eq('id', eventId);
    if (e2){ mlog('❌ Errore eliminando evento: ' + e2.message); return; }
    mlog('✔ Evento eliminato');

    mlog('✅ Completato. Verifica sulla mappa con un hard refresh.');
    mlog('—'.repeat(48));
  }

  async function cleanOrphans(){
    if (!sb) { mlog('❌ Supabase client non inizializzato'); return; }
    mlog('— Pulizia occorrenze orfane avviata');

    const { data: evs, error: e0 } = await sb.from('events').select('id');
    if (e0){ mlog('❌ Lettura events fallita: ' + e0.message); return; }
    const valid = new Set((evs||[]).map(e=>e.id));

    const { data: occs, error: e1 } = await sb.from('occurrences').select('id,event_id');
    if (e1){ mlog('❌ Lettura occurrences fallita: ' + e1.message); return; }

    const toDelete = (occs||[]).filter(o => !valid.has(o.event_id)).map(o=>o.id);
    if (!toDelete.length){ mlog('✔ Nessuna occorrenza orfana trovata'); mlog('—'.repeat(48)); return; }

    // Cancella a blocchi per sicurezza
    const chunk = 500;
    for (let i=0;i<toDelete.length;i+=chunk){
      const slice = toDelete.slice(i,i+chunk);
      const { error: e2 } = await sb.from('occurrences').delete().in('id', slice);
      if (e2){ mlog('❌ Errore durante la cancellazione a blocchi: ' + e2.message); return; }
    }
    mlog(`✔ Rimosse ${toDelete.length} occorrenze orfane`);
    mlog('✅ Completato. Hard refresh sulla home per verificare.');
    mlog('—'.repeat(48));
  }

  // Bind UI
  $('#runDiag')?.addEventListener('click', run);
  $('#copyDiag')?.addEventListener('click', ()=>{
    try{
      navigator.clipboard.writeText(out.textContent||'');
      alert('Report copiato negli appunti.');
    }catch(_){
      alert('Non riesco a copiare. Seleziona il testo e copia manualmente.');
    }
  });

  $('#btnDelCascade')?.addEventListener('click', ()=>{
    const id = ($('#delId').value||'').trim();
    if (!id) { alert('Inserisci un ID evento.'); return; }
    if (confirm('Confermi la cancellazione definitiva?')) deleteEventCascade(id);
  });

  $('#btnCleanOrphans')?.addEventListener('click', cleanOrphans);
})();
</script>
</body>
</html>
