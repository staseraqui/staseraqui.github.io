<!doctype html>
<html lang="it">
<head>
  <script src="assets/app-config.js?v=6"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin — Stasera Qui</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/style.css?v=12">
  <style>
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
    .card h2{margin:0 0 8px}
    .table{width:100%;border-collapse:collapse;margin:10px 0}
    .table th,.table td{border:1px solid rgba(255,255,255,.15);padding:8px;text-align:left;vertical-align:top}
    .table th{background:#0f1c2d}
    .smallmuted{font-size:13px;color:#b8c2ce}
    .row-actions{display:flex;gap:6px;flex-wrap:wrap}
    .modal{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;background:rgba(0,0,0,.5);z-index:99999}
    .modal .box{margin-top:60px;background:#0f1c2d;border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:14px;min-width:320px;max-width:920px;width:92%}
    .flex{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn.small{padding:6px 8px;font-size:12px}
    .right{ text-align:right }
    .errorlog{background:#0b1623;border:1px dashed rgba(255,255,255,.25);padding:10px;border-radius:8px;font-size:12px;white-space:pre-wrap}
    /* Nuovi controlli payout */
    #payPartners{min-width:260px;max-width:420px}
    #payPartners[multiple]{height:88px}
    .muted{opacity:.85}
  </style>
</head>
<body>
<header class="header">
  <a href="index.html" class="logo">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true">
      <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/>
      <circle cx="32" cy="24" r="9" fill="#ffffff"/>
    </svg>
    <span class="wordmark">stasera qui</span>
  </a>
</header>

<main class="wrap">
  <h1 style="margin:8px 0 14px">Area admin</h1>

  <!-- Diagnostica -->
  <div class="card" id="diagCard" style="margin-top:16px">
    <h2 style="margin-top:0">Diagnostica</h2>
    <p class="small">Esegue test rapidi su chiavi, DB, storage e funzioni Edge.</p>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
      <button class="btn primary" id="runDiag" type="button">Esegui test</button>
      <button class="btn" id="copyDiag" type="button">Copia report</button>
    </div>
    <pre id="diagOut" style="background:#0b1623;border:1px solid rgba(255,255,255,.12);padding:12px;border-radius:10px;max-height:420px;overflow:auto;margin:0;white-space:pre-wrap"></pre>
  </div>

  <div class="card">
    <h2>Azioni rapide</h2>
    <div class="grid">
      <div>
        <p class="small">Seleziona dalla mappa uno o più eventi e cancellali in blocco.</p>
        <a class="btn accent" href="seleziona-elimina.html">Seleziona ed elimina eventi</a>
      </div>
      <div>
        <p class="small">Importa da CSV (geocoding automatico + upload locandine) e pubblica subito.</p>
        <a class="btn primary" href="importa-eventi.html">Importa eventi (CSV)</a>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Reportistica</h2>
    <p class="small">Statistiche per periodo, città e tipologia.</p>
    <a class="btn" href="report.html">Apri report</a>
  </div>

  <div class="card">
    <h2>Pubblicazione singola</h2>
    <p class="small">Flusso pubblico con pagamento Stripe.</p>
    <a class="btn" href="pubblica-evento.html">Pubblica evento (singolo)</a>
  </div>

  <!-- ================== PARTNER (CRUD) ================== -->
  <div class="card" id="partnersCard">
    <h2>Partner</h2>
    <div class="flex" style="margin-bottom:8px">
      <button class="btn primary" id="btnAddPartner" type="button">➕ Nuovo partner</button>
      <button class="btn" id="btnTogglePartners" type="button">Mostra elenco</button>
      <span class="smallmuted">Gestisci l’anagrafica e genera il codice partner univoco.</span>
    </div>
    <div id="partnersTableWrap" class="smallmuted" style="display:none">Caricamento…</div>
  </div>

  <!-- ================== PAYOUT PARTNER ================== -->
  <div class="card" id="payoutsCard">
    <h2>Payout partner</h2>
    <div class="flex" style="margin-bottom:8px;align-items:flex-end">
      <div>
        <label class="small">Mese (opzionale)</label><br>
        <select id="payMonth" style="min-width:220px"></select>
      </div>
      <div>
        <label class="small">Partner (opzionale, multiselezione)</label><br>
        <select id="payPartners" multiple></select>
      </div>
      <div>
        <label class="small">Riferimento pagamento (per i selezionati)</label><br>
        <input id="payRefSel" placeholder="Es. SEPA 2025-09 batch #1" style="min-width:260px">
      </div>
      <div>
        <button class="btn" id="btnLoadPayouts" type="button" disabled>Carica</button>
      </div>
      <div>
        <button class="btn" id="btnCSVMonth" type="button" disabled>Scarica CSV (mese)</button>
      </div>
    </div>
    <div class="smallmuted" style="margin-top:-4px">Se lasci vuoti “Mese” e “Partner” vedi <b>tutto ciò che è in pending</b>.</div>

    <div id="payoutsSummary" class="smallmuted" style="margin-top:8px">Seleziona filtri (opzionali) e premi “Carica”.</div>

    <div id="payoutsSelectionBar" class="smallmuted" style="display:none;margin-top:8px">
      <span id="selInfo">Selezionati: € 0,00</span>
      <button class="btn primary" id="btnMarkSelected" type="button" style="margin-left:8px">Segna selezionati come pagati</button>
    </div>

    <div id="payoutDetail" style="margin-top:12px; display:none">
      <h3 style="margin:0 0 8px" id="payoutDetailTitle">Dettaglio</h3>
      <div class="flex" style="margin-bottom:6px">
        <input id="payRef" placeholder="Riferimento pagamento/bonifico (es. SEPA 2024-09 batch #1)" style="flex:1;min-width:260px">
        <button class="btn primary" id="btnMarkPaid" type="button">Segna tutto come pagato</button>
      </div>
      <div class="smallmuted muted" style="margin-top:-2px">Il riferimento viene salvato nel campo <code>payment_ref</code> su ogni riga pagata.</div>
      <div id="payoutDetailTable" class="smallmuted">—</div>
    </div>
  </div>

  <!-- ================== CODICI SCONTO (STRIPE) ================== -->
  <div class="card" id="couponCard">
    <h2>Codici sconto (Stripe)</h2>
    <p class="small">Crea promotion code (una tantum o con limite) che gli utenti possono inserire in Checkout.</p>

    <div class="grid">
      <div>
        <label>Codice*</label>
        <div class="flex">
          <input id="cp_code" placeholder="Es. ADMIN100" style="flex:1">
          <button class="btn small" id="cp_gen" type="button" title="Genera un codice casuale">Genera</button>
        </div>
      </div>
      <div>
        <label>Tipo sconto*</label>
        <select id="cp_type">
          <option value="percent">Percentuale (%)</option>
          <option value="amount">Valore fisso (EUR)</option>
        </select>
      </div>
    </div>

    <div class="grid">
      <div id="cp_percent_wrap">
        <label>Percentuale (0–100)</label>
        <input id="cp_percent" type="number" min="1" max="100" step="1" placeholder="es. 100">
      </div>
      <div id="cp_amount_wrap" style="display:none">
        <label>Importo in EUR</label>
        <input id="cp_amount" type="number" min="1" step="1" placeholder="es. 10">
      </div>
    </div>

    <div class="grid">
      <div>
        <label>Max utilizzi</label>
        <input id="cp_max" type="number" min="1" step="1" placeholder="es. 1 per monouso">
      </div>
      <div>
        <label>Scadenza</label>
        <input id="cp_exp" type="datetime-local">
      </div>
    </div>

    <div class="flex" style="justify-content:flex-end;margin-top:6px">
      <button class="btn primary" id="cp_create" type="button">Crea codice sconto</button>
    </div>

    <div class="smallmuted" id="cp_msg" style="margin-top:6px"></div>

    <h3 style="margin:14px 0 6px">Codici attivi</h3>
    <div id="cp_list" class="smallmuted">Caricamento…</div>
  </div>

  <!-- Error log -->
  <div class="card" id="errorsCard">
    <h2>Log errori</h2>
    <div id="errlog" class="errorlog">Nessun errore.</div>
  </div>
</main>

<footer class="page-footer"><a class="btn" href="index.html">← Torna alla mappa</a></footer>

<!-- ===== MODALE PARTNER ===== -->
<div id="partnerModal" class="modal" aria-hidden="true">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <h3 style="margin:0" id="pmTitle">Nuovo partner</h3>
      <button class="btn" id="pmClose" type="button">Chiudi</button>
    </div>

    <!-- campi anagrafica -->
    <div class="grid" style="margin-top:8px">
      <div><label>Nome*</label><input id="pmFirst" placeholder="Nome"></div>
      <div><label>Cognome*</label><input id="pmLast" placeholder="Cognome"></div>
    </div>
    <div class="grid">
      <div><label>Email*</label><input id="pmEmail" type="email"></div>
      <div><label>Telefono</label><input id="pmPhone" type="tel"></div>
    </div>
    <div class="grid">
      <div><label>Indirizzo di residenza</label><input id="pmAddr" placeholder="Via / civico / città / CAP"></div>
      <div><label>Data di nascita</label><input id="pmBirth" type="date"></div>
    </div>
    <div class="grid">
      <div><label>IBAN</label><input id="pmIBAN" placeholder="IT.."></div>
      <div><label>Stripe account ID</label><input id="pmStripe" placeholder="acct_..."></div>
    </div>

    <div class="grid">
      <div>
        <label>Codice partner*</label>
        <div class="flex">
          <input id="pmCode" placeholder="ABC123" style="flex:1" maxlength="12">
          <button class="btn small" id="pmGen" type="button" title="Genera e verifica unicità">Genera</button>
        </div>
        <div id="pmCodeMsg" class="smallmuted"></div>
      </div>
      <div>
        <label>Attivo</label>
        <select id="pmActive"><option value="true">Sì</option><option value="false">No</option></select>
      </div>
    </div>

    <div class="flex" style="justify-content:flex-end;margin-top:8px">
      <button class="btn primary" id="pmSave" type="button">Salva</button>
    </div>
    <div id="pmErr" class="smallmuted" style="color:#ff9a9a;margin-top:6px"></div>
  </div>
</div>

<script>
(async function(){
  // === util ===
  const $ = s => document.querySelector(s);
  const out = $('#diagOut');
  const errlog = $('#errlog');
  const logErr = (msg)=>{ try{ errlog.textContent = (errlog.textContent==='Nessun errore.'?'':(errlog.textContent+'\n')) + msg; }catch(_){} };
  function line(msg){ out.textContent += msg + '\n'; }
  function ok(msg){ line('✅ ' + msg); }
  function ko(msg){ line('❌ ' + msg); }
  function sep(){ line('—'.repeat(48)); }
  const money = c => ((c||0)/100).toFixed(2).replace('.',',');

  // Errori globali a video
  window.addEventListener('error', e => logErr('JS error: ' + (e?.message||e)));
  window.addEventListener('unhandledrejection', e => logErr('Promise rejection: ' + (e?.reason?.message||e?.reason||e)));

  const CFG = window.SQ_CONFIG || {};
  const SUPABASE_URL  = CFG.SUPABASE_URL;
  const SUPABASE_ANON = CFG.SUPABASE_ANON;

  let sb = null;
  if (window.supabase && SUPABASE_URL && SUPABASE_ANON){
    sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth: { persistSession: true, autoRefreshToken: true }});
  } else {
    logErr('Supabase non inizializzato: controlla assets/app-config.js');
  }

  // ===== Guard admin login =====
  async function requireAdmin(){
    if (!sb) throw new Error('Supabase non inizializzato');
    const { data:{ session } } = await sb.auth.getSession();
    if (session) return;
    const email = prompt('Email admin per accedere:');
    if (!email) { alert('Accesso annullato'); throw new Error('no-login'); }
    const { error } = await sb.auth.signInWithOtp({ email });
    if (error) { alert('Errore login: ' + error.message); throw error; }
    alert('Ti ho inviato un link di accesso via email. Aprilo, poi ricarica questa pagina.');
    throw new Error('pending-login');
  }
  try { await requireAdmin(); } catch(e){ if (String(e).includes('pending-login')) return; logErr('Auth: '+(e?.message||e)); throw e; }

  // ===== Helper: funzione base URL =====
  function fnBaseFromSupabaseUrl(u){
    try{ const host = new URL(u).host; return 'https://' + host.replace('.supabase.co', '.functions.supabase.co'); }
    catch(_){ return null; }
  }
  const FN_BASE = fnBaseFromSupabaseUrl(SUPABASE_URL);
  const URL_CHECKOUT = FN_BASE ? (FN_BASE + '/create-checkout-session') : null;
  const URL_WEBHOOK  = FN_BASE ? (FN_BASE + '/stripe-webhook')         : null;
  const URL_COUPON   = FN_BASE ? (FN_BASE + '/stripe-admin')           : null;

  // ===== DIAGNOSTICA =====
  async function pingFunction(url){
    if (!url) return { ok:false, status:0, note:'URL non costruibile' };
    try{
      let res = await fetch(url, { method:'OPTIONS' });
      if (res.ok || res.status===204) return { ok:true, status:res.status, note:'OPTIONS OK' };
      res = await fetch(url, { method:'POST', headers:{ 'content-type':'application/json', 'apikey': SUPABASE_ANON, 'Authorization': 'Bearer '+SUPABASE_ANON }, body: JSON.stringify({ ping:true }) });
      return { ok:true, status:res.status, note:'POST raggiungibile (expected 400/405)' };
    }catch(e){ return { ok:false, status:0, note:String(e&&e.message||e) }; }
  }
  async function run(){
    out.textContent = '';
    line('DIAGNOSTICA STASERA QUI — '+ new Date().toLocaleString()); sep();
    if (SUPABASE_URL)  ok('SUPABASE_URL presente'); else ko('SUPABASE_URL mancante');
    if (SUPABASE_ANON) ok('SUPABASE_ANON presente'); else ko('SUPABASE_ANON mancante');
    sep();
    if (URL_CHECKOUT){ const r1 = await pingFunction(URL_CHECKOUT); (r1.ok ? ok : ko)(`create-checkout-session — ${r1.status} (${r1.note})`); }
    if (URL_WEBHOOK) { const r2 = await pingFunction(URL_WEBHOOK);  (r2.ok ? ok : ko)(`stripe-webhook — ${r2.status} (${r2.note})`); }
    if (URL_COUPON)  { const r3 = await pingFunction(URL_COUPON);   (r3.ok ? ok : ko)(`stripe-admin — ${r3.status} (${r3.note})`); }
    sep(); line('FINE TEST ✅');
  }
  $('#runDiag')?.addEventListener('click', run);
  $('#copyDiag')?.addEventListener('click', ()=>{ try{ navigator.clipboard.writeText(out.textContent||''); alert('Report copiato.'); }catch(_){ alert('Seleziona e copia manualmente.'); } });

  // ====================== PARTNER: UI/CRUD ======================
  const partnersWrap = $('#partnersTableWrap');
  const pm = $('#partnerModal');
  const pmClose = $('#pmClose');
  const pmTitle = $('#pmTitle');
  const pmFirst = $('#pmFirst');
  const pmLast  = $('#pmLast');
  const pmEmail = $('#pmEmail');
  const pmPhone = $('#pmPhone');
  const pmAddr  = $('#pmAddr');
  const pmBirth = $('#pmBirth');
  const pmIBAN  = $('#pmIBAN');
  const pmStripe= $('#pmStripe');
  const pmCode  = $('#pmCode');
  const pmGen   = $('#pmGen');
  const pmCodeMsg = $('#pmCodeMsg');
  const pmActive= $('#pmActive');
  const pmSave  = $('#pmSave');
  const pmErr   = $('#pmErr');
  let editingPartnerId = null;

  function openPM(title, partner){
    pmTitle.textContent = title;
    pmErr.textContent = ''; pmCodeMsg.textContent='';
    if (partner){
      editingPartnerId = partner.id;
      pmFirst.value = partner.first_name || '';
      pmLast.value  = partner.last_name  || '';
      pmEmail.value = partner.email || '';
      pmPhone.value = partner.phone || '';
      pmAddr.value  = partner.address || '';
      pmBirth.value = partner.birth_date ? String(partner.birth_date).slice(0,10) : '';
      pmIBAN.value  = partner.iban || '';
      pmStripe.value= partner.stripe_account_id || '';
      pmCode.value  = partner.code || '';
      pmActive.value= String(!!partner.active);
    } else {
      editingPartnerId = null;
      pmFirst.value=''; pmLast.value=''; pmEmail.value=''; pmPhone.value=''; pmAddr.value='';
      pmBirth.value=''; pmIBAN.value=''; pmStripe.value=''; pmCode.value=''; pmActive.value='true';
    }
    pm.style.display='flex';
  }
  function closePM(){ pm.style.display='none'; }
  pmClose.onclick = closePM;
  pm.addEventListener('click', e=>{ if(e.target===pm) closePM(); });

  $('#btnAddPartner').onclick = ()=> openPM('Nuovo partner');

  // Mostra/Nascondi elenco partner
  $('#btnTogglePartners').onclick = ()=>{
    const vis = partnersWrap.style.display !== 'none';
    partnersWrap.style.display = vis ? 'none' : 'block';
    $('#btnTogglePartners').textContent = vis ? 'Mostra elenco' : 'Nascondi elenco';
  };

  function genCode(){
    const s='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let c=''; for(let i=0;i<6;i++) c+=s[Math.floor(Math.random()*s.length)];
    return c;
  }
  async function codeExists(code){
    try{
      const { data, error } = await sb.from('partners').select('id').eq('code', code).limit(1);
      if (error) { logErr('codeExists: '+error.message); return true; }
      return Array.isArray(data) && data.length>0;
    }catch(e){ logErr('codeExists ex: '+(e?.message||e)); return true; }
  }
  pmGen.onclick = async ()=>{
    let tries=0, code='';
    try{
      do { code = genCode(); tries++; } while (tries<10 && await codeExists(code));
      pmCode.value = code;
      if (await codeExists(code)) { pmCodeMsg.textContent = '⚠️ impossibile garantire unicità, scegli tu un codice'; }
      else pmCodeMsg.textContent = '✅ codice disponibile';
    }catch(e){ pmCodeMsg.textContent='Errore generazione codice'; logErr('pmGen: '+(e?.message||e)); }
  };
  pmCode.addEventListener('blur', async ()=>{
    try{
      const c=(pmCode.value||'').trim().toUpperCase();
      if (!c) { pmCodeMsg.textContent=''; return; }
      pmCode.value=c;
      pmCodeMsg.textContent = (await codeExists(c)) ? '❌ codice già presente' : '✅ codice disponibile';
    }catch(e){ logErr('pmCode blur: '+(e?.message||e)); }
  });

  async function loadPartners(showTable=false){
    try{
      partnersWrap.textContent = 'Caricamento…';
      const { data, error } = await sb.from('partners').select('*').order('created_at',{ascending:false});
      if (error){ partnersWrap.textContent = 'Errore: '+error.message; logErr('loadPartners: '+error.message); return; }
      if (!data || !data.length){ partnersWrap.textContent='Nessun partner. Clicca “Nuovo partner”.'; return; }
      const rows = data.map(p=>`
        <tr>
          <td>${p.code||'—'}</td>
          <td>${(p.first_name||'')+' '+(p.last_name||'')}</td>
          <td>${p.email||'—'}</td>
          <td>${p.phone||'—'}</td>
          <td>${p.iban||'—'}</td>
          <td>${p.stripe_account_id||'—'}</td>
          <td>${p.active?'Sì':'No'}</td>
          <td class="row-actions">
            <button class="btn small" data-edit="${p.id}">Modifica</button>
            <button class="btn small" data-toggle="${p.id}" data-on="${p.active?0:1}">${p.active?'Disattiva':'Attiva'}</button>
          </td>
        </tr>
      `).join('');
      partnersWrap.innerHTML = `
        <table class="table" aria-label="Partner">
          <thead><tr>
            <th>Codice</th><th>Nome</th><th>Email</th><th>Telefono</th><th>IBAN</th><th>Stripe acct</th><th>Attivo</th><th>Azioni</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>`;
      partnersWrap.querySelectorAll('[data-edit]').forEach(b=>{
        b.addEventListener('click', ()=>{
          const id=b.getAttribute('data-edit');
          const p = data.find(x=>x.id===id);
          openPM('Modifica partner', p);
        });
      });
      partnersWrap.querySelectorAll('[data-toggle]').forEach(b=>{
        b.addEventListener('click', async ()=>{
          try{
            const id=b.getAttribute('data-toggle');
            const on=b.getAttribute('data-on')==='1';
            const { error } = await sb.from('partners').update({active:on}).eq('id', id);
            if (error){ alert('Errore: '+error.message); logErr('toggle: '+error.message); return; }
            loadPartners(true);
          }catch(e){ logErr('toggle ex: '+(e?.message||e)); }
        });
      });

      partnersWrap.style.display = showTable ? 'block' : partnersWrap.style.display;
    }catch(e){
      partnersWrap.textContent = 'Errore di caricamento partner.';
      logErr('loadPartners ex: '+(e?.message||e));
    }
  }

  pmSave.onclick = async ()=>{
    pmErr.textContent='';
    const first = (pmFirst.value||'').trim();
    const last  = (pmLast.value||'').trim();
    const email = (pmEmail.value||'').trim();
    const code  = (pmCode.value||'').trim().toUpperCase();
    if (!first || !last || !email || !code){ pmErr.textContent='Compila Nome, Cognome, Email e Codice partner.'; return; }
    try{
      if (!editingPartnerId && await codeExists(code)){ pmErr.textContent='Codice già esistente.'; return; }
      const payload = {
        first_name:first, last_name:last, email,
        phone:(pmPhone.value||'').trim(),
        address:(pmAddr.value||'').trim(),
        birth_date: pmBirth.value || null,
        iban:(pmIBAN.value||'').trim(),
        stripe_account_id:(pmStripe.value||'').trim(),
        code, active:(pmActive.value==='true'),
        name: `${first} ${last}`.trim()
      };
      const { error } = await sb.from('partners').upsert(
        editingPartnerId ? { id:editingPartnerId, ...payload } : payload
      ).select('id').single();
      if (error){ pmErr.textContent='Errore: '+error.message; logErr('pmSave: '+error.message); return; }
      closePM(); loadPartners(true);
    }catch(e){ pmErr.textContent='Errore salvataggio.'; logErr('pmSave ex: '+(e?.message||e)); }
  };

  // Init partners (carico ma tengo nascosto)
  await loadPartners(false);

  // ====================== PAYOUTS ======================
  const payMonth = $('#payMonth');
  const payPartners = $('#payPartners');
  const payoutsSummary = $('#payoutsSummary');
  const payoutsDetailBox = $('#payoutDetail');
  const payoutsDetailTitle = $('#payoutDetailTitle');
  const payoutsDetailTable = $('#payoutDetailTable');
  const payRef = $('#payRef');
  const payRefSel = $('#payRefSel');
  const selBar = $('#payoutsSelectionBar');
  const selInfo = $('#selInfo');

  function prettyMonthLabel(ymd){
    try{
      const d = new Date(ymd + 'T00:00:00Z');
      const s = d.toLocaleDateString('it-IT',{ month:'long', year:'numeric' });
      return s.charAt(0).toUpperCase() + s.slice(1);
    }catch(_){ return ymd.slice(0,7); }
  }
  function monthToRange(ym){
    const [y,m] = ym.split('-').map(n=>parseInt(n,10));
    const from = new Date(Date.UTC(y,m-1,1));
    const to   = new Date(Date.UTC(m===12?y+1:y, m===12?1:m, 1));
    const d = x => x.toISOString().slice(0,10);
    return { from: d(from), to: d(to) };
  }

  async function loadAvailableMonths(){
    try{
      payMonth.innerHTML = '<option value="">— Tutti i mesi —</option>';
      $('#btnLoadPayouts').disabled = true;
      $('#btnCSVMonth').disabled = true;

      const { data, error } = await sb.from('v_partner_payouts_month')
        .select('month').order('month', { ascending:false });
      if (error){ payMonth.innerHTML = `<option disabled>Errore: ${error.message}</option>`; logErr('loadMonths: '+error.message); return; }
      if (!data || !data.length){ payMonth.innerHTML = '<option value="">Nessun mese con pending</option>'; return; }

      const seen = new Set();
      const opts = [];
      for (const r of data){
        if (!r.month || seen.has(r.month)) continue;
        seen.add(r.month);
        const val = r.month.slice(0,7);
        const label = prettyMonthLabel(r.month);
        opts.push(`<option value="${val}">${label}</option>`);
      }
      payMonth.innerHTML = `<option value="">— Tutti i mesi —</option>` + opts.join('');
      $('#btnLoadPayouts').disabled = false;
      $('#btnCSVMonth').disabled = false;
    }catch(e){ logErr('loadMonths ex: '+(e?.message||e)); }
  }

  async function loadPartnerFilter(){
    try{
      payPartners.innerHTML = '<option disabled>Caricamento…</option>';
      const { data, error } = await sb.from('partners')
        .select('code,first_name,last_name,active').order('first_name');
      if (error){ payPartners.innerHTML = '<option disabled>Errore caricamento</option>'; logErr('loadPartnerFilter: '+error.message); return; }
      const opts = (data||[])
        .filter(p=>p.active!==false)
        .map(p=>`<option value="${p.code}">${p.code} — ${(p.first_name||'')+' '+(p.last_name||'')}</option>`)
        .join('');
      payPartners.innerHTML = opts || '';
    }catch(e){ logErr('loadPartnerFilter ex: '+(e?.message||e)); }
  }

  function getSelectedPartnerCodes(){
    return Array.from(payPartners.selectedOptions||[]).map(o=>o.value).filter(Boolean);
  }

  $('#btnLoadPayouts').onclick = async ()=>{
    try{
      payoutsDetailBox.style.display='none';
      selBar.style.display='none';
      payoutsSummary.textContent = 'Caricamento…';

      // Filtri opzionali
      const ym = payMonth.value; // '' => tutti
      let query = sb.from('v_partner_payouts_month').select('*');
      if (ym){
        const { from } = monthToRange(ym);
        query = query.eq('month', from);
      }
      const codes = getSelectedPartnerCodes();
      if (codes.length) query = query.in('partner_code', codes);

      const { data, error } = await query.order('month',{ascending:false}).order('partner_code',{ascending:true});
      if (error){ payoutsSummary.textContent = 'Errore: '+error.message; logErr('loadPayouts: '+error.message); return; }
      if (!data?.length){ payoutsSummary.textContent='Nessun pending per questi filtri.'; return; }

      // mappa partner -> info
      const uniqCodes = Array.from(new Set(data.map(r=>r.partner_code).filter(Boolean)));
      const { data: partnersInfo } = await sb.from('partners')
        .select('code,first_name,last_name,iban').in('code', uniqCodes);
      const pmap = new Map((partnersInfo||[]).map(p=>[p.code,p]));

      const rows = data.map((r,idx)=>{
        const p = pmap.get(r.partner_code)||{};
        const eur = Number(r.partner_share_eur||0);
        const cents = Math.round(eur*100);
        return `
          <tr>
            <td class="right"><input type="checkbox" data-check="${idx}" data-code="${r.partner_code}" data-month="${r.month}" data-amount="${cents}"></td>
            <td><b>${r.partner_code}</b></td>
            <td>${p.first_name||'—'}</td>
            <td>${p.last_name||'—'}</td>
            <td>${p.iban||'—'}</td>
            <td>${prettyMonthLabel(r.month)}</td>
            <td class="right"><b>${eur.toFixed(2).replace('.',',')} €</b></td>
            <td class="right">${r.items}</td>
            <td><button class="btn small" data-open="${r.partner_code}" data-month="${r.month}">Dettaglio</button></td>
          </tr>`;
      }).join('');

      payoutsSummary.innerHTML = `
        <table class="table" aria-label="Payout pendenti">
          <thead>
            <tr>
              <th class="right">✓</th>
              <th>Partner</th>
              <th>Nome</th>
              <th>Cognome</th>
              <th>IBAN</th>
              <th>Mese</th>
              <th class="right">Totale</th>
              <th class="right">Items</th>
              <th></th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
          <tfoot>
            <tr><th colspan="6" class="right">Selezionati</th><th class="right" id="selTotal">0,00 €</th><th colspan="2"></th></tr>
          </tfoot>
        </table>`;

      // Gestione selezioni e totale
      function refreshSelTotal(){
        const checks = payoutsSummary.querySelectorAll('input[type="checkbox"][data-check]:checked');
        let tot=0; checks.forEach(c=> tot += Number(c.getAttribute('data-amount')||0));
        const euro = (tot/100).toFixed(2).replace('.',',')+' €';
        $('#selTotal').textContent = euro;
        selInfo.textContent = 'Selezionati: € ' + (tot/100).toFixed(2).replace('.',',');
        selBar.style.display = checks.length ? 'block' : 'none';
      }
      payoutsSummary.querySelectorAll('input[type="checkbox"][data-check]').forEach(ch=>{
        ch.addEventListener('change', refreshSelTotal);
      });
      refreshSelTotal();

      // Apri dettaglio
      payoutsSummary.querySelectorAll('[data-open]').forEach(b=>{
        b.addEventListener('click', ()=>{
          const range = { from: b.getAttribute('data-month'), to: null };
          const ym = payMonth.value;
          const r = ym ? monthToRange(ym) : { from: b.getAttribute('data-month'), to: null };
          openPayoutDetail(b.getAttribute('data-open'), r);
        });
      });

    }catch(e){ payoutsSummary.textContent='Errore di caricamento.'; logErr('btnLoad ex: '+(e?.message||e)); }
  };

  // Segna selezionati come pagati (per partner+mese)
  $('#btnMarkSelected').onclick = async ()=>{
    try{
      const checks = payoutsSummary.querySelectorAll('input[type="checkbox"][data-check]:checked');
      if (!checks.length){ alert('Seleziona almeno una riga.'); return; }
      const ref = (payRefSel.value||'').trim();
      if (!ref){ alert('Inserisci un riferimento pagamento (es. SEPA 2025-09 batch #1).'); return; }
      if (!confirm('Segnare come pagato le righe selezionate?')) return;

      // Aggrega per (partner_code, month)
      const groups = {};
      checks.forEach(ch=>{
        const code = ch.getAttribute('data-code');
        const month = ch.getAttribute('data-month'); // es. 2025-09-01
        const key = code+'|'+month;
        groups[key] = { code, month };
      });

      // Esegui update per ogni gruppo
      for (const k of Object.keys(groups)){
        const { code, month } = groups[k];
        const { from, to } = monthToRange(month.slice(0,7));
        const { error } = await sb.from('partner_commissions')
          .update({ status:'paid', payment_ref: ref })
          .eq('status','pending').eq('partner_code', code).gte('created_at',from).lt('created_at',to);
        if (error){ alert('Errore su '+code+' '+month+': '+error.message); logErr('markSelected '+code+': '+error.message); return; }
      }

      alert('Righe selezionate segnate come pagate.');
      $('#btnLoadPayouts').click(); // refresh
      selBar.style.display='none';
    }catch(e){ logErr('btnMarkSelected ex: '+(e?.message||e)); }
  };

  async function openPayoutDetail(partnerCode, range){
    try{
      const r = range?.from ? range : { from: new Date().toISOString().slice(0,10), to: null };
      const rng = r.from.includes('-') && r.to ? r : ( r.from ? monthToRange(r.from.slice(0,7)) : null );
      const rf = rng?.from || r.from, rt = rng?.to || r.to;
      payoutsDetailTitle.textContent = `Dettaglio ${partnerCode} — ${rf} → ${rt||'...'}`
      payRef.value = '';
      payoutsDetailTable.textContent = 'Caricamento…';
      payoutsDetailBox.style.display='block';
      const q = sb.from('partner_commissions')
        .select('created_at,item_type,currency,unit_amount_cents,stripe_fee_cents,net_cents,partner_share_cents')
        .eq('status','pending').eq('partner_code', partnerCode)
        .gte('created_at', rf);
      const { data, error } = rt ? await q.lt('created_at', rt) : await q;
      if (error){ payoutsDetailTable.textContent = 'Errore: '+error.message; logErr('detail: '+error.message); return; }
      if (!data?.length){ payoutsDetailTable.textContent = 'Nessun elemento in pending.'; return; }
      const total = data.reduce((s,r)=> s+(r.partner_share_cents||0), 0);
      const rows = data.map(r=>`
        <tr>
          <td>${r.created_at?.slice(0,10)||''}</td>
          <td>${r.item_type}</td>
          <td class="right">${money(r.unit_amount_cents)} €</td>
          <td class="right">${money(r.stripe_fee_cents)} €</td>
          <td class="right">${money(r.net_cents)} €</td>
          <td class="right"><b>${money(r.partner_share_cents)} €</b></td>
        </tr>`).join('');
      payoutsDetailTable.innerHTML = `
        <table class="table" aria-label="Dettaglio partner">
          <thead><tr><th>Data</th><th>Tipo</th><th>Lordo</th><th>Fee Stripe</th><th>Netto</th><th>Quota 50%</th></tr></thead>
          <tbody>${rows}</tbody>
          <tfoot><tr><th colspan="5" class="right">Totale</th><th class="right">${money(total)} €</th></tr></tfoot>
        </table>`;

      $('#btnCSVMonth').onclick = async ()=>{
        try{
          const ym = payMonth.value; // se vuoto, usa il mese di rf
          const baseYm = ym || rf.slice(0,7);
          const { from, to } = monthToRange(baseYm);
          const { data: rowsAll, error: errAll } = await sb.from('partner_commissions')
            .select('*').eq('status','pending').gte('created_at',from).lt('created_at',to)
            .order('partner_code').order('created_at');
          if (errAll){ alert('Errore: '+errAll.message); logErr('csv: '+errAll.message); return; }
          if (!rowsAll?.length){ alert('Nessun dato.'); return; }
          const head = ['created_at','partner_code','item_type','currency','unit_amount','stripe_fee','net','partner_share'].join(',');
          const body = rowsAll.map(r=>[
            r.created_at, r.partner_code, r.item_type, r.currency,
            (r.unit_amount_cents/100).toFixed(2),(r.stripe_fee_cents/100).toFixed(2),
            (r.net_cents/100).toFixed(2),(r.partner_share_cents/100).toFixed(2)
          ].join(',')).join('\n');
          const blob = new Blob([head+'\n'+body], {type:'text/csv;charset=utf-8;'});
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `staseraqui_payout_${from}.csv`; a.click();
        }catch(e){ logErr('csv ex: '+(e?.message||e)); }
      };

      $('#btnMarkPaid').onclick = async ()=>{
        try{
          const ref = (payRef.value||'').trim();
          if (!ref){ alert('Inserisci un riferimento pagamento.'); return; }
          if (!confirm('Segnare come pagato tutti gli elementi pending per questo partner e periodo?')) return;
          const { error } = await sb.from('partner_commissions')
            .update({ status:'paid', payment_ref: ref })
            .eq('status','pending').eq('partner_code', partnerCode)
            .gte('created_at', rf).lt('created_at', rt || '9999-12-31');
          if (error){ alert('Errore: '+error.message); logErr('markPaid: '+error.message); return; }
          alert('Aggiornato a paid.');
          $('#btnLoadPayouts').click();
          payoutsDetailBox.style.display='none';
        }catch(e){ logErr('markPaid ex: '+(e?.message||e)); }
      };
    }catch(e){ payoutsDetailTable.textContent='Errore apertura dettaglio.'; logErr('openDetail ex: '+(e?.message||e)); }
  }

  // ====================== COUPON STRIPE (via Edge: stripe-admin) ======================
  const cpCode = $('#cp_code');
  const cpType = $('#cp_type');
  const cpPercentWrap = $('#cp_percent_wrap');
  const cpAmountWrap  = $('#cp_amount_wrap');
  const cpPercent = $('#cp_percent');
  const cpAmount  = $('#cp_amount');
  const cpMax     = $('#cp_max');
  const cpExp     = $('#cp_exp');
  const cpCreate  = $('#cp_create');
  const cpMsg     = $('#cp_msg');
  const cpListBox = $('#cp_list');
  const cpGenBtn  = $('#cp_gen');

  cpType.addEventListener('change', ()=>{
    const t = cpType.value;
    if (t==='percent'){ cpPercentWrap.style.display='block'; cpAmountWrap.style.display='none'; }
    else { cpPercentWrap.style.display='none'; cpAmountWrap.style.display='block'; }
  });

  cpGenBtn.addEventListener('click', ()=>{
    const s='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let c=''; for(let i=0;i<6;i++) c+=s[Math.floor(Math.random()*s.length)];
    cpCode.value = 'ADMIN-' + c;
  });

  async function getAccessToken(){
    const { data:{ session } } = await sb.auth.getSession();
    return session?.access_token || '';
  }

  // >>> CREAZIONE CODICE SCONTO
  cpCreate.addEventListener('click', async () => {
    try {
      cpMsg.textContent = 'Creazione in corso…';

      const code = (cpCode.value || '').trim().toUpperCase();
      const type = cpType.value; // 'percent' o 'amount'
      const percent = Number(cpPercent.value);
      const amount  = Number(cpAmount.value);
      const maxRed  = cpMax.value ? Number(cpMax.value) : null;
      const expUnix = cpExp.value ? Math.floor(new Date(cpExp.value).getTime() / 1000) : null;

      if (!code) { cpMsg.textContent = 'Inserisci un codice (es. ADMIN100).'; return; }
      if (type === 'percent') {
        if (!percent || percent < 1 || percent > 100) {
          cpMsg.textContent = 'Inserisci una percentuale tra 1 e 100.'; return;
        }
      } else {
        if (!amount || amount < 1) {
          cpMsg.textContent = 'Inserisci un importo in euro (≥ 1).'; return;
        }
      }

      if (!URL_COUPON) { cpMsg.textContent = 'Funzione non disponibile (URL_COUPON non configurato).'; return; }

      const token = await getAccessToken();
      if (!token) { cpMsg.textContent = 'Devi essere loggato per creare un codice.'; return; }

      const payload = {
        action: 'create_promo',
        code,
        type,
        value: type === 'percent' ? percent : Math.round(amount * 100),
        max_redemptions: maxRed,
        expires_at: expUnix
      };

      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), 15000);

      let res, text;
      try {
        res = await fetch(URL_COUPON, {
          method: 'POST',
          headers: { 'content-type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify(payload),
          signal: controller.signal
        });
        text = await res.text();
      } catch (e) {
        if (e?.name === 'AbortError') { cpMsg.textContent = 'Errore: timeout.'; return; }
        cpMsg.textContent = 'Errore di rete: ' + (e?.message || e); return;
      } finally { clearTimeout(timer); }

      if (!res.ok) { cpMsg.textContent = 'Errore: ' + (text || ('HTTP ' + res.status)); return; }

      let data = {};
      try { data = JSON.parse(text); } catch (_) {}
      cpMsg.textContent = '✅ Creato: ' + (data?.code || code);

      cpCode.value = ''; cpPercent.value = ''; cpAmount.value = '';
      cpMax.value = ''; cpExp.value = '';

      loadPromoList();
    } catch (e) {
      cpMsg.textContent = 'Errore imprevisto: ' + (e?.message || e);
    }
  });

  // >>> LISTA CODICI
  async function loadPromoList(){
    const renderTable = (rowsHtml) => `
      <table class="table" aria-label="Codici attivi">
        <thead>
          <tr>
            <th>Codice</th>
            <th>Sconto</th>
            <th class="right">Max</th>
            <th class="right">Usati</th>
            <th>Scadenza</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${rowsHtml}</tbody>
      </table>`;

    try{
      if (!URL_COUPON){
        cpListBox.textContent = 'Function non disponibile (URL_COUPON non configurato).';
        return;
      }
      cpListBox.textContent = 'Caricamento…';

      const token = await getAccessToken();
      if (!token){
        cpListBox.textContent = 'Non sei loggato: inserisci la tua email quando la pagina lo chiede, poi riapri questa pagina.';
        return;
      }

      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), 10000);

      let res, txt;
      try{
        res = await fetch(URL_COUPON + '?active=true&limit=50', {
          headers: { 'Authorization': 'Bearer ' + token },
          signal: controller.signal
        });
        txt = await res.text();
      } finally { clearTimeout(timer); }

      if (!res.ok){
        cpListBox.textContent = `Errore (${res.status}): ${txt || 'impossibile caricare'}`;
        logErr('promo list HTTP ' + res.status + ': ' + txt);
        return;
      }

      let j = null;
      try { j = JSON.parse(txt); }
      catch(e){
        cpListBox.textContent = 'Errore: risposta non valida dal server.';
        logErr('promo list JSON: ' + (e?.message || e));
        return;
      }

      if (!j?.data?.length){
        cpListBox.textContent = 'Nessun codice attivo.';
        return;
      }

      const rows = j.data.map(p => `
        <tr>
          <td>${p.code}</td>
          <td>${
            p.coupon?.percent_off
              ? (p.coupon.percent_off + '%')
              : (p.coupon?.amount_off ? ((p.coupon.amount_off/100).toFixed(2) + ' €') : '—')
          }</td>
          <td class="right">${p.max_redemptions ?? '—'}</td>
          <td class="right">${p.times_redeemed ?? 0}</td>
          <td>${p.expires_at ? new Date(p.expires_at*1000).toISOString().slice(0,16).replace('T',' ') : '—'}</td>
          <td><button class="btn small" data-deact="${p.id}">Disattiva</button></td>
        </tr>
      `).join('');

      cpListBox.innerHTML = renderTable(rows);

      cpListBox.querySelectorAll('[data-deact]').forEach(b=>{
        b.addEventListener('click', async ()=>{
          try{
            if (!confirm('Disattivare questo codice?')) return;
            const id = b.getAttribute('data-deact');
            const tkn = await getAccessToken();
            const r = await fetch(URL_COUPON, {
              method:'POST',
              headers:{ 'content-type':'application/json', 'Authorization': 'Bearer ' + tkn },
              body: JSON.stringify({ action:'deactivate_promo', id })
            });
            if (!r.ok){ alert('Errore: ' + await r.text()); return; }
            loadPromoList();
          }catch(e){ logErr('deactivate ex: ' + (e?.message||e)); }
        });
      });

    }catch(e){
      cpListBox.textContent = (e?.name === 'AbortError')
        ? 'Errore: timeout (nessuna risposta dal server).'
        : ('Errore caricamento codici: ' + (e?.message || e));
      logErr('loadPromoList ex: ' + (e?.message || e));
    }
  }

  // inizializza viste
  await loadAvailableMonths();
  await loadPartnerFilter();
  loadPromoList();

})();
</script>
</body>
</html>
