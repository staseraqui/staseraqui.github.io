<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin — Stasera Qui</title>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="assets/style.css?v=14">
<!-- carica la configurazione -->
<script src="assets/app-config.js?v=1"></script>
<!-- supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
  .admin-wrap{max-width:980px;margin:0 auto;padding:16px}
  .card{background:#0f1c2d;border:1px solid rgba(255,255,255,.15);padding:16px;border-radius:12px;margin:12px 0}
  input[type="text"],input[type="file"],select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:#fff;color:#081421}
  .grid{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap}
  .ok{color:#7CFC7C}.err{color:#ff6b6b}
  pre{white-space:pre-wrap;background:#081421;padding:10px;border-radius:8px;max-height:360px;overflow:auto}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid rgba(255,255,255,.1);padding:8px 6px;text-align:left}
  .muted{color:#b8c2ce}.tiny{font-size:12px;color:#b8c2ce}
  .list{font-size:13px}
  .list code{background:#081421;padding:2px 6px;border-radius:6px}
</style>
</head>
<body>
<header class="header" style="padding:0 16px">
  <a href="index.html" class="logo">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true">
      <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/>
      <circle cx="32" cy="24" r="9" fill="#ffffff"/></svg>
    <span class="wordmark">stasera qui</span>
  </a>
</header>

<main class="admin-wrap">
  <h1>Console Admin</h1>

  <div class="card">
    <h3>Accesso</h3>
    <div class="grid">
      <div><label>PIN admin</label><input id="pin" type="text" placeholder="PIN scelto (es. TORINO-2025)"></div>
      <div style="align-self:end">
        <button class="btn" id="connect">Connetti</button>
        <span id="status" class="muted">Non connesso</span>
      </div>
    </div>
    <p class="tiny">Non servono più URL/Key: sono lette da <code>assets/app-config.js</code>.</p>
  </div>

  <div class="card">
    <h3>Upload locandine (JPG/PNG → URL pronti)</h3>
    <p class="list">
      1) Seleziona i file → <b>Carica</b> → ottieni l’URL da incollare nel CSV (colonna <code>poster_url</code>).<br>
      2) Oppure usa nel CSV la colonna <code>poster_file</code> con il nome file caricato (es. <code>loca1.jpg</code>).
    </p>
    <input id="imgFiles" type="file" accept="image/png,image/jpeg" multiple>
    <div class="btn-row" style="margin-top:10px">
      <button class="btn primary" id="uploadImgs">Carica</button>
    </div>
    <div id="imgLog" class="muted" style="margin-top:8px"></div>
    <pre id="imgList" style="display:none"></pre>
  </div>

  <div class="card">
    <h3>Caricamento massivo (CSV) con geocodifica</h3>
    <p class="muted">Scarica il <a href="#" id="dlTpl">template CSV</a>. Colonne:
      <code>title;description;price;poster_url;poster_file;categories;venue;address;city;date;time</code>.<br>
      <b>categories</b> separate con <b>|</b>. Metti <b>poster_url</b> oppure <b>poster_file</b>.
    </p>
    <input id="csvFile" type="file" accept=".csv">
    <div class="btn-row" style="margin-top:10px">
      <button class="btn" id="preview">Anteprima</button>
      <button class="btn primary" id="import">Importa (con geocodifica)</button>
    </div>
    <div id="logCSV" class="muted" style="margin-top:8px"></div>
    <pre id="csvPreview" style="display:none"></pre>
    <p class="tiny">Geocodifica: Nominatim (OSM). ~1 secondo tra richieste per rispetto dei limiti.</p>
  </div>

  <div class="card">
    <h3>Eliminazione massiva (per filtri)</h3>
    <div class="grid">
      <div><label>Filtro per città (facoltativo)</label><input id="delCity" type="text" placeholder="Es. Torino"></div>
      <div><label>Filtro per categoria (facoltativo)</label><input id="delCat" type="text" placeholder="Es. Musica"></div>
    </div>
    <div class="grid">
      <div><label>Dal (YYYY-MM-DD)</label><input id="delFrom" type="text" placeholder="2025-09-05"></div>
      <div><label>Al (YYYY-MM-DD)</label><input id="delTo" type="text" placeholder="2025-09-10"></div>
    </div>
    <div class="btn-row" style="margin-top:10px">
      <button class="btn secondary" id="deleteBtn">Elimina eventi</button>
    </div>
    <div id="logDel" class="muted" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <h3>Report veloci</h3>
    <div class="btn-row">
      <button class="btn" id="repDay">Eventi per giorno</button>
      <button class="btn" id="repCity">Eventi per città</button>
      <button class="btn" id="repCat">Eventi per categoria</button>
    </div>
    <table class="table" id="repTbl" style="margin-top:10px;display:none"></table>
  </div>

  <p class="small muted">Per sicurezza: il PIN non viene salvato. Se vuoi, in futuro aggiungiamo login via email (magic link).</p>
</main>

<script>
  // ===== Template CSV
  const tplCSV =
`title;description;price;poster_url;poster_file;categories;venue;address;city;date;time
Aperitivo Jazz;Live trio;Gratis;;loca1.jpg;Musica|Nightlife;Bar Centrale;Via Roma 1;Torino;2025-09-15;19:30
Festa Pro Loco;Stand e musica;10€;https://…/loca2.png;;Sagre & Fiere|Famiglie & Bambini;Piazza XX;Via Garibaldi;Alessandria;2025-09-16;18:00`;

  const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
  const $ = s => document.querySelector(s);
  let sb=null, rpc=null;

  // ===== Download template
  $('#dlTpl').onclick = (e)=>{
    e.preventDefault();
    const blob = new Blob([tplCSV], {type:'text/csv;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'staseraqui_template.csv';
    a.click();
  };

  // ===== Connessione (usa config)
  $('#connect').onclick = ()=>{
    const cfg = window.SQ_CONFIG || {};
    if(!cfg.SUPABASE_URL || !cfg.SUPABASE_ANON){
      alert('Config mancante: assets/app-config.js');
      return;
    }
    sb = supabase.createClient(cfg.SUPABASE_URL, cfg.SUPABASE_ANON);
    rpc = async (fn, args)=> {
      const { data, error } = await sb.rpc(fn, args);
      if (error) throw error;
      return data;
    };
    $('#status').textContent = 'Connesso';
    $('#status').className = 'ok';
  };

  // ===== Upload locandine su bucket "event-images"
  const uploadedMap = new Map(); // filename → public URL
  $('#uploadImgs').onclick = async ()=>{
    if(!sb){ alert('Connettiti prima.'); return; }
    const files = $('#imgFiles').files;
    if(!files || !files.length){ alert('Seleziona almeno un file.'); return; }
    $('#imgLog').textContent = 'Caricamento…';
    const lines = [];
    for (let i=0;i<files.length;i++){
      const f = files[i];
      const path = 'bulk/'+Date.now()+'_'+f.name.replace(/\s+/g,'_');
      const { error } = await sb.storage.from('event-images').upload(path, f, { upsert: true, contentType: f.type });
      if(error){ lines.push(`ERRORE ${f.name}: ${error.message}`); continue; }
      const { data:pub } = sb.storage.from('event-images').getPublicUrl(path);
      uploadedMap.set(f.name.toLowerCase(), pub.publicUrl);
      lines.push(`${f.name} → ${pub.publicUrl}`);
    }
    $('#imgLog').innerHTML = `<span class="ok">Fatto.</span> Caricate ${files.length} locandine.`;
    $('#imgList').style.display='block';
    $('#imgList').textContent = lines.join('\n');
  };

  // ===== CSV parser
  function parseCSV(text){
    const rows = text.split(/\r?\n/).filter(Boolean);
    const head = rows.shift().split(';').map(s=>s.trim());
    const idx = Object.fromEntries(head.map((h,i)=>[h,i]));
    const get = (cols, name)=> {
      const i = idx[name];
      return (i==null) ? '' : (cols[i]||'').trim();
    };
    const items = rows.map(line=>{
      const cols = line.split(';');
      const pf = get(cols,'poster_file');
      let poster_url = get(cols,'poster_url');
      if(!poster_url && pf){
        const url = uploadedMap.get(pf.toLowerCase());
        if(url) poster_url = url;
      }
      return {
        title: get(cols,'title'),
        description: get(cols,'description'),
        price: get(cols,'price'),
        poster_url,
        categories: (get(cols,'categories')||'').split('|').map(s=>s.trim()).filter(Boolean),
        venue: get(cols,'venue'),
        address: get(cols,'address'),
        city: get(cols,'city'),
        date: get(cols,'date'),
        time: get(cols,'time')
      };
    });
    return items;
  }

  let parsed=null;

  $('#preview').onclick = ()=>{
    const f = $('#csvFile').files[0];
    if(!f) { alert('Seleziona un file CSV.'); return; }
    const r = new FileReader();
    r.onload = ()=>{
      parsed = parseCSV(r.result);
      $('#csvPreview').style.display='block';
      $('#csvPreview').textContent = JSON.stringify(parsed, null, 2);
      $('#logCSV').textContent = parsed.length+' righe pronte';
    };
    r.readAsText(f, 'utf-8');
  };

  // ===== Geocoding (OSM)
  async function geocodeAddrOSM(addr){
    const url = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&q='+encodeURIComponent(addr);
    const r = await fetch(url, {headers:{'Accept-Language':'it','User-Agent':'staseraqui-admin'}});
    if(!r.ok) return null;
    const j = await r.json(); if(!j || !j.length) return null;
    return {lat:parseFloat(j[0].lat), lng:parseFloat(j[0].lon), label:j[0].display_name};
  }

  // ===== Import (1 req/sec)
  $('#import').onclick = async ()=>{
    const pin = $('#pin').value.trim();
    if(!sb || !rpc){ alert('Connettiti prima.'); return; }
    if(!pin){ alert('Inserisci PIN admin.'); return; }
    if(!parsed || !parsed.length){ alert('Fai prima Anteprima del CSV.'); return; }

    const out = [];
    $('#logCSV').innerHTML = 'Geocodifica in corso…';
    for (let i=0;i<parsed.length;i++){
      const row = parsed[i];
      let lat=null, lng=null;
      const q = [row.address, row.city].filter(Boolean).join(', ');
      if (q){
        try{
          const g = await geocodeAddrOSM(q);
          if (g){ lat=g.lat; lng=g.lng; }
        }catch(_){}
        await sleep(1000);
      }
      out.push({
        title: row.title || '',
        description: row.description || '',
        price: row.price || '',
        poster_url: row.poster_url || '',
        categories: row.categories || [],
        venue: row.venue || '',
        address: row.address || '',
        city: row.city || '',
        date: row.date || '',
        time: row.time || '',
        lat, lng
      });
      $('#logCSV').innerHTML = `Geocodifica ${i+1}/${parsed.length}…`;
    }

    try{
      const payload = { rows: out };
      const res = await rpc('fn_admin_bulk_import', { pin, payload });
      $('#logCSV').innerHTML = `<span class="ok">Import completato.</span> Inseriti: ${(res?.inserted||0)} — Errori: ${(res?.errors||0)}. Vai in Home e aggiorna per vedere i pin.`;
    }catch(e){
      $('#logCSV').innerHTML = '<span class="err">'+(e.message||e)+ '</span>';
    }
  };

  // ===== Delete massivo (filtri)
  $('#deleteBtn').onclick = async ()=>{
    const pin = $('#pin').value.trim();
    if(!sb || !rpc){ alert('Connettiti prima.'); return; }
    const filt = {
      city: $('#delCity').value.trim() || null,
      category: $('#delCat').value.trim() || null,
      from: $('#delFrom').value.trim() || null,
      to: $('#delTo').value.trim() || null
    };
    if(!pin){ alert('Inserisci PIN admin.'); return; }
    if(!filt.city && !filt.category && !filt.from && !filt.to){
      if(!confirm('Nessun filtro impostato: elimineresti TUTTI gli eventi. Sei sicuro?')) return;
    }
    try{
      const res = await rpc('fn_admin_bulk_delete', { pin, filt });
      document.getElementById('logDel').innerHTML = '<span class="ok">Eliminati '+(res?.deleted||0)+' eventi.</span>';
    }catch(e){
      document.getElementById('logDel').innerHTML = '<span class="err">'+(e.message||e)+ '</span>';
    }
  };

  // ===== Report
  async function runReport(viewName, cols){
    if(!sb){ alert('Connettiti prima.'); return; }
    const { data, error } = await sb.from(viewName).select('*');
    if(error){ alert(error.message); return; }
    const tbl = document.getElementById('repTbl');
    tbl.style.display='table';
    tbl.innerHTML = '<thead><tr>'+cols.map(c=>'<th>'+c+'</th>').join('')+'</tr></thead><tbody>'+
      data.map(r=>'<tr>'+cols.map(c=>'<td>'+(r[c]??'')+'</td>').join('')+'</tr>').join('')+'</tbody>';
  }
  document.getElementById('repDay').onclick = ()=> runReport('vw_events_by_day', ['day','count']);
  document.getElementById('repCity').onclick = ()=> runReport('vw_events_by_city', ['city','count']);
  document.getElementById('repCat').onclick = ()=> runReport('vw_events_by_category', ['category','count']);
</script>
</body>
</html>
