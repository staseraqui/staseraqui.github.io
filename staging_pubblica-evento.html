<!doctype html>
<html lang="it" class="sq">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>[STAGING] Pubblica evento — Stasera Qui</title>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="assets/publish.css?v=2">
</head>
<body class="sq">
<header class="header">
  <img src="assets/logo_lockup_dark_v4.svg" alt="stasera qui — logo">
</header>

<main class="container">
  <div class="hero">
    <h1>Pubblica il tuo evento (STAGING)</h1>
    <p>Questa è una pagina di prova che non tocca il sito live. Dopo l'approvazione, la porteremo in produzione.</p>
  </div>

  <form id="eventForm" class="card" onsubmit="return false">
    <div class="grid">
      <div>
        <label for="titolo">Titolo evento*</label>
        <input id="titolo" required maxlength="80" placeholder="Es. Aperitivo jazz in piazza">
      </div>
      <div>
        <label for="categorieBtn">Categorie*</label>
        <div class="actions">
          <button type="button" class="btn secondary" id="categorieBtn">Scegli categorie</button>
          <div id="catBadges"></div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div>
        <label for="prezzo">Prezzo/Ingresso</label>
        <input id="prezzo" placeholder="Es. Gratis / 10€ con drink">
      </div>
      <div>
        <label for="contatto">Prenotazione/Contatto</label>
        <input id="contatto" placeholder="Link o telefono">
      </div>
    </div>

    <div>
      <label for="descrizione">Descrizione breve (max 400)*</label>
      <textarea id="descrizione" name="descrizione" maxlength="400" required placeholder="Due righe chiare: cosa succede, per chi è, dettagli utili."></textarea>
    </div>

    <div class="grid">
      <div>
        <label for="locandina">Locandina/Foto (JPG/PNG)*</label>
        <input id="locandina" type="file" accept="image/png,image/jpeg" required>
      </div>
    </div>

    <h3 class="block-title">Occorrenze (puoi aggiungerne più di una)</h3>
    <div id="occBlocks">
      <div class="occ">
        <div class="grid">
          <div>
            <label>Luogo/Nome locale*</label>
            <input class="luogo" placeholder="Es. Bar Centrale">
          </div>
          <div>
            <label>Indirizzo*</label>
            <input class="indirizzo" placeholder="Via Roma 1">
          </div>
        </div>
        <div class="grid">
          <div>
            <label>Città*</label>
            <input class="citta" placeholder="Es. Torino">
          </div>
          <div>
            <label>Data*</label>
            <input class="data" type="date">
          </div>
        </div>
        <div class="grid">
          <div>
            <label>Orario*</label>
            <input class="ora" type="time">
          </div>
        </div>
      </div>
    </div>

    <div class="actions" style="margin-top:8px">
      <button type="button" class="btn" id="aggiungiOcc">Aggiungi altra occorrenza</button>
    </div>

    <p class="small">* Campi obbligatori. Il campo <b>Categorie</b> consente <b>scelta multipla</b>.</p>

    <div class="footer-actions">
      <button class="btn" id="anteprimaBtn">Rivedi anteprima</button>
      <button class="btn" id="confermaFooterBtn">Conferma pubblicazione evento</button>
      <button type="button" class="btn secondary" id="azzeraBtn">Azzera tutto</button>
    </div>
    <div id="err" class="err"></div>
  </form>

  <div id="preview" class="card" style="display:none">
    <h3>Anteprima</h3>
    <div class="small">
      <div><b>Titolo:</b> <span id="pv_titolo"></span></div>
      <div><b>Categorie:</b> <span id="pv_cats"></span></div>
      <div><b>Prezzo:</b> <span id="pv_prezzo"></span></div>
      <div><b>Contatto:</b> <span id="pv_contatto"></span></div>
      <div><b>Occorrenze:</b> <span id="pv_occ"></span></div>
    </div>
    <p id="pv_descr" style="margin-top:8px"></p>
    <div style="margin-top:8px" id="pv_list"></div>
    <div class="actions" style="margin-top:12px">
      <a class="btn" id="confermaBtn" href="#">Conferma pubblicazione evento</a>
      <span class="small">Verifica automatica testo/indirizzo/immagine prima del pagamento.</span>
    </div>
  </div>
</main>

<script>
const el = id => document.getElementById(id);
let categorie = [];

function renderCatBadges(){
  const wrap = document.getElementById('catBadges');
  wrap.innerHTML = '';
  categorie.forEach(c => {
    const b = document.createElement('span');
    b.className = 'badge';
    b.textContent = c;
    wrap.appendChild(b);
  });
}

const modalDiv = document.createElement('div');
modalDiv.className = 'modal';
modalDiv.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.52);display:none;align-items:flex-end;justify-content:center;z-index:50';
modalDiv.innerHTML = `
  <div class="sheet" style="background:#0f1c2d;border-top-left-radius:16px;border-top-right-radius:16px;padding:16px 16px 20px;border:1px solid rgba(255,255,255,.12);width:100%;max-width:980px;margin:0 auto">
    <h3 style="margin:0 0 6px">Scegli categorie (multi-selezione)</h3>
    <div class="chips" id="chips" style="display:flex;gap:10px;flex-wrap:wrap;margin:6px 0 12px">
      ${['Musica','Food & Drink','Nightlife','Cultura/Spettacolo','Famiglie & Bambini','Sport','Sagre & Fiere','Mercatini'].map(c => `<div class="chip" data-cat="${c}" style="background:#17304d;border:1px solid #2e6e8f;color:#d7f2ff;border-radius:28px;padding:10px 18px;font-weight:700;cursor:pointer;user-select:none">${c}</div>`).join('')}
    </div>
    <div class="actions">
      <button class="btn" id="catOk">Conferma</button>
      <button class="btn secondary" id="catClear">Azzera</button>
    </div>
  </div>`;
document.body.appendChild(modalDiv);

// modal handlers
document.getElementById('categorieBtn').addEventListener('click', ()=>{
  modalDiv.style.display='flex';
  modalDiv.querySelectorAll('.chip').forEach(ch => ch.classList.toggle('active', categorie.includes(ch.dataset.cat)));
});
modalDiv.addEventListener('click', (e)=>{ if(e.target===modalDiv) modalDiv.style.display='none'; });
modalDiv.addEventListener('click', (e)=>{
  if(e.target.classList.contains('chip')){
    e.target.classList.toggle('active');
    if(e.target.classList.contains('active')){
      e.target.style.background='#22b3f0'; e.target.style.color='#081421'; e.target.style.borderColor='#22b3f0';
    } else {
      e.target.style.background='#17304d'; e.target.style.color='#d7f2ff'; e.target.style.borderColor='#2e6e8f';
    }
  }
});
document.getElementById('catOk').addEventListener('click', ()=>{
  categorie = [...modalDiv.querySelectorAll('.chip.active')].map(ch => ch.dataset.cat);
  renderCatBadges();
  modalDiv.style.display='none';
});
document.getElementById('catClear').addEventListener('click', ()=>{
  categorie = [];
  renderCatBadges();
  modalDiv.querySelectorAll('.chip').forEach(ch => ch.classList.remove('active'));
});

// occorrenze dinamiche
const occBlocks = document.getElementById('occBlocks');
document.getElementById('aggiungiOcc').addEventListener('click', ()=>{
  const div = document.createElement('div');
  div.innerHTML = `
    <hr class="divider">
    <div class="occ">
      <div class="grid">
        <div>
          <label>Luogo/Nome locale*</label>
          <input class="luogo" placeholder="Es. Bar Centrale">
        </div>
        <div>
          <label>Indirizzo*</label>
          <input class="indirizzo" placeholder="Via Roma 1">
        </div>
      </div>
      <div class="grid">
        <div>
          <label>Città*</label>
          <input class="citta" placeholder="Es. Torino">
        </div>
        <div>
          <label>Data*</label>
          <input class="data" type="date">
        </div>
      </div>
      <div class="grid">
        <div>
          <label>Orario*</label>
          <input class="ora" type="time">
        </div>
      </div>
    </div>`;
  occBlocks.appendChild(div);
});

const err = document.getElementById('err');
function cleanText(t){ t = (t||'').trim().replace(/\s+/g,' '); return t ? t.charAt(0).toUpperCase()+t.slice(1) : ''; }
function collectOcc(){
  const blocks = [...document.querySelectorAll('#occBlocks .occ')];
  const occ = [];
  for(const b of blocks){
    const luogo = cleanText(b.querySelector('.luogo').value);
    const indirizzo = cleanText(b.querySelector('.indirizzo').value);
    const citta = cleanText(b.querySelector('.citta').value);
    const data = b.querySelector('.data').value;
    const ora = b.querySelector('.ora').value;
    if(!luogo || !indirizzo || !citta || !data || !ora){
      return {ok:false, msg:'Completa tutti i campi delle occorrenze (Luogo*, Indirizzo*, Città*, Data*, Orario*).'};
    }
    occ.push({luogo, indirizzo, citta, data, ora});
  }
  if(occ.length===0) return {ok:false, msg:'Aggiungi almeno 1 occorrenza.'};
  return {ok:true, occ};
}

function validateAndPreview(){
  err.textContent='';
  const titolo = cleanText(el('titolo').value);
  const descr = cleanText(el('descrizione').value);
  const file = el('locandina').files[0];
  if(!titolo || !descr || !file || categorie.length===0){
    err.textContent = 'Controlla: Titolo*, Descrizione*, Locandina*, almeno 1 Categoria*.';
    return false;
  }
  if(file.size > 5*1024*1024){ err.textContent='Immagine troppo pesante (>5MB).'; return false; }

  const occRes = collectOcc();
  if(!occRes.ok){ err.textContent = occRes.msg; return false; }
  const occ = occRes.occ;

  document.getElementById('pv_titolo').textContent = titolo;
  document.getElementById('pv_cats').textContent = categorie.join(', ');
  document.getElementById('pv_prezzo').textContent = el('prezzo').value || '—';
  document.getElementById('pv_contatto').textContent = el('contatto').value || '—';
  document.getElementById('pv_occ').textContent = `${occ.length} occorrenza/e`;
  document.getElementById('pv_descr').textContent = descr;
  const list = document.getElementById('pv_list');
  list.innerHTML = '<div class="small"><b>Dettaglio occorrenze</b></div>';
  const ul = document.createElement('ul'); ul.style.marginTop='6px';
  occ.forEach(o=>{
    const li = document.createElement('li');
    li.textContent = `${o.data} ore ${o.ora} — ${o.luogo}, ${o.indirizzo}, ${o.citta}`;
    ul.appendChild(li);
  });
  list.appendChild(ul);

  document.getElementById('preview').style.display='block';
  return true;
}

document.getElementById('anteprimaBtn').addEventListener('click', ()=>{
  if(validateAndPreview()){
    window.scrollTo({top: document.getElementById('preview').offsetTop - 10, behavior:'smooth'});
  }
});

document.getElementById('confermaFooterBtn').addEventListener('click', ()=>{
  if(validateAndPreview()){
    alert('Qui collegheremo Stripe (pagamento) e poi pubblicazione automatica.');
  }
});

document.getElementById('azzeraBtn').addEventListener('click', ()=>{
  el('titolo').value=''; el('prezzo').value=''; el('contatto').value=''; el('descrizione').value=''; el('locandina').value='';
  categorie = []; renderCatBadges();
  modalDiv.querySelectorAll('.chip').forEach(ch => { ch.classList.remove('active'); ch.style.background='#17304d'; ch.style.color='#d7f2ff'; ch.style.borderColor='#2e6e8f'; });
  const occWrap = document.getElementById('occBlocks');
  occWrap.innerHTML = `
    <div class="occ">
      <div class="grid">
        <div>
          <label>Luogo/Nome locale*</label>
          <input class="luogo" placeholder="Es. Bar Centrale">
        </div>
        <div>
          <label>Indirizzo*</label>
          <input class="indirizzo" placeholder="Via Roma 1">
        </div>
      </div>
      <div class="grid">
        <div>
          <label>Città*</label>
          <input class="citta" placeholder="Es. Torino">
        </div>
        <div>
          <label>Data*</label>
          <input class="data" type="date">
        </div>
      </div>
      <div class="grid">
        <div>
          <label>Orario*</label>
          <input class="ora" type="time">
        </div>
      </div>
    </div>`;
  document.getElementById('preview').style.display='none';
  document.getElementById('pv_list').innerHTML='';
  err.textContent='';
  window.scrollTo({top:0, behavior:'smooth'});
});

document.getElementById('confermaBtn').addEventListener('click', (e)=>{
  e.preventDefault();
  alert('Qui collegheremo Stripe (pagamento) + pubblicazione automatica.');
});
</script>
</body>
</html>
