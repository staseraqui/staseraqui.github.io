<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>stasera qui</title>
<link rel="icon" href="/favicon.ico">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="assets/style.css?v=7">
<style>
  /* piccoli aiuti visivi */
  .tabs-top{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:8px 0 14px}
  .tabs-top .btn{font-weight:700}
  .claim{font-style:italic;text-align:center;margin:6px 0 8px;font-weight:700}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .row input[type="date"]{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#fff;color:#081421}
  .counter-wrap{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:10px 0}
  .list-btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#ffcc00;color:#081421;font-weight:700}
  .map{height:500px;border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.1);margin:10px 0 16px}
  .pill, .chip{cursor:pointer}
  .pill.active, .chip.active{outline:2px solid #ffcc00}
  .cta.primary{background:#ffcc00;color:#081421;font-weight:800}
  .cta.accent{background:#22b3f0;color:#081421;font-weight:800}
  .gmap-pop h3{margin:0 0 6px;font-size:16px}
  .gmap-pop .small{font-size:13px;color:#cfe2f2}
</style>
</head>
<body>
<header class="header" style="padding:10px 16px">
  <!-- LOGO approvato: pin + wordmark, claim separato -->
  <div style="display:flex;align-items:center;gap:10px">
    <img src="assets/logo_lockup_dark_v4.svg" alt="stasera qui" style="height:56px">
  </div>
</header>

<main class="container">
  <div class="claim">Scopri cosa fare, dove vuoi, quando vuoi</div>

  <!-- Tabs info -->
  <div class="tabs-top">
    <a class="btn" href="mission.html">Mission</a>
    <a class="btn" href="chi-siamo.html">Chi siamo</a>
    <a class="btn" href="contatti.html">Contatti</a>
    <a class="btn" href="come-funziona.html">Come funziona</a>
  </div>

  <!-- Ricerca -->
  <div class="search">
    <input id="searchInput" placeholder="Cerca città, zona o evento… (facoltativo)">
  </div>

  <!-- Giorni -->
  <div class="pills" id="dayPills">
    <div class="pill" data-day="oggi">Oggi</div>
    <div class="pill" data-day="domani">Domani</div>
    <div class="pill" data-day="weekend">Weekend</div>
    <div class="pill" id="pickDate">Seleziona data</div>
    <input type="date" id="dateField" style="display:none">
  </div>

  <!-- Categorie -->
  <div class="chips" id="chips">
    <div class="chip" data-cat="Musica">Musica</div>
    <div class="chip" data-cat="Food & Drink">Food & Drink</div>
    <div class="chip" data-cat="Sagre & Fiere">Sagre & Fiere</div>
    <div class="chip" data-cat="Famiglie & Bambini">Famiglie & Bambini</div>
    <div class="chip" data-cat="Sport">Sport</div>
    <div class="chip" data-cat="Nightlife">Nightlife</div>
    <div class="chip" data-cat="Cultura/Spettacolo">Cultura/Spettacolo</div>
    <div class="chip" data-cat="Mercatini">Mercatini</div>
  </div>

  <!-- Contatore + lista -->
  <div class="counter-wrap">
    <div id="counter" class="small">0 eventi visibili sulla mappa</div>
    <button id="showList" class="list-btn">Mostra lista eventi visibili</button>
  </div>

  <!-- MAPPA -->
  <div id="map" class="map"></div>

  <!-- CTA -->
  <div class="cta-row">
    <a class="cta primary" href="pubblica-evento.html">Pubblica evento</a>
    <a class="cta accent"  href="lavora-con-noi.html">Lavora con noi</a>
  </div>

  <div class="footer small">
    © <span id="year"></span> Stasera Qui
  </div>
</main>

<script src="assets/app-config.js?v=7"></script>
<script src="https://esm.sh/@supabase/supabase-js@2"></script>
<script>
  // ======= Config da app-config.js =======
  const SUPABASE_URL = window.SQ?.https://rubdzlnolxcgpjklfggk.supabase.co;
  const SUPABASE_ANON_KEY = window.SQ?.eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1YmR6bG5vbHhjZ3Bqa2xmZ2drIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4OTI3NjQsImV4cCI6MjA3MjQ2ODc2NH0.Fhq7lKdx1OcyuCWOnHqNH7Omsg7qjdQVzxvNqZyeQQ8;
  const GMAPS_KEY = window.SQ?.AIzaSyCfLAJyhmA_lu6jP0Y1GbgVTvSn2nIICsg;

  // ======= Helpers =======
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const todayISO  = () => new Date().toISOString().slice(0,10);
  const addDays = (d, n) => { const x=new Date(d); x.setDate(x.getDate()+n); return x.toISOString().slice(0,10); }
  const weekendRange = () => {
    const d = new Date(), day = d.getDay(); // 0 dom -> 6 sab
    const sat = new Date(d); sat.setDate(d.getDate() + ((6-day+7)%7));
    const sun = new Date(sat); sun.setDate(sat.getDate()+1);
    const fmt = x => x.toISOString().slice(0,10);
    return {from:fmt(sat), to:fmt(sun)};
  };
  const normCats = c => {
    if (!c) return [];
    if (Array.isArray(c)) return c.map(s=>String(s).trim()).filter(Boolean);
    return String(c).split('|').map(s=>s.trim()).filter(Boolean);
  };

  // ======= Stato filtri =======
  let selDate = null; // YYYY-MM-DD (selezionata) oppure null
  let selCats = new Set(); // categorie attive

  // ======= Google Maps =======
  let map, markers = [], dirRenderer=null, dirService=null;

  function setCounter(n){ $('#counter').textContent = `${n} eventi visibili sulla mappa`; }

  function clearMarkers(){
    markers.forEach(m => m.setMap(null));
    markers = [];
    if (dirRenderer) { dirRenderer.setMap(null); dirRenderer = null; }
  }

  function fitIfNeeded(){
    if (!markers.length) return;
    const bounds = new google.maps.LatLngBounds();
    markers.forEach(m => bounds.extend(m.getPosition()));
    map.fitBounds(bounds, 60);
  }

  function addMarker(ev, occ){
    const pos = {lat: occ.lat, lng: occ.lng};
    const icon = {
      url: 'assets/pin_azzurro.svg',
      scaledSize: new google.maps.Size(32, 40),
      anchor: new google.maps.Point(16, 40)
    };
    const m = new google.maps.Marker({position:pos, map, icon});
    const cats = normCats(ev.categories).join(', ');
    const html = `
      <div class="gmap-pop">
        <h3>${ev.title}</h3>
        <div class="small">${occ.date} ore ${occ.time} — ${occ.venue}, ${occ.address}, ${occ.city}</div>
        <div class="small">Categorie: ${cats || '—'} · ${ev.price_text || ''}</div>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          <a class="btn" target="_blank" href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(occ.venue+', '+occ.address+', '+occ.city)}">Apri in Google Maps</a>
          <a class="btn" target="_blank" href="${ev.image_url}">Apri locandina</a>
        </div>
      </div>`;
    const info = new google.maps.InfoWindow({content: html});
    m.addListener('click', ()=> info.open({anchor:m, map}));
    markers.push(m);
  }

  // ======= Caricamento dati dal DB (no view) =======
  async function loadAndRender(){
    clearMarkers();

    // 1) Date range
    let from = todayISO(), to = todayISO();
    const active = $('.pill.active')?.dataset.day;
    if (active === 'domani'){ from = to = addDays(todayISO(), 1); }
    else if (active === 'weekend'){ const r=weekendRange(); from=r.from; to=r.to; }
    else if (selDate){ from = to = selDate; }

    // 2) Query occurrences nel range
    const { data: occ, error: errO } = await sb
      .from('occurrences')
      .select('*')
      .gte('date', from)
      .lte('date', to)
      .order('date', {ascending:true})
      .limit(2000);

    if (errO){ console.error('occ error', errO); setCounter(0); return; }
    if (!occ?.length){ setCounter(0); return; }

    // 3) Prendi gli eventi collegati
    const ids = [...new Set(occ.map(o=>o.event_id))];
    const { data: evs, error: errE } = await sb
      .from('events')
      .select('id,title,description,image_url,price_text,categories,published')
      .in('id', ids)
      .eq('published', true);

    if (errE){ console.error('events error', errE); setCounter(0); return; }
    const byId = new Map(evs.map(e => [e.id, e]));

    // 4) Applica filtri categoria / ricerca
    const activeCats = [...selCats];
    const q = ($('#searchInput').value||'').trim().toLowerCase();

    const filtered = occ.filter(o=>{
      const ev = byId.get(o.event_id); if (!ev) return false;
      // categorie
      if (activeCats.length){
        const evCats = normCats(ev.categories).map(s=>s.toLowerCase());
        const hit = activeCats.some(c => evCats.includes(c.toLowerCase()));
        if (!hit) return false;
      }
      // ricerca
      if (q){
        const hay = (ev.title+' '+ev.description+' '+o.venue+' '+o.address+' '+o.city).toLowerCase();
        if (!hay.includes(q)) return false;
      }
      return true;
    });

    // 5) Render pin in viewport (tutti; puoi filtrare per bounds se vuoi)
    filtered.forEach(o => {
      const ev = byId.get(o.event_id);
      if (!ev) return;
      if (typeof o.lat !== 'number' || typeof o.lng !== 'number') return;
      addMarker(ev, o);
    });

    setCounter(filtered.length);
    if (filtered.length) fitIfNeeded();
  }

  // ======= UI bindings =======
  $$('#chips .chip').forEach(ch=>{
    ch.addEventListener('click', ()=>{
      ch.classList.toggle('active');
      const c = ch.dataset.cat;
      if (ch.classList.contains('active')) selCats.add(c); else selCats.delete(c);
      loadAndRender();
    });
  });

  $$('#dayPills .pill').forEach(p=>{
    p.addEventListener('click', ()=>{
      $$('#dayPills .pill').forEach(x=>x.classList.remove('active'));
      p.classList.add('active');
      selDate = null; $('#dateField').style.display='none';
      loadAndRender();
    });
  });

  $('#pickDate').addEventListener('click', ()=>{
    $('#dateField').style.display='inline-block';
    $('#dateField').showPicker?.();
  });
  $('#dateField').addEventListener('change', ()=>{
    selDate = $('#dateField').value || null;
    $$('#dayPills .pill').forEach(x=>x.classList.remove('active'));
    loadAndRender();
  });

  $('#searchInput').addEventListener('keydown', (e)=>{
    if (e.key === 'Enter'){ e.preventDefault(); loadAndRender(); }
  });

  $('#showList').addEventListener('click', ()=>{
    if (!markers.length) return;
    alert('Apri l’elenco in basso (funzione in arrivo): per ora usa i pin sulla mappa.');
  });

  // ======= Init Google Maps =======
  window.initMap = function(){
    map = new google.maps.Map(document.getElementById('map'), {
      center:{lat:45.0703,lng:7.6869}, zoom:12, mapTypeControl:false, streetViewControl:false
    });
    // geolocalizza se consentito
    if (navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        map.setCenter({lat:pos.coords.latitude, lng:pos.coords.longitude});
        map.setZoom(13);
      });
    }
    // default: Oggi attivo
    const first = document.querySelector('.pill[data-day="oggi"]');
    first?.classList.add('active');
    loadAndRender();
  }
</script>

<!-- Google Maps JS (key dal tuo app-config.js) -->
<script>
  if (!GMAPS_KEY) { console.error('Manca GOOGLE_MAPS_API_KEY in assets/app-config.js'); }
  else {
    const s = document.createElement('script');
    s.src = `https://maps.googleapis.com/maps/api/js?key=${GMAPS_KEY}&callback=initMap&libraries=geometry`;
    s.async = true; s.defer = true;
    document.body.appendChild(s);
  }
  document.getElementById('year').textContent = new Date().getFullYear();
</script>
</body>
</html>
