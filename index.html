<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>stasera qui</title>
<link rel="icon" href="/favicon.ico">
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="assets/style.css?v=3">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<!-- Supabase JS -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
  .claim{font-style:italic;font-weight:700;text-align:center;margin:8px 0 16px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:0 0 12px}
  .tab{background:#0f1c2d;border:1px solid rgba(255,255,255,.15);color:#fff;padding:8px 12px;border-radius:10px;font-weight:700}
  .pill{cursor:pointer}
  .chip{cursor:pointer}
  #dateBadge{padding:8px 12px;border-radius:10px;background:#111f31;border:1px solid rgba(255,255,255,.35);min-width:170px;display:inline-block;text-align:center}
  #counter{margin:8px 0 4px;color:#b8c2ce}
  #datePicker{position:relative;z-index:9999} /* per Mac/Safari */
  /* Pin colore brand */
  .sq-pin{color:var(--accent)}
  /* Bordi molto visibili per selezioni */
  .pill.active,.chip.active{outline:3px solid #ffd24d;box-shadow:0 0 0 3px rgba(255,210,77,.25)}
  /* Banner info percorso */
  #routeInfo{position:fixed;left:16px;right:16px;bottom:16px;background:#0f1c2d;border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:10px 12px;display:none;z-index:10000}
</style>
</head>
<body>
<header class="header" style="padding:0 16px">
  <!-- Logo bloccato -->
  <a href="index.html" class="logo">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true">
      <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/>
      <circle cx="32" cy="24" r="9" fill="#ffffff"/>
    </svg>
    <span class="wordmark">stasera qui</span>
  </a>
</header>

<main class="container">
  <!-- Claim centrato -->
  <div class="claim">Scopri cosa fare, dove vuoi, quando vuoi</div>

  <!-- Tabs info -->
  <div class="tabs">
    <a class="tab" href="mission.html">Mission</a>
    <a class="tab" href="chi-siamo.html">Chi siamo</a>
    <a class="tab" href="contatti.html">Contatti</a>
    <a class="tab" href="come-funziona.html">Come funziona</a>
  </div>

  <!-- Ricerca con bottone + geolocalizzazione -->
  <div class="search" style="gap:8px">
    <input placeholder="Cerca citt√†, zona o evento‚Ä¶ (digita e poi premi Cerca)" id="searchInput">
    <button class="btn" id="searchBtn" type="button">Cerca</button>
    <button class="btn" id="locBtn" type="button">üìç Usa la mia posizione</button>
  </div>

  <!-- Filtri temporali -->
  <div class="pills" id="dayPills" style="align-items:center">
    <div class="pill" data-day="oggi">Oggi</div>
    <div class="pill" data-day="domani">Domani</div>
    <div class="pill" data-day="weekend">Weekend</div>
    <div class="pill" id="selDataBtn">Seleziona data</div>
    <input type="date" id="datePicker" style="display:none">
    <span id="dateBadge" style="display:none"></span>
  </div>

  <!-- Filtri categorie -->
  <div class="chips" id="chips">
    <div class="chip" data-cat="Musica">Musica</div>
    <div class="chip" data-cat="Food & Drink">Food & Drink</div>
    <div class="chip" data-cat="Sagre & Fiere">Sagre & Fiere</div>
    <div class="chip" data-cat="Famiglie & Bambini">Famiglie & Bambini</div>
    <div class="chip" data-cat="Sport">Sport</div>
    <div class="chip" data-cat="Nightlife">Nightlife</div>
    <div class="chip" data-cat="Cultura/Spettacolo">Cultura/Spettacolo</div>
    <div class="chip" data-cat="Mercatini">Mercatini</div>
  </div>

  <!-- Contatore + lista -->
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <div id="counter" class="small">‚Äî</div>
    <button class="btn" id="listBtn" type="button">Mostra lista eventi visibili</button>
  </div>

  <!-- Mappa -->
  <div id="map" class="map"></div>

  <!-- CTA sotto mappa -->
  <div class="cta-row">
    <a class="cta primary" href="pubblica-evento.html">Pubblica evento</a>
    <a class="cta accent" href="lavora-con-noi.html">Lavora con noi</a>
  </div>
</main>

<!-- Banner percorso -->
<div id="routeInfo"></div>

<script>
  // ====== CONFIGURA SUPABASE (INCOLLA QUI I TUOI VALORI) ======
  const SB_URL  = 'https://rubdzlnolxcgpjklfggk.supabase.co';
  const SB_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1YmR6bG5vbHhjZ3Bqa2xmZ2drIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4OTI3NjQsImV4cCI6MjA3MjQ2ODc2NH0.Fhq7lKdx1OcyuCWOnHqNH7Omsg7qjdQVzxvNqZyeQQ8';
  const sb = supabase.createClient(SB_URL, SB_ANON);

  // ====== UTILI ======
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const fmtIT = (d) => { const [y,m,dd]=d.split('-'); return `${dd}/${m}/${y}`; };
  const weekday = (s) => (new Date(s+'T00:00:00')).getDay(); // 0 dom ... 6 sab
  const todayISO = () => new Date().toISOString().slice(0,10);
  const addDays  = (d,n) => { const x=new Date(d); x.setDate(x.getDate()+n); return x.toISOString().slice(0,10); };

  // ====== MAPPA (no bandierina, attribution minima) ======
  const map = L.map('map', { attributionControl:false }).setView([45.0703, 7.6869], 12);
  L.control.attribution({prefix:false}).addTo(map);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

  // Icona pin (colore brand)
  const pinIcon = L.divIcon({
    className: 'sq-pin',
    html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 72" width="28" height="32" style="display:block">
             <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="currentColor"/>
             <circle cx="32" cy="24" r="9" fill="#ffffff"/>
           </svg>`,
    iconSize:[28,32], iconAnchor:[14,32], popupAnchor:[0,-30]
  });

  // Geolocalizzazione con bottone esplicito (Safari/Mac a volte non mostra il prompt in automatico)
  function requestLocation(){
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(pos=>{
      map.setView([pos.coords.latitude, pos.coords.longitude], 13);
      L.circle([pos.coords.latitude, pos.coords.longitude], {radius: 200, color:'#22b3f0'}).addTo(map);
      ORIGIN = { lat: pos.coords.latitude, lng: pos.coords.longitude, label: 'Posizione attuale' };
    }, err=>{ console.log('geo error', err); });
  }
  $('#locBtn').addEventListener('click', requestLocation);
  // Prova comunque a richiedere all'avvio (se il browser lo consente)
  requestLocation();

  // ====== STATO DATI ======
  let EVENTS=[], OCCS=[], EVENTS_BY_ID=new Map();
  let markers=[];
  let state = { day:null, customDate:null, cats:new Set(), query:'' };
  let ROUTE_LAYER=null, ORIGIN=null;

  function clearMarkers(){ markers.forEach(m=>map.removeLayer(m)); markers=[]; }

  // Geocode indirizzo (per origine manuale o ricerca), via Nominatim
  async function geocodeAddr(addr){
    const url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(addr);
    const r = await fetch(url, {headers:{'Accept-Language':'it'}});
    const j = await r.json();
    if (!j || !j.length) return null;
    return { lat: parseFloat(j[0].lat), lng: parseFloat(j[0].lon), label: j[0].display_name };
  }

  // Routing OSRM (distanza/tempo + polyline)
  async function drawRoute(from, to){
    if (!from || !to) return;
    // Pulisci eventuale route precedente
    if (ROUTE_LAYER){ map.removeLayer(ROUTE_LAYER); ROUTE_LAYER=null; }

    const url = `https://router.project-osrm.org/route/v1/driving/${from.lng},${from.lat};${to.lng},${to.lat}?overview=full&geometries=geojson`;
    const r = await fetch(url); const j = await r.json();
    if (!j || !j.routes || !j.routes.length) return;

    const route = j.routes[0];
    const distKm = (route.distance/1000).toFixed(1);
    const durMin = Math.round(route.duration/60);

    ROUTE_LAYER = L.geoJSON(route.geometry, { style:{ color:'#22b3f0', weight:5, opacity:0.9 } }).addTo(map);
    map.fitBounds(ROUTE_LAYER.getBounds(), {padding:[40,40]});

    const info = $('#routeInfo');
    info.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <div>
          <b>Percorso</b> ‚Äî <span class="small">${from.label || 'Origine'} ‚Üí ${to.label || 'Destinazione'}</span><br>
          Distanza: <b>${distKm} km</b> ¬∑ Tempo stimato: <b>${durMin} min</b>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn" id="chiudiRoute">Chiudi percorso</button>
          <a class="btn" target="_blank" rel="noopener"
             href="https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(from.lat+','+from.lng)}&destination=${encodeURIComponent(to.lat+','+to.lng)}&travelmode=driving">Apri in Google Maps</a>
        </div>
      </div>`;
    info.style.display='block';
    $('#chiudiRoute').onclick = ()=>{ if(ROUTE_LAYER){map.removeLayer(ROUTE_LAYER); ROUTE_LAYER=null;} info.style.display='none'; };
  }

  // Cerca SOLO quando premi il bottone (o ENTER)
  $('#searchBtn').addEventListener('click', async ()=>{
    const q = ($('#searchInput').value||'').trim();
    state.query = q;
    if (q){
      // se √® un indirizzo/luogo, prova a centrare mappa
      const g = await geocodeAddr(q);
      if (g){ map.setView([g.lat, g.lng], 13); }
    }
    renderMarkers();
  });
  $('#searchInput').addEventListener('keydown',(e)=>{ if(e.key==='Enter') $('#searchBtn').click(); });

  // Data badge helper
  function setDateBadgeISO(d1, d2){
    $('#dateBadge').style.display='inline-block';
    $('#dateBadge').textContent = d2 ? `${fmtIT(d1)} - ${fmtIT(d2)}` : fmtIT(d1);
  }

  // Pills giorno + Seleziona data
  $$('#dayPills .pill').forEach(p => p.addEventListener('click', ()=>{
    const k = p.getAttribute('data-day');
    if (!k) return;
    state.day = k; state.customDate=null;

    const t = todayISO();
    if (k==='oggi'){ setDateBadgeISO(t); }
    if (k==='domani'){ setDateBadgeISO(addDays(t,1)); }
    if (k==='weekend'){
      // trova sabato e domenica della settimana corrente
      const now = new Date(); const day = now.getDay(); // 0 dom .. 6 sab
      const daysToSat = (6 - day + 7) % 7;  // quanti giorni a sabato
      const daysToSun = (7 - day + 7) % 7;  // quanti giorni a domenica
      const sat = addDays(todayISO(), daysToSat);
      const sun = addDays(todayISO(), daysToSun);
      setDateBadgeISO(sat, sun);
    }
    renderMarkers();
  }));

  $('#selDataBtn').addEventListener('click', ()=>{
    const dp = $('#datePicker');
    dp.showPicker ? dp.showPicker() : dp.click();
  });
  $('#datePicker').addEventListener('change', (e)=>{
    state.customDate = e.target.value || null;
    state.day = null;
    if (state.customDate){ setDateBadgeISO(state.customDate); }
    else { $('#dateBadge').style.display='none'; }
    renderMarkers();
  });

  // Lista eventi visibili (modal semplice)
  $('#listBtn').addEventListener('click', ()=>{
    const b = map.getBounds();
    const occs = OCCS.filter(o => o.lat!=null && o.lng!=null && b.contains([o.lat,o.lng]) && occPassesFilters(o));
    if (!occs.length){ alert('Nessun evento visibile nell‚Äôarea attuale.'); return; }
    // ordina per data/ora
    occs.sort((a,b)=> (a.data+b.ora).localeCompare(b.data+b.ora));
    const rows = occs.map(o=>{
      const ev = EVENTS_BY_ID.get(o.event_id)||{};
      const title = ev.title||ev.titolo||'(evento)';
      const when = `${fmtIT(o.data)} ore ${o.ora||''}`;
      const where = `${o.luogo||''}, ${o.indirizzo||''}, ${o.citta||''}`;
      return `‚Ä¢ ${title} ‚Äî ${when} ‚Äî ${where}`;
    }).join('\n');
    alert('Eventi visibili:\n\n'+rows);
  });

  // Filtri categorie (multi)
  $$('#chips .chip').forEach(ch => ch.addEventListener('click', ()=>{
    ch.classList.toggle('active');
    const c = ch.getAttribute('data-cat');
    if (ch.classList.contains('active')) state.cats.add(c);
    else state.cats.delete(c);
    renderMarkers();
  }));

  // ====== LOGICA FILTRI ======
  function occPassesFilters(occ){
    // Giorni
    if (state.day === 'oggi'){ if (occ.data !== todayISO()) return false; }
    if (state.day === 'domani'){ if (occ.data !== addDays(todayISO(),1)) return false; }
    if (state.day === 'weekend'){ const w = weekday(occ.data); if (![5,6,0].includes(w)) return false; }
    if (state.customDate){ if (occ.data !== state.customDate) return false; }

    // Categorie sull'evento
    if (state.cats.size>0){
      const ev = EVENTS_BY_ID.get(occ.event_id);
      const evCats = (ev?.categories || ev?.categorie || []);
      if (!evCats.some(c=>state.cats.has(c))) return false;
    }

    // Testo (solo al click su Cerca)
    const q = (state.query||'').toLowerCase();
    if (q){
      const ev = EVENTS_BY_ID.get(occ.event_id)||{};
      const text = [ev.title||ev.titolo||'', occ.luogo||'', occ.indirizzo||'', occ.citta||''].join(' ').toLowerCase();
      if (!text.includes(q)) return false;
    }

    return true;
  }

  function updateCounter(){
    const b = map.getBounds();
    const count = OCCS.filter(o => o.lat!=null && o.lng!=null && b.contains([o.lat,o.lng]) && occPassesFilters(o)).length;
    $('#counter').textContent = count===1 ? '1 evento visibile sulla mappa' : `${count} eventi visibili sulla mappa`;
    // NIENTE pi√π popup automatico quando 0
  }

  function renderMarkers(){
    clearMarkers();
    const b = map.getBounds();
    OCCS.forEach(occ=>{
      if (occ.lat==null || occ.lng==null) return;
      if (!b.contains([occ.lat, occ.lng])) return;
      if (!occPassesFilters(occ)) return;

      const ev = EVENTS_BY_ID.get(occ.event_id)||{};
      const title = ev.title||ev.titolo||'(evento)';
      const cats  = (ev.categories||ev.categorie||[]).join(', ');
      const when  = `${fmtIT(occ.data)} ore ${occ.ora||''}`;
      const where = `${occ.luogo||''}, ${occ.indirizzo||''}, ${occ.citta||''}`;
      const descr = ev.description||ev.descrizione||'';
      const poster = ev.locandina_url ? `<br><a class="btn" target="_blank" rel="noopener" href="${ev.locandina_url}">Apri locandina</a>` : '';

      // Contatti (mostra solo se disponibili: richiede che li salviamo su events in futuro)
      let contattiHTML = '';
      if (Array.isArray(ev.contacts) && ev.contacts.length){
        contattiHTML = '<br><b>Contatti:</b><br>' + ev.contacts.map(c=>`${c.name||''} ${c.phone||''}`).join('<br>');
      }

      const m = L.marker([occ.lat,occ.lng],{icon:pinIcon}).addTo(map);
      m.bindPopup(
        `<b>${title}</b><br><small>${cats}</small><br>${when}<br>${where}` +
        (descr? `<br><br>${descr}` : '') +
        contattiHTML +
        `<br><br><button class="btn" data-calc="1">Calcola percorso</button>${poster}`
      ).on('popupopen', ()=>{
        const btn = document.querySelector('button[data-calc="1"]');
        if (btn){
          btn.onclick = async ()=>{
            if (!ORIGIN){
              const inp = prompt('Origine non impostata. Scrivi un indirizzo di partenza (oppure premi Annulla per usare Google Maps):');
              if (inp){
                const g = await geocodeAddr(inp);
                if (!g){ alert('Indirizzo di partenza non trovato.'); return; }
                ORIGIN = { lat:g.lat, lng:g.lng, label: g.label };
              }
            }
            const dest = { lat: occ.lat, lng: occ.lng, label: where };
            if (ORIGIN) await drawRoute(ORIGIN, dest);
            else window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest.lat+','+dest.lng)}&travelmode=driving`, '_blank');
          };
        }
      });
      markers.push(m);
    });
    updateCounter();
  }

  // Aggiornamenti mappa
  map.on('moveend', renderMarkers);
  map.on('zoomend', renderMarkers);

  // ====== CARICAMENTO DATI ======
  async function loadData(){
    // Eventi (aggiungo descrizione; in futuro potremo aggiungere ev.contacts se la salviamo)
    const { data: evs, error: e1 } = await sb
      .from('events')
      .select('id, title, titolo, description, descrizione, categories, categorie, locandina_url');
    if (e1) { console.error('events error', e1); return; }
    EVENTS = evs||[];
    EVENTS_BY_ID = new Map(EVENTS.map(e=>[e.id,e]));

    // Occorrenze
    const { data: occs, error: e2 } = await sb
      .from('occurrences')
      .select('id, event_id, lat, lng, data, ora, luogo, indirizzo, citta');
    if (e2) { console.error('occurrences error', e2); return; }
    OCCS = (occs||[]).filter(o=>o.lat!=null && o.lng!=null);

    renderMarkers();
  }
  loadData();
</script>
</body>
</html>
