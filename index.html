<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>stasera qui</title>
<link rel="icon" href="/favicon.ico">

<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="assets/style.css?v=10">

<!-- Leaflet (fallback se NON usi Google Maps) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<!-- Supabase JS -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
  .claim{font-style:italic;font-weight:700;text-align:center;margin:8px 0 16px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:0 0 12px}
  .tab{background:#0f1c2d;border:1px solid rgba(255,255,255,.15);color:#fff;padding:8px 12px;border-radius:10px;font-weight:700}
  .pill{cursor:pointer}
  .chip{cursor:pointer}
  #dateBadge{padding:8px 12px;border-radius:10px;background:#111f31;border:1px solid rgba(255,255,255,.35);min-width:170px;display:inline-block;text-align:center}
  #counter{margin:8px 0 4px;color:#b8c2ce}
  .sq-pin{color:var(--accent)}
  .pill.active,.chip.active{outline:3px solid #ffd24d;box-shadow:0 0 0 3px rgba(255,210,77,.25)}
  #routeInfo{position:fixed;left:16px;right:16px;bottom:16px;background:#0f1c2d;border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:10px 12px;display:none;z-index:10000}
  .popup-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}

  /* Datepicker overlay */
  #dpOverlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:flex-start;justify-content:center;z-index:9999}
  #dpBox{margin-top:80px;background:#0f1c2d;border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:14px}
  #dpInput{font-size:17px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:#fff;color:#081421}
  #dpBtns{display:flex;gap:8px;margin-top:10px;justify-content:flex-end}
</style>
</head>
<body>
<header class="header" style="padding:0 16px">
  <!-- Logo approvato -->
  <a href="index.html" class="logo">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true">
      <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/>
      <circle cx="32" cy="24" r="9" fill="#ffffff"/>
    </svg>
    <span class="wordmark">stasera qui</span>
  </a>
</header>

<main class="container">
  <!-- Claim -->
  <div class="claim">Scopri cosa fare, dove vuoi, quando vuoi</div>

  <!-- Tabs -->
  <div class="tabs">
    <a class="tab" href="mission.html">Mission</a>
    <a class="tab" href="chi-siamo.html">Chi siamo</a>
    <a class="tab" href="contatti.html">Contatti</a>
    <a class="tab" href="come-funziona.html">Come funziona</a>
  </div>

  <!-- Ricerca -->
  <div class="search" style="gap:8px">
    <input placeholder="Cerca citt√†, zona o evento‚Ä¶ (digita e poi premi Cerca)" id="searchInput" autocomplete="off">
    <button class="btn" id="searchBtn" type="button">Cerca</button>
    <button class="btn" id="locBtn" type="button">üìç Usa la mia posizione</button>
    <button class="btn" id="resetOriginBtn" type="button">üóò Reset posizione</button>
  </div>

  <!-- Filtri temporali -->
  <div class="pills" id="dayPills" style="align-items:center;gap:8px;flex-wrap:wrap">
    <div class="pill" data-day="oggi">Oggi</div>
    <div class="pill" data-day="domani">Domani</div>
    <div class="pill" data-day="weekend">Weekend</div>
    <div class="pill" id="selDataBtn">Seleziona data</div>
    <span id="dateBadge" style="display:none"></span>
  </div>

  <!-- Filtri categorie -->
  <div class="chips" id="chips">
    <div class="chip" data-cat="Musica">Musica</div>
    <div class="chip" data-cat="Food & Drink">Food & Drink</div>
    <div class="chip" data-cat="Sagre & Fiere">Sagre & Fiere</div>
    <div class="chip" data-cat="Famiglie & Bambini">Famiglie & Bambini</div>
    <div class="chip" data-cat="Sport">Sport</div>
    <div class="chip" data-cat="Nightlife">Nightlife</div>
    <div class="chip" data-cat="Cultura/Spettacolo">Cultura/Spettacolo</div>
    <div class="chip" data-cat="Mercatini">Mercatini</div>
  </div>

  <!-- Contatore + lista -->
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <div id="counter" class="small">‚Äî</div>
    <button class="btn light" id="listBtn" type="button">Mostra lista eventi visibili</button>
  </div>

  <!-- Mappa -->
  <div id="map" class="map"></div>

  <!-- CTA -->
  <div class="cta-row">
    <a class="cta primary" href="pubblica-evento.html">Pubblica evento</a>
    <a class="cta accent" href="lavora-con-noi.html">Lavora con noi</a>
  </div>
</main>

<!-- Banner percorso -->
<div id="routeInfo"></div>

<!-- Datepicker overlay -->
<div id="dpOverlay">
  <div id="dpBox">
    <input type="date" id="dpInput">
    <div id="dpBtns">
      <button class="btn" id="dpAnnulla" type="button">Annulla</button>
    </div>
  </div>
</div>

<script>
  // ====== CONFIG ======
  const SB_URL  = 'https://rubdzlnolxcgpjklfggk.supabase.co';
  const SB_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1YmR6bG5vbHhjZ3Bqa2xmZ2drIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4OTI3NjQsImV4cCI6MjA3MjQ2ODc2NH0.Fhq7lKdx1OcyuCWOnHqNH7Omsg7qjdQVzxvNqZyeQQ8';
  const GMAPS_API_KEY = 'AIzaSyCfLAJyhmA_lu6jP0Y1GbgVTvSn2nIICsg'; // tua chiave

  const sb = supabase.createClient(SB_URL, SB_ANON);

  const hasGoogleKey = GMAPS_API_KEY && !/^INSERISCI_/.test(GMAPS_API_KEY);
  let USE_GMAPS = false;

  let GMAPS = { map:null, infowindow:null, directionsService:null, directionsRenderer:null, geocoder:null };
  let LEAF = { map:null, pinIcon:null, routeLayer:null };

  let EVENTS=[], OCCS=[], EVENTS_BY_ID=new Map(), markers=[];
  let state = { day:null, customDate:null, cats:new Set(), query:'' };
  let ORIGIN = null;

  // una sola volta, per auto-fit quando non si vede nulla
  let _refitTried = false;

  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const fmtIT = (d) => { const [y,m,dd]=d.split('-'); return `${dd}/${m}/${y}`; };
  const todayISO = () => new Date().toISOString().slice(0,10);
  const addDays  = (d,n) => { const x=new Date(d); x.setDate(x.getDate()+n); return x.toISOString().slice(0,10); };
  const weekday  = s => (new Date(s+'T00:00:00')).getDay();

  // ====== MAPPA: bootstrap ======
  (function setupMap(){
    if (hasGoogleKey){
      USE_GMAPS = true;
      const s = document.createElement('script');
      s.src = `https://maps.googleapis.com/maps/api/js?key=${GMAPS_API_KEY}&libraries=geometry&callback=initGoogleMap`;
      s.async = true; s.defer = true;
      s.onerror = ()=>{ console.warn('Caricamento Google Maps fallito. Uso OSM.'); USE_GMAPS=false; initLeafletMap(); };
      document.head.appendChild(s);
      setTimeout(()=>{ if(!GMAPS.map){ console.warn('Timeout Google Maps ‚Üí uso OSM'); USE_GMAPS=false; initLeafletMap(); }}, 4000);
    } else {
      initLeafletMap();
    }
  })();

  // ====== GOOGLE MAPS ======
  window.initGoogleMap = function(){
    GMAPS.map = new google.maps.Map(document.getElementById('map'), {
      center:{lat:45.0703, lng:7.6869}, zoom:12, mapTypeControl:false, streetViewControl:false
    });
    GMAPS.infowindow = new google.maps.InfoWindow();
    GMAPS.directionsService = new google.maps.DirectionsService();
    GMAPS.directionsRenderer = new google.maps.DirectionsRenderer({suppressMarkers:true, preserveViewport:false});
    GMAPS.directionsRenderer.setMap(GMAPS.map);
    GMAPS.geocoder = new google.maps.Geocoder();

    GMAPS.map.addListener('dragend', renderMarkers);
    GMAPS.map.addListener('zoom_changed', renderMarkers);

    loadData();
  };

  function gAddMarker(occ, ev){
    const where = `${occ.luogo||''}, ${occ.indirizzo||''}, ${occ.citta||''}`;
    const when  = `${fmtIT(occ.data)} ore ${occ.ora||''}`;
    const cats  = (ev.categories||ev.categorie||[]).join(', ');
    const descr = ev.description||ev.descrizione||'';

    // Poster: giallo
    const posterHTML = ev.locandina_url
      ? `<a class="btn primary" target="_blank" rel="noopener" href="${ev.locandina_url}">Apri locandina</a>`
      : '';

    const m = new google.maps.Marker({
      position:{lat:occ.lat, lng:occ.lng},
      map: GMAPS.map,
      icon: {
        path: 'M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z',
        anchor: new google.maps.Point(32,64),
        fillColor:'#22b3f0', fillOpacity:1,
        strokeColor:'#ffffff', strokeWeight:3,
        scale:0.85
      }
    });

    const html = `
      <div style="color:#081421;max-width:300px">
        <b>${ev.title||ev.titolo||'(evento)'}</b><br>
        <small>${cats||''}</small><br>
        ${when}<br>${where}
        ${descr? `<br><br>${descr}`:''}
        <div class="popup-actions" style="margin-top:10px">
          <button class="btn accent" data-calc="1">Calcola percorso</button>
          ${posterHTML}
        </div>
      </div>`;

    m.addListener('click', ()=>{
      GMAPS.infowindow.setContent(html);
      GMAPS.infowindow.open(GMAPS.map, m);
      setTimeout(()=>{
        const btn=document.querySelector('button[data-calc="1"]');
        if(btn){ btn.onclick = ()=> routeTo({lat:occ.lat,lng:occ.lng,label:where}); }
      },0);
    });
    markers.push(m);
  }

  function gClearMarkers(){
    markers.forEach(m=>m.setMap(null));
    markers=[];
  }

  function clearRoute(){
    if (USE_GMAPS){
      GMAPS.directionsRenderer.set('directions', null);
    } else if (LEAF.routeLayer){
      LEAF.map.removeLayer(LEAF.routeLayer); LEAF.routeLayer=null;
    }
    $('#routeInfo').style.display='none';
  }

  // forza nuova geolocalizzazione ogni volta (senza cache)
  function getFreshPosition(){
    return new Promise((resolve,reject)=>{
      if (!navigator.geolocation){ reject(new Error('Geolocalizzazione non disponibile')); return; }
      navigator.geolocation.getCurrentPosition(
        pos=> resolve({lat:pos.coords.latitude, lng:pos.coords.longitude, label:'Posizione attuale'}),
        err=> reject(new Error('Geolocalizzazione negata o non riuscita')),
        { enableHighAccuracy:true, maximumAge:0, timeout:10000 }
      );
    });
  }

  async function routeTo(dest){
    try{
      // Prova sempre a prendere la posizione corrente
      ORIGIN = await getFreshPosition();
      drawRouteGoogle(ORIGIN, dest);
    }catch(e){
      // Se fallisce: se c'√® una vecchia origine usala, altrimenti chiedi un indirizzo
      if (ORIGIN){
        drawRouteGoogle(ORIGIN, dest);
      } else {
        const ask = prompt('Origine non impostata. Scrivi un indirizzo di partenza (oppure lascia vuoto per aprire Google Maps):','');
        if (ask && ask.trim()){
          GMAPS.geocoder.geocode({address:ask.trim()}, (res, status)=>{
            if(status==='OK' && res[0]){
              ORIGIN = {lat:res[0].geometry.location.lat(), lng:res[0].geometry.location.lng(), label:res[0].formatted_address};
              drawRouteGoogle(ORIGIN, dest);
            } else {
              alert('Impossibile calcolare il percorso (status: '+status+'). Apro Google Maps.');
              window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest.lat+','+dest.lng)}&travelmode=driving`,'_blank');
            }
          });
        } else {
          window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest.lat+','+dest.lng)}&travelmode=driving`,'_blank');
        }
      }
    }
  }

  function drawRouteGoogle(from, to){
    GMAPS.directionsService.route({
      origin: new google.maps.LatLng(from.lat, from.lng),
      destination: new google.maps.LatLng(to.lat, to.lng),
      travelMode: google.maps.TravelMode.DRIVING
    }, (res, status)=>{
      if(status!=='OK'){
        alert('Impossibile calcolare il percorso (status: '+status+').');
        return;
      }
      GMAPS.directionsRenderer.setDirections(res);
      const leg = res.routes[0].legs[0];
      const dist = leg.distance.text, dur = leg.duration.text;
      GMAPS.map.fitBounds(res.routes[0].bounds);

      const info = $('#routeInfo');
      info.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
          <div><b>Percorso</b> ‚Äî <span class="small">${from.label||'Origine'} ‚Üí ${to.label||'Destinazione'}</span><br>
          Distanza: <b>${dist}</b> ¬∑ Tempo stimato: <b>${dur}</b></div>
          <div style="display:flex;gap:8px">
            <button class="btn" id="chiudiRoute">Chiudi percorso</button>
            <button class="btn" id="cambiaOrigine">Cambia origine</button>
            <a class="btn" target="_blank" rel="noopener"
               href="https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(from.lat+','+from.lng)}&destination=${encodeURIComponent(to.lat+','+to.lng)}&travelmode=driving">Apri in Google Maps</a>
          </div>
        </div>`;
      info.style.display='block';
      $('#chiudiRoute').onclick = ()=> clearRoute();
      $('#cambiaOrigine').onclick = ()=>{
        const ask = prompt('Nuova origine (indirizzo):', from.label||'');
        if (ask && ask.trim()){
          GMAPS.geocoder.geocode({address:ask.trim()}, (res2, status2)=>{
            if(status2==='OK' && res2[0]){
              ORIGIN = {lat:res2[0].geometry.location.lat(), lng:res2[0].geometry.location.lng(), label:res2[0].formatted_address};
              drawRouteGoogle(ORIGIN, to);
            } else { alert('Indirizzo non trovato.'); }
          });
        }
      };
    });
  }

  // ====== LEAFLET (fallback OSM) ======
  function initLeafletMap(){
    LEAF.map = L.map('map', { attributionControl:false }).setView([45.0703,7.6869],12);
    L.control.attribution({prefix:false}).addTo(LEAF.map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap contributors'}).addTo(LEAF.map);

    LEAF.pinIcon = L.divIcon({
      className:'sq-pin',
      html:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 72" width="30" height="34" style="display:block;filter:drop-shadow(0 0 2px #fff)">
              <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="currentColor" stroke="#ffffff" stroke-width="2"/>
              <circle cx="32" cy="24" r="9" fill="#ffffff"/></svg>`,
      iconSize:[30,34], iconAnchor:[15,34], popupAnchor:[0,-30]
    });

    LEAF.map.on('dragend', renderMarkers);
    LEAF.map.on('zoomend', renderMarkers);

    loadData();
  }

  function lAddMarker(occ, ev){
    const where = `${occ.luogo||''}, ${occ.indirizzo||''}, ${occ.citta||''}`;
    const when  = `${fmtIT(occ.data)} ore ${occ.ora||''}`;
    const cats  = (ev.categories||ev.categorie||[]).join(', ');
    const descr = ev.description||ev.descrizione||'';

    const posterHTML = ev.locandina_url
      ? `<a class="btn primary" target="_blank" rel="noopener" href="${ev.locandina_url}">Apri locandina</a>`
      : '';

    const m = L.marker([occ.lat,occ.lng],{icon:LEAF.pinIcon}).addTo(LEAF.map);
    const html = `<div style="color:#081421;max-width:300px">
      <b>${ev.title||ev.titolo||'(evento)'}</b><br>
      <small>${cats||''}</small><br>
      ${when}<br>${where}
      ${descr? `<br><br>${descr}`:''}
      <div class="popup-actions" style="margin-top:10px">
         <button class="btn accent" data-calc="1">Calcola percorso</button>
         ${posterHTML}
      </div>
    </div>`;
    m.bindPopup(html).on('popupopen', ()=>{
      const btn = document.querySelector('button[data-calc="1"]');
      if(btn){ btn.onclick = ()=> drawRouteLeaflet(ORIGIN, {lat:occ.lat,lng:occ.lng,label:where}); }
    });
    markers.push(m);
  }

  function lClearMarkers(){
    markers.forEach(m=>LEAF.map.removeLayer(m));
    markers=[];
  }

  async function geocodeAddrOSM(addr){
    const url = 'https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(addr);
    const r = await fetch(url, {headers:{'Accept-Language':'it'}});
    const j = await r.json(); if(!j||!j.length) return null;
    return {lat:parseFloat(j[0].lat), lng:parseFloat(j[0].lon), label:j[0].display_name};
  }

  async function drawRouteLeaflet(from, to){
    if (!from){
      try { from = await getFreshPosition(); ORIGIN = from; }
      catch(_){}
      if (!from){
        const ask = prompt('Origine non impostata. Scrivi un indirizzo di partenza:','Torino');
        if (!ask) return;
        const g = await geocodeAddrOSM(ask);
        if(!g){ alert('Indirizzo non trovato.'); return; }
        ORIGIN = from = {lat:g.lat, lng:g.lng, label:g.label};
      }
    }
    if (LEAF.routeLayer){ LEAF.map.removeLayer(LEAF.routeLayer); LEAF.routeLayer=null; }

    const url = `https://router.project-osrm.org/route/v1/driving/${from.lng},${from.lat};${to.lng},${to.lat}?overview=full&geometries=geojson`;
    const r = await fetch(url); const j = await r.json();
    if (!j || !j.routes || !j.routes.length){ alert('Impossibile calcolare il percorso.'); return; }
    const route = j.routes[0];
    LEAF.routeLayer = L.geoJSON(route.geometry, {style:{color:'#22b3f0',weight:5,opacity:0.9}}).addTo(LEAF.map);
    LEAF.map.fitBounds(LEAF.routeLayer.getBounds(), {padding:[40,40]});

    const km = (route.distance/1000).toFixed(1), min = Math.round(route.duration/60);
    const info = $('#routeInfo');
    info.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <div><b>Percorso</b> ‚Äî <span class="small">${from.label||'Origine'} ‚Üí ${to.label||'Destinazione'}</span><br>
        Distanza: <b>${km} km</b> ¬∑ Tempo stimato: <b>${min} min</b></div>
        <div style="display:flex;gap:8px">
          <button class="btn" id="chiudiRoute">Chiudi percorso</button>
          <button class="btn" id="cambiaOrigine">Cambia origine</button>
          <a class="btn" target="_blank" rel="noopener"
             href="https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(from.lat+','+from.lng)}&destination=${encodeURIComponent(to.lat+','+to.lng)}&travelmode=driving">Apri in Google Maps</a>
        </div>
      </div>`;
    info.style.display='block';
    $('#chiudiRoute').onclick = ()=> clearRoute();
    $('#cambiaOrigine').onclick = async ()=>{
      const ask = prompt('Nuova origine (indirizzo):', from.label||'');
      if(!ask) return;
      const g = await geocodeAddrOSM(ask);
      if(!g){ alert('Indirizzo non trovato.'); return; }
      ORIGIN = {lat:g.lat, lng:g.lng, label:g.label};
      drawRouteLeaflet(ORIGIN, to);
    };
  }

  // ====== DATEPICKER OVERLAY ======
  const dpOverlay = $('#dpOverlay'), dpInput = $('#dpInput');
  $('#selDataBtn').addEventListener('click', ()=>{
    dpInput.value = state.customDate || todayISO();
    dpOverlay.style.display='flex';
    setTimeout(()=>dpInput.focus(),0);
  });
  $('#dpAnnulla').addEventListener('click', ()=> dpOverlay.style.display='none');
  dpInput.addEventListener('change', ()=>{
    if (dpInput.value){
      state.customDate = dpInput.value;
      state.day = null;
      _refitTried = false;
      setDateBadgeISO(state.customDate);
      renderMarkers();
    }
    dpOverlay.style.display='none';
  });
  dpOverlay.addEventListener('click', (e)=>{ if(e.target===dpOverlay) dpOverlay.style.display='none'; });

  function setDateBadgeISO(d1, d2){
    $('#dateBadge').style.display='inline-block';
    $('#dateBadge').textContent = d2 ? `${fmtIT(d1)} - ${fmtIT(d2)}` : fmtIT(d1);
  }

  // Click su Oggi/Domani/Weekend
  $$('#dayPills .pill').forEach(p => p.addEventListener('click', ()=>{
    const k = p.getAttribute('data-day'); if(!k) return;
    state.day = k; state.customDate=null;
    _refitTried = false;
    const t = todayISO();
    if (k==='oggi')   setDateBadgeISO(t);
    if (k==='domani') setDateBadgeISO(addDays(t,1));
    if (k==='weekend'){
      const now=new Date(), d=now.getDay();
      const sat=addDays(t, (6-d+7)%7), sun=addDays(t, (7-d+7)%7);
      setDateBadgeISO(sat, sun);
    }
    renderMarkers();
  }));

  // Categorie
  $$('#chips .chip').forEach(ch => ch.addEventListener('click', ()=>{
    ch.classList.toggle('active');
    const c = ch.getAttribute('data-cat');
    if (ch.classList.contains('active')) state.cats.add(c); else state.cats.delete(c);
    _refitTried = false;
    renderMarkers();
  }));

  // Ricerca (solo su click o Invio)
  $('#searchBtn').addEventListener('click', async ()=>{
    state.query = ($('#searchInput').value||'').trim();
    _refitTried = false;
    if (state.query){
      if (USE_GMAPS){
        GMAPS.geocoder.geocode({address:state.query}, (res, status)=>{
          if(status==='OK' && res[0]) GMAPS.map.setCenter(res[0].geometry.location);
          renderMarkers();
        });
      } else {
        const g = await geocodeAddrOSM(state.query);
        if (g) LEAF.map.setView([g.lat, g.lng], 13);
        renderMarkers();
      }
    } else {
      renderMarkers();
    }
  });
  $('#searchInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') $('#searchBtn').click(); });

  // Geolocalizzazione bottoni
  $('#locBtn').addEventListener('click', async ()=>{
    try{
      ORIGIN = await getFreshPosition();
      if (USE_GMAPS) GMAPS.map.setCenter({lat:ORIGIN.lat, lng:ORIGIN.lng});
      else LEAF.map.setView([ORIGIN.lat, ORIGIN.lng], 13);
      _refitTried = false;
      renderMarkers();
    }catch(e){
      alert('Geolocalizzazione negata o non riuscita.');
    }
  });

  $('#resetOriginBtn').addEventListener('click', ()=>{
    ORIGIN = null;
    alert('Posizione azzerata. Alla prossima richiesta verr√† chiesta nuovamente.');
  });

  // ====== FILTRI LOGICA ======
  function occPassesFilters(occ){
    if (state.day==='oggi'   && occ.data!==todayISO()) return false;
    if (state.day==='domani' && occ.data!==addDays(todayISO(),1)) return false;
    if (state.day==='weekend'){ const w=weekday(occ.data); if (![5,6,0].includes(w)) return false; }
    if (state.customDate && occ.data!==state.customDate) return false;

    if (state.cats.size>0){
      const ev = EVENTS_BY_ID.get(occ.event_id);
      const evCats = (ev?.categories || ev?.categorie || []);
      if (!evCats.some(c=>state.cats.has(c))) return false;
    }

    const q = (state.query||'').toLowerCase();
    if (q){
      const ev = EVENTS_BY_ID.get(occ.event_id)||{};
      const text = [ev.title||ev.titolo||'', occ.luogo||'', occ.indirizzo||'', occ.citta||''].join(' ').toLowerCase();
      if (!text.includes(q)) return false;
    }
    return true;
  }

  function updateCounter(){
    const bounds = USE_GMAPS ? GMAPS.map.getBounds() : LEAF.map.getBounds();
    const contains = (lat,lng)=> USE_GMAPS ? bounds && bounds.contains(new google.maps.LatLng(lat,lng)) : bounds && bounds.contains([lat,lng]);
    const count = OCCS.filter(o => o.lat!=null && o.lng!=null && contains(o.lat,o.lng) && occPassesFilters(o)).length;
    $('#counter').textContent = count===1 ? '1 evento visibile sulla mappa' : `${count} eventi visibili sulla mappa`;
  }

  // Calcolo bounds globali (tutte le occorrenze)
  function computeAllBounds(){
    const pts = OCCS.filter(o => o.lat!=null && o.lng!=null);
    if (!pts.length) return null;

    if (USE_GMAPS){
      const b = new google.maps.LatLngBounds();
      pts.forEach(o => b.extend(new google.maps.LatLng(o.lat, o.lng)));
      return b;
    } else {
      return L.latLngBounds(pts.map(o => [o.lat, o.lng]));
    }
  }

  function renderMarkers(){
    if (USE_GMAPS){ gClearMarkers(); } else { lClearMarkers(); }

    const bounds = USE_GMAPS ? GMAPS.map.getBounds() : LEAF.map.getBounds();
    const contains = (lat,lng)=> USE_GMAPS
      ? bounds && bounds.contains(new google.maps.LatLng(lat,lng))
      : bounds && bounds.contains([lat,lng]);

    let rendered = 0;

    OCCS.forEach(occ=>{
      if (occ.lat==null || occ.lng==null) return;
      if (bounds && !contains(occ.lat,occ.lng)) return;
      if (!occPassesFilters(occ)) return;

      const ev = EVENTS_BY_ID.get(occ.event_id)||{};
      if (USE_GMAPS) gAddMarker(occ, ev); else lAddMarker(occ, ev);
      rendered++;
    });

    updateCounter();

    if (rendered===0 && !_refitTried && OCCS.length>0){
      const all = computeAllBounds();
      if (all){
        _refitTried = true;
        if (USE_GMAPS) GMAPS.map.fitBounds(all);
        else LEAF.map.fitBounds(all);
        setTimeout(renderMarkers, 80);
      }
    }
  }

  // Lista eventi visibili
  $('#listBtn').addEventListener('click', ()=>{
    const bounds = USE_GMAPS ? GMAPS.map.getBounds() : LEAF.map.getBounds();
    const contains = (lat,lng)=> USE_GMAPS ? bounds && bounds.contains(new google.maps.LatLng(lat,lng)) : bounds && bounds.contains([lat,lng]);
    const occs = OCCS.filter(o => o.lat!=null && o.lng!=null && contains(o.lat,o.lng) && occPassesFilters(o))
                     .sort((a,b)=> (a.data+a.ora).localeCompare(b.data+b.ora));
    if (!occs.length){ alert('Nessun evento visibile nell‚Äôarea attuale.'); return; }
    const rows = occs.map(o=>{
      const ev = EVENTS_BY_ID.get(o.event_id)||{};
      return `‚Ä¢ ${(ev.title||ev.titolo||'(evento)')} ‚Äî ${fmtIT(o.data)} ore ${o.ora||''} ‚Äî ${o.luogo||''}, ${o.indirizzo||''}, ${o.citta||''}`;
    }).join('\n');
    alert('Eventi visibili:\n\n'+rows);
  });

  // ====== DATI ======
  async function loadData(){
    // Eventi
    const { data: evs } = await sb.from('events')
      .select('id, title, titolo, description, descrizione, categories, categorie, locandina_url');
    EVENTS = evs||[];
    EVENTS_BY_ID = new Map(EVENTS.map(e=>[e.id,e]));

    // Occorrenze ‚Äî prendo sia i nomi ITA che ENG e poi normalizzo
    const { data: occsRaw } = await sb.from('occurrences')
      .select('id, event_id, lat, lng, data, date, ora, time, luogo, venue, indirizzo, address, citta, city');

    const norm = (occsRaw||[]).map(o => ({
      id: o.id,
      event_id: o.event_id,
      lat: o.lat,
      lng: o.lng,
      data: o.data || o.date || null,
      ora: o.ora || o.time || '',
      luogo: o.luogo || o.venue || '',
      indirizzo: o.indirizzo || o.address || '',
      citta: o.citta || o.city || ''
    }));

    OCCS = norm.filter(o => o.lat!=null && o.lng!=null);
    _refitTried = false;
    renderMarkers();
  }
</script>
</body>
</html>
