<!doctype html>
<html lang="it">
<head>
<!-- ===== FAVICONS & PWA (staseraqui.it) ===== -->
<link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png?v=2">
<link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png?v=2">
<link rel="shortcut icon" href="/icons/favicon.ico?v=2">

<!-- Apple iOS Home Screen -->
<link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-touch-icon-120x120.png?v=2">
<link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-touch-icon-152x152.png?v=2">
<link rel="apple-touch-icon" sizes="167x167" href="/icons/apple-touch-icon-167x167.png?v=2">
<link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon-180x180.png?v=2">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Stasera Qui">

<!-- Android / PWA -->
<link rel="manifest" href="/site.webmanifest?v=2">
<meta name="theme-color" content="#081623">

<!-- Windows -->
<meta name="msapplication-TileColor" content="#081623">

<!-- Safari pinned tab (macOS) -->
<link rel="mask-icon" href="/icons/safari-pinned-tab.svg?v=2" color="#1E88E5">
<!-- ===== /FAVICONS ===== -->  
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<!-- SEO base -->
<title>Stasera Qui ‚Äî Eventi oggi vicino a te</title>
<meta name="description" content="Scopri cosa fare stasera vicino a te: concerti, sagre, nightlife, sport, cultura e altro. Filtra per data e categoria, visualizza sulla mappa e calcola il percorso.">
<link rel="canonical" href="https://www.staseraqui.it/">
<meta name="robots" content="index,follow">

<!-- Open Graph (Facebook/WhatsApp) -->
<meta property="og:type" content="website">
<meta property="og:title" content="Stasera Qui ‚Äî Eventi oggi vicino a te">
<meta property="og:description" content="Concerti, sagre, nightlife, sport, cultura e altro. Filtra per data e categoria e vedi tutto sulla mappa.">
<meta property="og:url" content="https://www.staseraqui.it/">
<meta property="og:site_name" content="Stasera Qui">
<meta property="og:image" content="https://www.staseraqui.it/assets/social/share-default.jpg">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Stasera Qui ‚Äî Eventi oggi vicino a te">
<meta name="twitter:description" content="Concerti, sagre, nightlife, sport, cultura e altro. Filtra per data e categoria e vedi tutto sulla mappa.">
<meta name="twitter:image" content="https://www.staseraqui.it/assets/social/share-default.jpg">

<link rel="icon" href="/favicon.ico">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="assets/style.css?v=10">

<!-- Leaflet (ORA LOCALE) -->
<link rel="stylesheet" href="/assets/vendor/leaflet/leaflet.css"/>
<script src="/assets/vendor/leaflet/leaflet.js"></script>

<!-- Supabase JS (ORA LOCALE) -->
<script src="/assets/vendor/supabase/supabase.min.js"></script>

<style>
  .claim{font-style:italic;font-weight:700;text-align:center;margin:8px 0 16px;font-size:20px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:0 0 12px}
  .tab{background:#0f1c2d;border:1px solid rgba(255,255,255,.15);color:#fff;padding:8px 12px;border-radius:10px;font-weight:700}
  .pill{cursor:pointer}
  .chip{cursor:pointer}
  #dateBadge{padding:8px 12px;border-radius:10px;background:#111f31;border:1px solid rgba(255,255,255,.35);min-width:170px;display:inline-block;text-align:center}
  #counter{margin:8px 0 4px;color:#b8c2ce}
  .sq-pin{color:var(--accent)}
  .pill.active,.chip.active{outline:3px solid #ffd24d;box-shadow:0 0 0 3px rgba(255,210,77,.25)}
  #routeInfo{position:fixed;left:16px;right:16px;bottom:16px;background:#0f1c2d;border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:10px 12px;display:none;z-index:10000}
  .popup-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}

  /* Datepicker overlay */
  #dpOverlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:flex-start;justify-content:center;z-index:9999}
  #dpBox{margin-top:80px;background:#0f1c2d;border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:14px}
  #dpInput{font-size:17px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:#fff;color:#081421}
  #dpBtns{display:flex;gap:8px;margin-top:10px;justify-content:flex-end}

  /* Ricerca + bottoni compatti */
  .search{display:flex;gap:8px;flex-wrap:wrap;margin:14px 0 10px}
  .search input{flex:1;min-width:220px}
  .btn.small{padding:6px 8px;font-size:12px;line-height:1}
  @media (max-width:480px){
    .btn.small{padding:6px 7px;font-size:12px}
  }

  /* Overlay richiesta area iniziale (se geolocalizzazione negata) */
  #geoOverlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:10001}
  #geoBox{background:#0f1c2d;border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:16px;max-width:520px;width:92%}
  #geoBox h3{margin:0 0 8px}
  #geoAddr{width:100%;background:#fff;color:#081421;border:1px solid rgba(0,0,0,.2);border-radius:10px}
  #geoBtns{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

  /* Barra condividi */
  .share{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:12px 0}
.leaflet-popup-content .popup-actions .btn{display:inline-block}
.leaflet-popup-content a.btn{text-decoration:none}

  <style id="sq-case-fix">
  .leaflet-popup-content,
  .leaflet-popup-content *,
  .sq-popup,
  .sq-popup * { text-transform: none !important; }
</style>  
</style>

<!-- Dati strutturati: Organization -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "Stasera Qui",
  "url": "https://www.staseraqui.it/",
  "logo": "https://www.staseraqui.it/favicon.ico",
  "sameAs": []
}
</script>

<!-- Dati strutturati: WebSite con SearchAction -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "Stasera Qui",
  "url": "https://www.staseraqui.it/",
  "potentialAction": {
    "@type": "SearchAction",
    "target": "https://www.staseraqui.it/?q={search_term_string}",
    "query-input": "required name=search_term_string"
  }
}
</script>

<!-- ‚úÖ Cookie banner / GA dopo consenso -->
<script src="assets/cookie-consent.js" defer></script>
</head>
<body>
<header class="header">
  <!-- Logo approvato -->
  <a href="index.html" class="logo" aria-label="Stasera Qui - home">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true">
      <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/>
      <circle cx="32" cy="24" r="9" fill="#ffffff"/>
    </svg>
    <span class="wordmark">stasera qui</span>
  </a>
</header>

<main class="container">
  <!-- Claim -->
  <div class="claim">Scopri cosa fare, dove vuoi, quando vuoi</div>

  <!-- Tabs -->
  <div class="tabs">
    <a class="tab" href="mission.html">Mission</a>
    <a class="tab" href="chi-siamo.html">Chi siamo</a>
    <a class="tab" href="contatti.html">Contatti</a>
    <a class="tab" href="come-funziona.html">Come funziona</a>
  </div>

  <!-- Condividi -->
  <div class="share" id="shareBar">
    <span class="small">Ti piace Stasera Qui? Condividilo:</span>
    <button class="btn primary" id="shareNative" type="button">Condividi</button>
  </div>

  <!-- Ricerca -->
  <div class="search">
    <input placeholder="Cerca citt√†, zona o evento‚Ä¶ (digita e poi premi Cerca)" id="searchInput" autocomplete="off" name="q" aria-label="Cerca citt√†, zona o evento">
    <button class="btn"        id="searchBtn" type="button">Cerca</button>
    <button class="btn small"  id="locBtn"    type="button" title="Usa la mia posizione">üìç usa posizione</button>
    <button class="btn small"  id="resetOriginBtn" type="button" title="Reset posizione">üóò reset posizione</button>
  </div>

  <!-- Filtri temporali -->
  <div class="pills" id="dayPills" style="align-items:center;gap:8px;flex-wrap:wrap">
    <div class="pill" data-day="oggi">Oggi</div>
    <div class="pill" data-day="domani">Domani</div>
    <div class="pill" data-day="weekend">Weekend</div>
    <div class="pill" id="selDataBtn">Seleziona data</div>
    <span id="dateBadge" style="display:none"></span>
  </div>

  <!-- Filtri categorie -->
  <div class="chips" id="chips">
    <div class="chip" data-cat="Musica">Musica</div>
    <div class="chip" data-cat="Food & Drink">Food & Drink</div>
    <div class="chip" data-cat="Sagre & Fiere">Sagre & Fiere</div>
    <div class="chip" data-cat="Famiglie & Bambini">Famiglie & Bambini</div>
    <div class="chip" data-cat="Sport">Sport</div>
    <div class="chip" data-cat="Nightlife">Nightlife</div>
    <div class="chip" data-cat="Cultura/Spettacolo">Cultura/Spettacolo</div>
    <div class="chip" data-cat="Mercatini">Mercatini</div>
  </div>

  <!-- Contatore + lista -->
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <div id="counter" class="small">‚Äî</div>
    <button class="btn light" id="listBtn" type="button">Mostra lista eventi visibili</button>
  </div>

  <!-- Mappa principale (Leaflet) -->
  <div id="map" class="map"></div>
  <!-- Contenitore mappa per il percorso Google (nascosto fino a richiesta percorso) -->
  <div id="gmap" class="map" style="display:none"></div>

  <!-- CTA -->
  <div class="cta-row">
    <a class="cta primary" href="pubblica-evento.html">Pubblica evento</a>
    <a class="cta success"  href="lavora-con-noi.html">Lavora con noi</a>
  </div>
</main>

<!-- Banner percorso -->
<div id="routeInfo"></div>

<!-- Datepicker overlay -->
<div id="dpOverlay">
  <div id="dpBox">
    <input type="date" id="dpInput">
    <div id="dpBtns">
      <button class="btn" id="dpAnnulla" type="button">Annulla</button>
    </div>
  </div>
</div>

<!-- Overlay area iniziale se geolocalizzazione negata -->
<div id="geoOverlay">
  <div id="geoBox">
    <h3>Da dove vuoi iniziare?</h3>
    <p class="small" style="margin-top:0">Geolocalizzazione disattivata. Inserisci una citt√† o indirizzo per centrare la mappa.</p>
    <input id="geoAddr" placeholder="Es. Milano, Piazza Duomo">
    <div id="geoBtns">
      <button class="btn" id="geoAnnulla" type="button">Chiudi</button>
      <button class="btn primary" id="geoOk" type="button">Vai</button>
    </div>
  </div>
</div>

<script>
  // ====== CONFIG ======
  const SB_URL  = 'https://rubdzlnolxcgpjklfggk.supabase.co';
  const SB_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1YmR6bG5vbHhjZ3Bqa2xmZ2drIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4OTI3NjQsImV4cCI6MjA3MjQ2ODc2NH0.Fhq7lKdx1OcyuCWOnHqNH7Omsg7qjdQVzxvNqZyeQQ8';
  const GMAPS_API_KEY = 'AIzaSyCfLAJyhmA_lu6jP0Y1GbgVTvSn2nIICsg'; // usato per percorso + autocomplete + geocoding

  const sb = supabase.createClient(SB_URL, SB_ANON);

  let USE_GMAPS = false; // mappa principale = Leaflet

  // Namespace utili
  let GMAPS = {
    map:null,            // mappa Google SOLO per il percorso
    infowindow:null,
    directionsService:null,
    directionsRenderer:null,
    geocoder:null,
    osrmPolyline:null,
    myPosMarker:null
  };
  let LEAF = { map:null, pinIcon:null, routeLayer:null, myPosMarker:null };

  let EVENTS=[], OCCS=[], EVENTS_BY_ID=new Map(), markers=[];
  let state = { day:null, customDate:null, cats:new Set(), query:'' };
  let ORIGIN = null;

  // Auto-fit: consentito solo prima di geoloc o ricerca
  let _refitTried = false;
  let allowAutoFit = true;

  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const fmtIT = (d) => { const [y,m,dd]=d.split('-'); return `${dd}/${m}/${y}`; };
  const todayISO = () => new Date().toISOString().slice(0,10);
  const addDays  = (d,n) => { const x=new Date(d); x.setDate(x.getDate()+n); return x.toISOString().slice(0,10); };
  const weekday  = s => (new Date(s+'T00:00:00')).getDay();

  // ===== Helpers robusti =====
  const isTruthyPub = v => (v===true || v===1 || v==='1' || v==='t' || v==='true' || v==='T' || v==='TRUE');
  function normCats(raw){
    const c = (raw?.categories ?? raw?.categorie ?? []);
    if (Array.isArray(c)) return c.filter(Boolean).map(String);
    if (c == null) return [];
    if (typeof c === 'string'){
      try{
        const j = JSON.parse(c);
        if (Array.isArray(j)) return j.filter(Boolean).map(String);
      }catch(_){}
      if (c.includes(',')) return c.split(',').map(s=>s.trim()).filter(Boolean);
      return c.trim() ? [c.trim()] : [];
    }
    return [];
  }
  function safeUrl(u){
    if (u == null) return '';
    if (Array.isArray(u)){
      for (const item of u){
        const s = safeUrl(item);
        if (s) return s;
      }
      return '';
    }
    if (typeof u === 'object'){
      const candidates = [u.url, u.href, u.link, u.src];
      for (const c of candidates){
        const s = safeUrl(c);
        if (s) return s;
      }
      return '';
    }
    let s = String(u).trim();
    if (!s) return '';
    if (/^data:image\//i.test(s)) return s;
    if (/^\/\//.test(s)) s = 'https:' + s;
    if (/^\//.test(s)) return s;
    if (/^www\./i.test(s) || /^[a-z0-9.-]+\.[a-z]{2,}(\/|$)/i.test(s)) s = 'https://' + s;
    try { new URL(s); return s; } catch(_){ return ''; }
  }
  function pickFirstUrl(...fields){
    for (const f of fields){
      const s = safeUrl(f);
      if (s) return s;
      if (typeof f === 'string'){
        try{
          const j = JSON.parse(f);
          const s2 = safeUrl(j);
          if (s2) return s2;
        }catch(_){}
      }
    }
    return '';
  }  
  function firstNonEmpty(...vals){
    for (const v of vals){
      const s = (v ?? '').toString().trim();
      if (s) return s;
    }
    return '';
  }
  // üîπ arrotondamento stabile per raggruppare posizioni (5 decimali ~ 1 m)
  const round5 = n => Math.round((+n + Number.EPSILON) * 1e5) / 1e5;

  // ======= GOOGLE: loader unico (Places + Geometry) =======
  let _gmapsLoading = null;
  async function ensureGoogleLoaded(){
    if (window.google && window.google.maps && window.google.maps.places) return;
    if (_gmapsLoading) return _gmapsLoading;
    _gmapsLoading = new Promise((resolve, reject)=>{
      window._initGmapsAll = function(){ resolve(); };
      const s = document.createElement('script');
      s.src = `https://maps.googleapis.com/maps/api/js?key=${GMAPS_API_KEY}&libraries=places,geometry&callback=_initGmapsAll`;
      s.async = true; s.defer = true;
      s.onerror = ()=> reject(new Error('Caricamento Google Maps fallito'));
      document.head.appendChild(s);
    });
    return _gmapsLoading;
  }

  // ===== Autocomplete (Places) su campi ricerca/overlay =====
  async function setupAutocomplete(){
    try{
      await ensureGoogleLoaded();
      const makeAC = (el)=>{
        if (!el) return;
        const ac = new google.maps.places.Autocomplete(el, {
          types:['geocode'],
          fields:['geometry','formatted_address'],
          componentRestrictions:{ country:'it' }
        });
        ac.addListener('place_changed', ()=>{
          const place = ac.getPlace();
          const loc = place?.geometry?.location;
          if (!loc) return;
          const lat = loc.lat(), lng = loc.lng();
          const label = place.formatted_address || el.value;
          if (el.id === 'geoAddr'){
            ORIGIN = {lat,lng,label}; lShowOrigin();
            $('#geoOverlay').style.display='none';
          }
          LEAF.map.setView([lat,lng], Math.max(13, LEAF.map.getZoom()));
          renderMarkers();
        });
      };
      makeAC(document.getElementById('searchInput'));
      makeAC(document.getElementById('geoAddr'));
    }catch(_){ /* se Places non carica, si va avanti col resto */ }
  }

  // ===== Geocoding ibrido con cache (prima Google, poi OSM IT) =====
  const GEO_CACHE_KEY='SQ_GEO_CACHE_V1';
  function geoCacheGet(q){
    try{
      const k=(q||'').trim().toLowerCase(); if(!k) return null;
      const store=JSON.parse(localStorage.getItem(GEO_CACHE_KEY)||'{}');
      return store[k]||null;
    }catch(_){ return null; }
  }
  function geoCacheSet(q,obj){
    try{
      const k=(q||'').trim().toLowerCase(); if(!k) return;
      const store=JSON.parse(localStorage.getItem(GEO_CACHE_KEY)||'{}');
      const now=Date.now();
      store[k] = { ...obj, _ts: now };
      const entries = Object.entries(store);
      if (entries.length > 300){
        entries.sort((a,b)=> (a[1]?._ts||0)-(b[1]?._ts||0));
        const toDel = entries.length - 300;
        for (let i=0;i<toDel;i++){ delete store[entries[i][0]]; }
      }
      localStorage.setItem(GEO_CACHE_KEY, JSON.stringify(store));
    }catch(_){}
  }

  async function geocodeAddrSmart(addr){
    const q=(addr||'').trim(); if(!q) return null;
    const cached = geoCacheGet(q);
    if (cached) return cached;

    // 1) Google (Italia)
    try{
      await ensureGoogleLoaded();
      const geocoder = new google.maps.Geocoder();
      const g = await new Promise((resolve)=> {
        geocoder.geocode({ address:q, componentRestrictions:{ country:'IT' }, region:'it' }, (res,status)=>{
          if(status==='OK' && res && res[0]){
            const r = res[0];
            const loc = r.geometry.location;
            resolve({ lat: loc.lat(), lng: loc.lng(), label: r.formatted_address });
          } else { resolve(null); }
        });
      });
      if (g){ geoCacheSet(q,g); return g; }
    }catch(_){}

    // 2) OSM/Nominatim (Italia)
    try{
      const url = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=it&q='+encodeURIComponent(q);
      const r = await fetch(url, { headers:{'Accept-Language':'it'} });
      const j = await r.json();
      if (Array.isArray(j) && j.length){
        const g = { lat: parseFloat(j[0].lat), lng: parseFloat(j[0].lon), label: j[0].display_name };
        geoCacheSet(q,g);
        return g;
      }
    }catch(_){}
    return null;
  }

  // ===== MAPPA: bootstrap (Leaflet) + Places in parallelo =====
  (function setupMap(){
    initLeafletMap();
    setupAutocomplete();
  })();

  function initRouteGoogleMap(){
    const gdiv = document.getElementById('gmap');
    GMAPS.map = new google.maps.Map(gdiv, {
      center:{lat:45.0703, lng:7.6869}, zoom:12, mapTypeControl:false, streetViewControl:false
    });
    GMAPS.infowindow = new google.maps.InfoWindow();
    GMAPS.directionsService = new google.maps.DirectionsService();
    GMAPS.directionsRenderer = new google.maps.DirectionsRenderer({suppressMarkers:true, preserveViewport:false});
    GMAPS.directionsRenderer.setMap(GMAPS.map);
    GMAPS.geocoder = new google.maps.Geocoder();
  }

  function pinSvgUrl(color = '#22b3f0'){
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 72">
      <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z"
            fill="${color}" stroke="#ffffff" stroke-width="3"/>
      <circle cx="32" cy="24" r="9" fill="#ffffff"/>
    </svg>`;
    return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
  }

  function gClearMarkers(){ markers.forEach(m=>m.setMap && m.setMap(null)); markers=[]; }

  function gShowOrigin(){
    if (GMAPS.myPosMarker) { GMAPS.myPosMarker.setMap(null); GMAPS.myPosMarker=null; }
    if (!ORIGIN || !GMAPS.map) return;
    GMAPS.myPosMarker = new google.maps.Marker({
      position:{lat:ORIGIN.lat, lng:ORIGIN.lng},
      map: GMAPS.map,
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 7,
        fillColor:'#4da3ff',
        fillOpacity:0.9,
        strokeColor:'#ffffff',
        strokeWeight:2
      },
      title: ORIGIN.label || 'Posizione attuale'
    });
  }

  function clearRoute(){
    const ldiv = document.getElementById('map');
    const gdiv = document.getElementById('gmap');
    if (gdiv) gdiv.style.display = 'none';
    if (ldiv) ldiv.style.display = 'block';
    if (GMAPS.directionsRenderer) GMAPS.directionsRenderer.set('directions', null);
    if (GMAPS.osrmPolyline){ GMAPS.osrmPolyline.setMap(null); GMAPS.osrmPolyline=null; }
    if (LEAF.routeLayer){ LEAF.map.removeLayer(LEAF.routeLayer); LEAF.routeLayer=null; }
    $('#routeInfo').style.display='none';
  }

  function getFreshPosition(){
    return new Promise((resolve,reject)=>{
      if (!navigator.geolocation){ reject(new Error('Geolocalizzazione non disponibile')); return; }
      navigator.geolocation.getCurrentPosition(
        pos=> resolve({lat:pos.coords.latitude, lng:pos.coords.longitude, label:'Posizione attuale'}),
        err=> reject(new Error('Geolocalizzazione negata o non riuscita')),
        { enableHighAccuracy:true, maximumAge:0, timeout:10000 }
      );
    });
  }

  async function routeTo(dest){
    try{ ORIGIN = await getFreshPosition(); }
    catch(_){
      if (!ORIGIN){
        const ask = prompt('Origine non impostata. Scrivi un indirizzo di partenza (oppure lascia vuoto per aprire Google Maps):','');
        if (ask && ask.trim()){
          const g = await geocodeAddrSmart(ask.trim());
          if (g){
            ORIGIN = {lat:g.lat, lng:g.lng, label:g.label};
            drawRouteAuto(ORIGIN, dest);
          } else {
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest.lat+','+dest.lng)}&travelmode=driving`,'_blank');
          }
          return;
        } else {
          window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest.lat+','+dest.lng)}&travelmode=driving`,'_blank');
          return;
        }
      }
    }
    drawRouteAuto(ORIGIN, dest);
  }

  async function drawRouteAuto(from, to){
    const haveKey = !!(GMAPS_API_KEY && !/^INSERISCI_/.test(GMAPS_API_KEY));
    if (!haveKey){ drawRouteLeaflet(from, to); return; }
    try{
      await ensureGoogleLoaded();
      const ldiv = document.getElementById('map');
      const gdiv = document.getElementById('gmap');
      if (ldiv) ldiv.style.display = 'none';
      if (gdiv) gdiv.style.display = 'block';
      if (!GMAPS.map) initRouteGoogleMap();

      GMAPS.directionsService.route({
        origin: new google.maps.LatLng(from.lat, from.lng),
        destination: new google.maps.LatLng(to.lat, to.lng),
        travelMode: google.maps.TravelMode.DRIVING
      }, (res, status)=>{
        if(status==='OK'){
          GMAPS.directionsRenderer.setDirections(res);
          const leg = res.routes[0].legs[0];
          const dist = leg.distance.text, dur = leg.duration.text;
          GMAPS.map.fitBounds(res.routes[0].bounds);
          gShowOrigin();
          showRouteInfo(from, to, dist, dur);
        } else { drawRouteOSRMOnGoogle(from, to); }
      });
    }catch(_){ drawRouteLeaflet(from, to); }
  }

  function showRouteInfo(from, to, distTxt, durTxt){
    const info = $('#routeInfo');
    info.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <div><b>Percorso</b> ‚Äî <span class="small">${from.label||'Origine'} ‚Üí ${to.label||'Destinazione'}</span><br>
        Distanza: <b>${distTxt}</b> ¬∑ Tempo stimato: <b>${durTxt}</b></div>
        <div style="display:flex;gap:8px">
          <button class="btn" id="chiudiRoute">Chiudi percorso</button>
          <button class="btn" id="cambiaOrigine">Cambia origine</button>
          <a class="btn" target="_blank" rel="noopener"
             href="https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(from.lat+','+from.lng)}&destination=${encodeURIComponent(to.lat+','+to.lng)}&travelmode=driving">Apri in Google Maps</a>
        </div>
      </div>`;
    info.style.display='block';
    $('#chiudiRoute').onclick = ()=> clearRoute();
    $('#cambiaOrigine').onclick = async ()=>{
      const ask = prompt('Nuova origine (indirizzo):', from.label||'');
      if (ask && ask.trim()){
        const g = await geocodeAddrSmart(ask.trim());
        if (g){ ORIGIN = {lat:g.lat, lng:g.lng, label:g.label}; drawRouteAuto(ORIGIN, to); }
        else { alert('Indirizzo non trovato.'); }
      }
    };
  }

  async function drawRouteOSRMOnGoogle(from, to){
    try{
      if (!GMAPS.map){ drawRouteLeaflet(from,to); return; }
      if (GMAPS.osrmPolyline){ GMAPS.osrmPolyline.setMap(null); GMAPS.osrmPolyline=null; }
      const url = `https://router.project-osrm.org/route/v1/driving/${from.lng},${from.lat};${to.lng},${to.lat}?overview=full&geometries=geojson`;
      const r = await fetch(url); const j = await r.json();
      if (!j || !j.routes || !j.routes.length){ alert('Impossibile calcolare il percorso (fallback).'); return; }
      const route = j.routes[0];
      const coords = route.geometry.coordinates.map(([lng,lat])=> new google.maps.LatLng(lat,lng));
      GMAPS.osrmPolyline = new google.maps.Polyline({ path:coords, strokeColor:'#22b3f0', strokeOpacity:0.95, strokeWeight:5 });
      GMAPS.osrmPolyline.setMap(GMAPS.map);
      const b = new google.maps.LatLngBounds(); coords.forEach(c=>b.extend(c)); GMAPS.map.fitBounds(b);
      const km = (route.distance/1000).toFixed(1), min = Math.round(route.duration/60);
      showRouteInfo(from, to, `${km} km`, `${min} min`);
    }catch(_){
      alert('Impossibile calcolare il percorso.');
    }
  }

  // ===== LEAFLET (mappa principale + percorso fallback) =====
  function initLeafletMap(){
    LEAF.map = L.map('map', { attributionControl:false }).setView([45.0703,7.6869],12);
    L.control.attribution({prefix:false}).addTo(LEAF.map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap contributors'}).addTo(LEAF.map);

    LEAF.pinIcon = L.divIcon({
      className:'sq-pin',
      html:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 72" width="30" height="34" style="display:block;filter:drop-shadow(0 0 2px #fff)">
              <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="currentColor" stroke="#ffffff" stroke-width="2"/>
              <circle cx="32" cy="24" r="9" fill="#ffffff"/></svg>`,
      iconSize:[30,34], iconAnchor:[15,34], popupAnchor:[0,-30]
    });

    LEAF.map.on('dragend', renderMarkers);
    LEAF.map.on('zoomend', renderMarkers);

    loadData().then(requestInitialLocation);
  }

  function lAddMarker(occ, ev){
    const where = `${occ.luogo||''}, ${occ.indirizzo||''}, ${occ.citta||''}`;
    const cats  = (ev._cats||[]).join(', ');
    const theDescr = ev.description||ev.descrizione||'';
    
    // ‚Äî‚Äî URL sito + locandina (robusto) ‚Äî‚Äî
    const website = pickFirstUrl(
      ev.website, ev.sito, ev.sito_web, ev.link, ev.url, ev.official_url, ev.sitoUfficiale,
      ev.link_evento, ev.url_evento, ev.facebook_event, ev.evento_facebook, ev.facebook,
      ev.instagram_event, ev.eventbrite_url, ev.ticket_url, ev.prenotazione_url, ev.booking_url,
      ev.sitoEvento, ev.website_url, ev.homepage, ev.link_ufficiale
    );

    let locandinaUrl = pickFirstUrl(
      ev.locandina_url, ev.poster_url, ev.cover_url, ev.image_url, ev.img, ev.cover,
      ev.locandina, ev.image, ev.foto_locandina, ev.flyer, ev.flyer_url,
      ev.banner, ev.banner_url, ev.thumbnail, ev.thumb, ev.cover_image, ev.img_url
    );

    if (locandinaUrl && locandinaUrl.startsWith('/')) {
      try { locandinaUrl = new URL(locandinaUrl, location.origin).toString(); } catch(_){}
    }

    const btnSite   = website ? `<a class="btn primary" target="_blank" rel="noopener" href="${website}">Apri sito evento</a>` : '';
    const btnPoster = locandinaUrl ? `<a class="btn primary" target="_blank" rel="noopener" href="${locandinaUrl}">Apri locandina</a>` : '';
    
    // Raggruppa le occorrenze future dello stesso evento nella stessa posizione
    const today = todayISO();
    const latKey = round5(occ.lat), lngKey = round5(occ.lng);

    const allDates = OCCS
      .filter(o =>
        o.event_id === occ.event_id &&
        o.data && o.data >= today &&
        round5(o.lat) === latKey && round5(o.lng) === lngKey
      )
      .sort((a,b) => (a.data+a.ora).localeCompare(b.data+b.ora)); // ASC: pi√π vicine per prime

    // === RIGA DATE DAL‚ÄìAL (con orari se presenti) ===
    let dateLine = '';
    if (allDates.length > 1) {
      const start = allDates[0];
      const end   = allDates[allDates.length - 1];
      const startTxt = start.ora ? `${fmtIT(start.data)} ore ${start.ora}` : `${fmtIT(start.data)}`;
      const endTxt   = end.ora   ? `${fmtIT(end.data)} ore ${end.ora}`   : `${fmtIT(end.data)}`;
      dateLine = `dal <b>${startTxt}</b> al <b>${endTxt}</b>`;
    } else {
      const only = allDates[0] || occ;
      dateLine = only.ora ? `${fmtIT(only.data)} ore ${only.ora}` : `${fmtIT(only.data)}`;
    }

    const otherDates = allDates.filter(o => o.id !== occ.id);
    const multiBadge = allDates.length > 1
      ? `<span class="small" style="background:#17304d;border:1px solid #2e6e8f;color:#d7f2ff;border-radius:999px;padding:2px 6px;margin-left:6px">evento multiplo</span>`
      : '';

    const listHtml = otherDates.length
      ? `<div style="margin-top:6px">
           <b>Altre date:</b>
           <ul style="margin:6px 0 0 18px">
             ${otherDates.slice(0,8).map(o =>
               `<li><a href="#" class="sq-date" data-date="${o.data}">${fmtIT(o.data)}${o.ora?` ore ${o.ora}`:''}</a></li>`
             ).join('')}
           </ul>
           ${otherDates.length>8 ? `<div class="small" style="opacity:.8">‚Ä¶e altre ${otherDates.length-8}</div>` : ``}
         </div>`
      : '';

    const m = L.marker([occ.lat,occ.lng], { icon: LEAF.pinIcon }).addTo(LEAF.map);
    const html = `<div style="color:#081421;max-width:320px">
        <b>${ev.title||ev.titolo||'(evento)'}</b>${multiBadge}<br>
        <small>${cats||''}</small><br>
        ${dateLine}<br>${where}
        ${theDescr ? `<br><br>${theDescr}` : ''}
        ${listHtml}
        <div class="popup-actions">
          <button class="btn accent" data-calc="1">Calcola percorso</button>
          ${btnSite}
          ${btnPoster}
        </div>
      </div>`;

    m.bindPopup(html).on('popupopen', ()=>{
      const btn = document.querySelector('button[data-calc="1"]');
      if (btn) btn.onclick = ()=> routeTo({ lat:occ.lat, lng:occ.lng, label:where });

      document.querySelectorAll('.sq-date').forEach(a=>{
        a.addEventListener('click', (e)=>{
          e.preventDefault();
          const d = a.getAttribute('data-date');
          state.customDate = d;
          state.day = null;
          allowAutoFit = false;
          const badge = document.getElementById('dateBadge');
          if (badge){ badge.style.display='inline-block'; badge.textContent = `${fmtIT(d)}`; }
          LEAF.map.closePopup();
          renderMarkers();
        });
      });
    });

    markers.push(m);
  }
  function lClearMarkers(){ markers.forEach(m=>LEAF.map.removeLayer(m)); markers=[]; }

  function lShowOrigin(){
    if (LEAF.myPosMarker){ LEAF.map.removeLayer(LEAF.myPosMarker); LEAF.myPosMarker=null; }
    if (!ORIGIN) return;
    LEAF.myPosMarker = L.circleMarker([ORIGIN.lat, ORIGIN.lng], {
      radius:6, fillColor:'#4da3ff', fillOpacity:0.9, color:'#fff', weight:2
    }).addTo(LEAF.map).bindTooltip(ORIGIN.label||'Posizione attuale',{permanent:false});
  }

  // ====== FILTRI ‚Äî HANDLERS UI ======
  (function setupDayPills(){
    const pills = $$('#dayPills .pill');
    const badge = $('#dateBadge');

    function setDateBadgeISO(d1, d2){
      badge.style.display='inline-block';
      badge.textContent = d2 ? `${fmtIT(d1)} - ${fmtIT(d2)}` : fmtIT(d1);
    }

    pills.forEach(p=>{
      const day = p.getAttribute('data-day');
      if (!day) return;
      p.addEventListener('click', ()=>{
        pills.forEach(x=> x.classList.toggle('active', x===p));
        state.day = day;
        state.customDate = null;
        _refitTried = false;
        const t = todayISO();
        if (day==='oggi')   setDateBadgeISO(t);
        if (day==='domani') setDateBadgeISO(addDays(t,1));
        if (day==='weekend'){
          const now=new Date(), d=now.getDay();
          const sat=addDays(t, (6-d+7)%7), sun=addDays(t, (7-d+7)%7);
          setDateBadgeISO(sat, sun);
        }
        renderMarkers();
      });
    });

    const dpOverlay = $('#dpOverlay');
    const dpInput = $('#dpInput');
    const dpAnnulla = $('#dpAnnulla');
    const selBtn = $('#selDataBtn');

    selBtn.addEventListener('click', ()=>{
      dpInput.value = state.customDate || todayISO();
      dpOverlay.style.display='flex';
      setTimeout(()=> dpInput.focus(), 0);
    });
    dpAnnulla.addEventListener('click', ()=> dpOverlay.style.display='none');
    dpOverlay.addEventListener('click', (e)=>{ if(e.target===dpOverlay) dpOverlay.style.display='none'; });
    dpInput.addEventListener('change', ()=>{
      if (dpInput.value){
        state.customDate = dpInput.value;
        state.day = null;
        _refitTried = false;
        setDateBadgeISO(state.customDate);
        pills.forEach(x=> x.classList.remove('active'));
        renderMarkers();
      }
      dpOverlay.style.display='none';
    });
  })();

  (function setupChips(){
    $$('#chips .chip').forEach(ch=>{
      ch.addEventListener('click', ()=>{
        ch.classList.toggle('active');
        const c = ch.getAttribute('data-cat');
        if (ch.classList.contains('active')) state.cats.add(c);
        else state.cats.delete(c);
        _refitTried = false;
        renderMarkers();
      });
    });
  })();

  // ===== CERCA ‚Äî centra mappa con geocoding ibrido + cache =====
  $('#searchBtn').addEventListener('click', async ()=>{
    state.query = ($('#searchInput').value||'').trim();
    _refitTried = false;
    allowAutoFit = false;
    if (!state.query){ renderMarkers(); return; }
    const g = await geocodeAddrSmart(state.query);
    if (g) { LEAF.map.setView([g.lat, g.lng], Math.max(13, LEAF.map.getZoom())); }
    else   { alert('Indirizzo non trovato.'); }
    renderMarkers();
  });
  $('#searchInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') $('#searchBtn').click(); });

  // ===== GEO iniziale =====
  function requestInitialLocation(){
    if (!navigator.geolocation){ showGeoOverlay(); return; }
    navigator.geolocation.getCurrentPosition(pos=>{
      ORIGIN = {lat:pos.coords.latitude, lng:pos.coords.longitude, label:'Posizione attuale'};
      allowAutoFit = false;
      LEAF.map.setView([ORIGIN.lat,ORIGIN.lng], 13); lShowOrigin();
      updateCounter();
    }, _=> showGeoOverlay(), {enableHighAccuracy:true, timeout:8000});
  }

  function showGeoOverlay(){
    $('#geoOverlay').style.display='flex';
    $('#geoAddr').focus();
  }
  $('#geoAnnulla').onclick = ()=> { $('#geoOverlay').style.display='none'; };
  $('#geoOk').onclick = async ()=>{
    const query = ($('#geoAddr').value||'').trim();
    if(!query) return;
    allowAutoFit = false;
    const g = await geocodeAddrSmart(query);
    if (g){ ORIGIN = {lat:g.lat,lng:g.lng,label:g.label}; LEAF.map.setView([g.lat,g.lng],13); lShowOrigin(); $('#geoOverlay').style.display='none'; updateCounter(); }
    else  { alert('Indirizzo non trovato.'); }
  };

  // üìç posizione
  $('#locBtn').addEventListener('click', async ()=>{
    if (ORIGIN){
      const resp = confirm('Vuoi aggiornare la posizione?\nOK = usa GPS adesso\nAnnulla = inserisci un indirizzo');
      if (resp){
        try{
          ORIGIN = await getFreshPosition();
          allowAutoFit = false;
          LEAF.map.setView([ORIGIN.lat,ORIGIN.lng], 13); lShowOrigin();
          renderMarkers();
        }catch(_){ alert('GPS non accessibile.'); }
      } else {
        const addr = prompt('Imposta origine (indirizzo):', ORIGIN.label||'');
        if (!addr) return;
        allowAutoFit = false;
        const g = await geocodeAddrSmart(addr);
        if (g){ ORIGIN = {lat:g.lat,lng:g.lng,label:g.label}; LEAF.map.setView([g.lat,g.lng],13); lShowOrigin(); renderMarkers(); }
        else  { alert('Indirizzo non trovato.'); }
      }
    } else {
      requestInitialLocation();
    }
  });

  $('#resetOriginBtn').addEventListener('click', ()=>{
    ORIGIN = null;
    if (LEAF.myPosMarker){ LEAF.map.removeLayer(LEAF.myPosMarker); LEAF.myPosMarker=null; }
    alert('Posizione azzerata. Alla prossima richiesta verr√† chiesta nuovamente.');
  });

  // ===== FILTRI LOGICA =====
  function occPassesFilters(occ){
    const today = todayISO();

    // Escludi passato
    if (occ.data && occ.data < today) return false;

    // Se √® stata scelta una data specifica, ha la precedenza
    if (state.customDate && occ.data !== state.customDate) return false;

    // Giorni rapidi
    if (state.day === 'oggi'   && occ.data !== today) return false;
    if (state.day === 'domani' && occ.data !== addDays(today, 1)) return false;

    // Weekend = SOLO il prossimo sabato/domenica (quelli mostrati nel badge)
    if (state.day === 'weekend'){
      const now = new Date();
      const sat = addDays(today, (6 - now.getDay() + 7) % 7);
      const sun = addDays(today, (7 - now.getDay() + 7) % 7);
      if (occ.data !== sat && occ.data !== sun) return false;
    }

    // Categorie
    if (state.cats.size > 0){
      const ev = EVENTS_BY_ID.get(occ.event_id);
      const evCats = (ev?._cats || []);
      if (!evCats.some(c => state.cats.has(c))) return false;
    }

    return true;
  }

  // ‚úÖ CONTATORE: numero di pin (evento+posizione) visibili, non occorrenze
  function updateCounter(){
    const bounds = LEAF.map.getBounds();
    const contains = (lat,lng)=> bounds && bounds.contains([lat,lng]);
    const visibleKeys = new Set();

    OCCS.forEach(o=>{
      if (o.lat!=null && o.lng!=null && contains(o.lat,o.lng) && occPassesFilters(o)){
        const key = `${o.event_id}|${round5(o.lat)},${round5(o.lng)}`;
        visibleKeys.add(key);
      }
    });

    const count = visibleKeys.size;
    $('#counter').textContent = count===1 ? '1 evento visibile sulla mappa' : `${count} eventi visibili sulla mappa`;
  }

  function computeAllBounds(){
    const pts = OCCS.filter(o => o.lat!=null && o.lng!=null);
    if (!pts.length) return null;
    return L.latLngBounds(pts.map(o => [o.lat, o.lng]));
  }

  // ‚úÖ MARKER: deduplica per (evento + posizione)
  function renderMarkers(){
    lClearMarkers();
    const bounds = LEAF.map.getBounds();
    const contains = (lat,lng)=> bounds && bounds.contains([lat,lng]);
    let rendered = 0;

    // Ordina per data/ora DESC (non critico: scegliamo il primo occ del gruppo)
    const occsToScan = OCCS.slice().sort((a,b)=>{
      const ad = a.data || '', bd = b.data || '';
      if (ad !== bd) return ad > bd ? -1 : 1;
      const at = a.ora || '', bt = b.ora || '';
      return at > bt ? -1 : (at < bt ? 1 : 0);
    });

    // Raggruppo occorrenze filtrate per chiave (evento+pos)
    const groups = new Map();
    occsToScan.forEach(occ=>{
      if (occ.lat==null || occ.lng==null) return;
      if (bounds && !contains(occ.lat,occ.lng)) return;
      if (!occPassesFilters(occ)) return;
      const key = `${occ.event_id}|${round5(occ.lat)},${round5(occ.lng)}`;
      if (!groups.has(key)) groups.set(key, occ); // prendi il primo valido
    });

    // Disegno un solo pin per gruppo
    for (const occ of groups.values()){
      const ev = EVENTS_BY_ID.get(occ.event_id)||{};
      lAddMarker(occ, ev);
      rendered++;
    }

    updateCounter();

    if (allowAutoFit && rendered===0 && !_refitTried && OCCS.length>0){
      const all = computeAllBounds();
      if (all){
        _refitTried = true;
        LEAF.map.fitBounds(all);
        setTimeout(renderMarkers, 80);
      }
    }
  }

  // ===== DATI =====
  async function loadData(){
    const { data: evs, error: evErr } = await sb.from('events')
      .select('*')
      .is('deleted_at', null);
    if (evErr) { console.error('ERR events:', evErr); return; }

    const EVENTS_ALL = Array.isArray(evs) ? evs : [];
    EVENTS = EVENTS_ALL
      .filter(e => !('published' in e) || isTruthyPub(e.published))
      .map(e => ({ ...e, _cats: normCats(e) }));
    EVENTS_BY_ID = new Map(EVENTS.map(e => [e.id, e]));

    const { data: occsRaw, error: occErr } = await sb.from('occurrences')
      .select('id, event_id, lat, lng, data, date, ora, time, luogo, venue, indirizzo, address, citta, city, deleted_at')
      .is('deleted_at', null);
    if (occErr) { console.error('ERR occs:', occErr); return; }

    const validEventIds = new Set(EVENTS.map(e => e.id));
    const norm = (occsRaw || [])
      .filter(o => validEventIds.has(o.event_id))
      .map(o => ({
        id: o.id,
        event_id: o.event_id,
        lat: o.lat,
        lng: o.lng,
        data: (o.data || o.date || null),
        ora:  (o.ora  || o.time || ''),
        luogo: o.luogo || o.venue || '',
        indirizzo: o.indirizzo || o.address || '',
        citta: o.citta || o.city || ''
      }))
      .filter(o => o.data);
    OCCS = norm.filter(o => o.lat != null && o.lng != null);

    console.info('Loaded EVENTS:', EVENTS.length, 'OCCS:', OCCS.length);
    _refitTried = false;
    renderMarkers();
  }
  
  // ===== CONDIVIDI (solo bottone giallo) =====
  (function(){
    const SHARE_URL  = 'https://www.staseraqui.it/';
    const SHARE_TEXT = 'Scopri cosa fare stasera vicino a te su Stasera Qui';
    const SHARE_TITLE = 'Stasera Qui';

    const btnNative = document.getElementById('shareNative');
    if (!btnNative) return;

    async function copyToClipboard(text){
      try { await navigator.clipboard.writeText(text); return true; }
      catch(_){
        const ok = prompt('Copia il link e premi OK:', text);
        return !!ok;
      }
    }

    btnNative.addEventListener('click', async ()=>{
      if (navigator.share){
        try{ await navigator.share({ title: SHARE_TITLE, text: SHARE_TEXT, url: SHARE_URL }); }
        catch(_){ /* utente ha annullato o errore ‚Üí ignora */ }
      } else {
        const ok = await copyToClipboard(SHARE_URL);
        if (ok) alert('Link copiato! Incollalo dove vuoi.');
      }
    });
  })();
</script>

<!-- ‚úÖ REGISTRAZIONE SERVICE WORKER (Turbo) -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function(){
    navigator.serviceWorker.register('/sw.js?v=3')
      .then(r => console.log('SW registrato:', r.scope))
      .catch(err => console.warn('SW errore:', err));
  });
}
</script>

<footer class="page-footer">
    <a href="termini-privacy.html" class="btn">Termini & Privacy</a>
    <a href="#" class="btn" id="cookieSettingsLink">Preferenze cookie</a>
</footer>

<noscript>
  <p style="padding:12px;text-align:center">Per usare Stasera Qui attiva JavaScript nel tuo browser.</p>
</noscript>
</body>
</html>
