<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Stasera Qui ‚Äî Eventi oggi vicino a te</title>
<meta name="description" content="Scopri cosa fare stasera vicino a te: concerti, sagre, nightlife, sport, cultura e altro. Filtra per data e categoria, visualizza sulla mappa e calcola il percorso.">
<link rel="canonical" href="https://www.staseraqui.it/">
<meta name="robots" content="index,follow">
<meta property="og:type" content="website">
<meta property="og:title" content="Stasera Qui ‚Äî Eventi oggi vicino a te">
<meta property="og:description" content="Concerti, sagre, nightlife, sport, cultura e altro. Filtra per data e categoria e vedi tutto sulla mappa.">
<meta property="og:url" content="https://www.staseraqui.it/">
<meta property="og:site_name" content="Stasera Qui">
<meta property="og:image" content="https://www.staseraqui.it/favicon.ico">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Stasera Qui ‚Äî Eventi oggi vicino a te">
<meta name="twitter:description" content="Concerti, sagre, nightlife, sport, cultura e altro. Filtra per data e categoria e vedi tutto sulla mappa.">
<meta name="twitter:image" content="https://www.staseraqui.it/favicon.ico">
<link rel="icon" href="/favicon.ico">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="assets/style.css?v=10">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
  .claim{font-style:italic;font-weight:700;text-align:center;margin:8px 0 16px;font-size:20px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:0 0 12px}
  .tab{background:#0f1c2d;border:1px solid rgba(255,255,255,.15);color:#fff;padding:8px 12px;border-radius:10px;font-weight:700}
  .pill{cursor:pointer}
  .chip{cursor:pointer}
  #dateBadge{padding:8px 12px;border-radius:10px;background:#111f31;border:1px solid rgba(255,255,255,.35);min-width:170px;display:inline-block;text-align:center}
  #counter{margin:8px 0 4px;color:#b8c2ce}
  .sq-pin{color:var(--accent)}
  .pill.active,.chip.active{outline:3px solid #ffd24d;box-shadow:0 0 0 3px rgba(255,210,77,.25)}
  #routeInfo{position:fixed;left:16px;right:16px;bottom:16px;background:#0f1c2d;border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:10px 12px;display:none;z-index:10000}
  .popup-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  #dpOverlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:flex-start;justify-content:center;z-index:9999}
  #dpBox{margin-top:80px;background:#0f1c2d;border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:14px}
  #dpInput{font-size:17px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:#fff;color:#081421}
  #dpBtns{display:flex;gap:8px;margin-top:10px;justify-content:flex-end}
  .search{display:flex;gap:8px;flex-wrap:wrap;margin:14px 0 10px}
  .search input{flex:1;min-width:220px}
  .btn.small{padding:6px 8px;font-size:12px;line-height:1}
  @media (max-width:480px){ .btn.small{padding:6px 7px;font-size:12px} }
  #geoOverlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:10001}
  #geoBox{background:#0f1c2d;border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:16px;max-width:520px;width:92%}
  #geoBox h3{margin:0 0 8px}
  #geoAddr{width:100%;background:#fff;color:#081421;border:1px solid rgba(0,0,0,.2);border-radius:10px;padding:12px}
  #geoBtns{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
</style>

<!-- Dati strutturati (omessi per brevit√†) -->
</head>
<body>
<header class="header">
  <a href="index.html" class="logo" aria-label="Stasera Qui - home">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true">
      <path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/>
      <circle cx="32" cy="24" r="9" fill="#ffffff"/>
    </svg>
    <span class="wordmark">stasera qui</span>
  </a>
</header>

<main class="container">
  <div class="claim">Scopri cosa fare, dove vuoi, quando vuoi</div>

  <div class="tabs">
    <a class="tab" href="mission.html">Mission</a>
    <a class="tab" href="chi-siamo.html">Chi siamo</a>
    <a class="tab" href="contatti.html">Contatti</a>
    <a class="tab" href="come-funziona.html">Come funziona</a>
  </div>

  <div class="search">
    <input placeholder="Cerca citt√†, zona o evento‚Ä¶ (digita e poi premi Cerca)" id="searchInput" autocomplete="off" name="q" aria-label="Cerca citt√†, zona o evento">
    <button class="btn" id="searchBtn" type="button">Cerca</button>
    <button class="btn small" id="locBtn" type="button" title="Usa la mia posizione">üìç usa posizione</button>
    <button class="btn small" id="resetOriginBtn" type="button" title="Reset posizione">üóò reset posizione</button>
  </div>

  <div class="pills" id="dayPills" style="align-items:center;gap:8px;flex-wrap:wrap">
    <div class="pill" data-day="oggi">Oggi</div>
    <div class="pill" data-day="domani">Domani</div>
    <div class="pill" data-day="weekend">Weekend</div>
    <div class="pill" id="selDataBtn">Seleziona data</div>
    <span id="dateBadge" style="display:none"></span>
  </div>

  <div class="chips" id="chips">
    <div class="chip" data-cat="Musica">Musica</div>
    <div class="chip" data-cat="Food & Drink">Food & Drink</div>
    <div class="chip" data-cat="Sagre & Fiere">Sagre & Fiere</div>
    <div class="chip" data-cat="Famiglie & Bambini">Famiglie & Bambini</div>
    <div class="chip" data-cat="Sport">Sport</div>
    <div class="chip" data-cat="Nightlife">Nightlife</div>
    <div class="chip" data-cat="Cultura/Spettacolo">Cultura/Spettacolo</div>
    <div class="chip" data-cat="Mercatini">Mercatini</div>
  </div>

  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <div id="counter" class="small">‚Äî</div>
    <button class="btn light" id="listBtn" type="button">Mostra lista eventi visibili</button>
  </div>

  <div id="map" class="map"></div>

  <div class="cta-row">
    <a class="cta primary" href="pubblica-evento.html">Pubblica evento</a>
    <a class="cta success"  href="lavora-con-noi.html">Lavora con noi</a>
  </div>
</main>

<div id="routeInfo"></div>

<div id="dpOverlay">
  <div id="dpBox">
    <input type="date" id="dpInput">
    <div id="dpBtns">
      <button class="btn" id="dpAnnulla" type="button">Annulla</button>
    </div>
  </div>
</div>

<div id="geoOverlay">
  <div id="geoBox">
    <h3>Da dove vuoi iniziare?</h3>
    <p class="small" style="margin-top:0">Geolocalizzazione disattivata. Inserisci una citt√† o indirizzo per centrare la mappa.</p>
    <input id="geoAddr" placeholder="Es. Milano, Piazza Duomo">
    <div id="geoBtns">
      <button class="btn" id="geoAnnulla" type="button">Chiudi</button>
      <button class="btn primary" id="geoOk" type="button">Vai</button>
    </div>
  </div>
</div>

<script>
  // ====== CONFIG ======
  const SB_URL  = 'https://rubdzlnolxcgpjklfggk.supabase.co';
  const SB_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1YmR6bG5vbHhjZ3Bqa2xmZ2drIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4OTI3NjQsImV4cCI6MjA3MjQ2ODc2NH0.Fhq7lKdx1OcyuCWOnHqNH7Omsg7qjdQVzxvNqZyeQQ8';
  const GMAPS_API_KEY = 'AIzaSyCfLAJyhmA_lu6jP0Y1GbgVTvSn2nIICsg';

  const sb = supabase.createClient(SB_URL, SB_ANON);

  const hasGoogleKey = GMAPS_API_KEY && !/^INSERISCI_/.test(GMAPS_API_KEY);
  let USE_GMAPS = false;

  let GMAPS = { map:null, infowindow:null, directionsService:null, directionsRenderer:null, geocoder:null, osrmPolyline:null, myPosMarker:null };
  let LEAF  = { map:null, pinIcon:null, routeLayer:null, myPosMarker:null };

  let EVENTS=[], OCCS=[], EVENTS_BY_ID=new Map(), markers=[];
  // *** Stato con range weekend ***
  let state = { day:null, customDate:null, cats:new Set(), query:'', weekendFrom:null, weekendTo:null };
  let ORIGIN = null;

  let _refitTried = false;
  let allowAutoFit = true;

  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const fmtIT = (d) => { const [y,m,dd]=d.split('-'); return `${dd}/${m}/${y}`; };
  const todayISO = () => new Date().toISOString().slice(0,10);
  const addDays  = (d,n) => { const x=new Date(d); x.setDate(x.getDate()+n); return x.toISOString().slice(0,10); };

  // Calcola sabato e domenica del PROSSIMO weekend rispetto a "base"
  function getUpcomingWeekendRange(base = new Date()){
    const d = new Date(base);
    const day = d.getDay(); // 0=Dom ... 6=Sab
    const t = d.toISOString().slice(0,10);

    // sabato e domenica prossimi (se oggi √® sab/dom: questo weekend)
    const sat = addDays(t, (6 - day + 7) % 7);
    const sun = addDays(t, (7 - day + 7) % 7);
    return { fromISO: sat, toISO: sun };
  }

  // ===== MAPPA bootstrap (Google/Leaflet) =====
  (function setupMap(){
    if (hasGoogleKey){
      USE_GMAPS = true;
      const s = document.createElement('script');
      s.src = `https://maps.googleapis.com/maps/api/js?key=${GMAPS_API_KEY}&libraries=geometry&callback=initGoogleMap`;
      s.async = true; s.defer = true;
      s.onerror = ()=>{ console.warn('Google Maps KO. Uso OSM.'); USE_GMAPS=false; initLeafletMap(); };
      document.head.appendChild(s);
      setTimeout(()=>{ if(!GMAPS.map){ console.warn('Timeout GMaps ‚Üí OSM'); USE_GMAPS=false; initLeafletMap(); }}, 4000);
    } else {
      initLeafletMap();
    }
  })();

  // --- (Funzioni Google/Leaflet e routing: invariate; omesse per brevit√† nel messaggio originale) ---
</script>

<!-- Per non superare la lunghezza del messaggio, le funzioni di mappa e routing sono identiche alle tue attuali.
     Sotto riporto SOLO le parti che cambiano nei filtri. Incolla comunque l'intero file che hai sopra ricevuto. -->

<script>
  // ===== DATEPICKER overlay (invariato a parte il renderMarkers) =====
  const dpOverlay = $('#dpOverlay'), dpInput = $('#dpInput');
  $('#selDataBtn').addEventListener('click', ()=>{
    dpInput.value = state.customDate || todayISO();
    dpOverlay.style.display='flex';
    setTimeout(()=>dpInput.focus(),0);
  });
  $('#dpAnnulla').addEventListener('click', ()=> dpOverlay.style.display='none');
  dpInput.addEventListener('change', ()=>{
    if (dpInput.value){
      state.customDate = dpInput.value;
      state.day = null;
      state.weekendFrom = null;
      state.weekendTo   = null;
      _refitTried = false;
      setDateBadgeISO(state.customDate);
      renderMarkers();
    }
    dpOverlay.style.display='none';
  });
  dpOverlay.addEventListener('click', (e)=>{ if(e.target===dpOverlay) dpOverlay.style.display='none'; });

  function setDateBadgeISO(d1, d2){
    $('#dateBadge').style.display='inline-block';
    $('#dateBadge').textContent = d2 ? `${fmtIT(d1)} - ${fmtIT(d2)}` : fmtIT(d1);
  }

  // ===== Click Oggi/Domani/Weekend =====
  $$('#dayPills .pill').forEach(p => p.addEventListener('click', ()=>{
    const k = p.getAttribute('data-day'); if(!k) return;
    state.day = k; state.customDate=null;
    state.weekendFrom = null; state.weekendTo = null;
    _refitTried = false;

    const t = todayISO();
    if (k==='oggi')   setDateBadgeISO(t);
    if (k==='domani') setDateBadgeISO(addDays(t,1));
    if (k==='weekend'){
      const { fromISO, toISO } = getUpcomingWeekendRange(new Date());
      state.weekendFrom = fromISO;
      state.weekendTo   = toISO;
      setDateBadgeISO(fromISO, toISO);
    }
    renderMarkers();
  }));

  // ===== FILTRI LOGICA =====
  const isTruthyPub = v => (v===true || v===1 || v==='1' || v==='t' || v==='true' || v=== 'T' || v==='TRUE');
  function normCats(raw){
    const c = (raw?.categories ?? raw?.categorie ?? []);
    if (Array.isArray(c)) return c.filter(Boolean).map(String);
    if (c == null) return [];
    if (typeof c === 'string'){
      try{ const j = JSON.parse(c); if (Array.isArray(j)) return j.filter(Boolean).map(String); }catch(_){}
      if (c.includes(',')) return c.split(',').map(s=>s.trim()).filter(Boolean);
      return c.trim() ? [c.trim()] : [];
    }
    return [];
  }

  function occPassesFilters(occ){
    // nascondo occorrenze passate
    if (occ.data && occ.data < todayISO()) return false;

    if (state.day==='oggi'   && occ.data !== todayISO()) return false;
    if (state.day==='domani' && occ.data !== addDays(todayISO(),1)) return false;

    // *** NOVIT√Ä: weekend = SOLO sabato-domenica del pross. weekend (range inclusivo) ***
    if (state.day==='weekend') {
      const from = state.weekendFrom, to = state.weekendTo;
      if (!from || !to) return false;
      if (occ.data < from || occ.data > to) return false;
    }

    if (state.customDate && occ.data !== state.customDate) return false;

    if (state.cats.size>0){
      const ev = EVENTS_BY_ID.get(occ.event_id);
      const evCats = (ev?._cats || []);
      if (!evCats.some(c=>state.cats.has(c))) return false;
    }
    return true;
  }

  // --- resto del codice: render markers, load data, counter, ecc. invariato dal tuo file ---
</script>

<footer class="page-footer">
  <a href="termini-privacy.html" class="btn">Termini & Privacy</a>
</footer>

<noscript><p style="padding:12px;text-align:center">Per usare Stasera Qui attiva JavaScript nel tuo browser.</p></noscript>
</body>
</html>
