<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Report — Stasera Qui</title>

  <!-- Config condivisa + Supabase v2 -->
  <script src="assets/app-config.js?v=6"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/style.css?v=12">

  <style>
    body{visibility:hidden}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    @media (max-width:900px){.grid3{grid-template-columns:1fr}}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
    .card h2{margin:0 0 8px}
    label.small{font-size:12px;opacity:.9}
    input[type="date"], input[type="text"], select{
      width:100%;height:36px;padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.25);
      background:#0f1c2d;color:#fff
    }
    .btn.small{padding:6px 8px;font-size:12px}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:10px}
    @media (max-width:900px){.kpis{grid-template-columns:1fr 1fr}}
    @media (max-width:520px){.kpis{grid-template-columns:1fr}}
    .kpi{background:#0f1c2d;border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:12px}
    .kpi .n{font-size:28px;font-weight:700;margin-top:4px}
    .muted{color:#b8c2ce}
    .errorlog{background:#0b1623;border:1px dashed rgba(255,255,255,.25);padding:10px;border-radius:8px;font-size:12px;white-space:pre-wrap}
    .note{font-size:13px;color:#b8c2ce;margin-top:6px}
    .pillrow{display:flex;gap:8px;flex-wrap:wrap}
    .chip{cursor:pointer;display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.25);background:#0f1c2d}
    .chip.active{outline:3px solid #ffd24d;box-shadow:0 0 0 3px rgba(255,210,77,.25)}
    .flex{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .right{text-align:right}
    #loading{display:none}
    #delBlock.disabled{opacity:.55}
    table.table{width:100%;border-collapse:collapse;margin-top:10px}
    table.table th, table.table td{border:1px solid rgba(255,255,255,.15);padding:8px;text-align:left;vertical-align:top}
    table.table th{background:#0f1c2d}
  </style>

  <!-- Overlay login (stesso meccanismo dell'admin) -->
  <script>
    (function(){
      const CFG = window.SQ_CONFIG || {};
      const SUPABASE_URL  = CFG.SUPABASE_URL  || "https://rubdzlnolxcgpjklfggk.supabase.co";
      const SUPABASE_ANON = CFG.SUPABASE_ANON || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1YmR6bG5vbHhjZ3Bqa2xmZ2drIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4OTI3NjQsImV4cCI6MjA3MjQ2ODc2NH0.Fhq7lKdx1OcyuCWOnHqNH7Omsg7qjdQVzxvNqZyeQQ8";
      if (!window.supabase) { document.body.style.visibility = 'visible'; return; }
      window.sb = window.sb || window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth:{ persistSession:true, autoRefreshToken:true } });

      async function ensureAuth(){
        try{
          const { data:{ session } } = await window.sb.auth.getSession();
          if (session){ document.body.style.visibility='visible'; return; }
        }catch(e){ console.warn('getSession', e); document.body.style.visibility='visible'; return; }

        const box = document.createElement('div');
        box.id = 'sq-login';
        box.style.cssText = 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:999999';
        box.innerHTML = `
          <div class="card" style="background:#141419;border:1px solid #24242c;border-radius:12px;padding:20px;max-width:360px;width:92%">
            <h2>Accesso</h2>
            <p class="small">Inserisci email e password</p>
            <input id="sq-email" type="email" placeholder="Email" autocomplete="username" style="width:100%;padding:12px;border-radius:10px;border:1px solid #2a2a33;background:#0f0f14;color:#f7f7fb;margin:8px 0">
            <input id="sq-pass" type="password" placeholder="Password" autocomplete="current-password" style="width:100%;padding:12px;border-radius:10px;border:1px solid #2a2a33;background:#0f0f14;color:#f7f7fb;margin:8px 0">
            <div class="small" id="sq-err" style="min-height:18px;color:#ffb4b4"></div>
            <button id="sq-go" class="btn primary" style="width:100%;padding:12px">Entra</button>
          </div>`;
        document.body.appendChild(box);
        document.body.style.visibility='visible';
        document.getElementById('sq-go').addEventListener('click', async ()=>{
          const email = (document.getElementById('sq-email').value||'').trim();
          const password = document.getElementById('sq-pass').value;
          const err = document.getElementById('sq-err');
          err.textContent = '';
          try{
            const { error } = await window.sb.auth.signInWithPassword({ email, password });
            if (error){ err.textContent = error.message || 'Accesso non riuscito'; return; }
            box.remove();
          }catch(e){ err.textContent = e?.message || String(e); }
        });
      }
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', ensureAuth);
      else ensureAuth();
    })();
  </script>
</head>
<body>
<header class="header">
  <a href="admin.html" class="logo" aria-label="Torna ad admin">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true"><path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/><circle cx="32" cy="24" r="9" fill="#ffffff"/></svg>
    <span class="wordmark">stasera qui</span>
  </a>
</header>

<main class="wrap">
  <h1 style="margin:8px 0 14px">Report</h1>

  <div class="card">
    <h2>Filtri</h2>
    <div class="grid3">
      <div>
        <label class="small">Data evento — dal</label>
        <input type="date" id="f_evt_from">
      </div>
      <div>
        <label class="small">Data evento — al</label>
        <input type="date" id="f_evt_to">
      </div>
      <div>
        <label class="small">Città (separa con virgola)</label>
        <input type="text" id="f_cities" placeholder="Es. Torino, Milano">
      </div>
    </div>

    <div class="grid">
      <div>
        <label class="small">Data caricamento — dal</label>
        <input type="date" id="f_up_from">
      </div>
      <div>
        <label class="small">Data caricamento — al</label>
        <input type="date" id="f_up_to">
      </div>
    </div>

    <div class="grid" id="delBlock">
      <div>
        <label class="small">Data cancellazione — dal</label>
        <input type="date" id="f_del_from">
      </div>
      <div>
        <label class="small">Data cancellazione — al</label>
        <input type="date" id="f_del_to">
      </div>
    </div>
    <div class="note" id="delNote" style="display:none">Dato cancellazioni non disponibile: nessuna tabella/colonna di log trovata. (Va bene così se elimini definitivamente dal DB.)</div>

    <div style="margin-top:10px">
      <label class="small">Categorie (opzionali)</label>
      <div id="catRow" class="pillrow" style="margin-top:6px"></div>
    </div>

    <div class="flex" style="justify-content:flex-end;margin-top:10px">
      <button class="btn" id="btnClear" type="button">Azzera filtri</button>
      <button class="btn primary" id="btnApply" type="button">Applica</button>
    </div>
    <div id="loading" class="note">Caricamento…</div>
  </div>

  <div class="kpis">
    <div class="kpi">
      <div class="muted">Attualmente in sito</div>
      <div class="n" id="k_now">—</div>
      <div class="note">Eventi pubblicati con almeno un’occorrenza futura (dopo i filtri).</div>
    </div>
    <div class="kpi">
      <div class="muted">Scaduti</div>
      <div class="n" id="k_expired">—</div>
      <div class="note">Tutte le occorrenze nel passato (dopo i filtri).</div>
    </div>
    <div class="kpi">
      <div class="muted">Caricati</div>
      <div class="n" id="k_uploaded">—</div>
      <div class="note">Eventi creati nel periodo di caricamento (filtri applicati).</div>
    </div>
    <div class="kpi">
      <div class="muted">Cancellati</div>
      <div class="n" id="k_deleted">—</div>
      <div class="note" id="k_deleted_note">Se è disponibile un log di cancellazione.</div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h2>Dettagli (facoltativo)</h2>
    <p class="small muted">Anteprima rapida degli eventi conteggiati, dopo i filtri. (Massimo 200 righe per non appesantire.)</p>
    <div id="detailTable" class="small">—</div>
  </div>

  <div class="card" style="margin-top:12px">
    <h2>Log errori</h2>
    <div id="errlog" class="errorlog">Nessun errore.</div>
  </div>
</main>

<footer class="page-footer">
  <a class="btn" href="admin.html">← Torna ad admin</a>
</footer>

<script>
(function(){
  const $  = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const errlog = $('#errlog');
  const logErr = (m)=>{ errlog.textContent = (errlog.textContent==='Nessun errore.'?'':(errlog.textContent+'\\n')) + m; };
  const todayISO = ()=> new Date().toISOString().slice(0,10);
  const inRange = (d,from,to)=> {
    if (!d) return false;
    if (from && d < from) return false;
    if (to   && d > to)   return false;
    return true;
  };
  const normCats = (raw)=>{
    const c = (raw?.categories ?? raw?.categorie ?? []);
    if (Array.isArray(c)) return c.filter(Boolean).map(String);
    if (c == null) return [];
    if (typeof c === 'string'){
      try{ const j = JSON.parse(c); if (Array.isArray(j)) return j.filter(Boolean).map(String); }catch(_){}
      if (c.includes(',')) return c.split(',').map(s=>s.trim()).filter(Boolean);
      return c.trim() ? [c.trim()] : [];
    }
    return [];
  };
  const truthy = v => (v===true || v===1 || v==='1' || v==='t' || v==='true' || v==='T' || v==='TRUE');

  const CATS = ['Musica','Food & Drink','Sagre & Fiere','Famiglie & Bambini','Sport','Nightlife','Cultura/Spettacolo','Mercatini'];
  const catRow = $('#catRow');
  CATS.forEach(c=>{
    const el = document.createElement('div');
    el.className='chip'; el.textContent=c; el.dataset.cat=c;
    el.addEventListener('click', ()=> el.classList.toggle('active'));
    catRow.appendChild(el);
  });

  const CFG = window.SQ_CONFIG || {};
  const SUPABASE_URL  = CFG.SUPABASE_URL  || "https://rubdzlnolxcgpjklfggk.supabase.co";
  const SUPABASE_ANON = CFG.SUPABASE_ANON || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1YmR6bG5vbHhjZ3Bqa2xmZ2drIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4OTI3NjQsImV4cCI6MjA3MjQ2ODc2NH0.Fhq7lKdx1OcyuCWOnHqNH7Omsg7qjdQVzxvNqZyeQQ8";
  const sb = window.sb || (window.sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth:{ persistSession:true, autoRefreshToken:true } }));

  // Stato dati
  let EVENTS = [];          // {id, title, created_at, published, _cats:[]}
  let OCCS   = [];          // {event_id, data, citta}
  let DELETES = [];         // {event_id, deleted_at, categories?, citta?} se disponibile
  let deleteSupport = false;

  async function loadData(){
    $('#loading').style.display='block';
    try{
      // 1) Events
      const { data: evs, error: e1 } = await sb.from('events')
        .select('id,title,created_at,published,categories').order('created_at',{ascending:false}).limit(5000);
      if (e1) throw e1;
      EVENTS = (evs||[]).map(e=>({ id:e.id, title:e.title||'(evento)', created_at:(e.created_at||'').slice(0,10), published: (!('published' in e) ? true : truthy(e.published)), _cats: normCats(e) }));

      // 2) Occorrenze
      const { data: occs, error: e2 } = await sb.from('occurrences')
        .select('event_id,data,date,citta,city').order('data',{ascending:false}).limit(20000);
      if (e2) throw e2;
      OCCS = (occs||[]).map(o=>({
        event_id:o.event_id,
        data: (o.data || o.date || '') || null,
        citta: (o.citta || o.city || '' ).toString().trim()
      }));

      // 3) Cancellazioni (best-effort)
      deleteSupport = false; DELETES = [];
      // Prova tabella "events_deleted"
      try {
        const { data: d1, error: de1 } = await sb.from('events_deleted')
          .select('event_id,deleted_at,city,citta,categories').order('deleted_at',{ascending:false}).limit(10000);
        if (!de1 && Array.isArray(d1)) {
          DELETES = d1.map(r=>({
            event_id: r.event_id || r.id || null,
            deleted_at: r.deleted_at ? String(r.deleted_at).slice(0,10) : null,
            citta: (r.citta || r.city || '').toString().trim(),
            _cats: normCats(r)
          }));
          deleteSupport = true;
        }
      } catch(_) {}
      // Se vuoto, prova colonna "deleted_at" su events
      if (!deleteSupport){
        try{
          const { data: ed, error: de2 } = await sb.from('events')
            .select('id,deleted_at,categories').is('deleted_at', null).limit(1);
          // sopra è solo test struttura; ora prendo quelli con deleted_at != null
          const { data: ed2, error: de3 } = await sb.from('events')
            .select('id,deleted_at,categories').not('deleted_at','is',null).order('deleted_at',{ascending:false}).limit(10000);
          if (!de3 && Array.isArray(ed2)){
            DELETES = ed2.map(r=>({ event_id:r.id, deleted_at: r.deleted_at ? String(r.deleted_at).slice(0,10) : null, citta:'', _cats: normCats(r) }));
            if (DELETES.length>0) deleteSupport = true;
          }
        }catch(_){}
      }
      // Se ancora nulla, prova "deleted_events"
      if (!deleteSupport){
        try {
          const { data: d2, error: de4 } = await sb.from('deleted_events')
            .select('event_id,deleted_at,city,citta,categories').order('deleted_at',{ascending:false}).limit(10000);
          if (!de4 && Array.isArray(d2)) {
            DELETES = d2.map(r=>({
              event_id: r.event_id || r.id || null,
              deleted_at: r.deleted_at ? String(r.deleted_at).slice(0,10) : null,
              citta: (r.citta || r.city || '').toString().trim(),
              _cats: normCats(r)
            }));
            deleteSupport = true;
          }
        } catch(_){}
      }

      // UI cancellazione
      if (!deleteSupport){
        $('#delBlock').classList.add('disabled');
        $('#delNote').style.display='block';
        $('#k_deleted_note').textContent = 'N/D (nessun log cancellazioni).';
      } else {
        $('#delBlock').classList.remove('disabled');
        $('#delNote').style.display='none';
        $('#k_deleted_note').textContent = 'Filtrabile per data canc. se il log è disponibile.';
      }
    }catch(e){
      logErr('Caricamento: '+(e?.message||e));
    }finally{
      $('#loading').style.display='none';
    }
  }

  function getActiveCats(){
    return new Set($$('#catRow .chip.active').map(x=>x.dataset.cat));
  }
  function parseCities(){
    const raw = ($('#f_cities').value||'').trim();
    if (!raw) return [];
    return raw.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
  }

  function eventMatchesFilters(ev, occsOfEvent, opts){
    const cats = getActiveCats();
    if (cats.size>0){
      if (!ev._cats || !ev._cats.some(c=>cats.has(c))) return false;
    }
    // città: basta una occorrenza in una delle città selezionate (indipendente dalle date di caricamento/cancellazione)
    const cities = opts.cities;
    if (cities.length>0){
      const ok = occsOfEvent.some(o => o.citta && cities.includes(o.citta.toLowerCase()));
      if (!ok) return false;
    }
    return true;
  }

  function apply(){
    try{
      const evtFrom = $('#f_evt_from').value || null;
      const evtTo   = $('#f_evt_to').value   || null;
      const upFrom  = $('#f_up_from').value  || null;
      const upTo    = $('#f_up_to').value    || null;
      const delFrom = $('#f_del_from').value || null;
      const delTo   = $('#f_del_to').value   || null;
      const cities  = parseCities();
      const opts = { cities };

      const today = todayISO();

      // mappa occorrenze per evento
      const occByEv = new Map();
      OCCS.forEach(o=>{
        if (!occByEv.has(o.event_id)) occByEv.set(o.event_id, []);
        occByEv.get(o.event_id).push(o);
      });

      // filtro eventi "visibili" per categoria/città (e poi per date)
      const eventsPub = EVENTS.filter(e => e.published !== false);

      // ---- KPI 1 e 2: now/expired su base occorrenze (con filtro data evento se settato)
      let k_now = 0, k_expired = 0;
      let detailRows = []; // raccolgo qualche riga per tabella

      for (const ev of eventsPub){
        const occ = (occByEv.get(ev.id) || []).filter(o=>{
          if (!o.data) return false;
          if (evtFrom || evtTo) return inRange(o.data, evtFrom, evtTo);
          return true;
        });
        if (!eventMatchesFilters(ev, occByEv.get(ev.id)||[], opts)) continue;
        if (occ.length === 0) continue; // nessuna occorrenza nel range => non conta nei due KPI
        const hasFuture = occ.some(o => o.data >= today);
        const hasPastOnly = !hasFuture && occ.every(o => o.data < today);
        if (hasFuture) k_now++;
        else if (hasPastOnly) k_expired++;
      }

      // ---- KPI 3: caricati (filtrati per data caricamento + categorie/città)
      let k_uploaded = 0;
      for (const ev of eventsPub){
        if (upFrom || upTo){
          const c = ev.created_at || null;
          if (!c || !inRange(c, upFrom, upTo)) continue;
        }
        const occ = occByEv.get(ev.id) || [];
        if (!eventMatchesFilters(ev, occ, opts)) continue;
        k_uploaded++;
      }

      // ---- KPI 4: cancellati (se disponibile log)
      let k_deleted = 'N/D';
      if (deleteSupport){
        const cats = getActiveCats();
        const delRows = DELETES.filter(r=>{
          if (delFrom || delTo){
            const d = r.deleted_at || null;
            if (!d || !inRange(d, delFrom, delTo)) return false;
          }
          // categorie
          if (cats.size>0){
            if (!r._cats || !r._cats.some(c=>cats.has(c))) return false;
          }
          // città se presente nel log
          if (cities.length>0 && r.citta){
            if (!cities.includes(String(r.citta).toLowerCase())) return false;
          } else if (cities.length>0 && !r.citta){
            // se il log non ha città, non riesco a filtrare: escludo per coerenza
            return false;
          }
          return true;
        });
        k_deleted = String(delRows.length);
      }

      // Aggiorna KPI
      $('#k_now').textContent      = String(k_now);
      $('#k_expired').textContent  = String(k_expired);
      $('#k_uploaded').textContent = String(k_uploaded);
      $('#k_deleted').textContent  = String(k_deleted);

      // Tabella di dettaglio (max 200 righe) — elenco eventi “now” e “expired”
      const rows = [];
      let pushRow = (type, ev, occ)=> rows.push([
        type,
        ev.title || '(evento)',
        ev.created_at || '',
        (occ||[]).map(o=>o.data).filter(Boolean).sort().join(' | '),
        (occ||[]).map(o=>o.citta).filter(Boolean).join(' | '),
        (ev._cats||[]).join(', ')
      ]);

      for (const ev of eventsPub){
        const occAll = occByEv.get(ev.id) || [];
        if (!eventMatchesFilters(ev, occAll, opts)) continue;
        const occ = occAll.filter(o=>{
          if (!o.data) return false;
          if (evtFrom || evtTo) return inRange(o.data, evtFrom, evtTo);
          return true;
        });
        if (occ.length===0) continue;

        const hasFuture = occ.some(o => o.data >= today);
        const hasPastOnly = !hasFuture && occ.every(o => o.data < today);
        if (hasFuture && rows.length<200) pushRow('NOW', ev, occ);
        else if (hasPastOnly && rows.length<200) pushRow('SCADUTO', ev, occ);
      }

      if (!rows.length){
        $('#detailTable').textContent = '— Nessun evento da mostrare con questi filtri —';
      } else {
        const head = ['Stato','Titolo','Caricato il','Date evento','Città','Categorie'];
        const html = [
          '<table class="table" aria-label="Dettaglio eventi">',
          '<thead><tr>', head.map(h=>`<th>${h}</th>`).join(''), '</tr></thead>',
          '<tbody>',
          rows.map(r=>`<tr>${r.map(c=>`<td>${(c||'').toString().replace(/[<>&]/g,s=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[s]))}</td>`).join('')}</tr>`).join(''),
          '</tbody></table>'
        ].join('');
        $('#detailTable').innerHTML = html;
      }

    }catch(e){
      logErr('Apply: '+(e?.message||e));
    }
  }

  // Azzera filtri
  $('#btnClear').addEventListener('click', ()=>{
    ['f_evt_from','f_evt_to','f_up_from','f_up_to','f_del_from','f_del_to','f_cities'].forEach(id=> $('#'+id).value='');
    $$('#catRow .chip.active').forEach(x=>x.classList.remove('active'));
    apply();
  });
  $('#btnApply').addEventListener('click', apply);

  // Carica dati e applica
  (async function init(){
    await loadData();
    apply();
    document.body.style.visibility='visible';
  })();

})();
</script>
</body>
</html>
