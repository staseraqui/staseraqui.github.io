<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Report — Stasera Qui</title>

  <!-- Config condivisa + Supabase v2 -->
  <script src="assets/app-config.js?v=6"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/style.css?v=12">

  <style>
    :root{ --accent:#22b3f0; }
    body{visibility:hidden}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    @media (max-width:900px){.grid3{grid-template-columns:1fr}}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
    .card h2{margin:0 0 8px}
    label.small{font-size:12px;opacity:1;color:#fff}

    /* input base */
    input[type="text"], select{
      width:100%;height:36px;padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.25);
      background:#0f1c2d;color:#fff
    }
    input[type="date"]{
      width:100%;height:36px;padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.25);
      background:#0f1c2d;color:#fff
    }

    /* Bottoni azzurri come in home */
    .btn{background:var(--accent);color:#fff;border:0;border-radius:10px;padding:10px 12px;cursor:pointer}
    .btn:hover{filter:brightness(.92)}
    .btn.small{padding:6px 8px;font-size:12px;line-height:1}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.light{background:rgba(255,255,255,.08);color:#fff}

    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:10px}
    @media (max-width:900px){.kpis{grid-template-columns:1fr 1fr}}
    @media (max-width:520px){.kpis{grid-template-columns:1fr}}
    .kpi{background:#0f1c2d;border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:12px}
    .kpi .n{font-size:28px;font-weight:700;margin-top:4px}
    .muted{color:#fff}
    .note{font-size:13px;color:#fff;margin-top:6px}

    .errorlog{background:#0b1623;border:1px dashed rgba(255,255,255,.25);padding:10px;border-radius:8px;font-size:12px;white-space:pre-wrap;color:#fff}
    .pillrow{display:flex;gap:8px;flex-wrap:wrap}
    .chip{cursor:pointer;display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.25);background:#0f1c2d;color:#fff}
    .chip.active{outline:3px solid #ffd24d;box-shadow:0 0 0 3px rgba(255,210,77,.25)}
    .flex{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .right{text-align:right}
    #loading{display:none}

    table.table{width:100%;border-collapse:collapse;margin-top:10px;color:#fff}
    table.table th, table.table td{border:1px solid rgba(255,255,255,.15);padding:8px;text-align:left;vertical-align:top}
    table.table th{background:#0f1c2d}

    /* Larghezze fisse + a capo multiplo nelle colonne date/città */
    #detailTable table.table{table-layout:fixed}
    #detailTable table.table th:nth-child(1), #detailTable table.table td:nth-child(1){width:90px}
    #detailTable table.table th:nth-child(2), #detailTable table.table td:nth-child(2){width:auto}
    #detailTable table.table th:nth-child(3), #detailTable table.table td:nth-child(3){width:120px}
    #detailTable table.table th:nth-child(4), #detailTable table.table td:nth-child(4){width:220px;white-space:pre-line}
    #detailTable table.table th:nth-child(5), #detailTable table.table td:nth-child(5){width:160px;white-space:pre-line}
    #detailTable table.table th:nth-child(6), #detailTable table.table td:nth-child(6){width:220px}

    /* Niente sbiadimento del blocco cancellazioni */
    #delBlock.disabled{opacity:1}
  </style>

  <!-- Overlay login (stesso meccanismo dell'admin) -->
  <script>
    (function(){
      const CFG = window.SQ_CONFIG || {};
      const SUPABASE_URL  = CFG.SUPABASE_URL  || "https://rubdzlnolxcgpjklfggk.supabase.co";
      const SUPABASE_ANON = CFG.SUPABASE_ANON || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1YmR6bG5vbHhjZ3Bqa2xmZ2drIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4OTI3NjQsImV4cCI6MjA3MjQ2ODc2NH0.Fhq7lKdx1OcyuCWOnHqNH7Omsg7qjdQVzxvNqZyeQQ8";
      if (!window.supabase) { document.body.style.visibility = 'visible'; return; }
      window.sb = window.sb || window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth:{ persistSession:true, autoRefreshToken:true } });

      async function ensureAuth(){
        try{
          const { data:{ session } } = await window.sb.auth.getSession();
          if (session){ document.body.style.visibility='visible'; return; }
        }catch(e){ console.warn('getSession', e); document.body.style.visibility='visible'; return; }

        const box = document.createElement('div');
        box.id = 'sq-login';
        box.style.cssText = 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:999999';
        box.innerHTML = `
          <div class="card" style="background:#141419;border:1px solid #24242c;border-radius:12px;padding:20px;max-width:360px;width:92%">
            <h2 style="color:#fff">Accesso</h2>
            <p class="small" style="color:#fff">Inserisci email e password</p>
            <input id="sq-email" type="email" placeholder="Email" autocomplete="username" style="width:100%;padding:12px;border-radius:10px;border:1px solid #2a2a33;background:#0f0f14;color:#f7f7fb;margin:8px 0">
            <input id="sq-pass" type="password" placeholder="Password" autocomplete="current-password" style="width:100%;padding:12px;border-radius:10px;border:1px solid #2a2a33;background:#0f0f14;color:#f7f7fb;margin:8px 0">
            <div class="small" id="sq-err" style="min-height:18px;color:#ffb4b4"></div>
            <button id="sq-go" class="btn primary" style="width:100%;padding:12px">Entra</button>
          </div>`;
        document.body.appendChild(box);
        document.body.style.visibility='visible';
        document.getElementById('sq-go').addEventListener('click', async ()=>{
          const email = (document.getElementById('sq-email').value||'').trim();
          const password = document.getElementById('sq-pass').value;
          const err = document.getElementById('sq-err');
          err.textContent = '';
          try{
            const { error } = await window.sb.auth.signInWithPassword({ email, password });
            if (error){ err.textContent = error.message || 'Accesso non riuscito'; return; }
            box.remove();
          }catch(e){ err.textContent = e?.message || String(e); }
        });
      }
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', ensureAuth);
      else ensureAuth();
    })();
  </script>
</head>
<body>
<header class="header">
  <a href="admin.html" class="logo" aria-label="Torna ad admin">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true"><path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/><circle cx="32" cy="24" r="9" fill="#ffffff"/></svg>
    <span class="wordmark">stasera qui</span>
  </a>
</header>

<main class="wrap">
  <h1 style="margin:8px 0 14px;color:#fff">Report</h1>

  <div class="card">
    <h2 style="color:#fff">Filtri</h2>
    <div class="grid3">
      <div>
        <label class="small">Data evento — dal</label>
        <input type="date" id="f_evt_from" autocomplete="off">
      </div>
      <div>
        <label class="small">Data evento — al</label>
        <input type="date" id="f_evt_to" autocomplete="off">
      </div>
      <div>
        <label class="small">Città (separa con virgola)</label>
        <input type="text" id="f_cities" placeholder="Es. Torino, Milano" autocomplete="off">
      </div>
    </div>

    <div class="grid">
      <div>
        <label class="small">Data caricamento — dal</label>
        <input type="date" id="f_up_from" autocomplete="off">
      </div>
      <div>
        <label class="small">Data caricamento — al</label>
        <input type="date" id="f_up_to" autocomplete="off">
      </div>
    </div>

    <div class="grid" id="delBlock">
      <div>
        <label class="small">Data cancellazione — dal</label>
        <input type="date" id="f_del_from" autocomplete="off">
      </div>
      <div>
        <label class="small">Data cancellazione — al</label>
        <input type="date" id="f_del_to" autocomplete="off">
      </div>
    </div>
    <div class="note" id="delNote" style="display:none">Dato cancellazioni non disponibile: nessuna tabella/colonna di log trovata. (Va bene così se elimini definitivamente dal DB.)</div>

    <div style="margin-top:10px">
      <label class="small">Categorie (opzionali)</label>
      <div id="catRow" class="pillrow" style="margin-top:6px"></div>
    </div>

    <div class="flex" style="justify-content:flex-end;margin-top:10px">
      <button class="btn" id="btnClear" type="button">Azzera filtri</button>
      <button class="btn primary" id="btnApply" type="button">Applica</button>
    </div>
    <div id="loading" class="note">Caricamento…</div>
  </div>

  <div class="kpis">
    <div class="kpi">
      <div class="muted">Attualmente in sito</div>
      <div class="n" id="k_now">—</div>
      <div class="note">Eventi pubblicati con almeno un’occorrenza futura (filtri applicati).</div>
    </div>
    <div class="kpi">
      <div class="muted">Scaduti</div>
      <div class="n" id="k_expired">—</div>
      <div class="note">Tutte le occorrenze nel passato (filtri applicati).</div>
    </div>
    <div class="kpi">
      <div class="muted">Caricati</div>
      <div class="n" id="k_uploaded">—</div>
      <div class="note">Eventi creati nel periodo di caricamento (filtri applicati).</div>
    </div>
    <div class="kpi">
      <div class="muted">Cancellati</div>
      <div class="n" id="k_deleted">—</div>
      <div class="note" id="k_deleted_note">Se è disponibile un log di cancellazione.</div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="flex" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0;color:#fff">Dettagli (facoltativo)</h2>
      <button class="btn small" id="btnCSV" type="button" title="Esporta i dettagli filtrati">Scarica CSV dettagli</button>
    </div>
    <p class="small muted" style="margin:6px 0 0">Elenco coerente con i filtri impostati. (Massimo 200 righe mostrate per non appesantire.)</p>
    <div id="detailTable" class="small" style="color:#fff">—</div>
  </div>

  <div class="card" style="margin-top:12px">
    <h2 style="color:#fff">Log errori</h2>
    <div id="errlog" class="errorlog">Nessun errore.</div>
  </div>
</main>

<footer class="page-footer">
  <a class="btn" href="admin.html">← Torna ad admin</a>
</footer>

<script>
(function(){
  const $  = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const errlog = $('#errlog');
  const logErr = (m)=>{ errlog.textContent = (errlog.textContent==='Nessun errore.'?'':(errlog.textContent+'\\n')) + m; };
  const todayISO = ()=> new Date().toISOString().slice(0,10);
  const inRange = (d,from,to)=> { if (!d) return false; if (from && d < from) return false; if (to && d > to) return false; return true; };
  const normCats = (raw)=>{ const c=(raw?.categories??raw?.categorie??[]); if(Array.isArray(c))return c.filter(Boolean).map(String);
    if(c==null)return[]; if(typeof c==='string'){ try{const j=JSON.parse(c); if(Array.isArray(j)) return j.filter(Boolean).map(String);}catch(_){}
    if(c.includes(','))return c.split(',').map(s=>s.trim()).filter(Boolean); return c.trim()?[c.trim()]:[] } return[] };
  const truthy = v => (v===true||v===1||v==='1'||v==='t'||v==='true'||v==='T'||v==='TRUE');

  const CATS = ['Musica','Food & Drink','Sagre & Fiere','Famiglie & Bambini','Sport','Nightlife','Cultura/Spettacolo','Mercatini'];
  const catRow = $('#catRow');
  CATS.forEach(c=>{
    const el = document.createElement('div');
    el.className='chip'; el.textContent=c; el.dataset.cat=c;
    el.addEventListener('click', ()=> el.classList.toggle('active'));
    catRow.appendChild(el);
  });

  const CFG = window.SQ_CONFIG || {};
  const SUPABASE_URL  = CFG.SUPABASE_URL  || "https://rubdzlnolxcgpjklfggk.supabase.co";
  const SUPABASE_ANON = CFG.SUPABASE_ANON || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1YmR6bG5vbHhjZ3Bqa2xmZ2drIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4OTI3NjQsImV4cCI6MjA3MjQ2ODc2NH0.Fhq7lKdx1OcyuCWOnHqNH7Omsg7qjdQVzxvNqZyeQQ8";
  const sb = window.sb || (window.sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth:{ persistSession:true, autoRefreshToken:true } }));

  // Stato dati
  let EVENTS = [], OCCS = [], DELETES = [], deleteSupport = false;
  let LAST_DETAIL_ROWS = [];

  async function loadData(){
    $('#loading').style.display='block';
    try{
      const { data: evs } = await sb.from('events')
        .select('id,title,created_at,published,categories').order('created_at',{ascending:false}).limit(5000);
      EVENTS = (evs||[]).map(e=>({ id:e.id, title:e.title||'(evento)', created_at:(e.created_at||'').slice(0,10), published: (!('published' in e) ? true : truthy(e.published)), _cats: normCats(e) }));

      const { data: occs } = await sb.from('occurrences')
        .select('event_id,data,date,citta,city').order('data',{ascending:false}).limit(20000);
      OCCS = (occs||[]).map(o=>({ event_id:o.event_id, data:(o.data||o.date||'')||null, citta:(o.citta||o.city||'').toString().trim() }));

      deleteSupport = false; DELETES = [];
      try {
        const { data: d1 } = await sb.from('events_deleted')
          .select('event_id,deleted_at,city,citta,categories').order('deleted_at',{ascending:false}).limit(10000);
        if (Array.isArray(d1)) {
          DELETES = d1.map(r=>({ event_id:r.event_id||r.id||null, deleted_at:r.deleted_at?String(r.deleted_at).slice(0,10):null, citta:(r.citta||r.city||'').toString().trim(), _cats:normCats(r) }));
          deleteSupport = true;
        }
      } catch(_) {}
      if (!deleteSupport){
        try{
          const { data: ed2 } = await sb.from('events')
            .select('id,deleted_at,categories').not('deleted_at','is',null).order('deleted_at',{ascending:false}).limit(10000);
          if (Array.isArray(ed2)){
            DELETES = ed2.map(r=>({ event_id:r.id, deleted_at:r.deleted_at?String(r.deleted_at).slice(0,10):null, citta:'', _cats:normCats(r) }));
            if (DELETES.length>0) deleteSupport = true;
          }
        }catch(_){}
      }
      if (!deleteSupport){
        try {
          const { data: d2 } = await sb.from('deleted_events')
            .select('event_id,deleted_at,city,citta,categories').order('deleted_at',{ascending:false}).limit(10000);
          if (Array.isArray(d2)) {
            DELETES = d2.map(r=>({ event_id:r.event_id||r.id||null, deleted_at:r.deleted_at?String(r.deleted_at).slice(0,10):null, citta:(r.citta||r.city||'').toString().trim(), _cats:normCats(r) }));
            deleteSupport = true;
          }
        } catch(_){}
      }

      if (!deleteSupport){
        $('#delBlock').classList.add('disabled');
        $('#delNote').style.display='block';
        $('#k_deleted_note').textContent = 'N/D (nessun log cancellazioni).';
      } else {
        $('#delBlock').classList.remove('disabled');
        $('#delNote').style.display='none';
        $('#k_deleted_note').textContent = 'Filtrabile per data canc. se il log è disponibile.';
      }
    }catch(e){
      logErr('Caricamento: '+(e?.message||e));
    }finally{
      $('#loading').style.display='none';
    }
  }

  function getActiveCats(){ return new Set($$('#catRow .chip.active').map(x=>x.dataset.cat)); }
  function parseCities(){ const raw=($('#f_cities').value||'').trim(); if(!raw) return []; return raw.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean); }

  function eventMatchesCatsCities(ev, occsOfEvent, cities, cats){
    if (cats.size>0){ if (!ev._cats || !ev._cats.some(c=>cats.has(c))) return false; }
    if (cities.length>0){ const ok = occsOfEvent.some(o => o.citta && cities.includes(o.citta.toLowerCase())); if (!ok) return false; }
    return true;
  }

  function apply(){
    try{
      const evtFrom = $('#f_evt_from').value || null;
      const evtTo   = $('#f_evt_to').value   || null;
      const upFrom  = $('#f_up_from').value  || null;
      const upTo    = $('#f_up_to').value    || null;
      const delFrom = $('#f_del_from').value || null;
      const delTo   = $('#f_del_to').value   || null;

      const cities  = parseCities();
      const cats    = getActiveCats();

      const hasUpFilter  = !!(upFrom || upTo);
      const hasDelFilter = !!(delFrom || delTo);
      const today = todayISO();

      const occByEv = new Map();
      OCCS.forEach(o=>{ if(!occByEv.has(o.event_id)) occByEv.set(o.event_id, []); occByEv.get(o.event_id).push(o); });

      const eventsPub = EVENTS.filter(e => e.published !== false);

      let k_now=0, k_expired=0, k_uploaded=0, k_deleted='N/D';

      for (const ev of eventsPub){
        if (hasUpFilter){
          const c = ev.created_at || null;
          if (!c || !inRange(c, upFrom, upTo)) continue;
        }
        const occAll = occByEv.get(ev.id) || [];
        if (!eventMatchesCatsCities(ev, occAll, cities, cats)) continue;

        const occ = occAll.filter(o=>{ if(!o.data) return false; if (evtFrom || evtTo) return inRange(o.data, evtFrom, evtTo); return true; });
        if (occ.length===0) continue;

        const hasFuture = occ.some(o=>o.data >= today);
        const hasPastOnly = !hasFuture && occ.every(o=>o.data < today);
        if (hasFuture) k_now++; else if (hasPastOnly) k_expired++;
      }

      for (const ev of eventsPub){
        if (hasUpFilter){
          const c = ev.created_at || null;
          if (!c || !inRange(c, upFrom, upTo)) continue;
        } else {
          const occAll = occByEv.get(ev.id) || [];
          if (!eventMatchesCatsCities(ev, occAll, cities, cats)) continue;
        }
        k_uploaded++;
      }

      if (deleteSupport){
        const delRows = DELETES.filter(r=>{
          if (hasDelFilter){ const d=r.deleted_at||null; if(!d || !inRange(d, delFrom, delTo)) return false; }
          if (cats.size>0){ if(!r._cats || !r._cats.some(c=>cats.has(c))) return false; }
          if (cities.length>0){ if(!r.citta) return false; if(!cities.includes(String(r.citta).toLowerCase())) return false; }
          return true;
        });
        k_deleted = String(delRows.length);
      }

      $('#k_now').textContent      = String(k_now);
      $('#k_expired').textContent  = String(k_expired);
      $('#k_uploaded').textContent = String(k_uploaded);
      $('#k_deleted').textContent  = String(k_deleted);

      const rows = [];
      const pushRow = (type, ev, occ)=>{
        const dates  = (occ||[]).map(o=>o.data).filter(Boolean).sort().join('\n');
        const citiesCell = (occ||[]).map(o=>o.citta).filter(Boolean).join('\n');
        rows.push([ type, ev.title||'(evento)', ev.created_at||'', dates, citiesCell, (ev._cats||[]).join(', ') ]);
      };

      const hasDeleteList = deleteSupport && hasDelFilter;

      if (hasDeleteList){
        const evMap = new Map(eventsPub.map(e=>[e.id, e]));
        const filteredDeletes = DELETES.filter(r=>{
          if (hasDelFilter){ const d=r.deleted_at||null; if(!d || !inRange(d, delFrom, delTo)) return false; }
          if (cats.size>0 && (!r._cats || !r._cats.some(c=>cats.has(c)))) return false;
          if (cities.length>0){ if(!r.citta) return false; if(!cities.includes(String(r.citta).toLowerCase())) return false; }
          return true;
        });
        for (const r of filteredDeletes){
          const ev = evMap.get(r.event_id) || { title:'(evento cancellato)', created_at:'', _cats:r._cats||[] };
          const fakeOcc = r.citta ? [{ data:'', citta:r.citta }] : [];
          if (rows.length < 200) pushRow('CANCELLATO', ev, fakeOcc);
        }
      } else {
        for (const ev of eventsPub){
          if (hasUpFilter){ const c=ev.created_at||null; if(!c || !inRange(c, upFrom, upTo)) continue; }
          const occAll = occByEv.get(ev.id) || [];
          if (!eventMatchesCatsCities(ev, occAll, cities, cats)) continue;
          const occ = occAll.filter(o=>{ if(!o.data) return false; if (evtFrom || evtTo) return inRange(o.data, evtFrom, evtTo); return true; });
          if (occ.length===0) continue;
          const hasFuture = occ.some(o=>o.data >= today);
          const hasPastOnly = !hasFuture && occ.every(o=>o.data < today);
          if (hasFuture && rows.length<200) pushRow('NOW', ev, occ);
          else if (hasPastOnly && rows.length<200) pushRow('SCADUTO', ev, occ);
        }
      }

      LAST_DETAIL_ROWS = rows.slice();

      if (!rows.length){
        $('#detailTable').textContent = '— Nessun evento da mostrare con questi filtri —';
      } else {
        const head = ['Stato','Titolo','Caricato il','Date evento','Città','Categorie'];
        const escape = s => (s||'').toString().replace(/[<>&]/g, m=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[m]));
        const bodyRows = rows.map(r=>`<tr>${r.map(c=>`<td>${escape(c==null?'':String(c))}</td>`).join('')}</tr>`).join('');
        const totalShown = rows.length;
        $('#detailTable').innerHTML = `
          <table class="table" aria-label="Dettaglio eventi">
            <thead><tr>${head.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
            <tbody>${bodyRows}</tbody>
            <tfoot>
              <tr><th colspan="5" class="right">Totale righe mostrate</th><th>${totalShown}</th></tr>
            </tfoot>
          </table>`;
      }
    }catch(e){ logErr('Apply: '+(e?.message||e)); }
  }

  $('#btnClear').addEventListener('click', ()=>{
    ['f_cities','f_evt_from','f_evt_to','f_up_from','f_up_to','f_del_from','f_del_to'].forEach(id=> $('#'+id).value='');
    $$('#catRow .chip.active').forEach(x=>x.classList.remove('active'));
    apply();
  });
  $('#btnApply').addEventListener('click', apply);

  // CSV esportazione
  let LAST_DETAIL_ROWS = [];
  $('#btnCSV').addEventListener('click', ()=>{
    try{
      if (!LAST_DETAIL_ROWS.length){ alert('Niente da esportare: applica dei filtri o carica i dati.'); return; }
      const head = ['Stato','Titolo','Caricato il','Date evento','Città','Categorie'];
      const q = (s)=> `"${ String(s==null?'':s).replace(/"/g,'""').replace(/\n/g,' | ') }"`;
      const lines = [ head.join(','), ...LAST_DETAIL_ROWS.map(r=> r.map(q).join(',')) ];
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'staseraqui_report_dettagli.csv'; document.body.appendChild(a); a.click(); a.remove();
    }catch(e){ logErr('CSV: '+(e?.message||e)); }
  });

  (async function init(){ await loadData(); apply(); document.body.style.visibility='visible'; })();

})();
</script>
</body>
</html>
