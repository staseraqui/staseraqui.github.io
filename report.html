<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Report — Stasera Qui</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/style.css?v=12">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="assets/app-config.js?v=6"></script>
  <style>
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    table{width:100%;border-collapse:collapse;margin:10px 0}
    th,td{border:1px solid rgba(255,255,255,.15);padding:8px;text-align:left}
    th{background:#0f1c2d}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
    @media print{ .toolbar, .page-footer { display:none } body{background:#fff;color:#000} th,td{border-color:#000} }
  </style>
</head>
<body>
<header class="header" style="padding:0 16px">
  <a href="admin.html" class="logo" aria-label="Torna all'area admin">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true"><path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/><circle cx="32" cy="24" r="9" fill="#ffffff"/></svg>
    <span class="wordmark">stasera qui</span>
  </a>
</header>

<main class="wrap">
  <h1 style="margin:8px 0 12px">Report automatico</h1>
  <div class="toolbar">
    <button class="btn" id="btnReload" type="button">Aggiorna ora</button>
    <button class="btn" id="btnPrint"  type="button">Stampa</button>
    <button class="btn primary" id="btnCSV" type="button">Scarica Excel (CSV)</button>
  </div>

  <div id="note" class="small" style="margin-bottom:8px;opacity:.8"></div>

  <h2 style="margin:10px 0 6px">Ieri</h2>
  <div id="boxY"></div>

  <h2 style="margin:16px 0 6px">Settimana in corso</h2>
  <div id="boxW"></div>

  <h2 style="margin:16px 0 6px">Mese in corso</h2>
  <div id="boxM"></div>
</main>

<footer class="page-footer"><a class="btn" href="admin.html">← Torna all’area admin</a></footer>

<script>
(async function(){
  const CFG = window.SQ_CONFIG || {};
  const sb = supabase.createClient(CFG.SUPABASE_URL, CFG.SUPABASE_ANON);

  const $ = s=>document.querySelector(s);
  const todayISO = () => new Date().toISOString().slice(0,10);

  function weekStart(d=new Date()){ const x=new Date(d); const day=x.getDay()||7; x.setDate(x.getDate()-day+1); x.setHours(0,0,0,0); return x; } // lunedì
  function monthStart(d=new Date()){ return new Date(d.getFullYear(), d.getMonth(), 1); }
  function isoDate(d){ return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); }

  function groupAgg(rows, keyFn, catFn){
    // ritorna { key -> { inseriti, scaduti, eliminati, nascosti } } aggregati
    const map = new Map();
    rows.forEach(r=>{
      const k = keyFn(r) || '—';
      if (!map.has(k)) map.set(k, { inseriti:0, scaduti:0, eliminati:0, nascosti:0 });
      const agg = map.get(k);
      agg.inseriti += r.inseriti||0;
      agg.scaduti  += r.scaduti||0;
      agg.eliminati+= r.eliminati||0;
      agg.nascosti += r.nascosti||0;
      map.set(k, agg);
    });
    // ritorna array ordinato
    return [...map.entries()].map(([k,v])=>({ key:k, ...v })).sort((a,b)=> b.inseriti - a.inseriti);
  }

  function renderTable(rows, label){
    if (!rows.length) return '<div class="small">Nessun dato.</div>';
    let html = `<table aria-label="${label}"><thead><tr>
      <th>${label}</th><th>Inseriti</th><th>Scaduti</th><th>Eliminati</th><th>Nascosti</th></tr></thead><tbody>`;
    rows.forEach(r=>{
      html += `<tr><td>${r.key}</td><td>${r.inseriti}</td><td>${r.scaduti}</td><td>${r.eliminati}</td><td>${r.nascosti}</td></tr>`;
    });
    html += '</tbody></table>';
    return html;
  }

  async function loadAll(){
    $('#note').textContent = 'Se “Regione” risulta N/D, aggiungi la colonna `regione` in `occurrences` per abilitarla nei raggruppamenti.';
    const today = todayISO();
    const y = new Date(); y.setDate(y.getDate()-1);
    const ieri = isoDate(y);
    const wStart = isoDate(weekStart());
    const mStart = isoDate(monthStart());

    // Carico eventi e occorrenze
    const { data: events } = await sb.from('events').select('id, created_at, published, deleted_at, categories, categorie');
    const { data: occs }   = await sb.from('occurrences').select('id, event_id, data, citta, city, regione, deleted_at');

    // Helper categorie
    const catsOf = e => (Array.isArray(e?.categories) ? e.categories : (Array.isArray(e?.categorie) ? e.categorie : []));

    function buildPeriodRows(startISO, endISOExclusive){
      // Inseriti: events.created_at nel periodo
      const inseritiEvIds = new Set((events||[]).filter(e=>{
        const t = (e.created_at||'').slice(0,10);
        return t && t >= startISO && t < endISOExclusive;
      }).map(e=> e.id));

      // Eliminati: events.deleted_at nel periodo
      const eliminatiEvIds = new Set((events||[]).filter(e=>{
        const d=(e.deleted_at||'').slice(0,10);
        return d && d >= startISO && d < endISOExclusive;
      }).map(e=> e.id));

      // Nascosti: published=false con updated_at nel periodo (se esiste); altrimenti approximazione: published=false ad oggi
      // NB: senza updated_at non possiamo sapere "quando" è stato nascosto → contiamo lo stato attuale nel periodo = 0 e segnaliamo a piè pagina
      const nascostiNowIds = new Set((events||[]).filter(e=> e.published===false && !e.deleted_at).map(e=> e.id));

      // Scaduti: occorrenze con data < today e data nel periodo
      const scaduteOcc = (occs||[]).filter(o=>{
        return o.data && o.data >= startISO && o.data < endISOExclusive && o.data < today;
      });

      // Aggrego per Città / Regione / Categoria
      const rowsCity=[], rowsReg=[], rowsCat=[];

      // Mappa di appoggio per recuperare occorrenze per evento (per città/regione)
      const occByEvent = new Map();
      (occs||[]).forEach(o=>{
        if (!occByEvent.has(o.event_id)) occByEvent.set(o.event_id, []);
        occByEvent.get(o.event_id).push(o);
      });

      // Per ogni evento, costruiamo righe aggregate
      (events||[]).forEach(e=>{
        const evId = e.id;
        const evCats = catsOf(e);
        const evOccs = occByEvent.get(evId)||[];

        // City/Regione prendiamo la PRIMA occorrenza nel periodo per etichettare (semplificazione)
        const firstOccInPeriod = evOccs.find(o => o.data && o.data >= startISO && o.data < endISOExclusive);

        const city = (firstOccInPeriod?.citta || firstOccInPeriod?.city || '—');
        const reg  = (firstOccInPeriod?.regione || 'N/D');

        const rBase = {
          inseriti: inseritiEvIds.has(evId) ? 1 : 0,
          eliminati: eliminatiEvIds.has(evId) ? 1 : 0,
          nascosti: nascostiNowIds.has(evId) ? 1 : 0,
          scaduti: 0 // calcolato sotto tramite occorrenze
        };

        // scaduti: contiamo quante occorrenze scadute nel periodo appartengono all’evento (1 per evento, non occorrenze)
        if (scaduteOcc.some(o => o.event_id===evId)) rBase.scaduti = 1;

        // città
        rowsCity.push({ key: city, ...rBase });

        // regione
        rowsReg.push({ key: reg, ...rBase });

        // categoria (1 riga per ciascuna categoria dell’evento)
        if (evCats.length){
          evCats.forEach(c => rowsCat.push({ key:c, ...rBase }));
        } else {
          rowsCat.push({ key:'—', ...rBase });
        }
      });

      return {
        city: groupAgg(rowsCity, r=>r.key),
        reg:  groupAgg(rowsReg,  r=>r.key),
        cat:  groupAgg(rowsCat,  r=>r.key)
      };
    }

    function renderPeriod(boxId, startISO, endISO){
      const res = buildPeriodRows(startISO, endISO);
      $(boxId).innerHTML =
        `<h3 style="margin:6px 0">Per città</h3>${renderTable(res.city,'Città')}` +
        `<h3 style="margin:10px 0 6px">Per regione</h3>${renderTable(res.reg,'Regione')}` +
        `<h3 style="margin:10px 0 6px">Per categoria</h3>${renderTable(res.cat,'Categoria')}`;
      return res;
    }

    // Ieri
    const y = new Date(); y.setDate(y.getDate()-1);
    const yStart = isoDate(y), yEnd = today;
    const resY = renderPeriod('#boxY', yStart, yEnd);

    // Settimana
    const wStartISO = isoDate(weekStart()), wEndISO = isoDate(new Date(new Date().setDate(new Date().getDate()+1)));
    const resW = renderPeriod('#boxW', wStartISO, wEndISO);

    // Mese
    const mStartISO = isoDate(monthStart()), mEndISO = wEndISO;
    const resM = renderPeriod('#boxM', mStartISO, mEndISO);

    // CSV export (tutte e tre le sezioni in un unico file)
    $('#btnCSV').onclick = ()=>{
      function blockToCSV(rows, title){
        const head = `${title},Inseriti,Scaduti,Eliminati,Nascosti`;
        const lines = rows.map(r=> `${r.key},${r.inseriti},${r.scaduti},${r.eliminati},${r.nascosti}`);
        return [head, ...lines].join('\n');
      }
      const parts = [];
      parts.push('IERI - CITTÀ'); parts.push(blockToCSV(resY.city,'Città'));
      parts.push('\nIERI - REGIONE'); parts.push(blockToCSV(resY.reg,'Regione'));
      parts.push('\nIERI - CATEGORIA'); parts.push(blockToCSV(resY.cat,'Categoria'));

      parts.push('\nSETTIMANA - CITTÀ'); parts.push(blockToCSV(resW.city,'Città'));
      parts.push('\nSETTIMANA - REGIONE'); parts.push(blockToCSV(resW.reg,'Regione'));
      parts.push('\nSETTIMANA - CATEGORIA'); parts.push(blockToCSV(resW.cat,'Categoria'));

      parts.push('\nMESE - CITTÀ'); parts.push(blockToCSV(resM.city,'Città'));
      parts.push('\nMESE - REGIONE'); parts.push(blockToCSV(resM.reg,'Regione'));
      parts.push('\nMESE - CATEGORIA'); parts.push(blockToCSV(resM.cat,'Categoria'));

      const blob = new Blob([parts.join('\n')], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `staseraqui_report_${today}.csv`;
      a.click();
    };

    $('#btnPrint').onclick = ()=> window.print();
    $('#btnReload').onclick = ()=> location.reload();
  })();
</script>
</body>
</html>
