<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Report — Stasera Qui</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/style.css?v=12">
  <script src="assets/app-config.js?v=2"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .controls .field{display:flex;flex-direction:column;gap:6px}
    .controls input,.controls select{background:#fff;color:#1c2a3a;border:1px solid rgba(0,0,0,.18);border-radius:10px;padding:10px 12px}
    .muted{color:#b8c2ce}
    .cards{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:12px 0}
    @media (max-width:960px){.cards{grid-template-columns:1fr 1fr}}
    @media (max-width:640px){.cards{grid-template-columns:1fr}}
    .kpi{background:var(--panel);border:1px solid var(--panel-border);border-radius:12px;padding:14px}
    .kpi h3{margin:0 0 6px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:top}
    th{color:#b8c2ce;text-align:left}
    tbody tr:hover{background:rgba(255,255,255,.03)}
    #err{color:#ffb4b4;font-weight:700;margin:10px 0}
  </style>
</head>
<body>
<header class="header">
  <a href="index.html" class="logo">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true"><path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/><circle cx="32" cy="24" r="9" fill="#ffffff"/></svg>
    <span class="wordmark">stasera qui</span>
  </a>
</header>

<main class="wrap">
  <h1 style="margin:8px 0 12px">Report</h1>

  <div id="err"></div>

  <div class="card">
    <div class="controls">
      <div class="field">
        <label for="mode">Modalità</label>
        <select id="mode">
          <option value="occ">Eventi per data occorrenza</option>
          <option value="pub">Eventi per data pubblicazione</option>
          <option value="del">Eventi annullati</option>
        </select>
      </div>
      <div class="field">
        <label for="from">Dal</label>
        <input type="date" id="from">
      </div>
      <div class="field">
        <label for="to">Al</label>
        <input type="date" id="to">
      </div>
      <div class="field" style="min-width:220px">
        <label for="city">Città</label>
        <select id="city">
          <option value="">(Tutte)</option>
        </select>
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <button class="btn primary" id="runBtn" type="button">Aggiorna</button>
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <a class="btn" href="admin.html">← Torna ad Admin</a>
      </div>
    </div>
  </div>

  <div class="cards">
    <div class="kpi">
      <h3>Totale eventi</h3>
      <div id="kpiEvents" style="font-size:28px;font-weight:800">—</div>
      <div class="muted small" id="kpiEventsNote"> </div>
    </div>
    <div class="kpi">
      <h3>Totale occorrenze</h3>
      <div id="kpiOccs" style="font-size:28px;font-weight:800">—</div>
      <div class="muted small" id="kpiOccsNote"> </div>
    </div>
    <div class="kpi">
      <h3>Città</h3>
      <div id="kpiCities" style="font-size:28px;font-weight:800">—</div>
      <div class="muted small" id="kpiCitiesNote"> </div>
    </div>
  </div>

  <div class="card">
    <h3 id="tblTitle" style="margin-top:0">Risultati</h3>
    <div class="muted small" id="tblSubtitle"></div>
    <div style="overflow:auto;margin-top:8px">
      <table id="tbl">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</main>

<script>
(function(){
  // ====== CONFIG ======
  const CFG = window.SQ_CONFIG || {};
  const SB_URL  = CFG.SUPABASE_URL;
  const SB_ANON = CFG.SUPABASE_ANON;
  if(!SB_URL || !SB_ANON){
    document.getElementById('err').textContent =
      'Chiavi mancanti in assets/app-config.js (SUPABASE_URL / SUPABASE_ANON).';
    return;
  }
  const sb = supabase.createClient(SB_URL, SB_ANON);

  // ====== UTILS ======
  const $ = s => document.querySelector(s);
  const fmtIT = iso => { if(!iso) return ''; const [y,m,d]=iso.split('T')[0].split('-'); return `${d}/${m}/${y}`; };
  const properCity = s => {
    s = (s||'').trim();
    if(!s) return '';
    const low = s.toLowerCase();
    // Capitalizza ogni parola
    return low.replace(/\b\p{L}+/gu, w => w.charAt(0).toUpperCase()+w.slice(1));
  };
  const normCity = s => (s||'').trim().toLowerCase();

  function rangeNote(from, to){
    const a = from ? fmtIT(from) : '—';
    const b = to   ? fmtIT(to)   : '—';
    return `Periodo: ${a} → ${b}`;
  }

  // ====== ELEMENTI ======
  const modeEl = $('#mode'), fromEl = $('#from'), toEl = $('#to'), cityEl = $('#city');
  const kEv = $('#kpiEvents'), kOc = $('#kpiOccs'), kCi = $('#kpiCities');
  const kEvN = $('#kpiEventsNote'), kOcN = $('#kpiOccsNote'), kCiN = $('#kpiCitiesNote');
  const th = $('#tbl thead'), tb = $('#tbl tbody'), sub = $('#tblSubtitle'), title = $('#tblTitle');

  // Default: ultimi 30 giorni
  const today = new Date(); const toISO = today.toISOString().slice(0,10);
  const fromISO = new Date(today.getFullYear(), today.getMonth(), today.getDate()-30).toISOString().slice(0,10);
  fromEl.value = fromISO; toEl.value = toISO;

  // ====== CARICAMENTO BASE (per menu Città) ======
  // Carico qualche dato per popolare la tendina città in modo robusto:
  // - tutte le occorrenze ultimi 180 giorni (basta per menu), e in più tutti i deletions ultimi 180 giorni
  // - normalizzazione case-insensitive
  let CITY_SET = new Map(); // normCity -> displayCity
  async function primeCities(){
    CITY_SET.clear();
    const since = new Date(); since.setDate(since.getDate()-180);
    const sinceISO = since.toISOString().slice(0,10);

    // Occorrenze per città (ultimi 6 mesi)
    const oc = await sb.from('occurrences')
      .select('citta')
      .gte('data', sinceISO)
      .limit(20000);
    if (!oc.error && oc.data){
      oc.data.forEach(r=>{
        const n = normCity(r.citta);
        if(n && !CITY_SET.has(n)) CITY_SET.set(n, properCity(r.citta));
      });
    }
    // Deletions per città (ultimi 6 mesi)
    const del = await sb.from('event_deletions')
      .select('city, created_at')
      .gte('created_at', sinceISO)
      .limit(20000);
    if (!del.error && del.data){
      del.data.forEach(r=>{
        const n = normCity(r.city);
        if(n && !CITY_SET.has(n)) CITY_SET.set(n, properCity(r.city));
      });
    }

    // Riempie il menu
    cityEl.innerHTML = '<option value="">(Tutte)</option>' +
      Array.from(CITY_SET.values()).sort().map(c=>`<option value="${normCity(c)}">${c}</option>`).join('');
  }

  // ====== LOGICA PRINCIPALE ======
  async function run(){
    $('#err').textContent = '';
    th.innerHTML = ''; tb.innerHTML = '';
    kEv.textContent = '—'; kOc.textContent = '—'; kCi.textContent = '—';
    kEvN.textContent = kOcN.textContent = kCiN.textContent = '';

    const mode = modeEl.value;
    const from = fromEl.value || null;
    const to   = toEl.value   || null;
    const cityNorm = cityEl.value || '';

    if (mode === 'occ'){
      await runOcc(from, to, cityNorm);
    } else if (mode === 'pub'){
      await runPub(from, to, cityNorm);
    } else {
      await runDel(from, to, cityNorm);
    }
  }

  // ------- Modalità: Eventi per data occorrenza -------
  async function runOcc(from, to, cityNorm){
    title.textContent = 'Eventi per data occorrenza';

    let q = sb.from('occurrences').select('id,event_id,data,ora,luogo,indirizzo,citta,lat,lng').order('data',{ascending:true}).limit(20000);
    if (from) q = q.gte('data', from);
    if (to)   q = q.lte('data', to);
    const ocRes = await q;
    if (ocRes.error){ $('#err').textContent = ocRes.error.message; return; }

    // City filter
    let occs = ocRes.data || [];
    if (cityNorm) occs = occs.filter(o => normCity(o.citta) === cityNorm);

    // Event ids
    const ids = Array.from(new Set(occs.map(o=>o.event_id))).filter(Boolean);
    let events = [];
    if (ids.length){
      // Carico eventi per quegli id
      const evRes = await sb.from('events')
        .select('id,title,titolo,categories,categorie,description,descrizione')
        .in('id', ids);
      if (!evRes.error && evRes.data) events = evRes.data;
    }
    const evById = new Map(events.map(e=>[e.id,e]));

    // KPI
    const cities = new Set(occs.map(o=> normCity(o.citta) ).filter(Boolean));
    kEv.textContent = ids.length;
    kOc.textContent = occs.length;
    kCi.textContent = cities.size;
    kEvN.textContent = rangeNote(from,to);
    kOcN.textContent = cityNorm ? `Città: ${properCity(cityNorm)}` : 'Città: tutte';
    kCiN.textContent = 'Città distinte nel range';

    // Tabella
    th.innerHTML = `<tr>
      <th>Data</th><th>Ora</th><th>Titolo</th><th>Città</th><th>Luogo</th><th>Indirizzo</th><th>Categorie</th>
    </tr>`;
    tb.innerHTML = occs.map(o=>{
      const ev = evById.get(o.event_id)||{};
      const title = ev.title || ev.titolo || '(evento)';
      const cats = (ev.categories || ev.categorie || []).join(', ');
      return `<tr>
        <td>${fmtIT(o.data)}</td>
        <td>${o.ora||''}</td>
        <td>${escapeHtml(title)}</td>
        <td>${escapeHtml(properCity(o.citta))}</td>
        <td>${escapeHtml(o.luogo||'')}</td>
        <td>${escapeHtml(o.indirizzo||'')}</td>
        <td>${escapeHtml(cats)}</td>
      </tr>`;
    }).join('') || `<tr><td colspan="7" class="muted">Nessun dato</td></tr>`;

    sub.textContent = `${occs.length} occorrenze — ${ids.length} eventi — ${cities.size} città. ${rangeNote(from,to)} ${cityNorm?(' — Città: '+properCity(cityNorm)) : ''}`;
  }

  // ------- Modalità: Eventi per data pubblicazione -------
  async function runPub(from, to, cityNorm){
    title.textContent = 'Eventi per data pubblicazione';

    // Carico eventi per data pubblicazione (created_at / inserted_at / createdAt)
    let q = sb.from('events').select('id,title,titolo,categories,categorie,description,descrizione,created_at,inserted_at,createdAt').order('created_at',{ascending:true}).limit(20000);
    if (from) q = q.gte('created_at', from);
    if (to)   q = q.lte('created_at', to);
    const evRes = await q;
    if (evRes.error){ $('#err').textContent = evRes.error.message; return; }
    let events = evRes.data || [];

    // Occorrenze per ricavare città & conteggio
    const ids = events.map(e=>e.id);
    let occByEvent = new Map();
    if (ids.length){
      const ocRes = await sb.from('occurrences').select('event_id,citta').in('event_id', ids).limit(50000);
      if (!ocRes.error && ocRes.data){
        const map = new Map();
        ocRes.data.forEach(o=>{
          if (!map.has(o.event_id)) map.set(o.event_id, []);
          map.get(o.event_id).push(o);
        });
        occByEvent = map;
      }
    }

    // Filtro città (se richiesto)
    if (cityNorm){
      events = events.filter(e=>{
        const arr = occByEvent.get(e.id)||[];
        return arr.some(o=> normCity(o.citta)===cityNorm );
      });
    }

    // KPI
    const occCount = events.reduce((sum,e)=> sum + ((occByEvent.get(e.id)||[]).length), 0);
    const cities = new Set();
    events.forEach(e=> (occByEvent.get(e.id)||[]).forEach(o=> cities.add(normCity(o.citta)) ));
    kEv.textContent = events.length;
    kOc.textContent = occCount;
    kCi.textContent = cities.has('') ? cities.size-1 : cities.size;
    kEvN.textContent = rangeNote(from,to);
    kOcN.textContent = cityNorm ? `Città: ${properCity(cityNorm)}` : 'Città: tutte';
    kCiN.textContent = 'Città degli eventi pubblicati';

    // Tabella
    th.innerHTML = `<tr>
      <th>Pubblicato</th><th>Titolo</th><th>Città (prima occ.)</th><th>#Occorrenze</th><th>Categorie</th>
    </tr>`;
    tb.innerHTML = events.map(e=>{
      const created = e.created_at || e.inserted_at || e.createdAt || '';
      const occs = occByEvent.get(e.id)||[];
      const firstCity = properCity((occs[0]?.citta)||'');
      const cats = (e.categories || e.categorie || []).join(', ');
      const title = e.title || e.titolo || '(evento)';
      return `<tr>
        <td>${created ? fmtIT(created) : ''}</td>
        <td>${escapeHtml(title)}</td>
        <td>${escapeHtml(firstCity)}</td>
        <td>${occs.length}</td>
        <td>${escapeHtml(cats)}</td>
      </tr>`;
    }).join('') || `<tr><td colspan="5" class="muted">Nessun dato</td></tr>`;

    sub.textContent = `${events.length} eventi pubblicati — ${occCount} occorrenze collegate. ${rangeNote(from,to)} ${cityNorm?(' — Città: '+properCity(cityNorm)) : ''}`;
  }

  // ------- Modalità: Eventi annullati -------
  async function runDel(from, to, cityNorm){
    title.textContent = 'Eventi annullati';

    let q = sb.from('event_deletions').select('event_id,title,city,created_at').order('created_at',{ascending:true}).limit(20000);
    if (from) q = q.gte('created_at', from);
    if (to)   q = q.lte('created_at', to);
    const delRes = await q;
    if (delRes.error){ $('#err').textContent = delRes.error.message; return; }
    let rows = delRes.data || [];

    if (cityNorm) rows = rows.filter(r => normCity(r.city)===cityNorm);

    // KPI
    const evIds = new Set(rows.map(r=>r.event_id));
    const cities = new Set(rows.map(r=>normCity(r.city)).filter(Boolean));
    kEv.textContent = evIds.size;
    kOc.textContent = rows.length;
    kCi.textContent = cities.size;
    kEvN.textContent = rangeNote(from,to);
    kOcN.textContent = cityNorm ? `Città: ${properCity(cityNorm)}` : 'Città: tutte';
    kCiN.textContent = 'Città (annullati)';

    // Tabella
    th.innerHTML = `<tr>
      <th>Data annullamento</th><th>Titolo</th><th>Città</th><th>Event ID</th>
    </tr>`;
    tb.innerHTML = rows.map(r=>`
      <tr>
        <td>${fmtIT(r.created_at||'')}</td>
        <td>${escapeHtml(r.title||'(evento)')}</td>
        <td>${escapeHtml(properCity(r.city))}</td>
        <td>${escapeHtml(r.event_id||'')}</td>
      </tr>
    `).join('') || `<tr><td colspan="4" class="muted">Nessun dato</td></tr>`;

    sub.textContent = `${rows.length} record di annullamento — ${evIds.size} eventi. ${rangeNote(from,to)} ${cityNorm?(' — Città: '+properCity(cityNorm)) : ''}`;
  }

  // ====== HELPERS ======
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  // ====== BIND ======
  $('#runBtn').addEventListener('click', run);
  modeEl.addEventListener('change', ()=> run());
  fromEl.addEventListener('change', ()=> run());
  toEl.addEventListener('change', ()=> run());
  cityEl.addEventListener('change', ()=> run());

  // ====== START ======
  (async ()=>{ await primeCities(); await run(); })();
})();
</script>
</body>
</html>
