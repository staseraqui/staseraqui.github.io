<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Report — Stasera Qui</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/style.css?v=10">
  <style>
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .filters{display:grid;grid-template-columns:1fr 1fr 1fr auto auto;gap:10px;margin:12px 0}
    @media(max-width:980px){.filters{grid-template-columns:1fr 1fr}}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:12px 0}
    .kpi{background:var(--panel);border:1px solid var(--panel-border);border-radius:12px;padding:14px}
    .kpi b{font-size:28px;display:block}
    .cols{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0}
    @media(max-width:980px){.kpis{grid-template-columns:repeat(2,1fr)}.cols{grid-template-columns:1fr}}
    .card.scroll{max-height:340px;overflow:auto}
    table{width:100%;border-collapse:collapse;background:var(--panel);border:1px solid var(--panel-border);border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
    th{background:#0f1c2d;position:sticky;top:0}
    .smallmuted{font-size:12px;color:#b8c2ce}
    #errBox{display:none;background:#3a0f0f;border:1px solid #7a2b2b;color:#ffdede;border-radius:12px;padding:12px;margin:12px 0;white-space:pre-wrap}
    #dbg{font-size:12px;color:#b8c2ce;margin-top:6px}
  </style>
  <script src="assets/app-config.js?v=2"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
<header class="header">
  <a href="index.html" class="logo">
    <svg class="pin" viewBox="0 0 64 72" aria-hidden="true"><path d="M32 0c13.255 0 24 10.745 24 24 0 17.5-24 40-24 40S8 41.5 8 24C8 10.745 18.745 0 32 0z" fill="#22b3f0"/><circle cx="32" cy="24" r="9" fill="#ffffff"/></svg>
    <span class="wordmark">stasera qui</span>
  </a>
</header>

<main class="wrap">
  <div class="topbar">
    <h1 style="margin:8px 0">Report</h1>
    <div class="actions">
      <a class="btn" href="index.html">← Torna alla mappa</a>
    </div>
  </div>

  <div id="errBox"></div>

  <!-- FILTRI -->
  <div class="card">
    <div class="filters">
      <div>
        <label for="fCity" class="smallmuted">Città</label>
        <select id="fCity"><option value="">(Tutte)</option></select>
      </div>
      <div>
        <label for="fStart" class="smallmuted">Dal (data occorrenza)</label>
        <input type="date" id="fStart">
      </div>
      <div>
        <label for="fEnd" class="smallmuted">Al (data occorrenza)</label>
        <input type="date" id="fEnd">
      </div>
      <div style="display:flex;align-items:flex-end"><button class="btn primary" id="applyBtn" type="button">Applica filtri</button></div>
      <div style="display:flex;align-items:flex-end"><button class="btn" id="clearBtn" type="button">Azzera</button></div>
    </div>
    <div id="dbg" class="smallmuted">—</div>
  </div>

  <!-- KPI -->
  <div class="kpis">
    <div class="kpi"><div class="small">Eventi (filtrati)</div><b id="k_events">—</b></div>
    <div class="kpi"><div class="small">Occorrenze (filtrate)</div><b id="k_occs">—</b></div>
    <div class="kpi"><div class="small">Città coperte (filtrate)</div><b id="k_cities">—</b></div>
    <div class="kpi"><div class="small">Periodo selezionato</div><b id="k_range">—</b></div>
  </div>

  <div class="cols">
    <div>
      <h3 class="block-title">Eventi per categoria (filtrati)</h3>
      <div id="catsBox" class="card small">—</div>
    </div>
    <div>
      <h3 class="block-title">Eventi per città (filtrate — tutte)</h3>
      <div id="citiesBox" class="card small scroll">—</div>
    </div>
  </div>

  <div>
    <h3 class="block-title">Eventi (max 200, filtrati)</h3>
    <div class="card" style="overflow:auto">
      <table id="tbl">
        <thead><tr>
          <th>Titolo</th><th>Categorie</th><th>Prima data (nel filtro)</th><th>Città</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</main>

<script>
(function(){
  // ====== Legge le chiavi nello stesso modo di pubblica-evento.html ======
  const CFG = window.SQ_CONFIG || {};   // <-- usa il tuo oggetto
  const SUPABASE_URL = CFG.SUPABASE_URL;
  const SUPABASE_ANON = CFG.SUPABASE_ANON || CFG.SUPABASE_ANON_KEY; // compatibile con entrambe le varianti

  if (!SUPABASE_URL || !SUPABASE_ANON){
    const box = document.getElementById('errBox');
    box.textContent = 'Chiavi mancanti in assets/app-config.js (SUPABASE_URL / SUPABASE_ANON o SUPABASE_ANON_KEY).';
    box.style.display='block';
    return;
  }

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // ====== DOM ======
  const els = {
    errBox:   document.getElementById('errBox'),
    dbg:      document.getElementById('dbg'),
    fCity:    document.getElementById('fCity'),
    fStart:   document.getElementById('fStart'),
    fEnd:     document.getElementById('fEnd'),
    apply:    document.getElementById('applyBtn'),
    clear:    document.getElementById('clearBtn'),
    k_events: document.getElementById('k_events'),
    k_occs:   document.getElementById('k_occs'),
    k_cities: document.getElementById('k_cities'),
    k_range:  document.getElementById('k_range'),
    catsBox:  document.getElementById('catsBox'),
    citiesBox:document.getElementById('citiesBox'),
    tblBody:  document.querySelector('#tbl tbody'),
  };

  // ====== Stato & dati ======
  let EVENTS=[], OCCS=[], OCCS_BY_EVENT=new Map();
  let FILTERS = { city:'', start:null, end:null };

  // ====== Utils ======
  const fmt = n => n.toLocaleString('it-IT');
  const fmtDate = s => { if(!s) return ''; const [y,m,d]=s.split('-'); return `${d}/${m}/${y}`; };
  const inRange = (d, start, end) => {
    if (!d) return true;
    if (start && d < start) return false;
    if (end   && d > end)   return false;
    return true;
  };

  function parseCats(ev){
    if (Array.isArray(ev.categories)) return ev.categories;
    if (Array.isArray(ev.categorie))  return ev.categorie;
    const s = ev.categories || ev.categorie || '';
    if (typeof s === 'string' && s.includes('|')) return s.split('|').map(x=>x.trim()).filter(Boolean);
    if (typeof s === 'string' && s.includes(',')) return s.split(',').map(x=>x.trim()).filter(Boolean);
    return s ? [String(s)] : [];
  }

  function groupCount(arr, keyFn){
    const map = new Map();
    arr.forEach(x=>{
      const k = keyFn(x);
      if (!k) return;
      map.set(k, (map.get(k)||0)+1);
    });
    return Array.from(map.entries()).sort((a,b)=>b[1]-a[1]);
  }

  function firstOccInFilter(evId, occsFiltered){
    const list = occsFiltered.filter(o => o.event_id===evId)
      .sort((a,b)=>((a.data||'')+(a.ora||'')).localeCompare((b.data||'')+(b.ora||'')));
    return list[0] || null;
  }

  function showError(msg){
    els.errBox.textContent = msg;
    els.errBox.style.display = 'block';
  }

  // ====== Caricamento dati ======
  (async function load(){
    els.errBox.style.display='none';

    const [evRes, ocRes] = await Promise.all([
      sb.from('events')
        .select('id, title, titolo, categories, categorie'),
      sb.from('occurrences')
        .select('id, event_id, lat, lng, data, date, ora, time, luogo, venue, indirizzo, address, citta, city')
    ]);

    if (evRes.error || ocRes.error){
      let msg = '';
      if (evRes.error) msg += 'Errore eventi: ' + evRes.error.message + '\n';
      if (ocRes.error) msg += 'Errore occorrenze: ' + ocRes.error.message;
      showError(msg||'Errore sconosciuto');
    }

    EVENTS = evRes.data || [];

    const norm = (ocRes.data || []).map(o => ({
      id: o.id,
      event_id: o.event_id,
      lat: o.lat,
      lng: o.lng,
      data: o.data || o.date || null,
      ora: o.ora || o.time || '',
      luogo: o.luogo || o.venue || '',
      indirizzo: o.indirizzo || o.address || '',
      citta: (o.citta || o.city || '').trim()
    }));
    OCCS = norm;

    // Debug numeri grezzi
    els.dbg.textContent = `Dati caricati — Eventi totali: ${fmt(EVENTS.length)} · Occorrenze totali: ${fmt(OCCS.length)}`;

    // Popola select città
    const cities = Array.from(new Set(OCCS.map(o=>o.citta).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'it'));
    if (cities.length){
      cities.forEach(c=>{
        const opt=document.createElement('option');
        opt.value=c; opt.textContent=c;
        els.fCity.appendChild(opt);
      });
    }

    // Mappa occorrenze per evento
    OCCS_BY_EVENT = new Map();
    OCCS.forEach(o=>{
      if (!OCCS_BY_EVENT.has(o.event_id)) OCCS_BY_EVENT.set(o.event_id, []);
      OCCS_BY_EVENT.get(o.event_id).push(o);
    });

    render();
  })();

  // ====== Filtra e renderizza ======
  function render(){
    const { city, start, end } = FILTERS;

    const occsFiltered = OCCS.filter(o=>{
      if (city && o.citta!==city) return false;
      if (!inRange(o.data, start, end)) return false;
      return true;
    });

    const eventIds = new Set(occsFiltered.map(o=>o.event_id));
    const eventsFiltered = EVENTS.filter(e => eventIds.has(e.id));

    // KPI
    els.k_events.textContent = fmt(eventsFiltered.length);
    els.k_occs.textContent   = fmt(occsFiltered.length);
    els.k_cities.textContent = fmt(new Set(occsFiltered.map(o=>o.citta).filter(Boolean)).size);
    els.k_range.textContent  = (start||end) ? `${start?fmtDate(start):'∞'} → ${end?fmtDate(end):'∞'}` : 'Tutto';

    // Categorie
    const catList = eventsFiltered.flatMap(e=>parseCats(e));
    const catPairs = groupCount(catList, x=>x);
    els.catsBox.innerHTML = catPairs.length
      ? catPairs.map(([c,n])=> `<div>${c} — <b>${fmt(n)}</b></div>`).join('')
      : '—';

    // Città
    const cityPairs = groupCount(occsFiltered, o=>o.citta);
    els.citiesBox.innerHTML = cityPairs.length
      ? cityPairs.map(([c,n])=> `<div>${c||'—'} — <b>${fmt(n)}</b></div>`).join('')
      : '—';

    // Tabella eventi
    const rows = eventsFiltered.slice(0,200).map(e=>{
      const cats = parseCats(e);
      const first = firstOccInFilter(e.id, occsFiltered);
      const titolo = e.title || e.titolo || '(evento)';
      return `<tr>
        <td>${titolo}</td>
        <td>${cats.join(', ')||'—'}</td>
        <td>${first ? (fmtDate(first.data)+' '+(first.ora||'')) : '—'}</td>
        <td>${first ? (first.citta||'—') : '—'}</td>
      </tr>`;
    }).join('');
    els.tblBody.innerHTML = rows || `<tr><td colspan="4">Nessun evento nel filtro selezionato</td></tr>`;
  }

  // ====== Eventi UI ======
  document.getElementById('applyBtn').addEventListener('click', ()=>{
    FILTERS.city  = els.fCity.value || '';
    FILTERS.start = els.fStart.value || null;
    FILTERS.end   = els.fEnd.value   || null;
    render();
  });
  document.getElementById('clearBtn').addEventListener('click', ()=>{
    els.fCity.value = '';
    els.fStart.value = '';
    els.fEnd.value = '';
    FILTERS = { city:'', start:null, end:null };
    render();
  });
})();
</script>
</body>
</html>
